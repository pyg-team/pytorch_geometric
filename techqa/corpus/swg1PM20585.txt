Title: IBM PM20585: MULTIPLE CONTENTS SCHEDULED TO PUBLISH AT SAME TIME FAILS WITH DATABASE DEADLOCK EXCEPTION - United States

Text:
  A FIX IS AVAILABLE
6.1.0.6 Download: WebSphere Portal and WCM V6.1.0 fix pack 6 [http://www-01.ibm.com/support/docview.wss?uid=swg24030970]



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  Multiple contents scheduled to publish at same time fails with
   database deadlock exception
   
   
    
   
   

LOCAL FIX
 *  N/A
   
   
    
   
   

PROBLEM SUMMARY
 *  Problem Summary:
   PM20585 simultaneous scheduled actions result in deadlocks (lock
   time-outs) and LockRetrievelExceptions
   
   Detailed Problem Description:
   PM20585 simultaneous scheduled actions result in deadlocks (lock
   time-outs) and LockRetrievelExceptions.  Some items might be
   left locked and in the previous state when several actions are
   scheduled at the same time.  In most cases the actions that are
   affected operations that are performed on drafts such as
   scheduled actions.
   a) DB related errors:
   [8/17/10 14:02:11:108 EDT] 0000005a XATransaction E   J2CA0027E:
   An exception occurred while invoking rollback on an XA Resource
   Adapter from dataSource jdbc/wpdbDSDB2, within transaction ID
   {XidImpl: formatId(57415344), gtrid_length(36),
   bqual_length(54), data(0000012a8136a8110000000100000904fa72507fa
   d6cccf243bb7e06cbd6882ab869f0ea0000012a8136a8110000000100000904f
   a72507fad6cccf243bb7e06cbd6882ab869f0ea0000000100000000000000000
   00000000001)}: com.ibm.db2.jcc.b.cj: XAER_NOTA :
   [ibm][db2][jcc][t4][2041][11392] Error executing
   XAResource.end().  Server returned XA_RBDEADLOCK. :
   [ibm][db2][jcc][t4][2041][11392] Error executing
   XAResource.rollback().  Server returned XAER_NOTA.
    at com.ibm.db2.jcc.c.ac.a(ac.java:1695). . . .
    at com.ibm.wps.services.workmanager.impl.WasWorkWrapper
   .run(WasWorkWrapper.java:41). . .
   Caused by: com.ibm.db2.jcc.b.SqlException:
   [ibm][db2][jcc][t4][2041][11392] Error executing
   XAResource.end().  Server returned XA_RBDEADLOCK.
    at com.ibm.db2.jcc.c.ac.a(ac.java:2611)
    at com.ibm.db2.jcc.c.ac.b(ac.java:1219)
    ... 40 more
   ---- Begin backtrace for Nested Throwables
   com.ibm.db2.jcc.b.SqlException: [ibm][db2][jcc][t4][2041][11392]
   Error executing XAResource.rollback().  Server returned
   XAER_NOTA.
    at com.ibm.db2.jcc.c.ac.a(ac.java:2611). . .
   
   b) LockRetrievalException
   [8/17/10 14:02:12:294 EDT] 0000005d ScheduledActi W   <Null
   Message>
   
   java.security.PrivilegedActionException:
   com.ibm.workplace.wcm.services.repository
   .LockRetrievalException: IWKMU1062X: Message: Failed to retrieve
   the node by UUID for identity {47e47f00439e51e384c0aca39882a8ef,
   com.aptrix.pluto.content.Content}, Cause:
   javax.jcr.ItemNotFoundException: A node does not exist with
   UUID: 47e47f00439e51e384c0aca39882a8ef
    at java.security.AccessController.doPrivileged(AccessController
   .java:285)
    at javax.security.auth.Subject.doAs(Subject.java:573)
    at com.ibm.websphere.security.auth.WSSubject.doAs(WSSubject
   .java:168). .  .
   Caused by: com.ibm.workplace.wcm.services.repository
   .LockRetrievalException: IWKMU1062X: Message: Failed to retrieve
   the node by UUID for identity {47e47f00439e51e384c0aca39882a8ef,
   com.aptrix.pluto.content.Content}, Cause:
   javax.jcr.ItemNotFoundException: A node does not exist with
   UUID: 47e47f00439e51e384c0aca39882a8ef
    at com.ibm.workplace.wcm.services.repository
   .RepositoryServiceImpl.isLocked(RepositoryServiceImpl.java:1903)
   . .  .
   Caused by: javax.jcr.ItemNotFoundException: A node does not
   exist with UUID: 47e47f00439e51e384c0aca39882a8ef
    at com.ibm.icm.jcr.WorkspaceImpl.getNodeByUuid(WorkspaceImpl
   .java:1160)
   
   
    
   
   

PROBLEM CONCLUSION
 *  Problem Analysis:
   There were two issues.  First, the code synchronizes using the
   event log database.  However, this synchronization results in
   lock time-outs and the scheduled actions fail to complete
   leaving the item in a locked state in most cases.  Second, there
   is a threading related issue where one scheduled action can
   modify parameters of another scheduled action executing at the
   same time.
   
   Problem Solution:
   The code was updated  allow users to implement a custom work
   manager and use it for the scheduled actions that might
   otherwise result in the documented time-outs.
   To add a custom WorkManager the user/ administrator must perform
   the following steps:
   (1) Access the Integrated Solution Console.
   (2) Navigate to Resources -> AsynchronousBeans -> Work managers
   (3) Create a custom WorkManger use wpsDefaultWorkManager as a
   template but change the number of threads to a number less than
   60
   (4) This value will need to be tuned to the customer's
   environment.  We would recommend starting with 30 and reducing
   further if necessary.
   (5) Ensure Growable is unchecked.  This will result in too many
   threads being started.
   (6) Update the WCMConfigService.properties file adding the
   following custom.draft.workmanager=yourCustomWorkManager
   (7) Restart the WCM server.
   The code was also updated to avoid the threading issues.
   
   Affected Users:
   All users who schedule multiple items at a given time.
   
   
    
   
   

TEMPORARY FIX

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   PM20585
   
   
 * REPORTED COMPONENT NAME
   LOTUS WEB CONT
   
   
 * REPORTED COMPONENT ID
   5724I2900
   
   
 * REPORTED RELEASE
   61A
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   NoPE
   
   
 * HIPER
   NoHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2010-08-16
   
   
 * CLOSED DATE
   2010-12-07
   
   
 * LAST MODIFIED DATE
   2010-12-07
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
   
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   LOTUS WEB CONT
   
   
 * FIXED COMPONENT ID
   5724I2900
   
   

APPLICABLE COMPONENT LEVELS
 * R61C PSY
   UP
   
   
 * R610 PSY
   UP
   
   
 * R615 PSY
   UP