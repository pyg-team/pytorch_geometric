Title: IBM Repairing corrupted Derby database on Impact 7.1 NOI installations - United States

Text:
NOI; Derby; database; RELATEDEVENTS; SEASONALITY; nci_db; ImpactDB; Service; ImpactDatabase TECHNOTE (FAQ)

QUESTION
 How do we fix our Derby database on a NOI installation which is corrupted and preventing the 7.1 Impact Server from even starting up? 

ANSWER
You need to completely reset Derby if this database is corrupted. 

It is IMPORTANT to note that any data entries, which were in your Maintenance Window Management (MWM), Reporting, and/or NOI tables, are going to be completely lost. So be sure this is what you're wanting to do before continuing.

Start with resetting the database with the core ImpactDB files (this information can also be found in the Impact Administration Guide).
Either shut the Impact Server completely down or just stop your ImpactDatabase Service.
Remove the ImpactDB/ directory from $IMPACT_HOME/db/<SERVER_NAME>/derby/ directory. 
Copy the ImpactDB/ directory from $IMPACT_HOME/install/dbcore directory to the $NCHOME/db/<SERVER_NAME>/derby/ directory.

Now perform the steps to place those core NOI database files back into the Derby database. 
Start with editing the connect string in these sql files (listed below). This is the default port, username and password, so be sure to adjust your connect string accordingly.
From:
connect 'jdbc:derby://__PRIMARY_HOST__:__PRIMARY_PORT__/__PRIMARY_DB__;user=__DBUSER__;password=__DBPASSWORD__;';
To: 
connect 'jdbc:derby://localhost:1527/ImpactDB;user=impact;password=derbypass;';
=======================================================
$IMPACT_HOME/add-ons/NOI/db/noi_derby.sql
$IMPACT_HOME/add-ons/RelatedEvents/db/relatedevents_derby.sql
$IMPACT_HOME/add-ons/Seasonality/db/seasonality_derby.sql
$IMPACT_HOME/add-ons/NOI/db/noi_derby_upgrade_71fp2.sql
$IMPACT_HOME/add-ons/Seasonality/db/seasonality_derby_upgrade_71fp2.sql
$IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp03.sql
$IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp04.sql
$IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp05.sql
* $IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp06.sql
=======================================================
*Note that the files list above may vary depending on what your latest Fix Pack (these are the files up to Fix Pack 6 7.1.0.6)


Once you've edit the sql files (above), run them in the following order from your $IMPACT_HOME/bin/ directory:
=======================================================
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/NOI/db/noi_derby.sql # creates NOI schema
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/Seasonality/db/seasonality_derby.sql # creates SEASONALITY schema
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/RelatedEvents/db/relatedevents_derby.sql # creates RELATEDEVENTS schema
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/NOI/db/noi_derby_upgrade_71fp2.sql
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/Seasonality/db/seasonality_derby_upgrade_71fp2.sql
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp03.sql
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp04.sql
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp05.sql
./nci_db connect -sqlfile $IMPACT_HOME/add-ons/NOI/db/noi_derby_updatefp06.sql
=======================================================

Finally either start up the Impact Server or restart the ImpactDatabase Service to reinitialize it to the base setup.