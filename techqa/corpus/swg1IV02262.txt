Title: IBM IV02262: A WMQ V7 MULTI-THREADED JMS PROGRAM FAILED TO RECONNECT TO A MULTI-INSTANCE QUEUE MANAGER AFTER FAILOVER. - United States

Text:
  FIXES ARE AVAILABLE
WebSphere MQ V7.0 Fix Pack 7.0.1.7 [http://www-01.ibm.com/support/docview.wss?uid=swg24030911]
WebSphere MQ V7.0.1 for i5/OS Fix Pack 7.0.1.7 [http://www-01.ibm.com/support/docview.wss?uid=swg24030912]
WebSphere MQ v7.0.1.7 Hypervisor for AIX [http://www-01.ibm.com/support/docview.wss?uid=swg24031715]


SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  For WebSphere MQ V7 if there are multiple threads running
   in a WMQ v7 JMS reconnectable client connected to a WMQ
   v7 multi-instance queue manager, when initiating a failover of
   the queue manager from the active node to the standby node,
   the JMS client does not automatically reconnect to the queue
   manager.
   
   A reconnectable client is established by setting the connection
   factory CLIENTRECONNECTOPTIONS property.
   
   A thread dump from the Java or JMS program shows a Java-level
   deadlock.
   
   Found one Java-level deadlock:
   =============================
   "pool-1-thread-8":
   waiting to lock monitor 0x0000000054ab9850 (object
   0x00002ab8037822f0, a
   com.ibm.mq.jmqi.remote.internal.
   RemoteReconnectThread$ReconnectMutex),
   which is held by "RcvThread:
   com.ibm.mq.jmqi.remote.internal.RemoteTCPConnection[qmid=xyz]"
   "RcvThread:
   com.ibm.mq.jmqi.remote.internal.RemoteTCPConnection[qmid=xyz]":
   waiting to lock monitor 0x0000000054ab9e68
   (object 0x00002ab7c9439518,
   a com.ibm.mq.jmqi.remote.internal.
   ReconnectableHconn$ReconnectMutex),
   which is held by "pool-1-thread-8"
   
   Java stack information for the threads listed above:
   ===================================================
   "pool-1-thread-8":
   at
   com.ibm.mq.jmqi.remote.internal.RemoteReconnectThread.
   eligibleForReconnect(RemoteReconnectThread.java:166)
   - waiting to lock <0x00002ab8037822f0> (a com.ibm.mq.
   jmqi.remote.internal.RemoteReconnectThread$ReconnectMutex)
   at
   com.ibm.mq.jmqi.remote.internal.ReconnectableHconn.
   eligibleForReconnect(ReconnectableHconn.java:1970)
   at
   com.ibm.mq.jmqi.remote.internal.ReconnectableHconn.
   reconnect(ReconnectableHconn.java:1907)
   - locked <0x00002ab7c9439518> (a com.ibm.mq.
   jmqi.remote.internal.ReconnectableHconn$ReconnectMutex)
   at
   com.ibm.mq.jmqi.remote.internal.RemoteFAP.
   jmqiPut(RemoteFAP.java:6805)
   ...(thread stack continues)
   Found 1 deadlock.
   
   
    
   
   

LOCAL FIX

PROBLEM SUMMARY
 *  ****************************************************************
   USERS AFFECTED:
   This issue affects users of the v7 WebSphere MQ classes for
   JMS who are using a com.ibm.mq.jms.MQConnectionFactory that has
   been configured to be reconnectable.
   
   This includes users of the WebSphere Application Server through
   the use of the WebSphere MQ classes for JMS within the Resource
   Adapter.
   
   Platforms affected:
   All Distributed (iSeries, all Unix and Windows) +Java
   ****************************************************************
   PROBLEM SUMMARY:
   The WebSphere MQ classes for JMS class MQConnectionFactory can
   be configured so that JMS Sessions created from the associated
   JMS Connection object automatically reconnect themselves to the
   queue manager if a TCP connection fault is detected, or
   connect to an alternative instance of a multi-instance queue
   manager, without the need for the application code to clean up
   and create a new JMS Connection to continue to communicate with
   the queue manager.
   
   For example, this behaviour can be configured programmatically
   using the supplied method on the ConnectionFactory:
   
   MQConnectionFactory.setClientReconnectOptions(
   WMQConstants.WMQ_CLIENT_RECONNECT);
   
   A problem can occur when the factory is configured in this
   manner and there are multiple threads within the JVM that are
   communicating with queue managers.
   If the TCP connection is disconnected between the client and
   queue manager, triggering the automatic reconnection, then a
   deadlock can occur involving the reconnection thread.
   
   A coredump of the JVM in this state will show threads
   deadlocked with Java stack traces of the following form:
   
   Thread 1:
   at
   com/ibm/mq/jmqi/remote/internal/RemoteReconnectThread.
   eligibleForReconnect(RemoteReconnectThread.java:165)
   at
   com/ibm/mq/jmqi/remote/internal/ReconnectableHconn.
   eligibleForReconnect(ReconnectableHconn.java:1970)
   at
   com/ibm/mq/jmqi/remote/internal/ReconnectableHconn.
   reconnect(ReconnectableHconn.java:1907)
   at
   com/ibm/mq/jmqi/remote/internal/RemoteFAP.
   jmqiPut(RemoteFAP.java:6805(Compiled Code))
   at
   com/ibm/msg/client/wmq/internal
   /WMQMessageProducer$SpiIdentifiedProducerShadow.
   sendInternal(WMQMessageProducer.java:857(Compiled Code))
   at
   com/ibm/msg/client/wmq/internal
   /WMQMessageProducer$ProducerShadow.
   send(WMQMessageProducer.java:542(CompiledCode))
   at
   com/ibm/msg/client/wmq/internal/WMQMessageProducer.
   send(WMQMessageProducer.java:1223(CompiledCode))
   at
   com/ibm/msg/client/jms/internal/JmsMessageProducerImpl.
   sendMessage(JmsMessageProducerImpl.java:912(Compiled Code))
   at
   com/ibm/msg/client/jms/internal/JmsMessageProducerImpl.
   send_(JmsMessageProducerImpl.java:767(Compiled Code))
   at
   com/ibm/msg/client/jms/internal/JmsMessageProducerImpl.
   send(JmsMessageProducerImpl.java:424(Compiled Code))
   at
   com/ibm/mq/jms/MQMessageProducer.
   send(MQMessageProducer.java:304(CompiledCode))
   at ReconnectableJMS$InnerProducer.
   run(ReconnectableJMS.java:132)
   at java/lang/Thread.run(Thread.java:736)
   
   
   Thread 2:
   at
   com/ibm/mq/jmqi/remote/internal
   /ReconnectableHconn.hasFailed(ReconnectableHconn.java:2083)
   at
   com/ibm/mq/jmqi/remote/internal/RemoteReconnectThread.
   eligibleForReconnect(RemoteReconnectThread.java:167)
   at
   com/ibm/mq/jmqi/remote/internal/ReconnectableHconn.
   eligibleForReconnect(ReconnectableHconn.java:1970)
   at
   com/ibm/mq/jmqi/remote/internal/system/RemoteConnection.
   asyncFailureNotify(RemoteConnection.java:3336)
   at
   com/ibm/mq/jmqi/remote/internal/RemoteRcvThread.
   run(RemoteRcvThread.java:594)
   at
   com/ibm/msg/client/commonservices/workqueue
   /WorkQueueItem.runTask(WorkQueueItem.java:209)
   at
   com/ibm/msg/client/commonservices/workqueue
   /SimpleWorkQueueItem.runItem(SimpleWorkQueueItem.java:100)
   at
   com/ibm/msg/client/commonservices/workqueue
   /WorkQueueItem.run(WorkQueueItem.java:224)
   at
   com/ibm/msg/client/commonservices/workqueue/WorkQueueManager.
   runWorkQueueItem(WorkQueueManager.java:298)
   at
   com/ibm/msg/client/commonservices/j2se/workqueue
   /WorkQueueManagerImplementation$ThreadPoolWorker.
   run(WorkQueueManagerImplementation.java:1220)
   
   In many cases, the JVM will mark the threads as Deadlocked.
   
   
    
   
   

PROBLEM CONCLUSION
 *  The synchronization code within the WebSphere MQ classes for JMS
   was modified so that this deadlock no longer occurs.
   
   ---------------------------------------------------------------
   The fix is targeted for delivery in the following PTFs:
   
                      v7.0
   Platform           Fix Pack 7.0.1.7
   --------           --------------------
   Windows            U200333
   AIX                U843721
   HP-UX (PA-RISC)    U844089
   HP-UX (Itanium)    U844094
   Solaris (SPARC)    U844090
   Solaris (x86-64)   U844096
   iSeries            tbc_p700_0_1_7
   Linux (x86)        U844091
   Linux (x86-64)     U844095
   Linux (zSeries)    U844092
   Linux (Power)      U844093
   
   The latest available maintenance can be obtained from
   'WebSphere MQ Recommended Fixes'
   http://www-1.ibm.com/support/docview.wss?rs=171&uid=swg27006037 [http://www-1.ibm.com/support/docview.wss?rs=171&uid=swg27006037]
   
   If the maintenance level is not yet available, information on
   its planned availability can be found in 'WebSphere MQ
   Planned Maintenance Release Dates'
   http://www-1.ibm.com/support/docview.wss?rs=171&uid=swg27006309 [http://www-1.ibm.com/support/docview.wss?rs=171&uid=swg27006309]
   ---------------------------------------------------------------
   
   
    
   
   

TEMPORARY FIX

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   IV02262
   
   
 * REPORTED COMPONENT NAME
   WMQ LIN X86-64
   
   
 * REPORTED COMPONENT ID
   5724H7230
   
   
 * REPORTED RELEASE
   701
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   NoPE
   
   
 * HIPER
   NoHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2011-06-22
   
   
 * CLOSED DATE
   2011-07-12
   
   
 * LAST MODIFIED DATE
   2011-07-12
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
   
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   WMQ LIN X86-64
   
   
 * FIXED COMPONENT ID
   5724H7230
   
   

APPLICABLE COMPONENT LEVELS
 * R701 PSY
   UP