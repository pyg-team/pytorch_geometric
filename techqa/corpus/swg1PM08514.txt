Title: IBM PM08514: TIMING WINDOW CAN CAUSE ASYNCIO WRITE TO BE DRIVEN TWICE WHEN AIOOK2COMPIMD IS NOT SPECIFIED 10/02/25 PTF PECHANGE - United States

Text:
z/os  A FIX IS AVAILABLE
Obtain the fix for this APAR.


SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  An application is using the asyncio service to write data on a
   socket.  The application did not specify AioOk2CompImd, meaning
   the write can not complete synchronously.  When the write is
   processed by TCPIP, EZBTCFWR finds the socket is blocked for
   write.  An event is created to represent this write request.
   However, before the event can be waited on, the socket is no
   longer blocked for write.  EZBTCFWR copies the application data
   and sends it.  However, EZBPFSDR sees the AioOk2CompImd is not
   on, so the user exit is driven.  However, the event was set up
   to drive asyncio part 2, so the call to the exit drives the
   write into EZBTCFWR again.  This causes the same write data to
   be sent twice.
   .
   PK90203/UK49089 introduces this error and has been flagged
   PE.  This PTF closed on 09/09/02 and is packaged in RSU 0909
   which just missed the base V1R11 cut off.
   
   ADDITIONAL SYMPTOMS:
   For Websphere MQ, message CSQX526E or CSQX620E is seen:
   CSQX526E !MQZ4 CSQXRCTL Message sequence error for channel
   
   channel_name, sent=xxxxx expected=yyyyy
   .
   CSQX620E !MQZ4 CSQXRESP System SSL error,
   channel channel_name,
   connection yyyy (::ffff:xx.xx.xx.xx)
   function 'gsk_secure_socket_read' RC=411
   .
   MQ compids: 5655L8200 5655R3600 R000
   .
   With JES, may see ABENDEC8 RC20D and message
   IAZ0525I server_name device_name Inbound BCB count not valid in
   received buffer
   .
   VERIFICATION STEPS:
   1) Packet trace will show the same data sent twice
   2) SYSTCPIP ctrace with option PFS, ENGINE, TCP will show the
   same asyncio request processed twice.
   3) The same DUCB will issue TCP trace message "Fast write
   entry" twice.  The TCB will be blocked for write on the first
   trace entry but not the second.
   
   
    
   
   

LOCAL FIX

PROBLEM SUMMARY
 *  ****************************************************************
   * USERS AFFECTED: All users of the IBM Communications Server   *
   *                 for z/OS Version 1 Release 11 IP             *
   ****************************************************************
   * PROBLEM DESCRIPTION: TCP socket data corruption may occur    *
   *                      when using asynchronous write type      *
   *                      socket calls with AIOOK2COMPIMD set     *
   *                      off.  A timing window exists where      *
   *                      the data presented on the write socket  *
   *                      call can be sent over the connection    *
   *                      twice.                                  *
   ****************************************************************
   * RECOMMENDATION:                                              *
   ****************************************************************
   Applications issuing asynchronous write type socket calls on a
   TCP socket with AIOOK2COMPIMD set off may have the user data
   added to the connection send queue twice.  The sequence of
   events leading to the problem are:
   - Socket call enters the TCP/IP stack and finds the connection
     is write blocked (send queue is full).
   - An event is added to the connection to drive the socket call
     asynchronously when the send queue has space available to
     hold the user data.
   - The TCP connection lock is released prior to waiting on the
     event.
   - An inbound ACK acquires the connection lock and frees data
     on the send queue.  The event is posted but the asynchronous
     part of the call is not scheduled because the event has not
     been waited on.
   - The socket call issues the wait on the event and finds the
     event has already been posted.  The socket call continues to
     process, adding the user data to the connection send queue.
   - The socket call returns to the PFS layer where it is detected
     the AIOOK2COMPIMD was not set on so an SRB is scheduled to
     notify the application the call has completed by driving the
     application exit or posting the ECB.
   - The SRB detects a wait was done against the event and drives
     the socket call back down to the TCP/IP stack instead of
     notifying the application the call is complete.
   - The user data is copied onto the connection send queue a
     second time before the SRB exits the TCP/IP stack and
     notifies the application that the call has completed.
   +-------------------------------------------------------------+
   + Please check our Communications Server for OS/390 homepages +
   + for common networking tips and fixes.  The URL for these    +
   + homepages can be found in Informational APAR II11334 [http://www-01.ibm.com/support/docview.wss?uid=isg1II11334].       +
   +-------------------------------------------------------------+
   
   
    
   
   

PROBLEM CONCLUSION
 *  The TCP socket send path has been amended to detect when an
   asynchronous write is not allowed to complete immediately and
   sets an indicator of the call has completed prior to exiting
   the TCP/IP stack.  The SRB scheduled to notify the application
   will not return to the TCP/IP stack if the call has completed
   on the first pass.
   
   * Cross Reference between External and Internal Names
   
   
    
   
   

TEMPORARY FIX
 *  *********
   * HIPER *
   *********
   
   
    
   
   

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   PM08514
   
   
 * REPORTED COMPONENT NAME
   TCP/IP V3 MVS
   
   
 * REPORTED COMPONENT ID
   5655HAL00
   
   
 * REPORTED RELEASE
   1B0
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   YesPE
   
   
 * HIPER
   YesHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt / Xsystem
   
   
 * SUBMITTED DATE
   2010-02-25
   
   
 * CLOSED DATE
   2010-03-03
   
   
 * LAST MODIFIED DATE
   2010-04-03
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
    UK54866
   
   

MODULES/MACROS
 *  EZBTCFWR EZBTLFWR TCFWR
   
   
    
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   TCP/IP V3 MVS
   
   
 * FIXED COMPONENT ID
   5655HAL00
   
   

APPLICABLE COMPONENT LEVELS
 * R1B0 PSY UK54866 [HTTPS://WWW14.SOFTWARE.IBM.COM/WEBAPP/SET2/ORDERMEDIA/SHOPCART?PTFS=UK54866]
   UP10/03/18 P F003 Â«
   
   

FIX IS AVAILABLE
 * SELECT THE PTF APPROPRIATE FOR YOUR COMPONENT LEVEL. YOU WILL BE REQUIRED TO SIGN IN. DISTRIBUTION ON PHYSICAL MEDIA IS NOT AVAILABLE IN ALL COUNTRIES.