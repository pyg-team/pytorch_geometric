Title: IBM How to check for loops in accounting structure - United States

Text:
Saving changes in Account Structure define fails with an error TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 User launches "Maintain - Account Structure - Define". Inside 'Define Account Structure' user makes changes to the account summations. User clicks "Save" then tries to close the window. After a while (for example 45 minutes) an error message appears.

Other errors occur when trying to save changes to forms. 

SYMPTOM
[/support/docview.wss?uid=swg21661291&amp;aid=1] 

 
Details:
[/support/docview.wss?uid=swg21661291&aid=2] [/support/docview.wss?uid=swg21661291&aid=2] 

Source: FrangoDirect.AccountD.GenerateSummationStructure#ControllerProxyClient 

Description: System.Web.Services.Protocols.SoapException: Server was unable to process request. ---> System.Runtime.InteropServices.ComException (0x800A000D): Type mismatch at... 

<...> 

Cognos.Controller.Proxy.CCRWS.AccountT_GenerateSummationStructure. 

 

When defining Forms: 

Event Viewer:
[/support/docview.wss?uid=swg21661291&aid=3] [/support/docview.wss?uid=swg21661291&aid=3]
Error No=7, Source=xGetSumRelations, Description=Out of memory

[/support/docview.wss?uid=swg21661291&aid=4] [/support/docview.wss?uid=swg21661291&aid=4]
... OutOfMemoryException ...


CAUSE
There are several possible causes for this/similar errors. 

 * For example see separate IBM Technote #1457016. 


This Technote relates to the cause where several changes have been made (in 'Accounts define') to the summation logic (i.e. how the accounts sum together) which are illogical. This has caused a summation loop (invalid). 

 * In other words, the cause is a circular reference in the account structure.


In other words, a mistake has been made so that:  * account AA sums to BB 
 * However, account BB sums to account AA.


This means when trying to generate summations the process will never emerge from that loop. Finally after some time (for example 45 mins), the system gives up trying and displays an error. 

Example: 
In one real-life example:  * 3.02.1021I was summed to 3.02.1020I 
 * and 3.02.1020I was summed to 3.02.1021I


This could be seen by directly opening the database table 'xkonto': 
[/support/docview.wss?uid=swg21661291&aid=5] [/support/docview.wss?uid=swg21661291&aid=5] 
DIAGNOSING THE PROBLEM
If you have recently made changes to the account structure, examine those changes carefully to find the loop(s).



RESOLVING THE PROBLEM
The finance superuser must correct the accounting structure (inside Controller) so that there are no incorrect summations. 

 * For example, in the example above they need to modify the accounts so that AA does not sum into BB.


Steps: 

There are several different possible methods to check for loops. You may need to run some or all of the following methods: 

 

 * Method #1 - Ask the finance superuser to check for loops manually (by looking at the configuration inside Controller). 
 * Method #2 - Check if a single account sums to itself (in sum1, sum2 or sum3).  * This is very simple to check 
    * See separate IBM Technote #1347628.
   
   
 * Method #3 - Check if you have multiple accounts looping into each other.  * This is much more complex to check. It requires an understanding of SQL tables and experience in the use of SQL scripts. 
    * See steps below for full details.
   
   
 * Method #4 - Ask the finance superuser to run a report:  * Specifically, click "Maintain > Account Structure > Reports" 
    * Under "Additional Reports" tick "Advanced Analysis of Summations". 
    * This may tell you if there is a loop.
   
   

Steps for Method #3 

Due to the nature of this method, it is recommended that you only run this process in a copy (or "test" version) of your database. 

 * If you need to run it on your production database, then make sure you have a valid database backup before proceeding.


The following instructions are based on Microsoft SQL. If you are using a different database technology, then they will need to be modified accordingly. 

1. Ask your SQL administrator (DBA) to launch 'SQL Server Management Studio' 

2. Locate the Controller database, and expand the tables 

3. Check to see the owner of the tables (for example, locate the table 'xkonto'). 

 * For most customers, its full name will appear as: dbo.xkonto 
 * For other customers, its name will include the SQL login, for example: fastnet.xkonto


We shall assume (from now on) that the table name is: fastnet.xkonto. 

 * Naturally you will need to modify the instructions (e.g. SQL scripts) to match your environment.


4. Run the following SQL script (to create a temporary table 'fmsum'): 


select konto, sum1 as skonto into fmsum from fastnet.xkonto where sumrad = 'T' and sum1 != ' '
union
select konto, sum2 as skonto from fastnet.xkonto where sumrad = 'T' and sum2 != ' '
union
select konto, sum3 as skonto from fastnet.xkonto where sumrad = 'T' and sum3 != ' '
[/support/docview.wss?uid=swg21661291&aid=6] [/support/docview.wss?uid=swg21661291&aid=6]


5. Search for the 'bad' rows by using the following script: 


WITH cteSumAcc (Skonto, Konto, Level)
AS
-- Anchor member definition
(SELECT ANCHOR.skonto, ANCHOR.konto, 0 AS Level
FROM fmsum AS ANCHOR 
UNION ALL
-- Recursive member definition
SELECT RECURSE.skonto, RECURSE.konto, Level + 1
FROM fmsum AS RECURSE
INNER JOIN cteSumAcc AS cteANCHOR
ON RECURSE.skonto = cteANCHOR.konto)
-- Statement that extracts using the CTE
SELECT skonto, konto, level
FROM cteSumAcc
OPTION (Maxrecursion 50)
GO 

 

6. Do not worry that you will see an error appearing (see below) inside 'Messages':
[/support/docview.wss?uid=swg21661291&aid=7] [/support/docview.wss?uid=swg21661291&aid=7] 

 

7. Check the 'Results' tab. 

 * Mostly it shows a level between 0 and 6 (which is good):

[/support/docview.wss?uid=swg21661291&aid=8] [/support/docview.wss?uid=swg21661291&aid=8]  

However, if there is a loop (i.e. circular summation) then it will keep increasing (until it hits 50 - which causes the error message). 

 * for this example you will see a row from level 1 to 50 with the same accounts under 'skonto' and 'konto':

[/support/docview.wss?uid=swg21661291&aid=9] [/support/docview.wss?uid=swg21661291&aid=9] That tells you that these 2 accounts are the problem ones. 

 

8. Before proceeding, you need to delete the temporary table (i.e. before running again) using the following script:


 * drop table fmsum



9. Now ask the finance superuser to fix the discovered loop, by using 'Maintain - Accounts Define'. 

10. Afterwards, try saving again.  * If you still get the same error this means another problem exists. 
 * You will therefore need to re-run the same steps (see above) until you find the next loop.

RELATED INFORMATION
#Technote 1457016 [http://www.ibm.com/support/docview.wss?uid=swg21457016]
1347628 - Errors when saving Form layout caused by Loo [http://www.ibm.com/support/docview.wss?uid=swg21347628]