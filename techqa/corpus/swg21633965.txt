Title: IBM Portal v8 script 'upgrade-profile' fails with EJPNK0040E error on Oracle - United States

Text:
EJPNK0040E; profile_full.json; upgrade-profile; oracle; ojdbc; setBinaryStream TECHNOTE (TROUBLESHOOTING)

PROBLEM
When migrating to WebSphere Portal v8 using an Oracle backend database, the script 'upgrade-profile' fails with 'EJPNK0040E (MODIFY_THEME_MODULES_PROFILE_NOT_FOUND_2) with parameters profile_full.json ibm.portal.80Theme'

SYMPTOM
In the ConfigTrace.log, the following exception can be seen:

=====================
"[wsadmin] WASX7209I: Connected to process "WebSphere_Portal" on node portalNode using SOAP connector; The type of process is: ManagedProcess 
[wsadmin] WASX7303I: The following options are passed to the scripting environment and are available as arguments that are stored in the argv variable: "[/opt/IBM/WebSphere/wp_profile/ConfigEngine, NO_VP_ID, ThemeUniqueName=ibm.portal.80Theme,
ThemeProfileFileName=profile_full.json, ModuleIDs=wcm_inplaceEdit, DeferredModuleIDs=${DeferredModuleIDs}, ModifyThemeAction=add]" 
[wsadmin] [04/08/13 14:47:53.803 CDT] FFDC1007I: FFDC Provider Installed: com.ibm.ffdc.util.provider.FfdcOnDirProvider@fa3ec53a 
[wsadmin] logged in as
"uid=wpsadmin,o=defaultWIMFileBasedRealm"
[wsadmin] [04/08/13 14:47:53.969 CDT] EJPXD0001I
[wsadmin]
com.ibm.wps.resourceaggregator.cmd.ProfileNotFoundException:
Unspecified message EJPNK0040E
(MODIFY_THEME_MODULES_PROFILE_NOT_FOUND_2) with parameters
profile_full.json ibm.portal.80Theme
=====================

In the SystemOut.log during WebSphere_Portal startup, JCR exceptions can be seen. These may occur several minutes before the ConfigEngine failure:

=================
[4/9/13 9:32:51:685 CDT] 00000013 DefaultTransa E Message: Could not save object in repository., Cause: javax.jcr.RepositoryException: RT0002E: Error while calling a function createItems of PLS data manager
com.ibm.workplace.wcm.services.repository.RepositoryException: Message: Could not save object in repository., Cause: javax.jcr.RepositoryException: RT0002E: Error while calling a function createItems of PLS data manager
at com.ibm.workplace.wcm.services.transaction.steps.repository.SaveWorkspace.execute(SaveWorkspace.java:140)
.
.
.
Caused by: java.lang.AbstractMethodError: java/sql/PreparedStatement.setBinaryStream(ILjava/io/InputStream;)V
at com.ibm.ws.rsadapter.jdbc.WSJdbcPreparedStatement.setBinaryStream(WSJdbcPreparedStatement.java:1408)
... 97 more
=================


CAUSE
The root cause of this error is the JCR exception seen in the SystemOut.log. It prevents the Portal8 theme from being properly deployed, and it ultimately leads to the failure in ConfigTrace.

The JCR error in this case is: "Caused by: java.lang.AbstractMethodError: java/sql/PreparedStatement.setBinaryStream(ILjava/io/InputStream;)V"

This can happen when the ojdbc14.jar or ojdbc5.jar driver is used instead of the ojdbc6.jar.

DIAGNOSING THE PROBLEM
Diagnosing this problem can be tricky, as it is not immediately obvious that the JCR error is the culprit. The error in ConfigTrace is caused by the Portal8 theme not being deployed correctly. It should have been deployed earlier in the upgrade-profile script by another script called:

deploy-webdav-resources-wp.theme.themes/default80

For this particular case, the deploy-webdav-resources-wp.theme.themes/default80 script ran without any errors. However upon checking the Portal8 theme in webdav by accessing this URL:

http://<host>:<port>/wps/mycontenthandler/dav/fs-type1/themes?mime-type=application/zip

We found that the Portal8 theme was missing all of the files, including profile_full.json like the error refers to. 

These files are stored in the JCR db, and we finally determined the Oracle driver problem, causing the JCR error several minutes before the actual failure, was preventing it from properly writing the theme files to the database. 

RESOLVING THE PROBLEM
To resolve the problem:

1. Edit wkplc_dbtype.properties and set oracle.DbLibrary to the ojdbc6.jar file.
2. Execute the following ConfigEngine commands to update the Portal configuration with the ojdbc6.jar driver:

ConfigEngine validate-database-connection
ConfigEngine connect-database

3. Log into the DMGR and check if any other custom JDBC Providers for Oracle have been created for the Portal Server/cluster. If those are using the ojdbc5 or ojdbc14.jar, they will need to be manually updated to ojdbc6.jar as well.

4. Save all changes and re-attempt upgrade-profile.