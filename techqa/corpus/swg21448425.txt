Title: IBM Staff query refresh does not complete due to transaction timeouts - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 By default, if the staff refresh daemon refreshes staff queries, 100 staff queries are refreshed within one transaction. This allows that each staff query refresh operation may take just over a second on average. However if staff queries take longer it is possible the whole transaction will be rolled back and none of the queries in that transaction will be refreshed. In such cases the performance of the user repository should be investigated. It is also possible to reduce the number of staff queries refreshed within a transaction via the property documented below. 

SYMPTOM
New Users added to Groups which control Human Task Ownership/Administration are not able to view their Human Tasks after updating the User Repository and then performing a Staff Query Refresh.


CAUSE
The transaction chunk size of the Staff Query Refresh is set to 100. For some systems, this chunk size may not be small enough.

DIAGNOSING THE PROBLEM
If the resolution of staff queries takes too long the transaction 

timeout can be exceeded leading to rollbacks, messages on the HTM Hold 
Queue and staff queries not being refreshed. Symptoms similar to the 
following will be seen in the SystemOut.log: 

CWTKE0073I: The people assignment refresh daemon (staff query refresh 
daemon) has completed 100 of 909 refresh operations. 
[9/15/10 19:52:40:479 PDT] 00001936 ExceptionUtil E CNTR0019E: EJB 
threw an unexpected (non-declared) exception during invocation of method 
"executeInTx". Exception data: 
com.ibm.websphere.csi.CSITransactionRolledbackException: Transaction 
rolled back; nested exception is: 
javax.transaction.TransactionRolledbackException: Transaction is marked 
rollback only due to timeout 
at 
com.ibm.ejs.csi.TransactionControlImpl.completeTxTimeout(TransactionCont 
rolImpl.java:1403) 
at 
com.ibm.ejs.csi.TransactionControlImpl.preInvoke(TransactionControlImpl. 
java:295) 
at com.ibm.ejs.csi.UOWControlImpl.preInvoke(UOWControlImpl.java:253) 
at 
com.ibm.ejs.container.EJSContainer.preInvokeActivate(EJSContainer.java:3 
468) 
at com.ibm.ejs.container.EJSContainer.preInvoke(EJSContainer.java:2933) 
at 
com.ibm.task.framework.EJSLocalStatelessTaskServiceManagerBean_fd52dd76. 
executeInTx(Unknown Source) 
at 
com.ibm.task.core.message.HtmMessage.sendToInternalQueue(HtmMessage.java 
:120) 
at 
com.ibm.task.core.message.RefreshStaffQueryMessage.processMessage(Refres 
hStaffQueryMessage.java:164) 
[9/15/10 19:52:40:506 PDT] 00001936 HTM W CWTKE0021W: Cannot 
refresh expired people assignment (staff query result). 


RESOLVING THE PROBLEM
If you ever need to decrease this slice size, check if the 
connection to your people directory, e.g. LDAP server, has issues. 
Usually, staff query operations should not last longer than one second. 
In addition you may decrease this slice size: 
1. Login in to the administrative console 
2. Navigate to the Human task Manager customer properties (this may 
vary depending on the release you are running): 
2a. If the Human task Manager is configured in a cluster: Servers 
-> clusters -> Cluster name > Business Process Choreographer 
-> Human Task Manager -> Custom Properties 
2b. If the Human task Manager is configured on a single server: 
Server -> Application servers -> server name -> Business 
Process Choreographer -> Human Task Manager -> Custom 
Properties. 
3. Create or modify a custom property 
"Staff.RefreshStaffQuery.SlicePerTx" and set a number lower than 100 
into the value text box (very low values should be avoided). 
4. You need to restart the server/cluster members to make this change 
effective. 

The Staff.RefreshStaffQuery.SlicePerTx property is applicable to 
Websphere Process Server release 6.1.2 and later (most current release 
at the time of writing: 7.0.0)