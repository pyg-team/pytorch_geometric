Title: IBM WebSphere Application Server 7.0.0.15 or 7.0.0.17 with Oracle 10g or 11g causes FileNet Enterprise Manager failures with FNRCE0000E - ERROR Unable to close database context. - United States

Text:
FileNet Enterprise Manager; FEM; WebSphere Application Server; WAS; Oracle TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Changes contained in Websphere Application Server 7 Fix Pack 15 and 17 (7.0.0.15 and 7.0.0.17) cause consumption of the Oracle connection pool, after which you cannot update objects in FEM. 

SYMPTOM
Failure to create P8 domain or update objects with FileNet Enterprise Manager.


CAUSE
Changes to the WebSphere Application Server 7 OracleDataStoreHelper class cause a failure to close Oracle JDBC connections. 

The root cause of this problem is using an Oracle JDBC driver that is not intended for use with the WebSphere Application Server SDK version 1.6.


ENVIRONMENT
WebSphere Application Server 7.0.0.15 or 7.0.0.17 with Oracle 10g or 11g



DIAGNOSING THE PROBLEM
The associated logs will contain similar errors as: 


P8 Error log:
2011-03-22T03:46:13.946Z 5A825A82 GCD FNRCE0000E - ERROR Unable to close database context
java.lang.AbstractMethodError: java/sql/Wrapper.isWrapperFor(Ljava/lang/Class;)Z
at com.ibm.websphere.rsadapter.OracleDataStoreHelper.doConnectionCleanup(OracleDataStoreHelper.java:358)
at com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.cleanupStates(WSRdbManagedConnectionImpl.java:4218)
at com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.cleanup(WSRdbManagedConnectionImpl.java:4038)
at com.ibm.ejs.j2c.MCWrapper.cleanup(MCWrapper.java:1531)
at com.ibm.ejs.j2c.FreePool.returnToFreePool(FreePool.java:508)
at com.ibm.ejs.j2c.PoolManager.release(PoolManager.java:1846)
at com.ibm.ejs.j2c.MCWrapper.releaseToPoolManager(MCWrapper.java:2384)
at com.ibm.ejs.j2c.ConnectionEventListener.connectionClosed(ConnectionEventListener.java:377)
at com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.processConnectionClosedEvent(WSRdbManagedConnectionImpl.java:1832)
at com.ibm.ws.rsadapter.jdbc.WSJdbcConnection.closeWrapper(WSJdbcConnection.java:906)
at com.ibm.ws.rsadapter.jdbc.WSJdbcObject.close(WSJdbcObject.java:240)
at com.ibm.ws.rsadapter.jdbc.WSJdbcObject.close(WSJdbcObject.java:193)
...
...

System.out log:
[3/23/11 15:31:04:693 CDT] 00000021 LocalExceptio E CNTR0020E: EJB threw an unexpected (non-declared) exception during invocation of method "executeChanges" on bean "BeanId(FileNetEngine#Engine-ejb-ws.jar#EngineCore, null)". Exception data: com.filenet.api.exception.EngineRuntimeException: FNRCE0024E: E_FAILED_TO_GET_DATASOURCE: The server cannot get the data source FNGCDDS. failedBatchItem=0 errorStack={
at com.filenet.engine.context.ServerCallContext.getConnectionWithRetry(ServerCallContext.java:1026)
at com.filenet.engine.context.ServerCallContext.getConnection(ServerCallContext.java:979)
at com.filenet.engine.context.ServerCallContext._getDBContext(ServerCallContext.java:728)
at com.filenet.engine.context.ServerCallContext.beginLocalTransaction(ServerCallContext.java:616)
at com.filenet.engine.gcd.GCDDBPersistence.checkDatabaseTable(GCDDBPersistence.java:294)
at com.filenet.engine.gcd.GCDDBPersistence.checkDatabaseTables(GCDDBPersistence.java:165) ...
Caused by: com.ibm.websphere.ce.j2c.ConnectionWaitTimeoutException: Connection not available, Timed out waiting for 180032 failedBatchItem=0
at com.ibm.ejs.j2c.FreePool.createOrWaitForConnection(FreePool.java:1664)
Caused by: java.security.PrivilegedActionException: com.ibm.websphere.ce.cm.ConnectionWaitTimeoutException: Connection not available, Timed out waiting for 180032
...
...

FFDC log::
[3/23/11 10:46:08:582 CDT] 0000002a FfdcProvider W com.ibm.ws.ffdc.impl.FfdcProvider logIncident FFDC1003I: FFDC Incident emitted on /u1/IBM/WebSphere/AppServer/profiles/AppSrv01/logs/ffdc/server1_72c672c6_11.03.23_10.46.08.304249656684198655194.txt Max connections reached 869
...



RESOLVING THE PROBLEM
To solve the problem, use the correct Oracle JDBC driver that is built for use with your JDK version. The driver ojdbc5.jar contains classes for use with JDK 1.5, and the ojdbc6.jar contains classes for use with JDK 1.6. 


Otherwise, patch WebSphere Application Server 7.0.0.15 or 7.0.0.17. The iFix for 7.0.0.15 and 7.0.0.17 is available here: http://www.ibm.com/support/docview.wss?uid=swg24029891 [http://www.ibm.com/support/docview.wss?uid=swg24029891]

Note that the above patch is incorporated into WebSphere Application Server 7.0.0.19 and higher.