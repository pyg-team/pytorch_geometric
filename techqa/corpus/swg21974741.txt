Title: IBM Two scenarios where multiple accounts for users could be created on an IBM Traveler server HA pool - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM
There are two scenarios where an IBM Traveler user could end up with multiple accounts on an IBM Traveler server HA pool. Note that these scenarios are not expected to be common. Symptoms include the following: 

 * When the new account is created, the user may see their device resync mail, calendar and contact data. 
 * The user may report that certain mail, calendar or contact items are not found on their mobile device and resyncing the data does not resolve the issue. 
 * The user may report a folder missing on the device. If the missing folder is the Inbox, then the user could experience connectivity messages.


NOTE: These symptoms will not impact the integrity of the user's data on the mail server; but rather impacts what data gets synced to the mobile device. 


CAUSE
 

There were two scenarios found that could result in a end user having multiple accounts on an IBM Traveler Server pool. 

 

Scenario 1: The more common scenario is an upgrade of an existing 8.5.3.200 Traveler server HA pool to 9.0.1.x. This will only happen if as part of the upgrade you are running some number of 9.0.1.x servers while some servers are still at the 8.5.3.200 level. There was a data migration step added in 9.0.1.0 that runs when all the servers are upgraded instead of when the first server was upgraded as it should have to prevent the possibility of this problem. Even in this scenario, however, multiple accounts may not get created during the upgrade. 

 

Scenario 2: The second and likely less common scenario is when resetting an existing user who is syncing a device that supports concurrent multiple data type syncs, such as Apple native mail and calendar applications. After the reset if both the mail and calendar apps sync at the exact same time, and get load balanced to different Traveler servers, it could result in more than one account being created for the user.


ENVIRONMENT
This problem has only been seen on an IBM Traveler server HA pool and is more commonly seen if at some point the IBM Traveler server pool was running a mixed level environment which included 8.5.3.200 servers running at the same time as 9.0.1.x servers in the same HA pool.



DIAGNOSING THE PROBLEM
A new tell command has been added to IBM Traveler 9.0.1.9 and later to check for this condition. An administrator can run this tell command manually or simply generate a SystemDump which will run the command as part of the system diagnosis. Here is the tell command syntax and expected output. 


tell traveler DbAccountsCheck <command> <max>

Where <command> includes:
Show - Displays all users with more than one Traveler database
account records.
Repair - Performs a Reset command on any users with more\n\
than one Traveler database account records.\n\

Where <max> indicates the maximum number of users with more than one
Traveler database account records to check.
''*'' may be used to check all users (no maximum). 

 

The SystemDump will use the * option to check all users. The output will be one of two formats.

Output 1
"No users found with duplicate account IDs. Unique index exists on account table preventing any future occurrences of this problem."

This indicates that no users were found to have multiple accounts and the IBM Traveler server successfully put a constraint on the account table that will prevent any possibility of this problem occurring in the future. 

 

Output 2
"CN=John Doe/OU=USA/O=Company has # account IDs when there should be only one account ID. You may need to reset CN=John Doe/OU=USA/O=Company # times.
xx out of ### users had multiple account IDs and may need to be reset multiple times."

This indicates that the specified number of users have multiple accounts. 


RESOLVING THE PROBLEM
Starting with 9.0.1.9, the Traveler server has been updated to handle the two scenarios discussed above but also will create a unique index on the account table to prevent any future possibility of this problem from happening. However, the unique property can not be applied while the account table has non-unique data (i.e., users with multiple accounts). Follow these steps to ensure that no user has multiple accounts. 

 

1) Run DbAccountsCheck command in show mode to determine if the problem exists. 

 

 * 
 * ex: tell traveler DbAccountsCheck show *


2) If any users are reported with this issue then the account table constraint has not yet been added to the account table. To remove the multiple accounts run a reset * command for the user once for each account. I.E. if the user has two accounts run the reset * command for the user twice. The DbAccountsCheck tell command has a repair option to simplify this operation. 

 

 * 
 * ex: tell traveler DbAccountsCheck repair <max>


In repair mode it is advisable to run in small batches and during off peak hours to ensure no performance impact on the system. In general batches of 50 or 100 users at a time should pose little impact to the overall system performance. 

 

 * 
 * ex: tell traveler DbAccountsCheck repair 50


3) Once all users with multiple accounts are cleared up the unique constraint should automatically be added to the account table. To verify run the DbAccountsCheck show option again. 

 

Note: If manually managing the database schema, then the show option will report no users found and will display the ddl script you need to run to apply the unique constraint on the account table. 

 

Once the unique index has been applied to the account table of the Traveler database this problem will permanently be resolved. 

RELATED INFORMATION
 IBM Traveler Server Recommended Maintenance [http://www.ibm.com/support/docview.wss?uid=swg24019529]
IBM Traveler Product Documentation [http://www.ibm.com/support/knowledgecenter/SSYRPW_9.0.1/traveler_901_welcome.html]