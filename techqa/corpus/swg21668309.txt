Title: IBM EKM server cannot be reached. It appears to be stopped. - United States

Text:
certificate certification expiring expired expire expires expiration ssl certs cert TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 login -ekmuser EKMAdmin -ekmpassword xxxxxx -> Error communicating with server. Server is not started. 

DIAGNOSING THE PROBLEM
Complete error: 

$ ekmcli
# login -ekmuser EKMAdmin -ekmpassword xxxxxx
Error communicating with server. Please check the logs for more information.
Server is not started. EKM server cannot be reached. It appears to be stopped.

ekmaudit.log did not show any errors. However debug shows the following:

Mar 3, 2014 1:08:50 PM Thread[main,5,main] KeyStoreLoader loadKeyStore
ALL: load /home/ekmserv/keymanager/key1.jck
Mar 3, 2014 1:08:51 PM Thread[main,5,main] KeyStoreLoader loadKeyStore
ALL:
com.ibm.keymanager.KeyManagerException: Audit is closed
at com.ibm.keymanager.audit.Audit.isOn(Audit.java:110)
.......
ALL: found key managers
ALL: found trust managers
ALL: config.drivetable.table.entry.provider = null
ALL: TransportListener.ssl.port = 1443 which is listening
ALL: TransportListener.ssl.protocols = SSL_TLS
ALL: TransportListener.ssl.host = null
...
ALL: javax.net.ssl.SSLHandshakeException: com.ibm.jsse2.util.h: Certificate expired 
....
Caused by: com.ibm.jsse2.util.h: Certificate expired 

List the certificates shows many certificates expired. 
keytool -list -v -storetype JCEKS -keystore key1.jck
Enter keystore password: xxxxxx
Keystore type: JCEKS
Keystore provider: IBMJCE
keystore contains 39 entries

But which one is the ssl cert to delete it and create a new one?. 


RESOLVING THE PROBLEM
The problem happens because there are expired keypair/cert in the keystore which was used as server certificate in SSL connection. 


Detail explanations:
Both EKM and JSSE will not have any way to choose which certificate in the keystore is used in SSL. Given a keystore, 

JSSE will simply choose the first cert which meets the requirement of the SSL connection. Thus when there are expired certificates in the keystore, it's possible it was chosen by JSSE to be used as the server certificate, even when where are other certificates which are unexpired.

The function of the property of TransportListener.ssl.protocols = SSL_TLS:
The meaning of this property is actually the SSL protocol which is enabled (can be SSLv3, TLSv1, etc). 

The "TransportListener.ssl.protocols = SSL_TLS" means both SSLv3 and TLSv1 are enabled on the server side.

In this case, the user is trying to use a keypair/cert with the alias "SSL_TLS" as the server certificate. 

Next step:

To solve this without affecting the existingcertificates for key serving purpose, use a separate keystore for SSL connections. For the existing keystore, user can still use it for key serving. Please have a different keystore for "Admin.ssl.keystore/truststore.*" and "TransportListener.ssl.keystore/truststore.*" properties.

After that login worked fine