Title: IBM Wrong table REORG with ADMIN_CMD cannot be reported in a compound SQL (compiled) statement - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 When you use the REORG with ADMIN_CMD to reorg your table in a compound SQL (compiled) statement, You may not meet any error if it is issued for a wrong 
table or a table which does not exist. 

SYMPTOM
Let me share the one test code for this issue. 

-------------------------------------
$ db2 -td@ -vf tst.sql 
SET SERVEROUTPUT ON 
DB20000I The SET SERVEROUTPUT command completed successfully. 

BEGIN 

CALL SYSPROC.ADMIN_CMD ('REORG TABLE IDONT.EXIST'); 
CALL DBMS_OUTPUT.PUT_LINE ( 'Hello' ); 

END 
DB20000I The SQL command completed successfully. 

Hello 

-------------------------------------

In a compound SQL (compiled) statement above, we have a REORG for nonexistent table by using ADMIN_CMD. Even though we do not have the table, 
we do not see any error message and you see the success message at the end. 
Moreover, you can see the result of the next statement. 
However, the table does not exist so REORG did not complete at all. 


CAUSE
Even though there is any exception occurred, if there is no appropriate handler 
for that in the SQL PL code, the execution continues with the next SQL statement. Thus, you could not see any error in the command line. 

For more detail, please check the following knowledge center link. 
-------------------------------------
http://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0004239.html [http://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0004239.html]

If an exception condition occurs for which there is no appropriate handler, the SQL procedure containing the failing statement is terminated with an unhandled exception condition. If a completion condition occurs for which there is no appropriate handler, execution continues with the next SQL statement.
------------------------------------- 


RESOLVING THE PROBLEM
Like other programming, you must use the error handler for a compound SQL (compiled) statement. By using handler, you can check each statement in a procedure have a error or not. Please check the following example as a reference. 

-------------------------------------
$ db2 -td@ -vf tst_state.sql 
SET SERVEROUTPUT ON 
DB20000I The SET SERVEROUTPUT command completed successfully. 

BEGIN 

DECLARE SQLSTATE CHAR(5) DEFAULT '00000';
DECLARE retstate CHAR(5) DEFAULT '00000';
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION, SQLWARNING, NOT FOUND
SET retstate = SQLSTATE;

CALL SYSPROC.ADMIN_CMD ('REORG TABLE IDONT.EXIST'); 
CALL DBMS_OUTPUT.PUT_LINE (retstate); 
END 
DB20000I The SQL command completed successfully. 

01H52 
------------------------------------- 

RELATED INFORMATION
 Compound SQL (compiled) statement [http://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0004239.html]