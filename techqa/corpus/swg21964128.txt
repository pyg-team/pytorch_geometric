Title: IBM What is a "vacuum check" and why may the Netezza system is almost unusable when it's running? - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 What is a "vacuum check" and why may the Netezza system is almost unusable when it's running? 


During system operation, the nzvacuumcat program monitors the amount of host disk space used by system tables in each database. It performs this check every 60 seconds. If the system catalog disk space for a particular database grows over a threshold amount, the nzvacuumcat program initiates a system table vacuum on that database.While the VACUUM command is working, the system prevents any newSQL or system table activity to start. This window of time is usually about1 to 2 seconds, but can be longer if significant amounts of system catalog updates/deletes have occurred since the last VACUUM 
operation.


ANSWER
If it is taking a long time to run the catalog vacuum most likely, you need to to reindex the catalog. Normally that should be done automatically when you use nzstop/nzstart but to force it you can run the /nz/kit/bin/adm/nzvacreindex script (after shutting the system down using nzstop). In general it is advised that the catalog should be reindexed once per week anyway.

You can also modify the /nz/kit/sbin/nzvacuumcat script to run less frequently. The default is every 60 seconds, but on a really busy system and the script may need to be modified it to be every 8 hours instead of every 60 seconds (along with running a manual reindex every night). If you look at the nzvacuumcat script, you should see the lines:

my $initial_sleep = 60; # how long to wait before starting to check
my $sleep_interval = 60; # how long to wait between checks

Change the sleep_interval variable from 60 seconds to something like 3600 (1 hour) to make it run less often. Vacuuming the catalog every 60 seconds is not necessary. Although a quick glance at the script shows that someone also added a check to clean up any history database load errors in the nzvacuumcat script. So if you set it to 1 hour or 4 hours and you have an error with the history load process, it might take quite a while before it gets cleaned up.

A few things about the script: 

- Netezza background process that starts at Netezza boot time. All background processes are started by startupsvr background process

- During, Netezza boot time it invokes VACUUM command to groom system tables for faster table scans by removing deleted records and shrinking the system tables.

- When Netezza is running, it checks for database system table growth above 120 KB (checks every 60 secs) and invokes system table vacuum if it grows above 128 KB.

- VACUUM command takes exclusive locks on all system catalog tables before vacuuming the system tables.

- nzvacuumcat will shrink the database size only when Vacuum command runs successfully.

- If it is not able to acquire locks, system will write ‘Could not acquire lock for lazy vacuum’ message in pg.log and will try again after some time.updates/deletes have occurred since the last VACUUM operation