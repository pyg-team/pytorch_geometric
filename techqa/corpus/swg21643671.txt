Title: IBM B2B Sterling Integrator Web services BPs fail due to error in HTTP Respond Service caused by Export Service - United States

Text:
HTTP Respond Service TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 IBM B2B Sterling Integrator Web Service first picks up an input file for the Export service, and runs the export service. Followed by the Web Service calls a simple BP that executes HTTP Respond service and it fails with Status Report: "Remote Exception while trying to process response: error marshalling arguments; nested exception is:

java.io.NotSerializableException: com.sterlingcommerce.woodstock.security.UserToken" 

Advanced Status: "TRANSMISSION ERROR" .

This this HTTP Respond service worked fine at Gentran Integration Suite 4.3, but fails after upgrading to SI 5.2.4.1. 

SYMPTOM
High level steps to reproduce this HTTP Respond service error: 

1. Set up a simple web service that just calls a simple BP with an assign to show the HTTP Respond service is working as expected in the SOA_MessageHandler and SOA_RequestHandler BPs.

2. Change the BP for the web service so that it picks up an input file for the Export service and then runs the export service. If your export requires a security context for the passphrase, you may have some additional configuration to do to add the context. See the Export Service documentation for details.

3. Post another request to the web service. This time the HTTP Respond will fail with an error.

Advanced Status: "TRANSMISSION ERROR"

Stack trace from http.log: 

ERROR [1372268472779] error marshalling arguments; nested exception is:
java.io.NotSerializableException: com.sterlingcommerce.woodstock.security.UserToken
ERRORDTL [1372268472779]java.rmi.MarshalException: error marshalling arguments; nested exception is:
java.io.NotSerializableException: com.sterlingcommerce.woodstock.security.UserToken
at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:138)
at com.sterlingcommerce.woodstock.services.pshttp.PSHttpAdapterImpl_Stub.se ndResponse(PSHttpAdapterImpl_Stub.java:445)
at com.sterlingcommerce.woodstock.services.pshttp.HttpRespondService.processData(HttpRespondService.java:86)
at com.sterlingcommerce.woodstock.workflow.activity.engine.ActivityEngineHelper.invokeService(ActivityEngineHelper.java:1813)
at com.sterlingcommerce.woodstock.workflow.activity.engine.ActivityEngineHelper.nextMainLogic(ActivityEngineHelper.java:633)
at com.sterlingcommerce.woodstock.workflow.activity.engine.ActivityEngineHelper.next(ActivityEngineHelper.java:362)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.doWork(WorkFlowQueueListener.java:398)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.run(WorkFlowQueueListener.java:235)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.onMessage(WorkFlowQueueListener.java:196)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.onMessage(WorkFlowQueueListener.java:183)
at com.sterlingcommerce.woodstock.workflow.queue.wfTransporter.run(wfTransporter.java:444)
at com.sterlingcommerce.woodstock.workflow.queue.BasicExecutor$Worker.run(BasicExecutor.java:508)
at java.lang.Thread.run(Thread.java:736)
Caused by: java.io.NotSerializableException:
com.sterlingcommerce.woodstock.security.UserToken
at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1165)
at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1518)
at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1483)
at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1401)
at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1159)
at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:332)
at sun.rmi.server.UnicastRef.marshalValue(UnicastRef.java:274)
at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:133)
... 12 more


CAUSE
When this problem occurs, it is dependent upon the web service calling a BP that executes an Export service, followed by either the HTTP Respond Service or the Mailbox Add Service in later steps. This combination of executed services (Export service followed by the HTTP Respond Service/Mailbox services) is important when recreating this issue. 

IBM has received reports that the HTTP Respond service worked successfully with this configuration in Gentran Integration Suite 4.3, but the same setup failed after upgrading the instance to IBM B2B Sterling Integrator 5.2.4.1. 


ENVIRONMENT
This error occurred on a SUSE Linux system with Microsoft SQL Server database, but can theoretically occur in any supported environment.



DIAGNOSING THE PROBLEM
If the Export service is removed from the BP invoked by SOA_RequestHandler, there is no error thrown by the HTTP Respond service. The Export service overwrites/removes the UserToken that the BP is running under. This causes issues later in the BP for services like Http Respond Service and Mailbox Add service which require a UserToken.




RESOLVING THE PROBLEM
As a workaround, implement an asynchronous sub-invoke of a BP containing only the HTTP Respond Service using the Invoke Sub-Process Service. By creating a new workflow context in Async mode for the HTTP Respond service, a new User Token is created for that workflow context, and the HTTP Respond service behaves as expected. 

There is no permanent fix for this error due to this issue was requested to be closed before a permanent fix was created and the workaround is used as the resolution.