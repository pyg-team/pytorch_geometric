Title: IBM Why am I seeing duplicate records in my target non-condensed CCD tables? - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 The SQL Apply program received an error and terminated. The error condition was resolved, and SQL Apply was restarted. But I am seeing duplicate records in my target non-condensed CCD tables. 

SYMPTOM
Duplicate records in target non-condensed CCD tables following SQL Apply restart after an abnormal termination.


CAUSE
The Apply program updates the IBMSNAP_SUBS_SET table's SYNCHTIME and SYNCHPOINT columns with the values from the log sequence number that it last processed at the end of every cycle, and before shutting down gracefully. However, if Apply receives an error such as loss of connectivity with the control database or the table space for the control tables is unavailable, it cannot update the IBMSNAP_SUBS_SET table before shutting down. So when Apply restarts, it restarts from an older SYNCHTIME and SYNCHPOINT value, and thus, replicates data that was already replicated in the previous cycle. 

Now if the COMMIT_COUNT was set to 0, Apply would have rolled back the cycle completely and there would not have been any duplicates. But with COMMIT_COUNT set to any positive value, there is data already committed to the target tables in chunks of transactions specified in the COMMIT_COUNT. Please note that the IBMSNAP_SUBS_SET table's SYNCHTIME and SYNCHPOINT columns are updated only at the end of the Apply cycle, and not with every COMMIT_COUNT cycle. So while the data stays committed in the target table, when it restarts Apply goes by the SYNCHTIME and SYNCHPOINT values that were bookmarked in the previous cycle.

If the CCD tables are non-condensed, there is no unique index on them, hence these records get inserted into the target tables even though they are duplicates.


RESOLVING THE PROBLEM
As a workaround, please create a UNIQUE INDEX that includes the IBMSNAP_INTENTSEQ and IBMSNAP_COMMITSEQ columns on the target CCD tables, and use the SQLERRCONTINUE feature to make Apply ignore the SQL0803N errors. This method will guarantee that all records are unique and at the same time keep the CCD non-condensed.