Title: IBM Decreasing the TcpTimedWaitDelay setting in Windows to help problematic relay connectivity on relays with many sockets in TIME_WAIT state. - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 How, when, and why you might want to decrease the TcpTimedWaitDelay setting on a Windows relay. 

SYMPTOM
Too many network sockets opened in the TIME_WAIT state causing a denial of service for the relay's network connectivity capacity.


CAUSE
Downstream clients and relays making requests to the relay for which the relay cannot satisfy the request. This typically involves stale entries in the relays gatherstate.xml and bfemapfile.xml. Site entries and their directory mapping's which no longer exist in the deployment. To fix the root cause of this problem, the relay's in the deployment should be reset from bottom to top (see this article [http://www-01.ibm.com/support/docview.wss?uid=swg21668058])

DIAGNOSING THE PROBLEM
To count the number of sockets currently open in the TIME_WAIT state issue the follow command on the relay's command line:


$> netstat -aon | find /i "52311" | find "TIME_WAIT" /i /c 

If the count is more than 100 it is evident there is an issue.


RESOLVING THE PROBLEM
One way to mitigate against this problem is to decrease the value of the TcpTimedWaitDelay setting in Windows from the default of 120 seconds to 30 seconds. This will close sockets waiting for a response within 30 seconds instead of 120 seconds which should help to keep the number of sockets open in the TIME_WAIT state lower on the machine overall and free up socket resources to allow further connections to occur.

See: http://technet.microsoft.com/en-us/library/cc739819%28v=ws.10%29.aspx?ppud=4 [http://technet.microsoft.com/en-us/library/cc739819%28v=ws.10%29.aspx?ppud=4] 

 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 

 * Description:
 * 


Note: Is a restart needed? According to Microsoft: "Depending on whether the system or adapter is DHCP-configured or static override values are specified, parameters may have both DHCP and statically configured values. If any of these parameters are changed using the registry editor, a restart of the system is generally required for the change to take effect. A restart is usually not required if values are changed using the Network Connections folder." 

Note: This will not help to increase the capacity of the number of endpoints allowed to connect to a relay (which is 1000). If more capacity is needed, it is recommended that more relays be provisioned and clients assigned to those additional relays. 

Note: The change in this setting helps to improve efficiency in closing sockets that have not received a response in a while, however there could be negative consequences in reducing this setting for clients attempting to connect to the relay over high latency network connections. Please analyze and test to see if the setting is change is something that should stay.