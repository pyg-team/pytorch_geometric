Title: IBM Newly registered users cannot log in immediately, but can log in after some period of time. - United States

Text:
vmm; search; cache; login; log in; new user TECHNOTE (TROUBLESHOOTING)

PROBLEM
Newly registered users cannot log in immediately, but can log in after some period of time.

CAUSE
When WebSphere Portal authenticates users with a federated repository, Virtual Member Manager's (VMM) search cache may prevent users from logging in immediately after they register. This technote generically refers to actions taken to add a user to the user repository as registering.

DIAGNOSING THE PROBLEM
Evaluate the use case. Collect the documentation specified in the Collecting Data: Login document appropriate for your version. This problem occurs when: 

1. A federated repository [http://www-01.ibm.com/support/docview.wss?uid=swg21386736] is configured. 

2. A user visits the WebSphere Portal site for the first time. 

3. This user thinks he has already registered with this site, but in actuality, he has not. He attempts to log in with a user ID, for example: user1. 

4. VMM searches for user1 in the LDAP, does not find it, and populates its search cache.
ServiceProvid > com.ibm.websphere.wim.ServiceProvider WIM_API login ENTRY ...
<wim:principalName>user1</wim:principalName> ...
LdapConnectio > com.ibm.ws.wim.adapter.ldap.LdapConnection searchEntities ENTRY dc=ibm,dc=com (...uid=user1...) ...
LdapConnectio > com.ibm.ws.wim.adapter.ldap.LdapConnection JNDI_CALL search(...
LdapConnectio < com.ibm.ws.wim.adapter.ldap.LdapConnection searchEntities RETURN [] 

5. User registers to the site with this same user ID, user1. 

6. user1 attempts to log in. 

7. VMM searches for user1, hits its search cache from (4), and denies the authentication request. 

ServiceProvid > com.ibm.websphere.wim.ServiceProvider WIM_API login ENTRY ...
<wim:principalName>user1</wim:principalName> ...
LdapConnectio > com.ibm.ws.wim.adapter.ldap.LdapConnection searchEntities ENTRY dc=ibm,dc=com (...uid=user1...) ...
LdapConnectio 3 com.ibm.ws.wim.adapter.ldap.LdapConnection checkSearchCache Hit cache: ...
LdapConnectio < com.ibm.ws.wim.adapter.ldap.LdapConnection searchEntities RETURN [] ...
exception 1 com.ibm.ws.wim.ProfileManager loginImpl CWWIM4537E No principal is found from the 'user1' principal name. ...
LTPAServerObj E SECJ0369E: Authentication failed when using LTPA. The exception is CWWIM4537E No principal is found from the 'user1' principal name 

8. After 10 minutes (default), VMM times out its search cache entry from (4). 

9. user1 attempts to log in again. 

10. VMM finds user1 in the LDAP and authenticates the user as expected.
ServiceProvid > com.ibm.websphere.wim.ServiceProvider WIM_API login ENTRY ...
<wim:principalName>user1</wim:principalName> ...
LdapConnectio > com.ibm.ws.wim.adapter.ldap.LdapConnection searchEntities ENTRY dc=ibm,dc=com (...uid=user1...) ...
LdapConnectio > com.ibm.ws.wim.adapter.ldap.LdapConnection JNDI_CALL search(...
LdapConnectio < com.ibm.ws.wim.adapter.ldap.LdapConnection searchEntities RETURN [...uid=user1...]


RESOLVING THE PROBLEM
Configure the VMM search results cache to meet your requirements and notify new users accordingly. 

If your require new users to log in immediately regardless of previous failed login attempts, you should disable VMM's search cache. Understand that this could affect performance. 

If your requirements favor performance and allow for some delay in account activation, then you could set VMM's search cache timeout to 60 seconds, for example. In your custom registration portlet, you could then display a message saying that it may take up to one minute for new accounts to activate. 

You may configure VMM's search cache [http://pic.dhe.ibm.com/infocenter/wasinfo/v7r0/index.jsp?topic=%2Fcom.ibm.websphere.nd.multiplatform.doc%2Finfo%2Fae%2Fae%2Fuwim_ldapperfsettings.html] with the WebSphere Application Server (WAS) Integrated Solutions Console (ISC): 

Global security > Federated repositories > [LDAP identifier] > Performance > Caches > Cache the search results 

For example, this will update the following stanza in VMM's configuration file, <profile>/config/cells/<cell name>/wim/config/wimconfig.xml from: 

<config:cacheConfiguration>
...
<config:searchResultsCache cacheSize="2000" cacheTimeOut="600"enabled="true" searchResultSizeLimit="1000"/>
</config:cacheConfiguration>

to: 

<config:cacheConfiguration>
...
<config:searchResultsCache cacheSize="2000" cacheTimeOut="60"enabled="true" searchResultSizeLimit="1000"/>
</config:cacheConfiguration>

RELATED INFORMATION
 WAS InfoCenter [http://pic.dhe.ibm.com/infocenter/wasinfo/v7r0/index.jsp?topic=%2Fcom.ibm.websphere.nd.multiplatform.doc%2Finfo%2Fae%2Fae%2Fuwim_ldapperfsettings.html]
WebSphere Portal - Collecting Data [http://www-01.ibm.com/support/docview.wss?uid=swg21591590]