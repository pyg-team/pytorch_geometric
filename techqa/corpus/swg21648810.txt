Title: IBM "Standard error 5 ... Client found response... 500 - Internal server error ... ORA-12704: character set mismatch" when running Ad Hoc reports - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 User runs an Ad Hoc report. User receives an error message. 

SYMPTOM
The screen message varies depending on what the operating system of the Controller application server is: 

Windows 2008 Screen:
[/support/docview.wss?uid=swg21648810&aid=1] [/support/docview.wss?uid=swg21648810&aid=1]
Standard Error
Number: 5
Source: FrangoDirect.ReportAdHocD....
Description: Client found response content type of 'text/html', but expected 'text/xml'.
The request failed with the error message:
<...>
<title>500 - Internal server error.</title>
<...>


Windows 2003 Screen:
[/support/docview.wss?uid=swg21648810&aid=2] [/support/docview.wss?uid=swg21648810&aid=2]
COMException (0x80004005): ORA-12704: character set mismatch


Event Viewer (Application Log):
The VB Application identified by the event source logged this Application FrReportB: Thread ID: 2912 ,Logged: Error occured at 2013-09-03 09:03:10 in FrReportB, Error No=-2147467259, Source=FrReportB.ReportAdHoc.AdHoc, Description=ORA-12704: character set mismatch, HelpFile= HelpContext=0 , 

CAUSE
Controller application repository database (the main financial database, not the Content Store database) has incorrect/incompatible Oracle character set. 

 * For more information, see IR COGCQ00830186.


More Information: 
In one real-life customer, their database was based on:  * NLS_CHARACTERSET: WE8ISO8859P1 
 * NLS_NCHAR_CHARACTERSET: UTF8 


This worked OK when they were using Controller 8.5.1, but when they upgraded to Controller 10.1.1 they received this error. 

Controller only supports a non-unicode character set for its application repository.  * This is different from the 'ContentStore' (report server) database which must be Unicode.

Specifically, IBM has always recommended the use of the following character set:  * NLS_CHARACTERSET = WE8MSWIN1252. 

This problem is caused by temporary tables in Oracle. Modern version of Controller (e.g. 10.1.1 FP2) use Oracle temporary tables in a different way from older versions of Controller (e.g. 8.x).  * This means that functions that may have worked OK in previous versions of Controller (despite using an unsupported database character set) will now no longer work in later versions of Controller.

ENVIRONMENT
Controller database hosted on Oracle.



DIAGNOSING THE PROBLEM
Use the following script to find the character set values of the relevant Oracle database: 

 
Connect system/<password>@<database_name> AS SYSDBA
select * from nls_database_parameters; 

For full details, see separate IBM Technote #1347750.


RESOLVING THE PROBLEM
Move the Controller schema to an Oracle database that is based on the correct/supported Oracle characterset: 

 * NLS_CHARACTERSET: WE8MSWIN1252 
 * NLS_NCHAR_CHARACTERSET (National Character Set): AL16UTF16



Afterwards, you must also delete the existing unsupported (e.g. UTF8) encoded temporary tables (currently in the database).  * This will delete all temp tables that were created using incorrect (e.g. UTF8) character set. The new temp tables will be created when they are needed during the regular processes. But this time they will be created using the correct (WE8MSWIN1252) character set.

Steps:
1. Create a new Oracle database using the 'supported' character set: 

 * NLS_CHARACTERSET: WE8MSWIN1252 
 * NLS_NCHAR_CHARACTERSET (National Character Set): AL16UTF16

TIP: For more information, see separate IBM Technote #1347750. 

2. Export the Controller schema from the 'bad' database to a DMP file, for example by using EXPDP 
3. Import the Controller schema into the 'good' database from that DMP file, for example by using IMPDP  * For more information on steps 2 & 3, see separate IBM Technote #1347756.


4. Launch Controller, and logon as an administrative user (e.g. ADM) 
5. Click "Maintain - Configuration - General" 
6. Click on section "Server Preferences" 
7. Create a new entry with the following properties: ORA_DYNAMIC_TEMP OPTIMIZE  * 


8. Click Save 
9. Close Controller 
10. Ensure that no users are on the system (downtime) 
11. Re-launch Controller and logon as an administrative user (e.g. ADM) 
12. Click "Maintain - Users - Single Mode" 
13. Click "Maintain - Database - Optimize" 
14. Tick/enable all available options 
15. Click "Run" 
16. After this has finished, remove the server preference (delete the " ORA_DYNAMIC_TEMP OPTIMIZE" reference).  * In general you should not have this server preference in place long term. 
 * If using Controller 10.1.1 FP2 (or similar versions) then you may need to manually delete/recreate some tables now. See IBM Technote #1649214 for full details.

17. Test. 

If the problem remains, then perform the following: 
18. Obtain a short period of downtime (no users on the system) 
19. Launch an Oracle SQL tool, such as "Oracle SQL Developer" 
20. Connect to the Controller database. IMPORTANT: Logon to the Oracle database using the same schema (user) that is used by Controller. 
21. Run the following script: 

DROP TABLE GRADH$ADHOC$2KOLDATA; 
create global temporary table GRADH$ADHOC$2KOLDATA on commit preserve rows as SELECT * FROM GRADH_ADHOC_2KOLDATA; 
DROP TABLE GRADH$ADHOC$BAKT; 
create global temporary table GRADH$ADHOC$BAKT on commit preserve rows as SELECT * FROM GRADH_ADHOC_BAKT; 

22. Test. 
RELATED INFORMATION
#1634513 - Several menu items such as 'Controller Link' [http://www.ibm.com/support/docview.wss?uid=swg21634513]
1347756 - Exporting and Importing a Controller 8.x sche [http://www.ibm.com/support/docview.wss?uid=swg21347756]
1347750 - How to check the Oracle database character se [http://www.ibm.com/support/docview.wss?uid=swg21347750]
1649214 - "No company is available in the popup list" w [http://www.ibm.com/support/docview.wss?uid=swg21649214]