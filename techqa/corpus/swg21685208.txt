Title: IBM PureData Systems for Analytics - N2001 reported ethsw1 and ethsw2 as unreachable how do I correct this? - United States

Text:
unreachable spa1.ethsw1 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 nzhw -issues

Description HW ID Location Role State

----------- ----- ----------- ------ -----------

EthSw 1005 spa1.ethsw1 Active Unreachable

EthSw 1006 spa1.ethsw2 Active Unreachable 

SYMPTOM
nzhw -issues and sysmgr log are reporting issues with the ethsw1 (gigsw01a) and ethsw2 (gigsw01b)

example:
nzhw -issues
Description HW ID Location Role State
----------- ----- ----------- ------ -----------
EthSw 1005 spa1.ethsw1 Active Unreachable
EthSw 1006 spa1.ethsw2 Active Unreachable

17:07:35.684928 ICT Info: NZ-01524: the state of ethsw [ethsw hwid=1005 sn="Y011CM37D046" SPA=1 Parent=1003 Position=1] changed from 'ok' to 'unreachable'


CAUSE
The switches are unreachable only from the management side. They are still functional and the NPS will still be active. What happens is the IP stack is hung for the management connection. 

When the AMM in bay 2 is active, the management link to the eth switches at times does not work so they report unreachable. The link in the article suggests that it can happen while the AMM in bay 1 is in bay one as well, but most commonly when the AMM in bay two is the active MM. The issue is a bug in the BNT firmware where the secondary management port on the switches doesn't work so in essence, every time the AMMs in bay 2 are primary, there is no mgmt link to those switches. Related retain time: http://eclient.lenexa.ibm.com:9082/search/?fetch=source/PMR/20701,004,000 O13/11/08 [http://eclient.lenexa.ibm.com:9082/search/?fetch=source/PMR/20701,004,000%20O13/11/08] 
This issue is addressed in higher Firmware levels of FDT. 
I find this issue in FDT 3.0.5.2. 


ENVIRONMENT
N2000 series of appliance. Not for N1001 series of appliances.



DIAGNOSING THE PROBLEM
Steps performed to identify the issue:

nzhw -issue
cat /opt/nz/fdt/version.txt 

 

system> list -l 2
system
blade[1] SN#Y010BG3AT02X
blade[3] SN#Y090BG388F0D
blade[5] SN#Y090BG37HF18
blade[7] SN#Y010BG3AT00K
blade[9] SN#Y090BG38FF05
blade[11] SN#Y090BG388F03
blade[13] SN#Y010BG39902H
blower[1]
blower[2]
power[1]
power[2]
power[3]
power[4]
mm[1] standby
mm[2] primary <-----AMM 
in Bay 2 is primary 
ssh mm001 health -l all - to identify if other issues exist 
grep -i HWID(from output of nzhw -isues) /nz/kit/log/sysmrg/sysmrg.log - to review further. 


ping gigsw01a and gigsw01b - to see if they are ping-able - or the appropriate gigswitch
ssh root@spu0101 - login to the SPU (login to the appropriate SPU. Mine is just a example)
cat /proc/net/bonding/bond0 - check to see if links are up for the bond. If they are not up then need to diagnose this as the issue not a hung switch issue.
Example: 
Slave Interface: eth0
MII Status: up
Link Failure Count: 1
Permanent HW addr: 00:0a:f7:1b:24:a0

Slave Interface: eth1
MII Status: up
Link Failure Count: 0
Permanent HW addr: 00:0a:f7:1b: 

in this case both associated interfaces are up and active.

crm_mon -1 - identify which host is the active host HA1 or HA2 and take note of it.








RESOLVING THE PROBLEM
To resolve this issue if all Hardware tests suggested show clean and AMM in bay 2 is the active AMM then we can fail over the Management Module (MM or AMM) to bring MM1 as the active to clear the condition. 

 

ssh mm001 reset -T mm[2] - to clear the issue. 

If this does not clear the issue you can also try the following. 

To reset the two ethswitches (gigsw0Xa and gigsw0Xb to clear the hung condition. 
1.) crm_mon -1 - to see which side of the cluster is active HA1 or HA2.
2.) ssh mm001 health -l all - This will list out the components and you can identify the two switches that need to be reset
3) ssh mm001 power -cycle -T switch[X] - reset the standby switch 1st.
4) wait 1 minute ssh mm001 power -cycle -T switch[X] - the other switch.

After a few minutes review nzhw -issues. The alert should have cleared.
This will not cause a outage of the NPS. It is safe to request a outage window to perform this activity though.