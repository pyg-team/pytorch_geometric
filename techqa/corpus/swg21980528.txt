Title: IBM Security Host Protection agents are Offline after using SiteProtector Certificate Management Tool - United States

Text:
offline; proventia; psw; windows TECHNOTE (FAQ)

QUESTION
 Why are the Host Protection agents in Offline status after replacing the SiteProtector default certificate? 

CAUSE
When using the SiteProtector Certificate Management Tool to replace SiteProtector default certificate, the Agent Manager PEM file (\Program Files\ISS\SiteProtector\Agent Manager\certificates) that is used to communicate with host products (RSDP 7.0 and earlier, Proventia Server for Windows, Proventia Server Linux, Proventia Desktop) is not updated.

The SiteProtector Certificate Management Tool only updates the KDB files containing the certificate used by GX, XGS, Proventia M, Enterprise Scanner; it does not update the PEM file used by host based agents.

ANSWER
The communication between the agents and SiteProtector will be interrupted unless the trust level is set to trust-all when registering. 


For instructions to change the configuration to trust-all for IBM Security Network Protection (XGS) see documentation IBM Knowledge Center - Configuring SiteProtector Management Settings. [https://www.ibm.com/support/knowledgecenter/SSHLHV_5.3.0/com.ibm.alps.doc/tasks/alps_sp_configuring_site_protector_settings.htm]

For instructions to change the configuration to trust-all for IBM Network IPS (GX) see documentation IBM Knowledge Center - Configuring SiteProtector Management in the Network IPS Local Management Interface [http://www.ibm.com/support/knowledgecenter/SSB2MG_4.6.1/com.ibm.ips.doc/tasks/configuringsiteprotectormanagementinproventiamanager.htm].

Alternatively, the following workaround can be applied:


 1.  Stop the issDaemon service on the Agent Manager.
     
     
 2.  Copy the following file from the Agent Manager system onto your Application Server one:
     
     \Program Files\ISS\SiteProtector\Agent Manager\server.*
     
     
 3.  On the Application Server server, open the Command Prompt as administrator and issue the following command:
     
     \Program Files\ISS\SiteProtector\Application Server\webserver\IHS\bin\gskcapicmd.bat" -cert -export -stashed -db "\ProgramFiles\ISS\Site Protector\Agent Manager\server.kdb" -label siteprotectorkeys-rsa -target-type p12 -target AM.p12
     
     
 4.  Enter a password for the destination file. This will generate an encrypted P12 file containing the certificate and private key of the Agent Manager.
     
     
 5.  Extract the Agent Manager certificate and encrypted private key from that P12 file using the following openssl command:
     
     openssl pkcs12 -info -in AM.p12
     
     This will ask you to enter the previously created password and to choose another password to display the information.
     
     
 6.  Use the information displayed by OpenSSL to create a new file that looks like this:
     
     -----BEGIN CERTIFICATE-----
     ...
     -----END CERTIFICATE-----
     
     -----BEGIN ENCRYPTED PRIVATE KEY-----
     ...
     -----END ENCRYPTED PRIVATE KEY-----
     
     Note: The return carriage must be present.
     
     
 7.  Rename that file to server.pem and copy it on the Agent Manager system in \Program Files\ISS\SiteProtector\Agent Manager.
     
     
 8.  Create a file called certYYYY_MM_DD_HH_MM.pem and paste the content of the public key extracted before inside of it. It should look like this:
     
     -----BEGIN CERTIFICATE-----
     ...
     -----END CERTIFICATE-----
     
     Note: The return carriage must be present.
     
     
 9.  If you already have your CA public key jump to step 12, otherwise in the Command Prompt issue the following command:
     
     \Program Files\ISS\SiteProtector\Application Server\webserver\IHS\bin\gskcapicmd.bat" -cert -list all -stashed -db "Program Files\ISS\SiteProtector\Application Server\webserver\IHS\server.kdb"
     
     This will list all the trusted CA's that are trusted by SiteProtector, find the name of the label that matches your CA.
     
     
 10. Use the label found using the command issued in Step 9 to issue the following command:
     
     ProgramFiles\ISS\SiteProtector\Application Server\webserver\IHS\bin\gskcapicmd.bat" -cert -export -stashed -db "Program Files\ISS\SiteProtector\Application Server\webserver\IHS\server.kdb" -label LABELFOUNDINSTEP9 -target-type p12 -target CA.p12
     
     You will be asked to enter a password to protect the file, this will export the private and public key from your CA from the KDB and store them in a file called CA.P12.
     
     
 11. Extract the CA certificate from that P12 file using the following openssl command:
     
     openssl pkcs12 -info -in CA.p12
     
     This will ask you to enter the previously created password and to choose another password to display the information.
     
     
 12. Create a file called cacert.pem using the information from CA.p12 that looks like the example below, and transfer it to the Host Protection Agent system:
     
     -----BEGIN CERTIFICATE-----
     ...
     -----END CERTIFICATE-----
     
     Note: The carriage return must be present.
     
     
 13. Start the issDaemon service on the Agent Manager system.
     
     
 14. Stop the BlackICE service on the Windows Host Protection agent.
     
     
 15. Place the newly file created at step 8 in this directory:
     
     \Program Files (x86)\IBM\Host Protection\cacerts\cacert.pem
     
     
 16. Edit the 2 lines regarding caCertFile & caCertPath in LocalProperties.xml located under \Program Files (x86)\IBM\Host Protection\LocalProperties.xml to look like this:
     
     <param name="caCertFile" value="./cacerts/cacert.pem" xmlns="http://www.iss.net/cml/common"/>
     <param name="caCertPath" value="./cacerts" xmlns="http://www.iss.net/cml/common"/>
     
     
 17. Start the BlackICE service on the Host Protection agent system.





[/support/docview.wss?uid=swg21980528&aid=1] [https://ibm.biz/BdHdjw] [/support/docview.wss?uid=swg21980528&aid=2] [http://ibm.biz/InfraSecForumTechnote] [/support/docview.wss?uid=swg21980528&aid=3] [http://ibm.biz/SecSuptUTube] [/support/docview.wss?uid=swg21980528&aid=4] [http://ibm.biz/InfraSecFixes] [/support/docview.wss?uid=swg21980528&aid=5] [http://ibm.biz/FlexLicLogin] [/support/docview.wss?uid=swg21980528&aid=6] [http://ibm.biz/MyNotification] [/support/docview.wss?uid=swg21980528&aid=7] [http://ibm.biz/ContactSecSupport]  


Cross reference information Segment Product Component Platform Version Edition Security IBM Security Host Protection General Information Linux, Windows Version Independent