Title: IBM When using IBM Business Process Manager (BPM) with Microsoft SQLServer, deadlocks can occur if process applications, toolkits, and tracks are created concurrently - United States

Text:
ibpms80relnotes; ibpme80relnotes; ibpma80relnotes; SQL; create process application; create tracks; create toolkits; deadlock; rollback; FFDC TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 If two or more users create a new process application, toolkit, or track at nearly the same time, some of these operations can fail with a stack trace that indicates a deadlock. When the operation fails, the underlying Microsoft SQL Server database transaction is fully rolled back and the user receives a database error message. 

CAUSE
 This problem is caused by lock contention in the LSW_BRANCH table. 

DIAGNOSING THE PROBLEM
Examine the server log files for one or more messages that indicate the creation of locks for new branches within a short time period. The following example shows nearly simultaneous actions: 

 
[3/6/12 23:05:52:664 PST] 0000009a wle_versionin W CWLLG0541W: Current version lock for branch Branch.747a0aa4-8dd7-4998-bedc-9b43d8f412c0 missing. Creating now.

[3/6/12 23:05:52:664 PST] 00000099 wle_versionin W CWLLG0541W: Current version lock for branch Branch.fdd457d7-f658-4edb-83de-e77710ecafde missing. Creating now.

In this case, the log messages indicate the activity takes place in exactly the same millisecond. In a clustered environment, these messages might exist in the logs for different cluster members. 


These messages are followed by FFDC entries and an exception indicating that a rollback took place: 
[3/6/12 23:05:54:316 PST] 0000009a FfdcProvider W com.ibm.ws.ffdc.impl.FfdcProvider logIncident FFDC1003I: FFDC Incident emitted on D:\w80\profiles\Custom02\logs\ffdc\AppTarget1_69c2cd5_12.03.06_23.05.54.3066840469416664456767.txt com.ibm.ws.rsadapter.jdbc.WSJdbcResultSet.next 2624

[3/6/12 23:05:54:327 PST] 0000009a XmlBeanDefini I org.springframework.beans.factory.xml.XmlBeanDefinitionReader loadBeanDefinitions Loading XML bean definitions from class path resource [org/springframework/jdbc/support/sql-error-codes.xml]

[3/6/12 23:05:54:361 PST] 0000009a SQLErrorCodes I org.springframework.jdbc.support.SQLErrorCodesFactory <init> SQLErrorCodes loaded: [DB2, Derby, H2, HSQL, Informix, MS-SQL, MySQL, Oracle, PostgreSQL, Sybase]

[3/6/12 23:05:54:417 PST] 0000009a FfdcProvider W com.ibm.ws.ffdc.impl.FfdcProvider logIncident FFDC1003I: FFDC Incident emitted on D:\w80\profiles\Custom02\logs\ffdc\AppTarget1_69c2cd5_12.03.06_23.05.54.3787554262088311358106.txt com.ibm.ws.uow.UOWManagerImpl.runUnderNewUOW 934

[3/6/12 23:05:54:430 PST] 0000009a FfdcProvider W com.ibm.ws.ffdc.impl.FfdcProvider logIncident FFDC1003I: FFDC Incident emitted on D:\w80\profiles\Custom02\logs\ffdc\AppTarget1_69c2cd5_12.03.06_23.05.54.426579347892757093495.txt com.ibm.ws.rsadapter.spi.WSRdbXaResourceImpl.rollback 524
[3/6/12 23:05:54:430 PST] 0000009a WSRdbXaResour E DSRA0304E: XAException occurred. XAException contents and details are: The cause is : null.

[3/6/12 23:05:54:430 PST] 0000009a WSRdbXaResour E DSRA0302E: XAException occurred. Error code is: XAER_NOTA (-4). Exception is: The function ROLLBACK: has failed. The status is: -4. Error: "*** SQLJDBC_XA DTC_ERROR Context: xa_rollback, state=1, StatusCode:-4 (0xFFFFFFFC) ***"

[3/6/12 23:05:54:459 PST] 0000009a FfdcProvider W com.ibm.ws.ffdc.impl.FfdcProvider logIncident FFDC1003I: FFDC Incident emitted on D:\w80\profiles\Custom02\logs\ffdc\AppTarget1_69c2cd5_12.03.06_23.05.54.4338471318704244961051.txt com.ibm.ejs.j2c.XATransactionWrapper.rollback 755

[3/6/12 23:05:54:460 PST] 0000009a XATransaction E J2CA0027E: An exception occurred while invoking rollback on an XA Resource Adapter from DataSource jdbc/TeamWorksDB, within transaction ID {XidImpl: formatId(57415344), gtrid_length(36), bqual_length(54),
data(00000135ebfa6d36000000012fd613aca54b9025887fe237d01b00a00dd4352e8302c96300000135ebfa6d36000000012fd613aca54b9025887fe237d01b00a00dd4352e8302c963000000010000000000000000000000000001)} : javax.transaction.xa.XAException: The function ROLLBACK: has failed. The status is: -4. Error: "*** SQLJDBC_XA DTC_ERROR Context: xa_rollback, state=1, StatusCode:-4 (0xFFFFFFFC) ***"
at com.microsoft.sqlserver.jdbc.SQLServerXAResource.DTC_XA_Interface(SQLServerXAResource.java:545)
at com.microsoft.sqlserver.jdbc.SQLServerXAResource.rollback(SQLServerXAResource.java:713)
at com.ibm.ws.rsadapter.spi.WSRdbXaResourceImpl.rollback(WSRdbXaResourceImpl.java:1336)
at com.ibm.ejs.j2c.XATransactionWrapper.rollback(XATransactionWrapper.java:1315)
at com.ibm.tx.jta.impl.JTAXAResourceImpl.rollback(JTAXAResourceImpl.java:365)


An FFDC stack like this stack indicates the thread that is experiencing the deadlock: 
[3/6/12 23:05:54:307 PST] FFDC Exception:com.microsoft.sqlserver.jdbc.SQLServerException SourceId:com.ibm.ws.rsadapter.jdbc.WSJdbcResultSet.next ProbeId:2624 Reporter:com.ibm.ws.rsadapter.jdbc.WSJdbcResultSet@72f6786
com.microsoft.sqlserver.jdbc.SQLServerException: Transaction (Process ID 76) was deadlocked on lock resources with another process and has been chosen as the deadlock victim. Rerun the transaction.
at com.microsoft.sqlserver.jdbc.SQLServerException.makeFromDatabaseError(SQLServerException.java:196)
at com.microsoft.sqlserver.jdbc.TDSTokenHandler.onEOF(tdsparser.java:246)
at com.microsoft.sqlserver.jdbc.SQLServerResultSet$FetchBuffer$FetchBufferTokenHandler.onEOF(SQLServerResultSet.java:4630)
at com.microsoft.sqlserver.jdbc.TDSParser.parse(tdsparser.java:83)
at com.microsoft.sqlserver.jdbc.SQLServerResultSet$FetchBuffer.nextRow(SQLServerResultSet.java:4696)
at com.microsoft.sqlserver.jdbc.SQLServerResultSet.fetchBufferNext(SQLServerResultSet.java:1683)
at com.microsoft.sqlserver.jdbc.SQLServerResultSet.next(SQLServerResultSet.java:956)
at com.ibm.ws.rsadapter.jdbc.WSJdbcResultSet.next(WSJdbcResultSet.java:3120)
at org.springframework.jdbc.core.RowMapperResultSetExtractor.extractData(RowMapperResultSetExtractor.java:91)
at org.springframework.jdbc.core.JdbcTemplate$1.doInPreparedStatement(JdbcTemplate.java:653)
at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:591)
at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:641)
at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:670)
at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:678)
at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:710)
at org.springframework.jdbc.core.simple.SimpleJdbcTemplate.query(SimpleJdbcTemplate.java:187)
at com.lombardisoftware.server.ejb.persistence.dao.UnversionedPODAO.findOrdered(UnversionedPODAO.java:227)
at com.lombardisoftware.server.ejb.persistence.dao.UnversionedPODAO.findOrdered(UnversionedPODAO.java:198)
at com.lombardisoftware.server.ejb.persistence.dao.UnversionedPODAO.find(UnversionedPODAO.java:194)
at com.lombardisoftware.server.ejb.persistence.dao.BranchDAO.findByFilter(BranchDAO.java:72)
at com.lombardisoftware.server.ejb.persistence.DefaultHandler.findByFilter(DefaultHandler.java:154)
at com.lombardisoftware.server.ejb.persistence.PersistenceServicesCore$5.call(PersistenceServicesCore.java:170)
at com.lombardisoftware.server.ejb.persistence.PersistenceServicesCore$5.call(PersistenceServicesCore.java:168)
at com.lombardisoftware.server.ejb.persistence.versioning.BranchManager.readAccess(BranchManager.java:143)
at com.lombardisoftware.server.ejb.persistence.PersistenceServicesCore.findByFilter(PersistenceServicesCore.java:168)
at sun.reflect.GeneratedMethodAccessor31.invoke(Unknown Source)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:37)
at java.lang.reflect.Method.invoke(Method.java:611)
at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:310)
at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:182)
at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:149)
at com.lombardisoftware.utility.spring.TransactionInterceptor$1.call(TransactionInterceptor.java:52)
at com.lombardisoftware.utility.spring.ProgrammaticTransactionSupport.executeInExistingTransaction(ProgrammaticTransactionSupport.java:457)
at com.lombardisoftware.utility.spring.ProgrammaticTransactionSupport.execute(ProgrammaticTransactionSupport.java:224)
at com.lombardisoftware.utility.spring.TransactionInterceptor.invoke(TransactionInterceptor.java:50)
at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:171)
at com.lombardisoftware.utility.spring.CoreEntryInterceptor.invoke(CoreEntryInterceptor.java:44)
at com.lombardisoftware.utility.spring.PSCoreEntryInterceptor.invoke(PSCoreEntryInterceptor.java:14)
at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:171)
at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:204)
at $Proxy31.findByFilter(Unknown Source)
at com.lombardisoftware.client.delegate.PersistenceServicesDelegateDefault.findByFilter(PersistenceServicesDelegateDefault.java:218)
at com.lombardisoftware.client.persistence.BranchFactory.findByProject(BranchFactory.java:77)
at com.lombardisoftware.server.core.validator.BranchServerSideValidator.validate(BranchServerSideValidator.java:55)


RESOLVING THE PROBLEM
Retry the operation that failed. 

 



Cross reference information Segment Product Component Platform Version Edition Business Integration IBM Business Process Manager Express Databases Linux, Windows 8.0.1.2, 8.0.1.1, 8.0.1, 8.0, 7.5.1.2, 7.5.1.1, 7.5.1 Business Integration IBM Business Process Manager Standard Databases AIX, Linux, Solaris, Windows 8.0.1.2, 8.0.1.1, 8.0.1, 8.0, 7.5.1.2, 7.5.1.1, 7.5.1