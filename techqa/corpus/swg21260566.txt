Title: IBM How Do I Configure OnDemand to Use a Loopback Connection with DB2 on AIX - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 I am receiving the following error message in my db2diag.log:

2007-05-09-15.09.02.800722-240 I30113C516 LEVEL: Severe (OS)
PID : 360580 TID : 258 PROC : arssockd
INSTANCE: archive NODE : 000
FUNCTION: DB2 UDB, SQO Memory Management, sqlocshr2, probe:200
CALLED : OS, -, shmat
OSERR : EMFILE (24) "The process file table is full."
DATA #1 : Memory set handle, PD_TYPE_OSS_MEM_SET_HDL, 20 bytes
0x301D8940 : FFFF FFFF FFFF FFFF 0000 0000 1410 003C ...............<
0x301D8950 : 0004 0000 .... 

CAUSE
The db2diag.log error shown in the Question section is an operating system error and indicates a 32-bit limitation. DB2® is attempting to create a new shared memory segment, but the operating system is returning the error EMFILE(24) because the maximum number of shared memory segments allowed for the process has been reached.

By default, AIX® does not allow 32-bit applications to attach to more than 11 shared memory segments per process, of which a maximum of 10 can be used for local DB2 connections. Because your IBM® Content Manager OnDemand library server and DB2 database must be local, using DB2 Call Level Interface (CLI), OnDemand makes a local connection to DB2 using shared memory. DB2 CLI makes the local connection to the database, causing AIX to report an error.

ANSWER
There are three possible solutions: 

 * Enable Extended Shared Memory. This solution is not recommended for large systems as it might result in performance degradation (see the Related Information section). To implement this solution, perform the following steps:  1. Set the AIX environment variable EXTSHM=ON, under your DB2 instance owner and also under your OnDemand instance owner. The OnDemand instance owner should be the Unix account that starts the OnDemand server and can be found in /usr/lpp/ars/config/ars.ini under SRVR_INSTANCE_OWNER. 
    2. Set the DB2 registry variable under your OnDemand DB2 instance,
       db2set DB2ENVLIST=EXTSHM 
    3. Restart DB2 and OnDemand.
   
   
 * Migrate your DB2 instance to 64 bit and upgrade OnDemand to v8.4 or later. In v8.4, OnDemand is now a 64 bit application. 
 * Configure DB2 to use a TCP/IP loopback connection for your OnDemand database. See the information below to implement this solution.


The following steps outline how to configure OnDemand and DB2 to use a loopback connection:  1.  Stop OnDemand. 
 2.  Check your current DB2 communication protocols for your OnDemand DB2 instance: 
     
     db2set DB2COMM
     
     
 3.  Set your DB2 instance communication protocol to TCPIP:
     
     db2set DB2COMM=existing_protocol_names,TCPIP
     
     
 4.  Determine which TCP/IP port number your instance is listening on for incoming requests.  1. To verify the port number or service name that the instance is listening on for incoming requests, use the following command: 
         
         db2 get dbm cfg | grep SVCENAME
         
         Example output:
         TCP/IP Service name (SVCENAME) = db2cdb2inst1
         
         Note: If no value is set, follow these two instructions.  1. Find the connection port used for your OnDemand DB2 instance in your /etc/services file:
             
             grep db2.*tcp /etc/services
             
             Example output:
             db2cdb2inst1 50000/tcp # Connection port for DB2 instance archive
             
          2. Update the SVCENAME database manager configuration parameter to the connection service name as defined in /etc/services file if no value was previously set:
             
             db2 update dbm cfg using svcename service_name
             
             Example:
             db2 update dbm cfg using svcename db2cdb2inst1
             
         
         
     
     
 5.  Catalog the loopback node using the following command:
     
     db2 catalog tcpip node new_nameremote hostname_or_ipserver service_name
     
     Example:
     db2 catalog tcpip node LOOPNODE remote 127.0.0.1 server db2cdb2inst1
     
     
 6.  Catalog the loopback database. The following steps assume that ARCHIVE is the value of SRVR_INSTANCE from /usr/lpp/ars/config/ars.ini and /arsdb is the value of ARS_DB2_DATABASE_PATH from /usr/lpp/ars/config/ars.cfg:
     
     db2 catalog db ARCHIVE as ARCHLOOP on /arsdb
     
     
 7.  Uncatalog the original OnDemand database:
     
     db2 uncatalog db ARCHIVE
     
     
 8.  Catalog the loopback database to the loopback node created in step 5 and catalog a database alias with the original OnDemand database name:
     
     db2 catalog db database_nameas loop_back_db_aliasat node loop_back_node_from_step_5
     
     Example:
     db2 catalog db ARCHLOOP as ARCHIVE at node LOOPNODE
     
     
 9.  Update the AUTHENTICATION database manager configuration parameter to CLIENT. The OnDemand library server must be local to the database. OnDemand does not have a method to pass both the user ID and password to connect to the local DB2 database. The change of the database manager authentication from the default of SERVER to CLIENT specifies that authentication occurs on the database partition where OnDemand is invoked using operating system security. This change allows OnDemand to continue to connect as the OnDemand instance owner without having to explicitly supply a password when connecting to DB2. 
     
     db2 update dbm cfg using AUTHENTICATION CLIENT
     
     
 10. Restart your DB2 instance to reflect the changes. 
 11. Start OnDemand. 
 12. Confirm that OnDemand is using the DB2 connection port now from your /etc/services file in step 4:
     
     netstat -an | grep port_number
     
     Example:
     netstat -an | grep 50000

RELATED INFORMATION
 Using EXTSHM with DB2 on AIX may cause performance degr [http://www.ibm.com/support/docview.wss?rs=0&uid=swg21191295]
DB2 Authentication Methods (Server vs Client) [http://publib.boulder.ibm.com/infocenter/db2luw/v8/topic/com.ibm.db2.udb.doc/admin/c0005435.htm]