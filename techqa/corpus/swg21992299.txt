Title: IBM Migrate Cluster Resources - IBM PureData System for Analytics - United States

Text:
nz nps netezza migration failover host cluster TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 How to safely migrate the cluster between the PureData hosts. 

SYMPTOM
Testing fail over and migration on IBM PureData HA cluster.
Migrate to standby host so currently active host may be serviced.
Migrate to standby for reboot.


CAUSE
Need to have resources running on standby host

DIAGNOSING THE PROBLEM
The hosts are in an active / passive configuration. One host owns all of the resources. 

Do not connect to the VIP interface as you will be disconnected during migration.
Do not login as nz user and then sudo to root as you will be disconnected during migration.
Connect to either host directly as the root user.

-------------------------------------

System health for safe migration. 

Health of the cluster

Test the health of the cluster.
[root]# /opt/nz-hwsupport/install_tools/hb_doctor 

Report failures to IBM support.


Check the drbd health
DRBD is the connection that keeps the NPS catalog in sync between the hosts.
[root]# service drbd status

The below output shows a healthy drbd connection status.

[root@nzhost-h1 ~]# service drbd status
drbd driver loaded OK; device status:
version: 8.4.4 (api:1/proto:86-101)
GIT-hash: 74402fecf24da8e5438171ee8c19e28627e1c98a build by root@nz80826-h1, 2016-06-03 04:06:13
m:res cs ro ds p mounted fstype
0:r1 Connected Primary/Secondary UpToDate/UpToDate C /export/home ext3
1:r0 Connected Primary/Secondary UpToDate/UpToDate C /nz ext3

If either connection does not show UpToDate/UpToDate please contact support before migrating.

Health of NPS
[nz]$ nzhw -issues ; nzds -issues ; nzds -regenstatus

Issues here most likely will not stop a migration but should be noted.


RESOLVING THE PROBLEM
Connected directly to either host as the root user run the command 

# /nzlocal/scripts/heartbeat_admin.sh --migrate

This will shutdown the cluster services (Database etc..) and move them to the standby host.

Once the migration is completed the resources may be checked with the command 
# crm_mon -i2 (control-c to exit)

Below shows the cluster resources running on HA1 with all resources started.
(Your configuration may differ slightly)

============
Last updated: Wed Oct 12 11:15:46 2016
Current DC: nz80000-h1 (3e8fc051-bbf0-488d-8e55-b22f8639b23d)
2 Nodes configured.
3 Resources configured.
============

Node: nz80000-h2 (4adecb0c-2d04-4c1b-8ca6-6603c399a70e): online
Node: nz80000-h1 (3e8fc051-bbf0-488d-8e55-b22f8639b23d): online

Resource Group: nps
drbd_exphome_device (heartbeat:drbddisk): Started nz80000-h1
drbd_nz_device (heartbeat:drbddisk): Started nz80000-h1
exphome_filesystem (heartbeat::ocf:Filesystem): Started nz80000-h1
nz_filesystem (heartbeat::ocf:Filesystem): Started nz80000-h1
fabric_ip (heartbeat::ocf:IPaddr): Started nz80000-h1
wall_ip (heartbeat::ocf:IPaddr): Started nz80000-h1
nz_dnsmasq (lsb:nz_dnsmasq): Started nz80000-h1
nzinit (lsb:nzinit): Started nz80000-h1
fencing_route_to_ha1 (stonith:apcmastersnmp): Started nz80000-h2
fencing_route_to_ha2 (stonith:apcmastersnmp): Started nz80000-h1


Once all of the resources are started the Database will start coming up. 

Once the database is online, check the status of the following after 5 minutes
# nzhw -issues ; nzds -issues ; nzds -regenstatus

This output should match what was found previously before the migration.

Make sure to allow the database to come online fully before migrating back to the other host.