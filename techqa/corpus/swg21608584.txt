Title: IBM DataPower service type metrics displayed in Tivoli Enterprise Portal - United States

Text:
TEP; WSM; WSM buffer; avg TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 The ITCAM for SOA DataPower Data Collector receives information on DataPower operations and the ITCAM for SOA agent processes that information. Aggregated metrics, for example, message size and response time, for those monitored operations are displayed in Tivoli Enterprise Portal.

The Services Inventory table in the Performance Summary workspace contains one row per unique combination of service port name and namespace, operation name and namespace, and service type (provider or requester), for each 5 minute time interval. Please see the Related information section below for a link to more information on the Performance Summary workspace.

The Services Inventory table also contains calculations such as average elapsed time. Exports of the table and historical information from the Tivoli Data Warehouse can also include calculated columns for average, minimum, and maximum message size.

It may not be clear how the average, minimum, and maximum message size values in a Services Inventory or Data Warehouse export are derived. 

SYMPTOM
For example, a Services Inventory export for a client sending a 749 byte message and receiving a 657 byte response may have these values: 

[/support/docview.wss?uid=swg21608584&amp;aid=1] Avg_Msg_Length Max_Msg_Length Min_Msg_Length Provider 703 749 657 Requester 417 556 279 
CAUSE
 The example below can help clarify what metrics to expect in the Services Inventory table by showing the values used for services type provider and requester, and demonstrating the affects of the DataPower processing policy on the message sizes sent to ITCAM for SOA. 

In the example below, a 749 byte message from the client is processed by the request rule in the DataPower processing policy and 279 bytes is sent from DataPower to the back-end. The request rule actions, which may include encryption, decryption, XSL transforms, signature processing, and more, are likely to change the message size. 

 * The client's 749 byte XML message size is what is included in the provider metrics sent from DataPower to ITCAM for SOA, if APAR IC85441 [http://www-01.ibm.com/support/docview.wss?uid=swg1IC85441] is installed. Please install DataPower firmware fix pack 4.0.2.9 or 5.0.0.3 to have this APAR fix. Otherwise, the size may not be correct. 
 * The 279 byte message size sent to the back-end is what is included in the requester metrics sent from DataPower to ITCAM for SOA. 
 * The processing policy in the response rule may change the size of the response message returned from the back-end. In this example, 556 bytes is returned from the back-end and 657 bytes is sent back to the client. The response size is the computed value before bytes are streamed out of the appliance and may not be exactly the same as the bytes received by the client.

[/support/docview.wss?uid=swg21608584&amp;aid=1] [/support/docview.wss?uid=swg21608584&amp;aid=1] DataPower Processing [/support/docview.wss?uid=swg21608584&amp;aid=1] [/support/docview.wss?uid=swg21608584&amp;aid=1] [/support/docview.wss?uid=swg21608584&amp;aid=1] Provider Processing Policy Requester [/support/docview.wss?uid=swg21608584&amp;aid=1] Client -----------> 
749 bytes 
( 2 ) Request rule changes the client request before sending a request to the back-end ---------> 
279 bytes 
( 0 ) Back-end <---------- 
657 bytes 
( 3 ) Response rule changes back-end response before sending it to the client <--------- 
556 bytes 
( 1 ) The numbers in parenthesis, 2, 0, 3, and 1, correspond to an event type included at the very beginning of the metric records in the ITCAM for SOA metric log where the message size values can be found. See the Diagnosing the problem section below for a description of the metric records and where to find the metric log.


DIAGNOSING THE PROBLEM
Details of DataPower metrics sent to ITCAM for SOA can be reviewed in metric logs created by the ITCAM for SOA data collector. 

When the ITCAM for SOA data collector collects metrics from DataPower, the metrics are stored in metric logs in the data collector logs directory, <ITM_HOME>/TMATM6/KD4/logs. The ITCAM for SOA agent copies the metric logs to the <ITM_HOME>/TMATM6/KD4/logs/KD4.DCA.CACHE directory. 

Metric log records are semi-colon delimited. A transaction that includes a request and response typically writes four messages to the metric log that include an epoch timestamp, port, operation, and message lengths. For this example, where the message lengths are 749, 657, 279 and 556, the metric log will resemble the following: 

2; <epoch_time> ; ... ; <port> ; <operation> ;1;1;0;0;749;... 
3; <epoch_time> ; ... ; <port> ; <operation> ;1;1;0;0;657;... 
0; <epoch_time> ; ... ; <port> ; <operation> ;1;1;0;0;279;... 
1; <epoch_time> ; ... ; <port> ; <operation> ;1;1;0;0;556;... 

The first token in the log, an event type, also indicates the service type. 

Metric records beginning with event type 2 and 3 are provider records containing the interaction between the client and DataPower. The provider data is the average, minimum, and maximum of the lengths included in the event type 2 and 3 records. 

 * 2 is what the client sent to DataPower. 
 * 3 is what DataPower sent the client. 


Records beginning with event type 0 and 1 are requester records describing the interaction between DataPower and the back-end. The requester data is the average, minimum, and maximum of the lengths in the 0 and 1 records.  * 0 is what DataPower sent to back-end. 
 * 1 is what the back-end sent to DataPower.

RESOLVING THE PROBLEM
If the Services Inventory table includes unexpected values for message lengths, execute a step-by-step controlled test in a non-production environment using the DataPower probe and the ITCAM for SOA data collector metric logs. 

 1. Enable the DataPower probe for the service. 
 2. Send a single message to DataPower for which the back-end will respond with a consistent response. 
 3. Use the example table in the Cause section of this document above, and make note of the message size from the client. 
 4. Examine the DataPower probe to look at the message at the beginning of request processing. 
 5. Examine the DataPower probe to see and make note of the other message sizes: the size of the message sent to, and received from the back-end, and the response returned to the client. 
 6. Review the ITCAM for SOA metric logs to confirm they reflect the numbers recorded from review of the probe. 
 7. Calculate average, minimum, and maximum message size as shown in the Symptom section. 
 8. Review the Services Inventory for your single transaction to confirm the calculated values match the manual calculations.


If you find an issue, collect the following information for IBM support:  1. Export the DataPower probe. 
 2. Collect the ITCAM for SOA metric log. 
 3. Right click on the Services Inventory and export the Services Inventory table data including the relevant columns like Average Message Length, Min Message Length and Max Message Length.

RELATED INFORMATION
#ITCAM for SOA Information Center [http://pic.dhe.ibm.com/infocenter/tivihelp/v3r1/index.jsp?topic=%2Fcom.ibm.itcamsoa.doc%2Fkd4ugmst61 ]
WebSphere DataPower SOA Appliances Information Centers [http://www-01.ibm.com/software/integration/datapower/library/documentation]