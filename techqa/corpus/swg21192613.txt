Title: IBM Informix Dynamic Server (IDS): database server runs slow when activating HDR if databases use unbuffered logging - United States

Text:
performance; hdr; threads; log buffers; informix; informix dynamic server; ids TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 A loss of database performance may be experienced when activating High Data Availability (HDR) Replication. Depending on the kind of activity, many threads may end up waiting for a free logical log buffer if databases use unbuffered logging. 

SYMPTOM
 

When you activate High Data Availability (HDR) Replication on IBM® Informix® Dynamic Server (IDS), you observe a drop in the performance of the database server. The output of the onstat -u command shows a number of threads that are waiting for a logical log buffer to be freed, as indicated by the letter G in the first position of the "flags" column.

Example:

Note: In order to aid clarity, some columns have been omitted from this example.

$ onstat -u
IBM Informix Dynamic Server Version 11.70.UC8 -- On-Line -- Up 04:09:29 -- 1265784 Kbytes

Userthreads
address flags sessid user tty wait
126e2f028 ---P--D 1 informix - 0 
126e2f850 ---P--F 0 informix - 0 
126e30078 ---P--F 0 informix - 0 
126e308a0 ---P--F 0 informix - 0 
126e310c8 ---P--F 0 informix - 0 
126e318f0 ---P--- 12 informix - 0 
126e32118 ---P--B 13 informix - 0 
126e33168 Y--P--- 305107 erm_user - 1289d3e28 
126e33990 ---P--D 16 informix - 0 
126e341b8 G--P--- 305114 erm_user - 134fbb5f8 
126e382f8 G-BP--- 305109 erm_user - 128981ea8 
126e39348 G--P--- 305110 erm_user - 1349eeee0 
126e39b70 Y--P--- 305105 appestwr tty25 1284e85e8 
126e3a398 G-BP--- 305104 wls_user - 1281dd8c0 
126e3abc0 G--P--- 305113 erm_user - 1285fe4e8 
126e3b3e8 G--P--- 305101 wls_user tty34 127fcd6c0 
126e3bc10 Y--P--- 305106 erf_user tty34 134936da8 
126e3d488 G-BP--- 305166 edd_user tty16 1289ee328
..


CAUSE

One of more of the databases that you are using are using unbuffered logging and the database server is processing a large number of small transactions. 
IDS uses three buffers for the logical log and the configuration parameter LOGBUFF defines their size.

When your database is configured to use unbuffered logging, a logical log buffer is flushed to disk every time a transaction is committed. IDS uses these buffers cyclically so if a buffer is being flushed, IDS will write to the next free log buffer.

When you are using HDR, IDS adds a second set of (three) buffers called HDR buffers that are identical in size to the logical log buffers. Before the current logical log buffer is flushed to disk and marked as free, the following (additional) tasks are performed:


1. The current logical log buffer is copied into a free HDR buffer.
2. The HDR buffer is sent to the secondary server.
3. The secondary receives the content of the buffer an acknowledgement packet back to the primary server.
4. The primary server marks the HDR buffer (that was just sent) as free.


Note: The speed with which these tasks are executed is heavily dependent upon the performance of the network that connects the primary and secondary servers to each other.
When using unbuffered logging, the buffers are likely to be flushed while still almost empty and therefore the rate at which they are re-used is high. In addition, a logical log buffer cannot be flushed and re-used until the corresponding HDR log buffer has been successfully sent to the secondary. As a consequence, all the threads that need to write logging information will be forced to wait for a log buffer to become available.

To monitor the way in which the logical log buffers are used, issue the onstat -l commands shown in the example below:

$ onstat -l

IBM Informix Dynamic Server Version 11.70.UC8 -- On-Line -- Up 04:16:54 -- 1265784 Kbytes

Physical Logging
Buffer bufused bufsize numpages numwrits pages/io
P-1 0 16 0 0 0.00
phybegin physize phypos phyused %used
10003f 40000 621 0 0.00

Logical Logging
Buffer bufused bufsize numrecs numpages numwrits recs/pages pages/io
L-3 0 16 2 2 2 1.0 1.0
Subsystem numrecs Log Space used
OLDRSAM 2 64

The important number to look at is pages/io. If this number is low, then IDS is flushing almost empty buffers. 


Important: This is only one possible cause of the problem. If this document does not provide you with the solution, you should search for other documents that refer to this topic.



DIAGNOSING THE PROBLEM
 

A network problem could be seen through the use of non-Informix software utilities like rcp or even ftp. If rcp or ftp from a client to the server is slower than it should be then this shows a network problem, not a problem with Informix.


RESOLVING THE PROBLEM
 

To ensure good database performance when using HDR, it is important that you have a fast network connection between the primary and the secondary servers. 
For non-ANSI databases, performance can be improved by changing the database logging mode from unbuffered to buffered. However before making such a change, you should be aware of the implications.

RELATED INFORMATION
#How to determine the logging mode of a database [http://www.ibm.com/support/docview.wss?rs=0&uid=swg21155533]