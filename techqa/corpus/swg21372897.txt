Title: IBM Message Driven Bean support in MQ when multiple Java Virtual Machines attempt message retrieval from the same queue - United States

Text:
Message Driven Bean MDB WebSphere MQ WMQ WebSphere Application Server WAS Java Virtual Machine JVM ASF mode non ASF mode high performance Cluster MQ V6 JMS client MQ V7 JMS client TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 There is a known design limitation with Message Driven Bean (MDB) support in WebSphere MQ, when multiple Java Virtual Machines (JVMs) attempt retrieving a message from the same queue. This will also be the case if you use multiple application servers, or if you are accessing a queue, hosted on a central queue manager, from several application server instances. 

This limitation is specified in the DeveloperWorks article below: 
( See "Scaling up: the source queue") 

CAUSE
You're trying to get the most out of high performance message-driven beans and WebSphere Application Server (specifically - Scaling up the source queue).

RESOLVING THE PROBLEM
1) Does this design limitation still exists for MQ V6 JMS clients?
YES, they utilize a queue browser, which polls for messages and then delivers them. If two or more queue browsers exist, they may attempt to deliver the same message, and contention for messages arises. For a given JVM, only one browser per queue exists, so as identified, this limitation only exists when multiple JVMs are used.


2) What is the correct way to avoid?
It is possible to workaround this limitation by utilizing non-ASF mode in WebSphere Application Server, as this does not use a queue browsing agent, and instead the messages are read destructively from the queue, by the same thread that the Message Driven Bean (MDB) is executed on. 

To set the application server to non-ASF mode, the NON.ASF.RECEIVE.TIMEOUT property should be set, as per the WebSphere Application Server manual [http://www.ibm.com/support/knowledgecenter/SS7JFU_8.0.0/com.ibm.websphere.express.doc/info/exp/ae/umb_prolscp.html?cp=SS7JFU_8.0.0%2F1-15-5-533].

Also see this article on non-ASF mode [http://www.ibm.com/developerworks/websphere/library/techarticles/0611_titheridge/0611_titheridge.html].

The MQ V7 JMS client, when connected to a MQ V7 queue manager, uses a different method of receiving messages for asynchronous consumers, and so does not exhibit the same limitation. 

This is because the queue manager delivers messages to the client, as opposed to the client polling for messages.

3) Is it bad practice to run Message Driven Beans in a WebSphere Application Server Clustered environment (two or more application servers reading the same queue) in ASF -mode: 
In order to answer, it will first be necessary to explain the way messages are picked up from the queue in ASF, and non ASF mode. 

In ASF mode, a queue agent thread (one per queue, per JVM) will be browsing for messages on the queue. When the queue agent thread finds a message, it will pass the message id, which will be used in MQGET to finally get the message. If 2 queue agent threads are browsing for messages concurrently, then there can be contention issues, and one of the Message Driven Beans (MDB's) will receive the message, and the other will not. 

In non ASF mode, there is a destructive get that happens on the message, and there is no browsing on the queue. If the receiving Message Driven Bean (MDB) is using non message id / correlation id selectors, a browse will be issued on the queue, and if the selector matches for multiple Message Driven Beans (MDBs), then contention could again arise. 

So, the answer for Question 3 is as follows:

It is not a bad practice to run Message Driven Bean's (MDB's) in WebSphere Application Server Clustered environments, in ASF mode. (As explained above in ASF mode, only one of the MDB's will receive the message, and the message will neither be lost, nor will there be a duplicate message, on multiple application servers.) However, there will be message contention that causes performance issues.

4) What is best practice regarding the number of different MDBs (different message selectors) reading one MQ queue: 
There is no restriction on the number of different Message Driven Beans (MDB's) connecting to, and receiving messages from one MQ queue.

5) If there are multiple MDBs reading one queue, is there only one queue browser per listener port / per queue, or one for every MDB
As explained in the ASF mode, there is one queue agent performing the queue browse, per queue, for every JVM.

RELATED INFORMATION
#developerWorks Article [http://www.ibm.com/developerworks/websphere/library/techarticles/0508_parkinson/0508_parkinson.html]


 

PRODUCT ALIAS/SYNONYM
 WMQ MQ