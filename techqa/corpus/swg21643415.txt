Title: IBM 线程在调用DB2 JCC驱动程序中的SocketInputStream.socketRead0函数的时候可能无限期的挂起 - United States

Text:
 TECHNOTE (FAQ)

疑问
 WebSphere Commerce使用DB2 9.5或9.7版本时，怎样通过DB2 JCC 驱动程序对SocketInputStream.socketRead0的调用超时来避免线程一直挂起。

在SystemOut.log文件中记录了挂起的线程的信息，如下:

[1/2/12 1:23:45:678 EDT] 0000001c ThreadMonitor W WSVR0605W: Thread "WebContainer : 15" (00000045) has been active for 722010 milliseconds and may be hung. There is/are 1 thread(s) in total in the server that may be hung.
at java.net.SocketInputStream.socketRead0(Native Method)
at java.net.SocketInputStream.read(SocketInputStream.java:141)
at com.ibm.db2.jcc.t4.z.b(z.java:199)
at com.ibm.db2.jcc.t4.z.c(z.java:268)
at com.ibm.db2.jcc.t4.z.c(z.java:381)
at com.ibm.db2.jcc.t4.z.v(z.java:1149)
at com.ibm.db2.jcc.t4.cb.a(cb.java:40)
at com.ibm.db2.jcc.t4.q.a(q.java:32)
at com.ibm.db2.jcc.t4.rb.i(rb.java:135)
at com.ibm.db2.jcc.am.mn.ib(mn.java:2055)
at com.ibm.db2.jcc.am.nn.rc(nn.java:3220)
at com.ibm.db2.jcc.am.nn.b(nn.java:4002)
at com.ibm.db2.jcc.am.nn.ec(nn.java:728)
at com.ibm.db2.jcc.am.nn.executeQuery(nn.java:698)

日志中看不到锁等待或者锁超时的问题，甚至当设置锁超时时间（LOCKTIMEOUT）和死锁检测时间（DLCHKTIME）都大于0时，日志文件中也不存在死锁和超时的记录 

原因
导致线程挂起的主要原因是通常与数据库和应用服务器之间连接断开有关。连接断开通常是由防火墙或者其他网络问题导致。然而，在WebSphere Application Server Administration Console(WebSphere应用服务器管理控制台)中定义的事务超时的值对socketRead0操作不会有效。因此，在这种情况下挂起的线程不会发生所期望的超时。

答案
调查连接断开的原因，并解决这个问题。调查这个原因可能要花费一定的时间，特别在生产环境，需要快速地解决。 

另外，为避免线程无限期挂起，通过在数据源中加入自定义的blockingReadConnectionTimeout属性能使SocketInputStream.socketRead0操作超时。

添加blockingReadConnectionTimeout属性步骤如下：
1、打开WebSphere Application Server管理控制台
2、展开【资源】菜单. 
3、展开【JDBC】选项
4、点击【数据资源】选项
5、在主窗口中点击"WebSphere Commerce DB2 Datasource demo"数据源
6、在其他属性模块中，点击自定义属性
7、点击【新建】
8、在“名称”字段中，填上“blockingReadConnectionTimeout”
9、在“值”字段，填上你所希望的超时时间（以秒计），例如：900秒
10、点击【应用】，然后点击【确定】
11、保持更改
12、重启WebSphere Application Server

这个值即为connection socket读取超时的时间（以秒计）。此属性仅适用于IBM JDBC 和 SQLJ type 4连接的驱动程序，并且成功建立连接后，该属性会影响发送到数据源的所有请求。 其默认值为0（0表示不允许超时）。

添加了blockingReadConnectionTimeout属性后，如果有一个线程被挂起了，在日志中会记录类似于下面信息：

[1/2/12 1:23:45:678 EDT] 0000001c ThreadMonitor W WSVR0605W: Thread "WebContainer : 15" (00000045) has been active for 722010 milliseconds and may be hung. There is/are 1 thread(s) in total in the server that may be hung.
...
[1/2/12 1:25:45:678 EDT] 00000045 ConnectionEve W J2CA0206W: A connection error occurred. To help determine the problem, enable the Diagnose Connection Usage option on the Connection Factory or Data Source.
...
[1/2/12 1:25:46:000 EDT] 00000045 ConnectionEve A J2CA0056I: The Connection Manager received a fatal connection error from the Resource Adapter for resource jdbc/WebSphere Commerce DB2 DataSource demo. The exception is: com.ibm.db2.jcc.am.DisconnectNonTransientConnectionException: [jcc][t4][2030][11211][4.12.56] A communication error occurred during operations on the connection's underlying socket, socket input stream, or socket output stream. Error location: Reply.fill() - socketInputStream.read (-1). Message: Read timed out. ERRORCODE=-4499, SQLSTATE=08001:java.net.SocketTimeoutException: Read timed out
...
[1/2/12 1:25:47:000 EDT] 00000045 RemoteExcepti E CNTR0019E: EJB threw an unexpected (non-declared) exception during invocation of method "findByProductFamilyIdAndColumnName". Exception data: com.ibm.ejs.persistence.EJSPersistenceException: find failed:; nested exception is:
com.ibm.ejs.persistence.EJSPersistenceException: getPStmt failed; nested exception is:
com.ibm.websphere.ce.cm.StaleConnectionException: [jcc][t4][10335][10366][4.12.56] Invalid operation: Connection is closed. ERRORCODE=-4470, SQLSTATE=08003
....
[1/2/12 1:25:48:000 EDT] 00000045 SystemOut O javax.transaction.TransactionRolledbackException: CORBA TRANSACTION_ROLLEDBACK 0x0 No; nested exception is:
org.omg.CORBA.TRANSACTION_ROLLEDBACK: javax.transaction.TransactionRolledbackException: ; nested exception is:
com.ibm.websphere.ce.cm.StaleConnectionException: [jcc][t4][10335][10366][4.12.56] Invalid operation: Connection is closed. ERRORCODE=-4470, SQLSTATE=08003 vmcid: 0x0 minor code: 0 completed: No
...
[1/2/12 1:25:49:000 EDT] 00000045 ThreadMonitor W WSVR0606W: Thread "WebContainer : 15" (00000045) was previously reported to be hung but has completed. It was active for approximately 904351 milliseconds. There is/are 0 thread(s) in total in the server that still may be hung. 

上面日志信息是当blockingReadConnectionTimeout发生时所期望出现的信息。这种情况下可采取适当的回滚。

另外，如果伴随blockingReadConnectionTimeout抛出StaleConnectionException，请参考以下文章： 

How to configure WebSphere data source parameters when a firewall is present [http://www.ibm.com/support/docview.wss?uid=swg21066467].


相关信息
#How to configure WebSphere data source parameters when [http://www.ibm.com/support/docview.wss?uid=swg21066467]
Common IBM Data Server Driver for JDBC and SQLJ [http://publib.boulder.ibm.com/infocenter/db2luw/v9r5/index.jsp?topic=%2Fcom.ibm.db2.luw.apdv.java.doc%2Fsrc%2Ftpc%2Fimjcc_r0052038.html]
An US English translation is available [http://www.ibm.com/support/docview.wss?uid=swg21590014]