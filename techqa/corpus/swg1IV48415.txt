Title: IBM IV48415: LOCK CONFLICT WITH SYBASE AGENT AND STORED PROCEDURE SP_SPACEUSED - United States

Text:
 SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  Problem Description:
   The Sybase agent calls Sybase provided stored procedure
   sp_spaceused to get Database Detail related attributes
   including space used information. User may find lock conflict
   which is related to the Sybase agent and stored procedure
   sp_spaceused.
   
   The root cause of the problem is that the Sybase system
   procedures always operate at isolation level 1. From Sybase
   info center:
   
   1   Prevent dirty reads. Allow non-repeatable reads and phantom
   rows. At isolation level 1, it applies exclusive and shared
   locks to maintain the data consistency.
   
   Detailed Recreation Procedure:
   
   Insert data into a table in process of long running transaction
   while the agent executes sp_spaceused stored procedue. You will
   find lock conflict information, for example,
   
   spid   status       blk  cmd     transaction_name     name
    ------ ----------- ---- ------- --------------------
   ---------------------
    <id 1> lock sleep  1221 SELECT  NULL                 Tivoli
   Monitoring
   Agent
    <id 2> sleeping    0    INSERT  $ins                 Product
   User
   
   <id 1> is Sybase agent collector - koyxxcol process:
   
   SQL TEXT: SELECT
   table_name=SUBSTRING(convert(varchar(255),table_name),1,12),
   Executing procedure: sp_spaceused
   Subordinate SQL Text: select @spaceusage = spaceusage(@dbid)
   
   <id 2> is the process which blocks sp_spaceused:
   Ex_table-blk <table> 0 <database>        Non Cursor Lock
   
   
    
   
   

LOCAL FIX

PROBLEM SUMMARY
 *  1) since sp_spaceused is Sybase provided stored procedure, we
   cannot modify its isolation level. We can copy sp_spaceused and
   create a new stored procedure with name eg. sp__itm_spaceused.
   In sp__itm_spaceused,
   we change isolation level:
   from
   set transaction isolation level 1
   to
   set transaction isolation level 0
   As a result, sp__itm_spaceused allows dirty read.
   2) Add a variable in Sybase agent configuration file to allow
   client use sp__itm_spaceused instead of sp_spaceused by changing
   the variable.
   
   
    
   
   

PROBLEM CONCLUSION
 *  The option of using sp__itm_spaceused will be provided in
   6.2.0-ITM-TIV_SYB-IF0011
   
   
    
   
   

TEMPORARY FIX

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   IV48415
   
   
 * REPORTED COMPONENT NAME
   TIV MON SYBASE
   
   
 * REPORTED COMPONENT ID
   5724B96SO
   
   
 * REPORTED RELEASE
   620
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   NoPE
   
   
 * HIPER
   NoHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2013-09-12
   
   
 * CLOSED DATE
   2014-03-04
   
   
 * LAST MODIFIED DATE
   2014-03-04
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
   
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   TIV MON SYBASE
   
   
 * FIXED COMPONENT ID
   5724B96SO
   
   

APPLICABLE COMPONENT LEVELS
 * R620 PSY
   UP