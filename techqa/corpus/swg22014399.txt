Title: IBM Non-local accounts return SQL30082N rc=24, SQL1092N, SQL0551N - United States

Text:
LDAP; osauthdb; SQL30082; SQL1092; SQL0551; standalone; test TECHNOTE (FAQ)

QUESTION
 Standalone programs to determine if there is problem outside of DB2 when using non-local authentication/authorization 

CAUSE
Root cause usually due to incorrect operating system configuration outside of DB2's control. SQL30082 rc=24 often reported after implementing LDAP or some other form of non-default (non local) operating system authentication. 

This may also result in authorization errors like SQL1092N or SQL0551N because there are problems finding the group membership for a user. Note that group membership will fail for static SQL, this is working as designed. 

The programs also print out timestamps to determine if there are delays calling operating system APIs. 


ANSWER
 

Perform explicit connect to verify SQL30082 rc=24 is returned:
db2 "connect to sample user db2inst1"
(User is prompted for password)

Implicit connects does not test authentication calls, do not use:
db2 "connect to sample"

Errors returned from these stand-alone programs indicate there is problem outside of DB2's control. Work with your system administrator to resolve.

The Linux and AIX test programs must be run as root. Specify user which is receiving SQL30082. In examples below it is user "db2inst1" with password xxxxx

Linux (default local authentication): 

Sample Run
# ./linuxGetUserPw db2inst1 xxxxx
The passwd password is incorrect
Passwd: len=1, pwd=x
Crypt: xxxxx
gid: 23581
Group membership :
Group ID (gid) : 23581
Group Name : db2inst1
Group ID (gid) : 157
Group Name : stapsys
Group ID (gid) : 158
Group Name : stapdev
Group ID (gid) : 101
Group Name : dasadm1
Group ID (gid) : 23581
Group Name : db2inst1
The shadow password is correct
Shadow: len=98, pwd=xxxxx
Crypt: xxxxx 

 

Download 

Intel/AMD64 linuxGetUserPw [/support/docview.wss?uid=swg22014399&aid=2]linuxGetUserPw [/support/docview.wss?uid=swg22014399&aid=1] PowerPC (Little Endian) linuxGetUserPw_ppcle [/support/docview.wss?uid=swg22014399&aid=4]linuxGetUserPw_ppcle [/support/docview.wss?uid=swg22014399&aid=3] 



Linux (Transparent LDAP or DB2AUTH=OSAUTHDB): This test program should be used when the user account is not local to Linux such as a remote LDAP server or when DB2AUTH=OSAUTHDB is used in combination with third party authentication. 

Must be run as root! Specify user which is receiving SQL30082.. In example below it is user "db2inst1" with password xxxxx 

 

Sample Run
# ./linuxTransLdap db2inst1 xxxxx
Account has NOT expired.
Password has NOT expired.
Initializing PAM using PAM config file /etc/pam.d/db2.
pam_start successful.
Attempting to authenticate user db2inst1.
pam_authenticate failed with the following reason:
auth error
Starting getting groups for user db2inst1.
getgrouplist returned 4 groups.
23581, 157, 158, 101
Listing the groups with names:
gid = 23581, group name = db2inst1
gid = 157, group name = stapsys
gid = 158, group name = stapdev
gid = 101, group name = dasadm1
Finish.

Examples of errors

a) Attempting to authenticate user db2inst1. 
pam_authenticate failed with the following reason: 
auth error
Finish. 

This may be caused by incorrectly configured /etc/pam.d/db2 file. Work with the Linux system administrator to resolve.

b) getspnam_r( db2inst1 ) failed. Result is NULL. rc = 2.errno= 2 

errno 2 in /usr/include/*/errno.h maps to NOENT (no such file or directory). Unable to find the user db2inst1.


Download
linuxTransLdap2 and linuxTransLdap: If linuxTransLdap2 has runtime error, use linuxTransLdap instead



Intel/AMD64 (newer version) linuxTransLdap2_x86 [/support/docview.wss?uid=swg22014399&aid=6]linuxTransLdap2_x86 [/support/docview.wss?uid=swg22014399&aid=5] Intel/AMD64 (use this one if linuxTransLdap_x86 has problems) linuxTransLdap_x86 [/support/docview.wss?uid=swg22014399&aid=8]linuxTransLdap_x86 [/support/docview.wss?uid=swg22014399&aid=7] zLinux linuxTransLdap_os390 [/support/docview.wss?uid=swg22014399&aid=10]linuxTransLdap_os390 [/support/docview.wss?uid=swg22014399&aid=9] PowerPC (Little Endian) linuxTransLdap_ppcle [/support/docview.wss?uid=swg22014399&aid=12]linuxTransLdap_ppcle [/support/docview.wss?uid=swg22014399&aid=11]  

Windows

Sample Authenticating local non-domain id db2inst1 on local machine MYCOMPUTER

C:\>db2auth db2inst1 xxxxx -l

[ NetServerGetInfo 0 ms ]

This machine is NOT a domain controller

[ LookupAccountNameA 0 ms ]

LookupAccountNameA found user db2inst1 in domain MYCOMPUTER.

User SID = S-1-5-21-1948279686-2654247516-1166183285-1000

[ AuthzInitializeContextFromSid 15 ms ]

AuthzInitializeContextFromSid completed.

[ LogonUserA 0 ms ]

Authentication was successful


Calling NetUserGetLocalGroups with:
DCName = NULL
uni_fullUserName = db2inst1\db2inst1


Sample Authenticating MYDOMAIN\db2inst1
C:\>db2auth db2inst1 xxxxx -d MYDOMAIN

[ NetServerGetInfo 0 ms ]

This machine is NOT a domain controller

[ LookupAccountNameA 0 ms ]

LookupAccountNameA found user MYDOMAIN\db2inst1 in domain MYDOMAIN.

User SID = S-1-5-21-581112117-2996542980-2825243346-36578

[ AuthzInitializeContextFromSid 78 ms ]

AuthzInitializeContextFromSid completed.

[ LogonUserA 16 ms ]

Authentication was successful

[ DsGetDcNameW 0 ms ]

Domain Controller name is \\MYDOMAINDC2

Calling NetUserGetLocalGroups with:
DCName = \\MYDOMAINDC2
uni_fullUserName = db2inst1

[ NetUserGetLocalGroups 31 ms ]

The user db2inst1 belongs to the following local groups:
Users

Calling NetUserGetGroups with:
DCName = \\MYDOMAINDC2
uni_userid = db2inst1

[ NetUserGetGroups 0 ms ]

The user db2inst1 belongs to the following global groups:
Domain Users


db2auth.exe [/support/docview.wss?uid=swg22014399&aid=14]db2auth.exe [/support/docview.wss?uid=swg22014399&aid=13] 

AIX 

Sample Run (Transparent LDAP or DB2AUTH=OSAUTHDB) 


#./aixAuthTest -NOSETAUTH -OSAUTH db2inst1 xxxxx

timestamp : Tue Jan 2 10:35:37 2018

Test will include the following:

Authentication with userid=db2inst1, password=xxxxx
Don't call getauthdb and setauthdb.
Group lookup with userid=db2inst1
Call the getgrset to do group lookup.


User db2inst1 has REGISTRY value set to "files" but we are not calling setauthdb.

Start time : Tue Jan 2 10:35:37 2018

Authenticating....
No errors from loginrestrictions.
No error from passwdexpired.
User authenticated. The authenticate API returned successfully
loginsuccess succeeded
loginsuccess Message:
Last unsuccessful login: Tue Dec 26 08:09:50 2017 on /dev/pts/5 from test.ibm.com
Last login: Thu Dec 28 13:43:47 2017 on ftp from test.ibm.com
Done authenticating.

Doing group lookup......
Group lookup of user db2inst1 using getgrset.
setauthdb to empty string to remove the restriction on which modules are used.
setauthdb() returned old auth db ""
getgrset returned 200,1,7777.
build (200)
staff (1)
pdxdb2 (7777)
Done group lookup...... 

 

aixAuthTest [/support/docview.wss?uid=swg22014399&aid=16]aixAuthTest [/support/docview.wss?uid=swg22014399&aid=15]

RELATED INFORMATION
 Source Code for standalone programs [https://github.ibm.com/askDB2Security]