Title: IBM Unexpected DB2 service termination in Windows - United States

Text:
ADPlus; userdump; core; crash; dump; ADPlus.vbs; windbg; debug; symbol; db2sysc TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 This technote provides instructions on installing and configuring ADPlus script to create a user dump when db2sysc.exe or the Windows service DB2COPY xx abnormally terminates without creating any DB2 diagnostic information. 

CAUSE
Customer monitoring tools can cause this problem

ENVIRONMENT
Windows XP/7/Vista/2003/2008/2012

DIAGNOSING THE PROBLEM



In order to identify the cause, collect the list of all running services and identify applications which were running at the time of DB2 service termination. An alternative method to collect a Windows user dump is listed in the links section under "Configuring Windows to produce a user-mode dump".

Collect Windows Event viewer output (Control Panel->Administrative Tools->Event Viewer) and try to find any pattern or certain sequence of events that may have caused the db2 service to be terminated.

Downloading and Configuring Windows Debugger
(a) Download and execute Microsoft's ADPlus software. It is bundled with Microsoft Debugging Tools for Windows or as part of the Windows SDK: http://support.microsoft.com/kb/286350 [http://support.microsoft.com/kb/286350]

Given tool can be obtained from following URL 

Standalone Debugging Tools for Windows (WinDbg)
http://msdn.microsoft.com/en-us/windows/hardware/hh852365 [http://msdn.microsoft.com/en-us/windows/hardware/hh852365]

The Windows 7 release of WinDbg can be used to debug Windows XP/2003/7/Vista/2008. 

(b) After this has been installed, create a new system environment variable.

Control Panel->System->Advanced Tab->Environment Variables->System variables

[/support/docview.wss?uid=swg21329986&amp;aid=1]

Create a new System variable called:

_NT_SYMBOL_PATH

and set its value to:

srv*DownstreamStore*http://msdl.microsoft.com/download/symbols

[/support/docview.wss?uid=swg21329986&amp;aid=2]

You do NOT need to restart the server after this has been done.
More details please refer to link "Symbol Support"


(c) Check disk space

Ensure there is enough free disk space in the directory where you
installed the Debugging Tools for Windows, i.e. "C:\Program Files\Debugging Tools for Windows". Several memory dumps will be created there - one for the first-chance exception, another one for the second-chance exception. 

Depending on the size of the user memory to dump, Windows may need more than 1.5 GB of free disk space.

If an output directory is provided to the ADPlus script, ensure there is sufficient space there.

(d) Open Task Manager and note the Process ID (PID) of the "db2syscs.exe".

(e) Attaching Windows Debugger

Once installed, go to "C:\Program Files\Debugging Tools for Windows" (32-bit) or "C:\Program Files\Debugging Tools for Windows (x64)" (64-bit) directory and run this command (from command line): 

adplus -crash -p 1234 

Where 1234 is the PID (Process IDentifier) of the running db2sysc.exe process.

Note you may be prompted to change your VBScript default interpreter from Wscript.exe to Cscript.exe. You can enter "No".

The ADPlus will then activate the monitoring and run in background.

In an event where the db2sysc.exe crashes or gets killed, a log will be created in the directory under "C:\Program Files\Debugging Tools for Windows\Crash_Mode__Date...". 

This should be done when there is not too much activity on the server as DB2 will slow down temporarily while "ADPlus" is attaching to it. However, there should
be no long term impact on the performance of the server as the tool will
not kick in until DB2 dies. Please create the output directory to store the output as well.

After the attachment has been made, a small console window will be
created by "ADPlus". Please do NOT attempt to close this window in any
way - the window is supposed the remain open as long as the monitoring
is going on.

Sample Output

This example creates an output directory c:\dumps to store the dumps. ADPlus is run in crash mode to attach to db2sysc PID 2344 and to output the user dumps to c:\dumps.

C:\Program Files\Debugging Tools for Windows (x64)>mkdir c:\dumps

C:\Program Files\Debugging Tools for Windows (x64)>ADPlus -crash -p 2344 -o c:\dumps
Starting ADPlus
********************************************************
* *
* ADPlus Flash V 7.01.002 02/27/2009 *
* *
* For ADPlus documentation see ADPlus.doc *
* New command line options: *
* -pmn <procname> - process monitor *
* waits for a process to start *
* -po <procname> - optional process *
* won't fail if this process isn't running *
* -mss <LocalCachePath> *
* Sets Microsoft's symbol server *
* -r <quantity> <interval in seconds> *
* Runs -hang multiple times *
* *
* ADPlusManager - an additional tool to facilitate *
* the use of ADPlus in distributed environments like *
* computer clusters. *
* Learn about ADPlusManager in ADPlus.doc *
* *
********************************************************

Attaching to 2344 - db2syscs in Crash mode 10/18/2011 16:01:59
Logs and memory dumps will be placed in c:\dumps\20111018_160159_Crash_Mode



(f) Collecting data

Wait until DB2 crashes. After DB2 crashes, the "ADPlus" console window
will show some activity and the memory dump will start to be created.

This may take anywhere between seconds to minutes. Finally, the "ADPlus"
console window will disappear and you will find a new directory in the
Debugging tools install directory or output path, which will be named

"Crash_Mode__Date_...__Time_..."

This is a signal for you that the data collection has finished
successfully. Please collect the full contents of the
"Crash_Mode__Date_...__Time_..." directory.


(g) Backing out

In order to back this tool out, there is no need to disable anything.
The tool will be disabled automatically when db2syscs.exe dies.


You can use Microsoft Windbg to check the stack traceback to identify the culprit behind the DB2 service termination. Note that you need symbol files for your DB2 release level ( *.pdb files) as well as symbol files for Microsoft Windows (Windows debug symbols SRV*c:\symbols*http://msdl.microsoft.com/download/symbols - please check the following link for details: http://www.microsoft.com/whdc/devtools/debugging/debugstart.mspx [http://www.microsoft.com/whdc/devtools/debugging/debugstart.mspx]).

If above steps does not help identify the cause of sudden DB2 service termination, please contact IBM DB2 support team. Above information as well as the output of:

db2support . -s -d <database>

This command creates the file db2support.zip in the current directory where db2support command was run.





RELATED INFORMATION
 Configuring Windows to produce a user-mode dump [http://www.ibm.com/support/docview.wss?uid=swg21569373]
Symbol Support [http://msdn.microsoft.com/en-us/library/windows/hardware/hh162982.aspx]