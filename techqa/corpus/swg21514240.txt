Title: IBM Dropping the OpenPages Reporting Schema Manually using SQL - United States

Text:
drop reporting schema unique foreign keys RT TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 How can an administrator drop the reporting schema manually if it fails through the OpenPages User Interface (UI)? 

CAUSE
A certain sequence of events can cause foreign keys to be out of sync on the RT tables.

DIAGNOSING THE PROBLEM
The aurora log contains a message such as: 

ORA-20555: -16191|61|-2449|ORA-02449: unique/primary keys in table referenced by foreign keys|DROP TABLE 
The following is a larger stacktrace example where it failed on dropping the RT_RISK table: java.sql.SQLException: ORA-20555: -16191|89|-2449|ORA-02449: unique/primary keys in table referenced by foreign keys|DROP TABLE rt_risk PURGE
ORA-06512: at "OPENPAGES.OP_RPS_MGR", line 1165
ORA-06512: at line 1
at oracle.jdbc.driver.SQLStateMapping.newSQLException(SQLStateMapping.java:70)
at oracle.jdbc.driver.DatabaseError.newSQLException(DatabaseError.java:133)
at oracle.jdbc.driver.DatabaseError.throwSqlException(DatabaseError.java:206)
at oracle.jdbc.driver.T4CTTIoer.processError(T4CTTIoer.java:455)
at oracle.jdbc.driver.T4CTTIoer.processError(T4CTTIoer.java:413)
at oracle.jdbc.driver.T4C8Oall.receive(T4C8Oall.java:1034)
at oracle.jdbc.driver.T4CCallableStatement.doOall8(T4CCallableStatement.java:191)
at oracle.jdbc.driver.T4CCallableStatement.executeForRows(T4CCallableStatement.java:950)
at oracle.jdbc.driver.OracleStatement.doExecuteWithTimeout(OracleStatement.java:1223)
at oracle.jdbc.driver.OraclePreparedStatement.executeInternal(OraclePreparedStatement.java:3386)
at oracle.jdbc.driver.OraclePreparedStatement.execute(OraclePreparedStatement.java:3487)
at oracle.jdbc.driver.OracleCallableStatement.execute(OracleCallableStatement.java:3858)
at oracle.jdbc.driver.OraclePreparedStatementWrapper.execute(OraclePreparedStatementWrapper.java:1374)
at com.ibm.ws.rsadapter.jdbc.WSJdbcPreparedStatement.pmiExecute(WSJdbcPreparedStatement.java:960)
at com.ibm.ws.rsadapter.jdbc.WSJdbcPreparedStatement.execute(WSJdbcPreparedStatement.java:636)
at com.openpages.aurora.service.persistence.PersistenceManager.executeDBTask(PersistenceManager.java:2506)
at com.openpages.aurora.service.persistence.PersistenceManager.executeDBTask(PersistenceManager.java:2419)
at com.openpages.aurora.service.persistence.PersistenceManager.executeTask(PersistenceManager.java:2374)
at com.openpages.aurora.service.framework.process.DBTaskProcess.process(DBTaskProcess.java:157)
at com.openpages.aurora.service.framework.process.AbstractProcess.execute(AbstractProcess.java:347)
at com.openpages.aurora.service.framework.process.AbstractProcess.startExecution(AbstractProcess.java:576)
at com.openpages.sdk.helper.QueueJobRunner.start(QueueJobRunner.java:91)
at com.openpages.sdk.util.queue.QueueJob.start(QueueJob.java:79)
at com.openpages.aurora.service.framework.process.AbstractProcessRunner.execute(AbstractProcessRunner.java:84)
at com.openpages.aurora.service.framework.process.AsynchronousProcessRunner.run(AsynchronousProcessRunner.java:51)
at java.lang.Thread.run(Thread.java:736)
--- nested by ---
ERROR CODE : -16191
EXCEPTION : Database error occured!
TYPE : com.openpages.aurora.service.persistence.TaskFailedException
MESSAGE : Object = General_; Parameters = [-2449, ORA-02449: unique/primary keys in table referenced by foreign keys, DROP TABLE rt_risk PURGE]
The requested operation could not be completed. Please contact your System Administrator.
at com.openpages.aurora.service.persistence.PersistenceManager.executeDBTask(PersistenceManager.java:2527)
at com.openpages.aurora.service.persistence.PersistenceManager.executeDBTask(PersistenceManager.java:2419)
at com.openpages.aurora.service.persistence.PersistenceManager.executeTask(PersistenceManager.java:2374)
at com.openpages.aurora.service.framework.process.DBTaskProcess.process(DBTaskProcess.java:157)
at com.openpages.aurora.service.framework.process.AbstractProcess.execute(AbstractProcess.java:347)
at com.openpages.aurora.service.framework.process.AbstractProcess.startExecution(AbstractProcess.java:576)
at com.openpages.sdk.helper.QueueJobRunner.start(QueueJobRunner.java:91)
at com.openpages.sdk.util.queue.QueueJob.start(QueueJob.java:79)
at com.openpages.aurora.service.framework.process.AbstractProcessRunner.execute(AbstractProcessRunner.java:84)
at com.openpages.aurora.service.framework.process.AsynchronousProcessRunner.run(AsynchronousProcessRunner.java:51)
at java.lang.Thread.run(Thread.java:736)
11 Sep 2009 21:31:29,911
ERROR WorkflowImpl on demosystem001
ACTORID=6;USER=OpenPagesAdministrator;TOKENID=12154
The following exception occurred: 
[Non-deferrable Alarm : 3](WorkflowImpl.java:319) 
RESOLVING THE PROBLEM
When an administrator drops or recreates the reporting schema through the OpenPages User Interface (UI), the command will drop and/or recreate the tables beginning with RT. If the 'Drop' button is clicked, the RT tables will be dropped. If the 'Re-create' button is clicked, the RT tables will be dropped, recreated, and will be repopulated with data. If the "ORA-20555: -16191|61|-2449|ORA-02449: unique/primary keys in table referenced by foreign keys|DROP TABLE" message appears in the UI and/or in the logs, the following steps can be performed to drop the reporting schema tables manually: 


1. Log into SQL*Plus or equivalent tool using the OPENPAGES oracle.
2. Run the following SELECT statement: 

set serveroutput on size unlimited

declare

lv_stmt varchar2(1024);

begin
for c_obj in
(
select table_name from user_tables where (table_name like 'RT%')
)
loop
select 'DROP TABLE '||c_obj.table_name||' CASCADE CONSTRAINTS' into lv_stmt from dual;
dbms_output.put_line('dropping table '||c_obj.table_name);
execute immediate lv_stmt;
commit;
end loop;
end;

/ 
The SQL statement will generate the appropriate SQL statements to drop the remaining RT tables in the system. Depending on what foreign keys and/or tables are in the system, this process may need to be repeated twice. 

3. Once all the RT tables have been dropped, an administrator should now be able to log into the application and click on the 'Drop' command successfully.  

HISTORICAL NUMBER
 1763