Title: IBM Shared memory overflow errors for ITM for system P agent data providers - United States

Text:
cecdataprovider aixdataprovider hmcdataprovider system p data provider shared memory emsvcsctrl harmad overflow allocation malloc TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Shared memory is exhausted when harmad daemon is running 

SYMPTOM
Data provider not starting and no data in the Tivoli Enterprise Portal for CEC/HMC/VIOS/AIX system P agent


CAUSE
The harmad daemon is running and taking all shared memory

ENVIRONMENT
Systems running the Event Management subsystem and the CEC Base, HMC Base, AIX Premium or VIOS Premium ITM agents

DIAGNOSING THE PROBLEM
The system P agent data provider is exiting with errors like:
ERROR: Spmi: Shared Memory OverFlow.. STBase=70000000, SHigh=70000570
or:
ERROR: Spmi: Unable to malloc

RESOLVING THE PROBLEM
The harmad daemon is the resource monitor for AIX operating system resources and is part of the AIX Event Management subsystem. It also uses shared memory and is known to take a lot of shared memory.




The harmad daemon can be stopped running the following command:
emsvcsctrl -k

After that, it is recommended to run the following procedure:
1. genld -ld | grep -p Spmi | grep Proc
# List all Spmi consumers running
2. Stop/kill all Spmi consumer process listed in step 1. above:
a) stop the CEC agent
b) for the other processes, stop them in a clean way, or use
kill <pid> (do not use kill -9 <pid> )
3. slibclean
4. genld -ld | grep -p Spmi | grep Proc
# Should not list anything as we stopped all Spmi consumer
5. ipcs -m | grep 0x78 
# Should not list anything. If at least an entry is listed then shared memory clean-up steps are required.

Shared memory cleanup steps: -
6. ipcrm -m <ID> # For all entries in output of 5. above
7. slibclean

Now, try to start the system P agent.

In case you want to start harmad and other Spmi consumers, run the commands in the following order:
1. start xmwlm
2. emsvcsctrl -s # Kindly do this if you really want to run harmad.
3. start any other Spmi consumer process which you want to run.


Regarding the harmad daemon, there's an APAR stating that it is in fact no longer required:
IBM IZ86786: PREVENT EMAIXOS (HARMAD) FROM RUNNING IN HACMP ON AIX 5.3

In case you no longer need the harmad daemon, it is recommended that you delete the daemon and the associated subsystem using the following command:
emsvcsctrl -d

For more info about emsvcsctrl:
http://publib.boulder.ibm.com/infocenter/pseries/v5r3/topic/com.ibm.aix.cmds/doc/aixcmds2/emsvcsctrl.htm [http://publib.boulder.ibm.com/infocenter/pseries/v5r3/topic/com.ibm.aix.cmds/doc/aixcmds2/emsvcsctrl.htm]