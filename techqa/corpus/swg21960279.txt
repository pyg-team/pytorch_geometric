Title: IBM ESX sub-nodes are reporting offline in TEP - United States

Text:
cpci.jar; esx ; vm agent; subnodes; offline; greyed; dataprovider; data provider; kvm_data_provider.bat; CpciException; FactoryInterfaceController; java; java class TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 All the esx sub-nodes of a specific vcenter server, are showed offline in TEP navigator tree despite the agent seems to be correctly started. 

CAUSE
Most of the times, when all the sub nodes are showed offline, there is a problem with the collector process.

DIAGNOSING THE PROBLEM
If you find the following message in the kvmagent RAS1 log: 

562D9CA.0000-3F58:customproviderserver.cpp,708,"startProviderMonitorin gThread") The data provider process pid[5912] "kvm_data_provider.bat"exited with return code 1 


it means that the data collector process failed the initialization and likely closed unexpectedly. 

This would explain the offline sub-nodes. 

In this case, in order to investigate the reason of the failure, you need to open the data collector log file, 

that has the following naming convention: 

 kvm_data_provider_<nnnnnnn>.log 

 

In this file, when the process fails initialization, you may find Java exception that help understanding what is wrong. 

For example, if you find an exception like: 


*****************
(Exception in thread "main" java.lang.NoClassDefFoundError: 
com.ibm.tivoli.monitoring.agentFactory.customProvider.CpciException 
at java.lang.J9VMInternals.verifyImpl(Native Method) 
at java.lang.J9VMInternals.verify(J9VMInternals.java:72) 
at java.lang.J9VMInternals.initialize(J9VMInternals.java:134) 
Caused by: java.lang.ClassNotFoundException: 
com.ibm.tivoli.monitoring.agentFactory.customProvider.CpciException 
at java.net.URLClassLoader.findClass(URLClassLoader.java:434) 
at java.lang.ClassLoader.loadClass(ClassLoader.java:660) 
at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:358) 
at java.lang.ClassLoader.loadClass(ClassLoader.java:626) 
... 3 more 
Could not find the main class: 
com.ibm.tivoli.monitoring.agent.kvm.itm.FactoryInterfaceController. 
Program will exit. 

************************* 

This indicates a problem while trying to load a specific Java class.
The class path used to find class "com.ibm.tivoli.monitoring.agent.kvm.itm.FactoryInterfaceController" 
is defined by the -cp option when Java is invoked, and can be verified into
the log file called kvm_data_provider_<nnnnnnnnn>_startup.log.

In a Windows environment it usually looks like the following:

"C:\opt\IBM\ITM\TMAITM6_x64\cpci.jar;C:\opt\IBM\ITM\TMAITM6_x64\vim51_jaxws.jar;C:\opt\IBM\ITM\TMAITM6_x64\kvm_data_provider.jar" 

 

It is possible that one or more of the jar files listed in this classpath definition are actually missing from the containing folder. 

In this specific scenario, look for cpci.jar and vim51_jaxws.jar. 

In order for the data collection to initialize successfully, they must be both present into TMAITM6_x64 folder.


RESOLVING THE PROBLEM
If one or more of the aforementioned jar files are missing, you can resolve the problem by copying them from another server where the agent is installed, into the right folder : (C:\opt\IBM\ITM\TMAITM6_x64) of the failing machine. 

Then you need to restart agent to definitely fix the issue. 

It is possible that in presence of specific Java exceptions, the data collector process fails initialization but does not close. 

This would prevent the agent from starting another instance of the process. 

For this reason, after you stopped the agent, look for any Java process belonging to vm agent as follow: 


1) Verify with a system tool that this Java PID really belongs to the VM agent path (you can do it using Process Explorer or adding the "Command Line" column in Windows Task Manager). 
2) If it really belongs to VM data collector, please kill it, as it belongs to the old agent instance. 
3) After you are sure there are no other Java process belonging to VM agent data collector, restart the VM agent.

 

PRODUCT ALIAS/SYNONYM
 IBM Tivoli Monitoring agent for Virtual Environments 7.2