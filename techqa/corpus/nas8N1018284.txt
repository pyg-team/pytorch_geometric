Title: IBM System Values Affecting Storage at R420 and Later - United States

Text:
MSGCPF0907; MSGCPF1050; MSGCPI099A; MSGCPI099B; MSGCPI099C; MSGCPI099D; STG TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 This document describes system values affecting storage at R420 and beyond. 

RESOLVING THE PROBLEM
Up until the advent of R420, the only method for providing a warning that the IBM® iSeries™ family of servers system was starting to run out of available storage in the system ASP was a threshold level for that ASP that was set in the service tools. If the level of storage usage in that ASP reaches 100%, the system will stop with a System Reference Code (SRC) on the front panel and the recovery is an IPL. In an effort to prevent the system from filling auxiliary storage and, thereby, crashing the system, a number of changes have been made to the system at R420. 

The following new system values have been added to the system:

o QSTGLOWLMT
o QSTGLOWACN

Prior to the installation of V4R2, the ASP threshold contains a value which is the system default or a user-specified value. Typically, the value will be the shipped default of 90%. When this threshold is crossed, the system generates message CPF0907 message to QSYSOPR and QHST every hour that the system stays at or above the threshold.

QSTGLOWLMT is a new threshold that, rather than looking at how much storage is used, looks at how much free storage space is available. If the system goes below this new limit, the system checks the setting of QSTGLOWACN to see what its response should be.

*ALLOBJ and *SECADM special authorities are required to change the QSTGLOWACN system value. A change to this system value takes effect immediately.

The possible settings for QSTGLOWACN are:



*MSG Send message CPI099C to QSYSMSG and QSYSOPR message queue. This message is also sent for the other actions. *CRITMSG Send critical message CPI099B to the user who is specified in the service attribute to receive critical messages. *REGFAC Submit a job to call exit programs registered for the QIBM_QWC_QSTGLOWACN exit point. *ENDSYS End the system to the restricted state. *PWRDWNSYS Power down the system immediately and restart it. 
During installation of V4R2, the new system values are installed. QSTGLOWLMT will be set to 5%. QSTGLOWACN will be set to *MSG. 

If, however, the Service Tools (ST) value is set to a value greater than 95%, then QSTGLOWLMT is set to a value of 100 minus the ST value. For example, if ST is 98%, QSTGLOWLMT will be set to (100-98), 2%. The interaction between QSTGLOWLMT and the DST setting occurs only during initial installation of V4R2M0. Any subsequent changes to the ST value are not reflected by any change to the system value. After the initial installation, it is the responsibility of the user to maintain any desired linkage between the two values. The absence of synchronization between the new values and with DST is deliberate. It is intended that the user has the option of receiving a warning that the Auxiliary Storage Threshold has been reached and of taking an action as determined by the system values when the low limit is reached. 

Therefore, with the Auxiliary Storage Threshold set at 90% and QSTGLOWLMT set to 3, the traditional DST message (CPF0907) is sent at 90% full, and the action defined for the low limit action is enacted at 97% full. 

Therefore, with the Auxiliary Storage Threshold set at 90% and QSTGLOWLMT set to 3, the traditional DST message (CPF0907) is sent at 90% full, and the action defined for the low limit action is enacted at 97% full. [/support/docview.wss?uid=nas8N1018284&amp;aid=1] 

QWCATARE is also invoked in QSYSARB5 system job for the limit event 000C 0208. It sends message CPI099C to QSYSMSG and QSYSOPR. 

If the action is *MSG, *CRITMSG, or *ENDSYS it will establish a timer event for 30 minutes. 
If the action is *CRITMSG, it will call QWCSSNCR to send CPI099B as a critical message. 
If the action is *ENDSYS and the system is not in restricted state, it will perform ENDSYS *IMMED. 
If the action is *PWRDWNSYS, it will perform PWRDWNSYS *IMMED RESTART(*YES). 

If the action is *MSG, *CRITMSG, or *ENDSYS it will establish a timer event for 30 minutes.      [/support/docview.wss?uid=nas8N1018284&amp;aid=2] 


QWCPARB5 runs during IPL and currently materializes resource management data. It checks if the system is over the limit and calls QWCATARE. QWCATARE will send message CPI099C if the action is *MSG. Otherwise, it will send CPI099D because the system is coming up in restricted state. QWCATARE will establish a timer event for 30 minutes. 

Message CPI099D - The system will start but in a restricted state and the console will be the only active device. 

The user must take actions to reduce the usage of auxiliary storage. These actions may include: o The deletion of any unused objects saving objects and specifying STG(*FREE). o Saving old log versions of QHST that are not currently used and then deleting them. o Printing or deleting spooled files on the system. 
The user must take actions to reduce the usage of auxiliary storage. [/support/docview.wss?uid=nas8N1018284&amp;aid=3] 

During subsystem start-up, if we are over the limit and if the system is in the restricted state, the subsystem will not be started. Message CPI099B will be sent as a diagnostic and existing message CPF1050 will be sent as an escape. The text of message CPI099B states: 

The amount of storage available in the system auxiliary storage pool is below the critical lower limit value. Storage usage must be reduced. This is a serious system condition. A failure to reduce the storage usage may lead to a situation requiring initialization of auxiliary storage and loss of user data. Use the WRKSYSSTS command to monitor the amount of storage used. Use the PRTDSKINF command to print information about storage usage. The WRKSYSVAL command can be used to display and change the auxiliary storage lower limit value (QSTGLOWLMT) and the auxiliary storage lower limit action (QSTGLOWACN). 

The above flowcharts illustrate the efforts that were made to prevent a constant IPL cycle if storage will not go above the free space level set in QSTGLOWLMT. The key from a diagnostic point to explain unexpected IPLs, restricted states and inability to start SBSDs, is to check QHST for the messages outlined above. 

The introduction of the Storage Low Limit and Low Action system values provided the potential for system initiated action which is timely, automatic, and designed to assist in preventing a system crash. 

QSTGLOWLMT and Installation 

The Install code now checks QSTGLOWLMT and takes this value into account when determining if enough storage is available to install the requested products. Prior to V4R2, the LP component assumed that all disk was available. Install will now not start if installing the products requested would cause the lower limit to be exceeded. Automatic install also retrieves the QSTGLOWACN value. If the value is *REGFAC, *ENDSYS, or PWRDWNSYS, the value is changed to *MSG. At the end of the installation, the value is returned to its original value. This change to the action value is to prevent a customer upgrade from ending abruptly and leaving Licensed Programs in an unusable state.  


Cross reference information Segment Product Component Platform Version Edition Operating System IBM i 6.1 Operating System IBM i 7.1 
HISTORICAL NUMBER
 13351417