Title: IBM PK84373: CRUISE MRC DATA CORRUPTED - United States

Text:
 SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  The CRUISE MRC capture option cause tapes to be created that can
   not always be restored because the MRC data at the end of the
   tape is corrupt.
   
   Browsing the tape data showed that when UFHM had attempted to
   compress the MRC data the tape was unusable. When the compress
   had not been done the tape was OK.  Why the compression is
   sometimes skipped even though the data captured is exactly the
   same I have not figured out. The problem with the compression
   seems to be caused by the layout of
   the IRCTDF records. These are fixed length lrecs. When 4 byte
   file addresses are being used the length is 7.  With 8 byte file
   addresses the length is 16.  The DBDEF for the file shows ILT to
   be 16, even though our system uses 4 byte file addresses.
   
   
    
   
   

LOCAL FIX
 *  NA
   
   
    
   
   

PROBLEM SUMMARY
 *  APAR NUMBER:  PK84373
   PRODUCT:  z/TPFDF
   FUNCTIONAL AREA:  TPFDF CRUISE UTILITY
   SHIPPED IN PUT:  6
   
   ABSTRACT:
   Data captured with CRUISE may not be able to be restored when
   using the MRC-YES option on a system where the z/TPFDF FARF6
   switch has NOT been turned on.
   
   PACKAGE CONTENTS:
   Source Segments:
   (C) tpfdf/rt/ufhm00.cpp
   (C) tpfdf/rt/ufhn00.cpp
   
   Object Only Binaries:
   None.
   
   Configuration Independent Binaries:
   None.
   
   Support Files:
   None.
   
   OTHER BINARIES TO BUILD: YES
   (C) <sys>/load/UFHM.so
   (C) <sys>/load/UFHN.so
   (C) <sys>/obj/ufhm00.o
   (C) <sys>/obj/ufhn00.o
   
   COMMENTS:
   The following problems with CRUISE capture processing with
   MRC-YES on systems where the z/TPFDF FARF6 switch has NOT been
   turned on (ZMODE T has NOT been entered) may cause capture data
   to be corrupted, resulting it being unusable for restore:
   
   1. The MRC file, IRCTDF, is part of the capture data that is
   written to tape. The LRECs of IRCTDF are fixed length LRECs.
   The SW00SR slot field, SW00ILT, contains the LREC size of fixed
   length records. The IRCTDF LRECs assume that 8 byte file
   addresses (FARF6) are in use. If the system does not use FARF6
   addressing, then smaller LRECs can be used to save space on the
   tape because 4-byte file addresses are captured instead of
   8-byte file addresses. To accomplish this, SW00ILT for IRCTDF
   is updated with the reduced LREC size. In some cases CRUISE
   capture prccessing does not update SW00ILT appropriately. The
   IRCTDF data is corrupted when written to tape since SW00ILT is
   not updated consistently during compression processing. The
   capture tape that contains this corrupted data cannot be used
   in a restore.
   2. The MRC index file IRCXDF is UP organized based on the ECB
   creating the respective detail files. This organization is
   corrupted because CRUISE fails to pass the correct part of the
   ECB index value, which is an 'int', to the keylist which
   requires a 'short'.
   3. The calculation of the number LRECs per block is inncorrect
   on non-FARF6 systems (ZMODE T has not been entered). Instead of
   using the reduced 4-byte file address LRECs, the value from the
   SW00SR slot field SW00ILT is used. This causes more of the
   capture tape to be used then necessary.
   4. Some miscellaneous coding issues in MRC segments could cause
   problems during MRC processing or warnings from certain
   compilers.
   
   
    
   
   

PROBLEM CONCLUSION
 *  SOLUTION:
   1. Updated segments ufhm00.cpp and ufhn00.cpp to set SW00ILT
   appropriately (based on the SB8BDF6 systc switch) when the
   IRCTDF file is opened.
   2. Segment ufhn00.cpp has been updated to pass the correct part
   of ECB index value to the keylist.
   3. Segment ufhm00.cpp has been updated to use the correct LREC
   size when determining the number of LRECs per block.
   4. Segments ufhm00.cpp and ufhn00.cpp were updated to ensure
   that certain pointers are not NULL before being de-referenced
   and to remove unneeded variables. A few other minor updates
   were made to prevent potential compiler warnings.
   
   With the above solutions applied the MRC data will no longer be
   corrupted when written to the capture tape and subsequently the
   tape can be used to restore data.
   
   COREQS: NO
   None.
   
   MIGRATION CONSIDERATIONS: YES
   Coexistence, migration, and fallback considerations:
   Any CRUISE tapes containing data that was captured using the
   MRC-YES option on systems that do NOT have ZMODE T specified)
   potentially cannot be restored (if the data on it was
   compressed).  In order to avoid problems at restore time, new
   capture tapes should be created with this APAR installed.
   
   Note: One way to check whether a particular capture tape
   included the MRC-YES option is to write a utility to scan the
   tape for a control block containing the text "IRCTDF" in the
   IDCATXT8 field in the corresponding DSECT.  These control
   blocks follow the data blocks that are on the tape.
   
   
   
   
   BUILD COMMANDS AND INSTRUCTIONS: YES
   #maketpf commands for linux
   maketpf -f UFHN ufhn00.o
   maketpf -f UFHM ufhm00.o
   maketpf UFHN link
   maketpf UFHM link
   
   UPDATED INFORMATION UNITS: NO
   None.
   
   See your IBM representative if you need additional information.
   
   DOWNLOAD INSTRUCTIONS:
   http://www.ibm.com/software/htp/tpf/maint/maintztpf.html [http://www.ibm.com/software/htp/tpf/maint/maintztpf.html]
   
   APAR URL:
   http://www.ibm.com/software/htp/tpf/ztpfmaint/put6/PK84373.htm [http://www.ibm.com/software/htp/tpf/ztpfmaint/put6/PK84373.htm]
   
   
    
   
   

TEMPORARY FIX

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   PK84373
   
   
 * REPORTED COMPONENT NAME
   ZTPFDF
   
   
 * REPORTED COMPONENT ID
   5748F1501
   
   
 * REPORTED RELEASE
   110
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   NoPE
   
   
 * HIPER
   NoHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2009-04-08
   
   
 * CLOSED DATE
   2009-07-08
   
   
 * LAST MODIFIED DATE
   2009-07-08
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
   
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   ZTPFDF
   
   
 * FIXED COMPONENT ID
   5748F1501
   
   

APPLICABLE COMPONENT LEVELS
 * R110 PSY
   UP