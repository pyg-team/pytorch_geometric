Title: IBM Configuring Probe Circular Store and Forward - United States

Text:
SAF; rolling; circular; store and forward; probe; omnibus TECHNOTE (FAQ)

QUESTION
 When the Primary Object Server becomes unavailable, there is a short period of time (less than 60 seconds) between when the gateway last transferred events and when the Object Server was shutdown which can result in event loss. How can I prevent this? 

CAUSE
This functionality was added in Omnibus patches 7.2.1.1-TIV-NCOMNIbus-FP0001 and 7.2.0.4-TIV-NCOMNIbus-FP0004. It is available in the base release of later versions.



ANSWER
Some probe event loss is observed due to the timing of the probe sending events during Object Server failover and failback. Store-and-forward (SAF) functionality in the Probe API is enhanced to minimize event loss during ObjectServer failover. If a connection to an ObjectServer is lost, when the probe connects to the backup ObjectServer, the probe replays the last RollSAFInterval seconds of events to the ObjectServer.


Make the following changes in any Object Servers (Primary and Backup) the probe will connect to:

1) Add a new column ProbeSubSecondId (int) to the alerts.status table in a failover pair of ObjectServers.

The default value for this field is 0. The probe will assign the incremented value to the ProbeSubSecondId field for those events that have the same LastOccurrence value.

2) Add the ProbeSubSecondId column to the gateway map.

3) Replace the deduplication trigger in the failover pair of ObjectServers as follows:

create or replace trigger deduplication
group default_triggers
debug false
enabled true
priority 1
comment 'Deduplication processing for ALERTS.STATUS'
before reinsert on alerts.status
for each row
begin


if ( (old.LastOccurrence > new.LastOccurrence) or ( (
old.ProbeSubSecondId >= new.ProbeSubSecondId)
and (old.LastOccurrence = new.LastOccurrence) ) ) then

cancel;
else

set old.Tally = old.Tally + 1;
set old.LastOccurrence = new.LastOccurrence;
set old.StateChange = getdate();
set old.InternalLast = getdate();
set old.Summary = new.Summary;
set old.AlertKey = new.AlertKey;
set old.ProbeSubSecondId = new.ProbeSubSecondId;
if (( old.Severity = 0) and (new.Severity > 0))
then
set old.Severity = new.Severity;
end if;
end if;
end

In the probe properties, configure the following:

1) Probe circular store-and-forward functionality does not behave as expected on ObjectServer failback if a probe is configured to use a virtual Object Server definition for the Server property. Configure the probe to use a primary ObjectServer for the Server property and a backup Object Server (with BackupObjectServer property set to TRUE) for the ServerBackup property.

2) Set StoreAndForward to 2 to enable circular store-and-forward. Setting this property to 0 disables store-and-forward. Setting the value to 1 enables Legacy store-and-forward where the probe logs to the store file only when the Object Server is unavailable.

3) Set RollSAFInterval to 90. This should be greater than or equal to 1.5 times the ObjectServer Granularity. This specifies the time in seconds that events will be stored in the circular store-and-forward file.

4) Set SAFPoolSize to 3. This value should be greater than 0 at a minimum. This specifies the number of files that can be used to store events.