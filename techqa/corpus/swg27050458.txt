Title: IBM Changing a DB2 PureScale Cluster from RoCE without IP support to RoCE with IP Support - United States

Text:
 PRODUCT DOCUMENTATION

ABSTRACT
 This document shows one how to change a DB2 PureScale cluster from using adapters that have RoCE without IP support (ie - EC27/28/29/30) to using adapters that have IP Support (For example, EC3A, EC3B, EC2M, EC2N, EC37, EC38, EC3L and EC3M) 

CONTENT
Before You Begin


 * Know the IP addresses that will be assigned to your switches. This is a requirement for RoCE with IP support. Please see the the following pages for details on the IP address assignment:  *  DB2 11.1: https://www.ibm.com/support/knowledgecenter/en/SSEPGG_11.1.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html [https://www.ibm.com/support/knowledgecenter/en/SSEPGG_11.1.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html] 
    *  DB2 10.5: https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html [https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html]
   
   
 * Know that you must keep the same IP addresses and host names that were previously used for the old RoCE cards the same for the new RoCE cards. 
 * See the IBM Knowledge Center for LUW for RoCE adapters that have and do not have IP support to ensure that you are following the correct procedure for the correct adapter. Also ensure that you are using an adapter that is appropriately supported on the DB2 release and fix pack that you will be using. 
 * Plan for a maintenance window, as this procedure requires the entire cluster to be stopped.



Procedure 
(Start as the instance owner) 

1. Stop all db2 and CF processes in the cluster 

db2stop / db2stop force 

2. Stop the instance on each host by running the 'db2stop instance' command for every host in the cluster 

db2stop instance on <host> 

(Switch to root) 

3. Go to the install path and enter maintenance mode for both CM and CFS 

a. Run db2ls to find the install paths and select the one that applies: 
root@samplehost:/> /usr/local/bin/db2ls 
Install Path Level Fix Pack Special Install Number Install Date Installer UID 
--------------------------------------------------------------------------------------------------------------------- 
/opt/IBM/db2/V11.1 11.1.2.2 2a Mon Nov 6 15:10:57 2017 EST 0 

For example, If your install path is /opt/IBM/db2/V11.1 (the default for 11.1), change to /opt/IBM/db2/V11.1/bin: 
cd /opt/IBM/db2/V11.1/bin 

b. Then enter maintenance: 
db2cluster -cm -enter -maintentance -all 
db2cluster -cfs -enter -maintenance -all 
Note: The CM enter maintenance should be successful before CFS is executed. 

4. On all hosts, remove the old RoCE devices that are without IP support 

To view all roce-related devices: 
lsdev -C | grep -E "RoCE|icm|hba" 

For example, 
root@samplehost:/> lsdev -C | grep -E "RoCE|icm|hba" 
hba0 Available 02-00 PCIe2 10GbE RoCE Converged Host Bus Adapter (b315506714101604) 
hba1 Available 03-00 PCIe2 10GbE RoCE Converged Host Bus Adapter (b315506714101604) 
icm Available Infiniband Communication Manager 
roce0 Available 02-00-00 PCIe2 10GbE RoCE Converged Network Adapter 
roce1 Available 03-00-00 PCIe2 10GbE RoCE Converged Network Adapter 


a. Remove the roce card devices: 
rmdev -Rdl roceX 
where X is a logical number starting at 0, incrementing for each RoCE card on the system. 
Ensure that they are all removed (via the lsdev -C | grep -E "RoCE" command) 

b. Remove the icm device: 
rmdev -Rdl icm 

c. Remove the hba devices that are associated with the roceX devices: 
rmdev -Rdl hbaX 
where X is a logical number starting at 0, incrementing for each RoCE card on the system. 

5. Assign the IP address(es) on the switch(es) (and perform any additional configuration at the switch side, if necessary) 

If the same switches are being used to connect the new adapters, for example, EC28 to EC38 (both are 10Gb), then one must only add the IP addresses to the existing switches. If however the switches are also being replaced as part of the network change, then the other switch configurations must also be completed at this time as well. 

The following Knowledge Center page describes how to Configure the switches for RoCE with Purescale and assign the IP address(es) on the switch(es): 
DB2 11.1: https://www.ibm.com/support/knowledgecenter/en/SSEPGG_11.1.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html [https://www.ibm.com/support/knowledgecenter/en/SSEPGG_11.1.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html] 
DB2 10.5: https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html [https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0060383.html] 


Example syntax to set an IP address on a Lenovo (formerly IBM) switch is shown below: 
enable 
configure terminal 
interface ip <number> 
ip address <your IP address> 
ip netmask <your IP address> 
enable 
copy running-config startup-config 

Use the appropriate switch vendor documentation for other vendors to assign an IP address to a switch, and configure switches as per the Knowledge Center requirements in this step. 

6. Shutdown the LPARs and the machines 

7. Change the cards in the machine and connect them to the appropriate ethernet switches that are RoCE capable 

For example, replace the EC28 cards with EC38. 

Note: Ensure that the adapter is supported in the appropriate slot in the machine. 

8. Boot up the machines and LPARs 

9. Follow the Knowledge Center page for configuring the network settings on the hosts on a RoCE network with IP support 

Link to the page: 
DB2 11.1: https://www.ibm.com/support/knowledgecenter/SSEPGG_11.1.0/com.ibm.db2.luw.qb.server.doc/doc/t0061915.html [https://www.ibm.com/support/knowledgecenter/SSEPGG_11.1.0/com.ibm.db2.luw.qb.server.doc/doc/t0061915.html] 
DB2 10.5: https://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0061915.html [https://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0061915.html] 

Note: It is important to keep the same IP addresses and host names that were previously used for the old adapters. The IP addresses required will already be in /etc/hosts since they were already configured at an earlier date for RoCE without IP support. All other configurations however (such as dat.conf) must be done to match the configuration requirements for RoCE with IP support. 

10. Perform an RDMA ping test 

The RDMA ping test can be performed using the db2Clusterping tool. db2Clusterping can be downloaded from here: http://www-01.ibm.com/support/docview.wss?uid=swg21967473 [http://www-01.ibm.com/support/docview.wss?uid=swg21967473] 
Note: Its important that this works from all interfaces to all other interfaces (that are within the same IP subnet) on the new RoCE cards before proceeding on. It is expected that the pairs in different IP subnets do not pass the RDMA ping test at this stage. 

11. Change /var/ct/cfg/netmon.cf on every host in the cluster to add the new network interfaces and IP addresses at the switch(es) 

The IP address for the switch must go on the same line as the network interface who's IP address matches the same IP subnet. The format used is "!REQD <network interface> <switch IP address>" for each line in the file. 

For example, if en1's IP address is 10.1.1.1, and the switch IP address is 10.1.1.24, 
and en2's IP address is 10.1.2.1 and the second switch IP address is 10.1.2.23, then 
the netmon.cf contents will look like this: 

!IBQPORTONLY !ALL <-- This is standard on all hosts. It will already be present and can be kept as-is. 
!REQD en0 9.26.51.1 <-- en0 is the public network in this example. It will already be present and can be kept as-is. 
!REQD en1 10.1.1.24 <-- This one was added 
!REQD en2 10.1.2.23 <-- This one was added 

12. Go to the install path and exit maintenance mode for both CM and CFS: 

a. Run db2ls to find the install paths and select the one that applies: 
root@samplehost:/> /usr/local/bin/db2ls 

Install Path Level Fix Pack Special Install Number Install Date Installer UID 
--------------------------------------------------------------------------------------------------------------------- 
/opt/IBM/db2/V11.1 11.1.2.2 2a Mon Nov 6 15:10:57 2017 EST 0 

For example, If your install path is /opt/IBM/db2/V11.1 (the default for 11.1), change to /opt/IBM/db2/V11.1/bin: 
cd /opt/IBM/db2/V11.1/bin 

b. Then exit maintenance: 
db2cluster -cm -exit -maintenance -all 
db2cluster -cfs -exit -maintenance -all 
Note: The CM exit maintenance should be successful before CFS is executed. 

13. Repair the CM domain: 

export DB2INSTANCE=<your db2 instance id> 
db2cluster -cm -list -domain 
db2cluster -cm -repair -domain <domain> -force 

(Switch to the instance owner) 

14. Start the instance on each host by running the 'db2start instance' command for every host in the cluster 

db2start instance on <host> 

15. Start db2 and CF processes: 

db2start 

16. (Optional) Perform a second RDMA ping test 

Using the db2Clusterping tool, perform a second RDMA ping test. This time, all interface pairs from source to destination should pass. 



ORIGINAL PUBLICATION DATE
 2017/10/7