Title: IBM Nested Stored Procedure Calls Returning Result Sets - United States

Text:
ODBC; SQLCLI TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 This document contains information regarding a restriction that was enforced starting at V5R1. Result sets from nested stored procedure calls are not returned unless the new syntax for defining the cursor is used. This support was added by PTF in V5R2. 

RESOLVING THE PROBLEM
When an application uses nested stored procedure calls (a stored procedure that calls a stored procedure), any result set returned to the client must originate from the top-most level (the stored procedure called by the client) unless the cursor being returned from the lower level cursors are declared to return to client. The support to declare a cursor in this fashion was added through PTFs in V5R2 of IBM OS/400 so earlier releases of the operating system or V5R2 systems without the PTFs are not able to pass result sets between stored procedures and ultimately to a client (caller). 

Support for returned cursors is added to V5R2 with PTF SI13260 and its co-requisite PTFs. This support will be built into the base support for all subsequent operating system releases. Support for the RETURN clause has been added for the DECLARE CURSOR statement. This new function does not include support over IBM DRDA. 

On systems without the new support, unpredictable results can occur if a stored procedure calls another stored procedure that returns a result set. No error message is issued. At a specific operating system release or PTF level, certain types of results sets (array versus cursor) might return data to the caller. Other code levels might return no result set.

Note that the SQL Procedures portability across DB2 platforms table in the IBM Redbooks publication Developing Cross-Platform DB2 Stored Procedures: SQL Procedure and the DB2 Stored Procedure Builder, SG24-5485, implies that the operating system supports nested calls that return result sets. This is not accurate for systems without the new functionality. Version "00" of the Redbooks publication states that the ALLOCATE CURSOR statement for processing result sets from nested procedures is supported; however, this is true only for systems running V5R2 or greater. This should read Not yet supported. The ALLOCATE CURSOR (and related RESULT_SET_LOCATOR, ASSOCIATE LOCATORS, and so on) are not available on the operating system until V5R2 (with the new function PTF).

Using the New Support

The syntax diagram for the DECLARE CURSOR statement can now include the RETURN clause shown below:

.-WITHOUT RETURN-------------. 
-+----------------------------+------->
| .-TO CALLER-. |
'-WITH RETURN--+-----------+-'
'-TO CLIENT-'

The default behavior is equivalent to ‘WITHOUT RETURN’.

The following is a description of the RETURN clause.

WITHOUT RETURN or WITH RETURN 
Specifies if the result table of the cursor is intended to be used as a result set that will be returned from a procedure. 

[/support/docview.wss?uid=nas8N1017754&amp;aid=1] WITHOUT RETURN: Specifies that the result table of the cursor is not intended to be used as a result set that will be returned from a procedure. 
WITH RETURN: Specifies that the result table of the cursor is intended to be used as a result set that will be returned from a procedure. WITH RETURN is relevant only if the DECLARE CURSOR statement is contained within the source code for a procedure. In other cases, the precompiler might accept the clause; however, it has no effect.

Within a procedure, cursors declared using the WITH RETURN clause that are still open when the IBM® SQL/400® procedure ends define the result sets from the SQL procedure. All other open cursors in an SQL procedure are closed when the SQL procedure ends. Otherwise, any cursors open at the end of an external procedure are considered the result sets.

For non-scrollable cursors, the result set consists of all rows from the current cursor position to the end of the result table. For scrollable cursors, the result set consists of all rows of the result table.

TO CALLER: Specifies that the cursor can return a result set to the caller of the procedure. For example, if the caller is a client application, the result set is returned to the client application.

TO CLIENT: Specifies that the cursor can return a result set to the client application. This cursor is invisible to any intermediate nested procedures. If a function called the procedure directly or indirectly, result sets cannot be returned to the client and the cursor will be closed after the procedure finishes. In the case where a result set is being returned from a program using an array result set rather than a cursor, the following syntax can be used: 

SET RESULT SETS WITH RETURN TO CLIENT ARRAY host-structure-array FOR host-variable ROWS 

Refer to the SET RESULT SETS information in the chapter on Statements in the DB2 UDB for iSeries SQL Reference for more information. 


Cross reference information Segment Product Component Platform Version Edition Operating System IBM i 7.2 Operating System IBM i 7.1 Operating System IBM i 6.1 
HISTORICAL NUMBER
 19693746