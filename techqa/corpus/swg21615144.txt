Title: IBM Data Server Driver for JDBC and SQLJ INSERT SQL statement fails with SQLCODE -1585 if auto-generated keys retrieved, at driver version 3.61 or later - United States

Text:
-1585; SQl1585N; useIdentityValLocalForAutoGeneratedKeys.; JCC; autogenerated; keys; JCC; JDBC; DB2; temporary table space; page size; 54048 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 An application which uses the IBM Data Server Driver for JDBC and SQLJ (JCC) to retrieve auto-generated keys on an INSERT statement, may fail with the following exception at driver version 3.61 (DB2 9.5 Fix Pack 7) or later:




SYMPTOM
com.ibm.db2.jcc.am.SqlException: DB2 SQL Error: SQLCODE=-1585, SQLSTATE=54048, SQLERRMC=null, DRIVER=3.63.75

SQLCODE -1585 corresponds to the message 

SQL1585N A system temporary table space with sufficient page size does not exist. SQLSTATE=54048

If there is no temporary table space with a sufficient page size to process the INSERT statement, this error normally occurs. This technote is in regards to scenarios in which there is a temporary table space with a sufficient page size to process the INSERT statement, yet SQLCODE -1585 is still returned.


CAUSE
In driver version 3.61 (as documented in APAR IC71913), the default behavior for auto-generated key retrieval changed, and a new new datasource/connection boolean property useIdentityValLocalForAutoGeneratedKeys was introduced. Values: 


true - driver uses the database IDENTITY_VAL_LOCAL() function to determine the auto-generated keys values.
false - driver uses the method 
SELECT * FROM FINAL TABLE (<INSERT-statement>) 
if supported by the database server.

The default is false.

Prior to driver version 3.61, the only method that the driver used was the database IDENTITY_VAL_LOCAL() function.

During processing of the statement SELECT * FROM FINAL TABLE (<INSERT-statement>) the DB2 Compiler processes a temporary result set containing two (2) sets of columns - the columns in the INSERT statement, and those in the SELECT FROM FINAL TABLE statement. There is a limitation for statements of the typeSELECT FROM FINAL TABLE (<statement>) that the sum of the column lengths cannot exceed the maximum available temporary table space page size.


DIAGNOSING THE PROBLEM
To retrieve auto-generated keys, the application needs to use the following Statement.executeUpdate or Connection.prepareStatement methods:

For prepared statements:
Connection.prepareStatement(sql-statement, Statement.RETURN_GENERATED_KEYS);
Connection.prepareStatement(sql-statement, String [] columnNames);
Connection.prepareStatement(sql-statement, int [] columnIndexes);

For statements:
Statement.executeUpdate(sql-statement, Statement.RETURN_GENERATED_KEYS);
Statement.executeUpdate(sql-statement, String [] columnNames);
Statement.executeUpdate(sql-statement, int [] columnIndexes);

Where columnNames or columnIndexes identify the column(s) of the INSERT statement to generate keys for.

If the sum of the column lengths of the rows specified in the INSERT statement is one half or greater of the largest available temporary table space page size (e.g 16384 is half of 32767 bytes for a 32-kilobyte page temporary table space), then an INSERT statement would be susceptible to this problem.






RESOLVING THE PROBLEM
Set the datasource property useIdentityValLocalForAutoGeneratedKeys to true, or decrease the number of columns in the INSERT.

RELATED INFORMATION
 Retrieval of automatically generated keys in JDBC appli [http://pic.dhe.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.apdv.java.doc/src/tpc/imjcc_c0057055.html]
Retrieving auto-generated keys for an INSERT statement [http://pic.dhe.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.apdv.java.doc/src/tpc/imjcc_t0057053.html]
IC71913: DOCUMENTATION OF CHANGES IN IBM DATA SERVER DR [http://www-01.ibm.com/support/docview.wss?uid=swg1IC71913]
Common IBM Data Server Driver for JDBC and SQLJ propert [http://pic.dhe.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.apdv.java.doc/src/tpc/imjcc_r0052607.html]