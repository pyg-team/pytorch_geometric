Title: IBM After enable Connection concentrator in DPF environment, why application still hold transaction log on nodes that application have already “Decoupled”? - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 After enable Connection concentrator in DPF environment, why application still hold transaction log on nodes that application have already “Decoupled”? It is decided by following to points: 

CAUSE
If an application will hold the transaction log on one member is not decided by the application are in “Decoupled” status on that member.

ANSWER
If an application will hold the transaction log on one member is not decided by the application are in “Decoupled” status on that member. 

1. If the transaction of this application WRITE the log on this member;
2. If the application have been committed on the coordinator member.

When an application have WRITE the transaction log on a member and before the statements were committed on the coordinator member, even the application is "Decoupled" on this member, it will still hold the transaction log.

Here to show this by an example, a DPF environment with two physical hosts, 4 members:

0 bjwangfaix01 0
1 bjwangfaix01 1
2 bjwangfaix02 0
3 bjwangfaix02 1

1) On member 0, create a table, insert one row, but do not commit;

$db2 "create tabele wf_t1 (c1 int)"
$db2 +c "insert into wf_t1 values(1)"

2) This time, if we check, we can find member 3's transaction log was holded by this application(188). 

$db2_all "db2 get snapshot for db on sample" |egrep "Node number|Appl id holding the oldest transaction" （appid=188）
Node number = 3
Appl id holding the oldest transaction = 188

3) If we check the transaction status, with db2pd -trans, we can find transaction write log on member 3(this is because the inserted data was distributed to member 3)

$ db2_all "db2pd -db sample -trans"|egrep "Database Member|188 "
Address AppHandl [nod-index] TranHdl Locks State 
Database Member 0
0x0A00020010BBEF80 188 [000-00188] 18 1 READ 
Database Member 1
0x0A00010010BA5300 188 [000-00188] 3 0 READ 
Database Member 2
0x0A00010010BBB880 188 [000-00188] 16 0 READ
Database Member 3
0x0A00010010BBB880 188 [000-00188] 16 4 WRITE

4) If we check the application status by db2 get snapshot, we can see member 0 was in 'UOW Waiting' and other members are in 'Decoupled' status; but the member hold the log was 3 not 0;

db2_all "db2 get snapshot for application agentid 188"|egrep "Application handle|Application status|Coordinator member number|Current member number|Number of SQL requests since last commit"


Application handle = 188
Application status = UOW Waiting
Coordinator member number = 0
Current member number = 0
Number of SQL requests since last commit = 1


Application handle = 188
Application status = Decoupled
Coordinator member number = 0
Current member number = 1
Number of SQL requests since last commit = 0


Application handle = 188
Application status = Decoupled
Coordinator member number = 0
Current member number = 2
Number of SQL requests since last commit = 0


Application handle = 188
Application status = Decoupled
Coordinator member number = 0
Current member number = 3
Number of SQL requests since last commit = 0

5) We can insert some more data to verify this:

db2 +c "insert into wf_t1 values (999)"
DB20000I The SQL command completed successfully.

=> db2_all "db2pd -db sample -trans"|egrep "Database Member|188 "
Database Member 0 -- Database SAMPLE -- Active -- Up 0 days 00:58:14 -- Date 06/30/2016 02:57:11
0x0A00020010BBEF80 188 [000-00188] 18 1 READ 0x00000000 0x00000000 0x0000000000000000 0x00000000001AF03E 0 0 0 0 0x000000024FAD 1 n/a n/a n/a n/a
Database Member 1 -- Database SAMPLE -- Active -- Up 0 days 00:35:49 -- Date 06/30/2016 02:57:12
0x0A00010010BA5300 188 [000-00188] 3 0 READ 0x00000000 0x00000000 0x0000000000000000 0x00000000000F8E36 0 0 0 0 0x0000000054B8 1 n/a n/a n/a n/a
Database Member 2 -- Database SAMPLE -- Active -- Up 0 days 00:58:17 -- Date 06/30/2016 02:57:14
0x0A00010010BBB880 188 [000-00188] 16 4 WRITE 0x00000000 0x00000000 0x000000000010A3A9 0x000000000010A3A9 220107389 220107389 200 273 0x000000004F1A 1 n/a n/a n/a n/a
Database Member 3 -- Database SAMPLE -- Active -- Up 0 days 00:57:39 -- Date 06/30/2016 02:57:15
0x0A00010010BBB880 188 [000-00188] 16 6 WRITE 0x00000000 0x00000000 0x00000000000E6FCC 0x00000000000E6FCE 163043851 163043997 348 567 0x000000004EFD 1 n/a n/a n/a n/a

db2_all "db2 get snapshot for application agentid 188"|egrep "Application handle|Application status|Coordinator member number|Current member number|Number of SQL requests since last commit"

Application handle = 188
Application status = UOW Waiting
Coordinator member number = 0
Current member number = 0
Number of SQL requests since last commit = 4

Application handle = 188
Application status = Decoupled
Coordinator member number = 0
Current member number = 1
Number of SQL requests since last commit = 0

Application handle = 188
Application status = Decoupled
Coordinator member number = 0
Current member number = 2
Number of SQL requests since last commit = 0

Application handle = 188
Application status = Decoupled
Coordinator member number = 0
Current member number = 3
Number of SQL requests since last commit = 0


$db2_all "db2 get snapshot for db on sample" |egrep "Node number|Appl id holding the oldest transaction"
Node number = 2
Appl id holding the oldest transaction = 188
Node number = 3
Appl id holding the oldest transaction = 188