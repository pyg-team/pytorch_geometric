Title: IBM Domino Mail routing does not fail over within clustered servers - United States

Text:
fail over; failover; Incident; vantive #1330493; cluster fail over; cluster failover; mail routing; route; routing; mail router; does not fail over; does not failover; clustered servers; mail does not fail over; failover does not occur; cluster TECHNOTE (FAQ)

QUESTION
In Lotus Domino, when the primary machine in a cluster goes down, the secondary machine's mail.box file fills up with mail that is pending being routed to the first server. The router does not seem to realize it can deliver e-mails locally. Issuing the "tell router show" command displays the pending e-mails that are all waiting for an NRPC transfer to the main machine and other normal mail routes.

CAUSE
This problem is probably called by a cluster.ncf file that is corrupt or a cldbdir.nsf file that does not have all the correct replicas listed. Renaming the mail.box file does not help.

ANSWER
This issue was reported to Quality Engineering as SPR# RCE4UQ6R8 and was resolved under the following circumstances: 

1. When the Cluster Database Directory Manager and the Cluster Replicator were shut down on all Domino servers/clusters.

2. When cldbdir.nsf was renamed.

3. When the Cluster Database Directory Manager and the Cluster Replicator were renamed. Restarting Cldbdir will rebuild Cldbdir.nsf. 

NOTE: It is important to remove cldbdir.nsf from all servers in the cluster and rebuild them all, or you will end up with duplicate documents for the same database on the servers on which cldbdir.nsf was rebuilt. This is because upon rebuilding, the database documents are created with new UNIDs while the entries are still present in cldbdir.nsf on another cluster server where they were not removed.

Another point to consider is that if Cldbdir was recently rebuilt after the failover and issues arise at this point, the secondary server likely has corrupt information in its Cldbdir. In this case, a copy of Cldbdir prior to the failover may be employed successfully.

Make sure that:

-- MailClusterFailover=1 is set on all servers in the domain in the Configuration Document.

-- Cluster information is placed in the Server Document.

-- In earlier versions of Domino, the Cluster Replicator and the Cluster Database Directory Manager tasks start and then are added to the "ServerTasks=" line in the notes.ini file. In the 8.5 versions, these tasks run automatically.

-- Cldbdir creates and populates the Cluster Database Directory (cldbdir.nsf).

-- The cluster.ncf file is used in conjunction with this parameter to deliver the mail. The first server listed in cluster.ncf will route the mail if that server can perform the function. Otherwise, the next server listed will route the mail. Check the Server Document for the mail routing task. If one of the server names is missing from the cluster, cluster.ncf must be rebuilt. This can be accomplished by shutting down the server, deleting or renaming cluster.ncf and restarting the server. For more information, refer to Document #1087756 [http://www.ibm.com/support/docview.wss?rs=899&uid=swg21087756], "When is cluster.ncf created by a Notes client or a Domino server?"

NOTE: Sometimes there may be confusion about the fact that if cluster replication is disabled for mail files within the Cluster directory, this affects how mail routes. Since the router and replication are separate tasks, disabling cluster replication has no effect on how mail is delivered within a cluster. To disable mail routing cluster failover, do it within the Configuration Document --> Router/SMTP panel --> Advanced --> Controls.

RELATED INFORMATION
 When is cluster.ncf created by a Notes client or a Domi [http://www.ibm.com/support/docview.wss?uid=swg21087756]
A simplified Chinese translation is available [http://www.ibm.com/support/docview.wss?uid=swg21604193]




HISTORICAL NUMBER
 182877