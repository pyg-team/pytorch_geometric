Title: IBM DB2 Content Management application may receive SQL0930N. - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 If you are running DB2 Content Manager Enterprise Edition (prior to the version 8.4.1 Fix Pack 1) on DB2 
version 9.5 onwards on Windows, users may receive SQL0930N error. It means that there is not enough storage available to process the statement. 

SYMPTOM
The key entry in db2diag.log looks like : 

2010-11-18-16.42.10.009000+660 E1652113H736 LEVEL: Error (OS)
PID : 7464 TID : 11684 PROC : db2syscs.exe
INSTANCE: DB2INST1 NODE : 000 DB : SAMPLE
APPHDL : 0-49749 APPID: 10.49.4.9.56851.101118053614
AUTHID : DB2INST1
EDUID : 11684 EDUNAME: db2agent (SAMPLE)
FUNCTION: DB2 UDB, SQO Memory Management, sqloLogMemoryCondition, probe:100
CALLED : OS, -, VirtualAlloc
OSERR : 8 "Not enough storage is available to process this command."
MESSAGE : Private memory and/or virtual address space exhausted
DATA #1 : Requested size, PD_TYPE_MEM_REQUESTED_SIZE, 4 bytes
10616832
DATA #2 : Current set size, PD_TYPE_SET_SIZE, 4 bytes
738000896


CAUSE
DB2 Version 9.5 for Windows changed the way of acquiring virtual memory. Windows allows three states of memory acquisition via VirtualAlloc API : RESERVE, COMMIT, FREE. In versions prior to DB2 9.5, DB2 used a combination of COMMIT/FREE. This model was assigning/releasing physical memory at the time of request. Beginning in DB2 9.5, the dominant architecture is now 64-bit, and expectation of vastly larger virtual address spaces used by db2syscs process. Persisting with COMMIT/FREE model would lead to overuse of physical memory and introduce additional operating system level overhead. In that way RESERVE/COMMIT/FREE model is leaner. DB2 changes status of reserved address range to COMMIT when required. However, this model leads to fragmentation of virtual space. Apparently you cannot convert adjacent blocks of RESERVE/COMMIT/FREE memory into - let's say - new RESERVE/COMMIT one. So if a new large request comes up requiring substantial chunk of memory - such as for ICMSEARCH stored procedure - this chunk can only be freshly acquired from so far unused range of addresses, or it may fail. This explains DB2 march towards 2gb ceiling (i.e 2gb user space), without actually using all that much of physical memory.


ENVIRONMENT
This issue only occurs if you are running DB2 Content Manager Enterprise Edition (prior to the version 8.4.1 Fix Pack 1) on DB2 version 9.5 onwards on Windows



DIAGNOSING THE PROBLEM
In order to confirm the above assertion as to the root cause of problem observed, you can collect below diagnostic data and contact IBM DB2 Technical Support at 1-800-IBM-SERV to report the issue. 

 

 1. db2pd command:
    
    db2pd -inst -alldbs -memb all sort > memb.all.pd
    db2pd -inst -alldbs -memp > memp.all.pd
    db2pd -inst -alldbs -mems > mems.all.pd
    db2pd -dbptnmem > dbptnmem.pd
    db2pd -eve > eve.pd
    db2pd -stack all
    
    
 2. vadump:
    download the vadump utility using this URL:
    http://www.microsoft.com/downloads/en/details.aspx?FamilyID=9d467a69-57ff-4ae7-96ee-b18c4790cffd&displaylang=en [http://www.microsoft.com/downloads/en/details.aspx?FamilyID=9d467a69-57ff-4ae7-96ee-b18c4790cffd&displaylang=en]
    
    vadump -v -p <db2syscsPid> > vardump.out
    
    
 3. db2support command:
    
    db2support . -d <database name> -c -s -o db2support.zip
    


RESOLVING THE PROBLEM
 

 1. If you set DB2MEMDISCLAIM registry variable to OFF, it will stop DB2 to retain reserved memory and will force reserved memory into commit memory and thus reduce fragmentation. DB2 instance must be recycled for this change to take effect.
    
    db2set DB2MEMDISCLAIM=OFF
    db2stop
    db2start
    
    
 2. Upgrade to 64bit environment of DB2 Content Manager Enterprise Edition.

RELATED INFORMATION
 DB2MEMDISCLAIM [http://publib.boulder.ibm.com/infocenter/db2luw/v9r5/topic/com.ibm.db2.luw.admin.regvars.doc/doc/r0005665.html?resultof=%22%44%42%32%4d%45%4d%44%49%53%43%4c%41%49%4d%22%20%22%64%62%32%6d%65%6d%64%69%73%63%6c%61%69%6d%22%20]