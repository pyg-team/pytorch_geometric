Title: IBM Resolve migration failure due to the packed descriptor corrcuption - United States

Text:
db2cat; Packed Descriptor Corruption; Database Migration TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 The migratin from v8.x to v9.x may fail and crash the instance if there exist corrupted pack descriptor in the database 

SYMPTOM
The error code SQL2519N may be received during the migration and db2 instance may crash


CAUSE
The corrupted packed descriptor will cause the migration fail

DIAGNOSING THE PROBLEM
The trap stack is like the following:

sqlnls_UnpaddedCharLen 
sqlrlEncodeImplicitValue 
sqlrlm_8to9_syscolumns
sqlrlm_catalogFixup
sqlrlm_catalog_migrate 


RESOLVING THE PROBLEM
1. Take a db2 trace to find the corrupted table. Note that as the migration will crash the instance, thus using db2trc debug point sqloEDUExceptionFilter to hang the instance before db2 enters the trap handler and dump out the trace records before the instance crashes.
db2trc on -debug DB2.SQLO.sqloEDUExceptionFilter.entry -l 512m -suspend
db2 migrate db F907DB01




When it hits the debug point in the following message will be written in db2diag.log and dump out the trace record at this time. 

db2trc dump migrate_trc.dmp
db2trc off 

2011-07-28-14.37.48.454000+480 I1050454H609 LEVEL: Severe
PID : 4776 TID : 4524 PROC : db2syscs
INSTANCE: INST1 NODE : 000 DB : SAMPLE
APPHDL : 0-7 APPID: *LOCAL.INST1.110728063725
AUTHID : INST1
EDUID : 4524 EDUNAME: db2agent (SAMPLE)
FUNCTION: DB2 UDB, trace services, crash_trace, probe:10
MESSAGE : MARKER=16395=PD_DB2_TRC_CRASH_SUSPEND "Trc. debug: Suspending"
DATA #1 : Function, 4 bytes
DB2 UDB, oper system services, sqloEDUExceptionFilter
DATA #2 : unsigned integer, 4 bytes
0 


2. Format migrate_trc.dmp by

db2trc fmt migrate_trc.dmp migrate_trc.fmt

3. In migrate_trc.fmt file search the last string like "sqlrlm_8to9_syscolumns" which should point to the corrupted table information. In the following example, the corrupted table should be INST1.T1 and the pack descriptor for column C1 is corrupted.

4523270 entry DB2 UDB catalog migration sqlrlm_8to9_syscolumns fnc (1.3.138.37.0)
pid 4180 tid 2812 cpid 3256 node 0
eduid 2812 eduname db2agent
bytes 52

Data1 (PD_TYPE_STRINGN,8) String with size:
INST1
Data2 (PD_TYPE_STRINGN,12) String with size:
T1
Data3 (PD_TYPE_STRINGN,8) String with size:
C1

4. Use db2cat utility to regenerate a new pack descriptor and replace the corrupted one.

export DB2SVCPW=<db2svcpw>
export DB2CAT=SERVICE 
Please contact DB2 support for service password. 

Use the following db2cat command to generate a new packed descriptor and replace the corrupted by
db2cat -d <db> -n <table> -s <schema> -g new.pd -o db2cat1.out 
db2cat -d <db> -n <table> -s <schema> -r new.pd -o db2cat2.out 

 

5. Repeat the above steps until all the corrupted packed descriptors are fixed

RELATED INFORMATION
 db2cat informantion center [http://publib.boulder.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.admin.cmd.doc/doc/r0024085.html]