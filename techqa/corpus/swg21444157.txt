Title: IBM Resetting a user's Domino IMAP mail file - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM
Why has my IMAP mail stopped synchronizing?

SYMPTOM
Several cases have been observed where a user running Outlook and IMAP has issues with messages, be it formatting, synchronizing or deleting messages from their inbox. In most cases, the server was running Domino 8 or Domino 8.5


RESOLVING THE PROBLEM

This article takes you through the process of performing a full update of malfunctioning IMAP enabled Notes databases. 

Using the Domino console and Domino webadmin client, complete the following steps:

1. Log into the Domino console.
2. Close the target database.
3. Stop the Domino router.
4. Run the fixup program against the mail file.
5. Reset the user's Domino IMAP profile.
6. Rest the IMAP summary attributes.
7. Start the router and log out of the Domino console.
8. Log into the Domino webadmin and change the user's preferred mail format.

Logging into and using the Domino console

Many of the troubleshooting steps in this technote rely on Domino console commands. Follow the steps below to access the Domino console in live mode.

1. Telnet into the server as an administrative user.
2. Type "nvs" and press the Enter key. The NVS selection menu is shown.
3. Using your keyboard arrow keys, highlight the Domino NVS instance and press the Enter key.
4. At the command prompt, change user's to the notes user.

su - notes

5. Change directories to the notesdata folder .

cd /TWISTER/notesdata

6. Start the Domino console using the root user's ID file.

/opt/ibm/lotus/bin/cconsole -f /home/notesbackup/notesid/root.id

7. A warning message is displayed. Press "n" to continue.
8. When prompted, enter the root user's password.
9. Enable the live console update option.

live on

Note: While in live mode all Domino log messages will be printed to the screen.

Close target mail databases

Whenever you run any of these procedures, the Notes database should be closed before proceeding. First notify users with issues to close their Lotus Notes, IMAP or POP3 clients, log out of iNotes and disable the email account in any wireless devices. After users have completely disconnected from the server, verify that the database is actually closed. In the Domino console run the command 

show opendatabases

Check the output of this command to ensure that the target database is not in the list. If the database is still open even after the users have logged out of all of their clients, the database is probably being kept open by iNotes. To clear and close all iNotes databases, you will need to flush the http iNotes cache. To do this, run the following command:

tell http inotes flushforms

Check to see if the database is removed from the open databases list. 

Stop the Domino router

To ensure that the user's mail file is not modified during these operations you should stop the Domino router. When you stop the Domino router messages will still be accepted from the internet but will not be delivered to users. In the Domino console run the following command:

tell router quit

Fix the user's Domino mail file

The first step in troubleshooting a user's mail file is to run the Notes fixup utility. With the database closed run the following command replacing UserName with the user's Lotus Foundations Start user name.

load fixup -jF mail/UserName.nsf

Watch the resulting log messages. The results should look similar to the following:
When you see "Database Fixup: Shutdown" continue on to the next steps. 

Clearing DBIID 9B78C7C9 for DB /TWISTER/notesdata/mail/UserName.nsf
09/14/2010 06:38:44 PM Database Fixup: Started: -jF mail/UserName.nsf
09/14/2010 06:38:44 PM Performing consistency check on mail/UserName.nsf...
Command has been executed on remote server. Use 'Live' console option, in future, to view response from server.
09/14/2010 06:38:46 PM Recovery Manager: Assigning new DBIID for /TWISTER/notesdata/mail/UserName.nsf (need new backup for media recovery).
09/14/2010 06:38:46 PM Completed consistency check on mail/UserName.nsf
09/14/2010 06:38:46 PM Performing consistency check on views in database mail/UserName.nsf
09/14/2010 06:38:46 PM Completed consistency check on views in database mail/UserName.nsf
09/14/2010 06:38:46 PM Database Fixup: Shutdown

Ignore the DBIID messages as they are informational only. The related information section contains information.

Resetting a user's Domino IMAP profile

If your IMAP clients cannot sync with your Start server, resetting the profile will likely correct the issue. When the server disables IMAP on a mail file, it will discard any IMAP specific information and when re-enabled, this information will be recreated.

To ensure that mail received during this process is not delivered to the client, the Domino router must be stopped. This means that the server will receive and queue messages, but will not deliver them to user inboxes until the router is restarted. After disabling the mail router remove the IMAP profile from the affected user's mail file. Once the IMAP profile is removed, re-enable it. This will regenerate several IMAP specific items. Finally, start the Domino router to deliver all queued messages.
The process and commands are outlined below. Replace UserName with the Lotus Foundations Start user name of the affected user. From within the quick console, complete the following steps:

1. Disable IMAP from the user's mail file: 

load convert -e- mail/UserName.nsf

2. Enable IMAP on the user's mail file: 

load convert -e mail/UserName.nsf

Updating IMAP summary attributes on messages

IMAP clients use a number of attributes to determine header information. These attributes are not added during the IMAP Profile enabling process. By default, any message formatted in MIME will have these attributes, and Notes rich text formatted messages will not. In some cases a message may have been modified without the router's knowledge causing the message size attribute to be incorrect. This will affect the opening of the message. In other cases, a message may not have these attributes, which means the entire message must be downloaded before header information can be displayed. To fix either scenario, use the convert utility to remove and then add IMAP summary attributes to messages.

1. Remove IMAP summary attributes: 

load convert -o mail/UserName.nsf

2. Add IMAP summary attributes:

load convert -h mail/UserName.nsf

Load the Domino Router and Log out of the Domino console

Once all of these tasks are complete, you can start the Domino router and exit out of the Domino console.

1. Reload the router. Once loaded, all queued messages will be delivered to the server's users.

load router

2. Disable the live console update option.

live off

3. Exit the console session 

done

4. Exit out of the telnet session by typing 'exit' and the Enter key until your terminal window closes (about 3 times).

Change the user's preferred format to MIME

Depending on a user's mail settings and usage, some messages may not contain certain IMAP specific attributes. By default, messages received are kept in their original formats. Messages received from the Internet are in MIME format and compatible with IMAP clients. Messages generated by Lotus Notes clients are in Notes rich text format and lack some IMAP attributes. When IMAP attributes are missing, an IMAP client must download the entire message before it can display the header information. If your users are using IMAP exclusively, changing their preferred mail format then changing their preferred format for incoming mail to MIME will tell the server to convert the message to MIME regardless of the original format. Before making the decision and changing this setting from the default, be aware that any rich text items not supported by MIME will be stripped from the message such as embedded Notes form elements.

This process is performed from within the Lotus Domino Web Administration client. To connect to the client enter, the following URL in a web browser, replacing ServerName with your server's domain name or IP address. 

https:// ServerName:4443/webadmin.nsf

Once connected to the server, you will see a login page. Enter an administrative user's credentials. You will be redirected to the webadmin client. Click the People & Groups (1) tab, open the Domino Directories tree to "By Organization" (2), and click the name of the IMAP user (3).

[/support/docview.wss?uid=swg21444157&aid=1] [/support/docview.wss?uid=swg21444157&aid=1]


The users's profile document will open. Click the "Edit document" button to edit the document. Change the "Format preference for incoming mail:" (1) drop-down menu to MIME. Click the "Save & Close" button (2). 

[/support/docview.wss?uid=swg21444157&aid=2] [/support/docview.wss?uid=swg21444157&aid=2]

Once these changes have been made, email message destined for this user will be converted to MIME type. Messages already stored in the user's mail file will remain in their original format.

RELATED INFORMATION
#Details on server log entry: 'Clearing DBIID ...' [http://www.ibm.com/support/docview.wss?uid=swg21367184]