Title: IBM DB2: Sustained traps in HADR environment. - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 After a sustained trap on primary database, indicated by ADM14013C error message, graceful TAKEOVER will not complete because suspended EDU cannot be forced. 

CAUSE
By default DB2 instance is configured for trap resiliency, that is, when segmentation violation, exception or trap happens, DB2 engine will decide whether it can continue processing or DB2 has to be shut down. If trap can be sustained, EDU (thread), which has hit the problem, will be suspended.
A sustained trap will cause:
1. FODC_Trap diagnostics being dumped.
2. ADM14013C error logged to db2diag.log, e.g:

2016-08-11-17.12.02.738830-240 I11777E618 LEVEL: Severe
PID : 17428 TID : 46913424451904 KTID : 17451<
PROC : db2sysc
INSTANCE: db2inst NODE : 000 DB : SAMPLE
APPHDL : 0-7 APPID: *LOCAL.db2inst.160811211133
AUTHID : db2inst HOSTNAME: hotellnx92
EDUID : 18 EDUNAME: db2agent (SAMPLE)
FUNCTION: DB2 UDB, RAS/PD component, pdResilienceIsSafeToSustain, probe:800
DATA #1 : String, 37 bytes
Trap Sustainability Criteria Checking
DATA #2 : Hex integer, 8 bytes
0x0000000400081000
DATA #3 : Boolean, 1 bytes
true

2016-08-11-17.12.02.760909-240 E47808E1033 LEVEL: Severe
PID : 17428 TID : 46913424451904 KTID : 17451<
PROC : db2sysc
INSTANCE: db2inst NODE : 000 DB : SAMPLE
APPHDL : 0-7 APPID: *LOCAL.db2inst.160811211133
AUTHID : db2inst HOSTNAME: hotellnx92
EDUID : 18 EDUNAME: db2agent (SAMPLE) (suspended)
FUNCTION: DB2 UDB, DRDA Application Server, sqljsTrapResilience, probe:800
MESSAGE : ADM14013CThe following type of critical error occurred: "Trap".
This error occurred because one or more threads that are associated
with the current DB2 instance have been suspended, but the nstance
process is still running. First Occurrence Data Capture (FODC) was
invoked in the following mode: "Automatic". FODC diagnostic
information is located in the following directory:

Note: ADM14011C is the error code for not sustained trap.

3. db2pdcfg will report a sustained trap:
$ db2pdcfg -trapresilience
DB2 trap resilience is enabled.
Current threshold setting : 0 ( disabled )
Number of traps sustained : 1

4. EDU which has hit the problem will be listed in db2pd -edus output as suspended, e.g.
EDU ID Kernel TID EDU Name USR (s) SYS (s)
==========================================================================
21 17454 db2loggw (SAMPLE) 0.000000 0.000000
20 17453 db2loggr (SAMPLE) 0.030000 0.000000
19 17452 db2dlock (SAMPLE) 0.000000 0.000000
18 17451 db2agent (SAMPLE) (suspended) 1.350000 0.340000
17 17442 db2resync 0.010000 0.000000
16 17439 db2ipccm 0.010000 0.000000


DIAGNOSING THE PROBLEM
After a suspended trap, DB2 engine will function properly, but suspended EDU cannot be be forced. 

As the result:
- db2stop will not complete, db2stop force must be used 
- in HADR environment, a graceful takeover will not be possible

Last message logged by primary will be an information that HADR attempts to force all applications:

2016-07-14-15.42.12.113894+120 I230584243E503 LEVEL: Info
PID : 6210 TID : 140682354222848 PROC : db2sysc 0
INSTANCE: db2inst NODE : 000 DB : SAMPLE
APPHDL : 0-252 APPID: *LOCAL.DB2.160714134212
HOSTNAME: db2host
EDUID : 280 EDUNAME: db2agent (SAMPLE) 0
FUNCTION: DB2 UDB, High Availability Disaster Recovery, hdrTakeoverForceApp, probe:42032
DATA #1 : String, 37 bytes
Waiting for all user appls forced off

but because suspended agent cannot be forced, TAKEOVER will eventually timeout with following message logged on standby:

2016-07-14-15.52.12.693010+120 I93886481E597 LEVEL: Error
PID : 5986 TID : 140309803558656 PROC : db2sysc 0
INSTANCE: db2inst NODE : 000 DB : SAMPLE
HOSTNAME: db2host
EDUID : 56 EDUNAME: db2hadrs.0.0 (SAMPLE) 0
FUNCTION: DB2 UDB, High Availability Disaster Recovery, hdrEduAcceptEvent, probe:20240
DATA #1 : <preformatted>
Standby has not received data from primary for 601 seconds. Check the status of the primary. Aborting TAKEOVER.
hdrCurrentTime 1468504332 hdrLastLogRecvTime 1468503731 hdrGracefulTkTimeout 600


RESOLVING THE PROBLEM
After a suspended trap on primary, TAKEOVER BY FORCE must be used in order to complete the failover.

RELATED INFORMATION
 Recovering from sustained traps [http://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.5.0/com.ibm.db2.luw.admin.trb.doc/doc/t0055494.html]