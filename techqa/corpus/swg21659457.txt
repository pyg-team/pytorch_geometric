Title: IBM 使用parallel forEach循环的流程常遇到死锁问题 - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

问题（摘要）
 当BPEL流程中使用到很多parallel forEach循环,运行过程中有可能常出现由于死锁造成的TransactionRolledbackLocalException错误。 

症状
SystemOut.log会在问题发生时候提示死锁错误和交易回滚的信息： 

[8/25/13 19:19:29:123 IDT] 0000005c ExceptionUtil E CNTR0020E: EJB 
threw an unexpected (non-declared) exception during invocation of method
"invokeProcessSessionBean" on bean 
"BeanId(BPEContainer_WPS1.AppTarget#bpecontainer.jar#CScopeProvider, 
null)". Exception data: javax.ejb.TransactionRolledbackLocalException: 
; nested exception is: com.ibm.bpe.api.ProcessError 
com.ibm.bpe.database.TomSQLException: com.ibm.db2.jcc.b.pn: DB2 SQL 
Error: SQLCODE=-911, SQLSTATE=40001, SQLERRMC=2, DRIVER=3.52.110 
at com.ibm.bpe.database.ProcessInstanceB.get(ProcessInstanceB.java:151)
at com.ibm.bpe.database.Tom.getProcessInstanceB(Tom.java:10931) 
at com.ibm.bpe.database.ActivityInstanceB.getProcessInstanceB(ActivityInsta
nceB.java:1556) 
at com.ibm.bpe.engine.BpelActivityKindComplexBegin.doActivate(BpelActivityK
indComplexBegin.java:163) 
at com.ibm.bpe.engine.BpelActivityStateInactive.activateOrSkip(BpelActivity
StateInactive.java:308) 
at com.ibm.bpe.engine.BpelEngineCore.continueControlLink(BpelEngineCore.jav
a:342) 
... 
Caused by: com.ibm.bpe.api.ProcessError 
... 30 more 
Caused by: com.ibm.bpe.database.TomSQLException: com.ibm.db2.jcc.b.pn: 
DB2 SQL Error: SQLCODE=-911, SQLSTATE=40001, SQLERRMC=2, DRIVER=3.52.110
at com.ibm.bpe.database.ProcessInstanceB.get(ProcessInstanceB.java:151)
at com.ibm.bpe.database.Tom.getProcessInstanceB(Tom.java:10931) 
at com.ibm.bpe.database.ActivityInstanceB.getProcessInstanceB(ActivityInsta
nceB.java:1556) 
at com.ibm.bpe.engine.BpelActivityKindComplexBegin.doActivate(BpelActivityK
indComplexBegin.java:163) 
at com.ibm.bpe.engine.BpelActivityStateInactive.activateOrSkip(BpelActivity
StateInactive.java:308) 
at com.ibm.bpe.engine.BpelEngineCore.continueControlLink(BpelEngineCore.jav
a:342) 
at com.ibm.bpe.engine.BpelContinueLinkMessage3.execute(BpelContinueLinkMess
age3.java:92) 
at com.ibm.bpe.engine.BpelEngine.onMessage(BpelEngine.java:1464) 
at com.ibm.bpe.framework.sca.ProcessImplementationHandler.bpc_onMessage(Pro
cessImplementationHandler.java:595) 
at com.ibm.bpe.framework.sca.ProcessImplementationHandler.handleScaParamete
rWrapper(ProcessImplementationHandler.java:256) 
at com.ibm.bpe.framework.sca.ProcessImplementationHandler.processMessage(Pr
ocessImplementationHandler.java:155) 
at com.ibm.ws.sca.internal.message.impl.MessageDispatcherImpl.processMessag
eWithPCI(MessageDispatcherImpl.java:715) 
at com.ibm.ws.sca.internal.message.impl.MessageDispatcherImpl.processMessag
e(MessageDispatcherImpl.java:1167) 
at com.ibm.ws.sca.internal.proxy.impl.ProxyInvocationHandlerImpl.invoke(Pro
xyInvocationHandlerImpl.java:781) 
at $Proxy87.processMessage(Unknown Source) 
at com.ibm.bpe.framework.sca.ProcessSessionBean.runInComponentContext(Proce
ssSessionBean.java:1553) 
at com.ibm.bpe.framework.sca.ProcessSessionBean.bpc_onMessage(ProcessSessio
nBean.java:2288) 
... 29 more 


原因
在parallel forEach循环结束时定义了一个小的isolated scope，这样造成两个线程同时进去这个isolated scope时,分别尝试去获得特定的锁且同时去读取流程实例和更新同一个变量的时候，则会产生死锁。




诊断问题
检查BPEL流程发现isolated scope功能使用不当的问题。isolated scope功能一般只在多个变量需要被更按照不同顺序更新时候才启用，scope中仅有一个变量时候则不应使用isolated类型。 

 


解决问题
将BPEL流程修改为non-isolated scope帮助避免了死锁的发生。

相关信息
#An US English translation is available [http://www.ibm.com/support/docview.wss?uid=swg21657803]