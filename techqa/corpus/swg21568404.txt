Title: IBM WebSphere DataPower and ITCAM SOA - WSM agent pending records - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 The command 'show wsm-agent-status' from the DataPower command line shows the current status of the Web Services Management (WSM) buffer. The WSM buffer holds records in preparation for collection by ITCAM SOA. Here is an example of the 'show wsm-agent-status' command:

Active Subscribers: 1
Polled Subscribers: 0
Records Seen: 1049
Records Lost: 0
Pending Records: 251
Complete Records: 87
Memory Used: 63 kbytes

Complete Records are records ready to be collected. 

Pending Records are records for which the request, but not the response, has been processed.

This same status is available in the DataPower Web GUI and via requests sent over SNMP and the DataPower XML Management interface. 

SYMPTOM
A low Pending Record count (less than 50 or 100) may not be a concern, because it simply indicates requests for which responses are still in flight. 

A higher count in the Pending Records may indicate a loop hole in the DataPower configuration where responses are not being captured for the WSM processing. A high count indicates that the number of pending records has probably been increasing over time. 

If the Pending Record count continues to increase, it will eventually approach the maximum amount of records allowed in the WSM buffer (see Resolving the Problem). When the WSM buffer is full, or nearly full, of pending records, ITCAM SOA data collection will stop because there is no room in the buffer for Complete records to be recorded.

CAUSE
Pending records are commonly caused by error or fault transactions where there is no WSM processing configured in DataPower. Pending records can also be caused when a Web Service Proxy request rule has included an action to skip backside processing. 



DIAGNOSING THE PROBLEM
Review your configuration for the root cause for pending records, monitor the WSM agent status to confirm the Pending Record count is increasing over time and test individual services to diagnose this issue. 


Review the DataPower configuration for: 

 * Web Service Proxies or Multi-Protocol GateWays (MPGWs) with no error rule. Add an error rule to any service being monitored by ITCAM SOA so that error responses are properly processed for ITCAM SOA data collection.

 * MPGWs with an error rule, but no action that does a dp:wsm-agent-append() to complete the pending WSM record. MPGWs require additional stylesheets for ITCAM SOA monitoring. Pending records can result when the stylesheets have been configured on a request and a response rule, but not on an error rule.

 * Web service proxies where the request rule contains an action to skip backside processing. A stylesheet must be added to the web service proxy processing policy to modify the current WSM record to specify that processing is one-way. 

Monitor WSM agent status 
It may be possible to isolate test cases where pending records are created by testing service transactions while closely monitoring the WSM agent status. Monitoring WSM status is most easily done in an SSH session where the Command Line Interface (CLI) command can be used: 

show wsm-agent-status 

The most effective way to monitor WSM agent status is with a script that executes this CLI command because a script can monitor the WSM agent status frequently enough to determine when pending records are created and a script can save output easily to a file. 

To use a script such as check_wsm_status.sh (attached) that monitors the WSM Agent status using the DataPower Command Line Interface (CLI): 

check_wsm_status.sh [/support/docview.wss?uid=swg21568404&aid=2]check_wsm_status.sh [/support/docview.wss?uid=swg21568404&aid=1] 
 *  Log on to a Unix server which has access to the DataPower appliance where pending records are an issue. Modify the script so that it specifies: DataPower host name, userid, password, and domain name. Run the script manually. Review the output to ensure it shows the WSM agent status and time properly. Schedule the script in Unix cron to run two or three times day. Review the output to see how fast the Pending Records are growing. Use Unix grep or edit tools to look at only the Local Time and Pending Record count, for example: egrep "Local Time|Pending" might yield this output:
   
   wsm_script_output.txt: Local Time: Thu May 3 21:53:37 wsm_script_output.txt: Pending Records: 118 wsm_script_output.txt: Local Time: Thu May 3 21:58:38 wsm_script_output.txt: Pending Records: 136 wsm_script_output.txt: Pending Records: 134 wsm_script_output.txt: Pending Records: 136 wsm_script_output.txt: Local Time: Thu May 3 21:58:51 wsm_script_output.txt: Pending Records: 135 wsm_script_output.txt: Local Time: Thu May 3 22:04:51 wsm_script_output.txt: Pending Records: 190 
 * 
 *  If the script is running successfully twice a day, consider scheduling it to run more frequently, for example, once an hour, to increase the precision with which pending record issues can be identified. 

Compare WSM agent status with errors in the log 
If the DataPower best practice of off-box logging for DataPower, for example, to a syslog server, has been implemented, look for logs during the time when Pending Records are increasing to correlate the increase in Pending Records with something out of the ordinary in the DataPower logs.  * 
   The pending record history above shows a large amount of pending records created between 21:58 and 22:04. An example of an error that could contribute to the failure to complete pending records would be if execution of the stylesheet that does WSM processing aborted at 21:59:

 * 


Test services most exposed to creating pending records 
Check and test the services set up for ITCAM SOA monitoring based on exposure to the usual cause of exposure to the typical root cause items listed above. For example, a Multi-Protocol Gateway (MPGW) without error handling or with conditional processing in the error rule, is a likely cause of Pending Records. Review any MPGW processing policy to see if it contains an error rule to handle issues such as backend connection failures. Look to see if that error rule handles WSM processing. 

To test: 
 * In a development environment, modify a MPGW configuration to specify an invalid backend address or test a known error condition. 
 * Send a request to the MPGW service. 
 * Look at the WSM agent status.  * If the Complete Record count increased by one, then the processing policy correctly handled the backend connection failure and created a complete record for ITCAM SOA data collection. 
    * If only the Pending Record count increased, then the processing policy could be improved to handle a backend connection failure more thoroughly for WSM processing.
   
   

RESOLVING THE PROBLEM
Modify the DataPower configuration to include error rules for services being monitored by ITCAM SOA. 

If data collection has stopped because the number of pending records is nearing or has reached the maximum consider these steps: 

 * Reload the appliance to reset the WSM agent status, clearing the pending records. 
 * Increase the maximum number of records allowed in the WSM buffer.  * This can be done in the DataPower Web GUI by selecting Objects > Web Services Management. 
    * The default Maximum Record Size [https://l2dp15.rtp.raleigh.ibm.com:9090/configure/WebServicesAgent?navFrame=false#] is 3000 records. 
    * This maximum helps protect the appliance transaction processing resources, particularly memory resources, from being impacted by WSM processing. 
    * It is a common practice to increase this maximum when transaction volumes require it or while working on a data collection issue. 
    * To ensure that increasing the maximum is not detrimental to the appliance, monitor the memory usage on the appliance. 
    * Increasing the WSM Maximum Record size is not expected to be a measurable impact to the overall memory usage on the appliance. This can be confirmed by monitoring memory before and after changing the WSM configuration. 
   
   

RELATED INFORMATION
#DataPower off-device logging: a configuration example [http://www-01.ibm.com/support/docview.wss?uid=swg21269136]