Title: IBM Content Platform Engine upgrade fails if database replication is enabled - United States

Text:
upgrade; distributed transaction TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 You receive 'Cannot use SAVE TRANSACTION within a distributed transaction.' and 'J2CA0027E: An exception occurred while invoking rollback on an XA Resource Adapter
from DataSource' errors while upgrading Content Engine. 

CAUSE
The Content Engine upgrade process must alter tables during a transaction. Altering tables during a transaction is not allowed when SQL replication is enabled.

ENVIRONMENT
Microsoft SQL Server 

WebSphere Application Server


DIAGNOSING THE PROBLEM
You see the following errors in the logs during an upgrade to CPE 5.2 or later. 


SystemOut Log:
Error code is: XAER_NOTA (-4). Exception is: The function ROLLBACK: has failed. The status is: -4. Error: "*** SQLJDBC_XA DTC_ERROR Context: xa_rollback, state=1, StatusCode:-4 (0xFFFFFFFC) ***" [12/23/13 13:11:53:760 CST] 00000020 XATransaction E J2CA0027E: An exception occurred while invoking rollback on an XA Resource Adapter from DataSource FNTargetDSXA, within transaction ID {XidImpl:formatId(57415344), gtrid_length(36), bqual_length(54), data (0000014320ded6f500000002000046eff106b992caa73daad76fe5a4be85d5c1bcd084f60000014320ded6f500000002000046eff106b992caa73daad76fe5a4be85d5c1bcd084f6000000010000000000000000000000000001)} : javax.transaction.xa.XAException: The function ROLLBACK: has failed. The status is: -4. Error: "*** SQLJDBC_XA DTC_ERROR Context:xa_rollback, state=1, StatusCode:-4 (0xFFFFFFFC) ***" 
at com.microsoft.sqlserver.jdbc.SQLServerXAResource.DTC_XA_Interface(SQLServerXAResource.java:545)
at com.microsoft.sqlserver.jdbc.SQLServerXAResource.rollback(SQLServerXAResource.java:713) 

P8 Error Log:
FNRCD0009E - ERROR ObjectStoreUpgrade(OSName) Exception encountered with upgrader task, attempt #1
com.filenet.api.exception.EngineRuntimeException: FNRCD0009E: DB_ERROR: The database access failed with the following error: ErrorCode 627, Message 'Cannot use SAVE TRANSACTION within a distributed transaction.' ObjectStore: "OSName", SQL: ""ALTER TABLE DocVersion ADD recovery_item_id uniqueidentifier "" 
at com.filenet.engine.dbpersist.DBMSSQLContext.throwEngineException(DBMSSQL Context.java:339)
...


RESOLVING THE PROBLEM
Disable SQL Server Replication before performing upgrades of Content Manager products.