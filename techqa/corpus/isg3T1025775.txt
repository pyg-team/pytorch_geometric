Title: IBM Shared Ethernet Adapter (SEA) Enhancements in PowerVM/VIOS V2.2.5 and Network Switch Maintenance/Reboot - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Question

What are the Shared Ethernet Adapter (SEA) Enhancements in PowerVM/VIOS V2.2.5 and how do those enhancements behave when a Network Switch under Maintenance/Reboot?


CAUSE
This technote touches upon major Shared Ethernet Adapter (SEA) Enhancements in PowerVM/VIOS V2.2.5 and describes about the precautionary measures related to the enhancements when you perform network Switch maintenance and reboot. See Related URLs or contact your local IBM Support Representative for more details.

RESOLVING THE PROBLEM
Answer 

I. Major Shared Ethernet Adapter (SEA) Enhancements in PowerVM/VIOS V2.2.5

The new SEA features which enhance the administrative control over the failover system, as well as to provide best adapter state transition in the event of incidents. Administrators could make use of these enhancements by using new SEA attributes - fb_delay, noauto_failback, health_time, link_time. Click below link to learn more about these attributes of SEA. https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/Power%20Systems/page/Shared%20Ethernet%20Adapter%20(SEA)%20Enhancements%20in%20PowerVM%202.2.5 [https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/Power%20Systems/page/Shared%20Ethernet%20Adapter%20(SEA)%20Enhancements%20in%20PowerVM%202.2.5]


II. Effect of Network Switch Reboot on SEA Enhancements

The new SEA enhancements in V2.2.5 introduced new attributes preventing immediate failback after a SEA failover / recovery event. The attributes introduced and covered during our tests are fb_delay, health_time & link_time. These are dynamic attributes that can be changed at run time, and the new value would govern the time delay in the subsequent failover/failback events. All new attributes are set to their default value fb_delay:30 health_time:600 link_time:60 (all in seconds) and noauto_failback: disabled , but can adjust with in the following ranges:

health_time range: 60...18000
link_time range: 10…3600
fb_delay range: 30…90
noauto_failback: enabled / disabled 

The enhancements introduced in VIOS V2.2.5 increase the total time before a failed SEA adapter initiates its failback. It is important to understand that these attributes’ behavior at higher priority SEA would wait certain period of time until failback, thus assuming the primary SEA and take over the network traffic. So in a redundant Network Switch environment, Administrators would need to wait for a total time (link_time + health_time + fb_delay) in seconds after the first switch maintenance/reboot before performing the second switch maintenance/reboot. The wait period is applied for health_time attribute is from the last failure recovery event and for the link_time attribute, it is from last link up event.

To disable the link check as part of health check, install the APAR IV97991 (http://www-01.ibm.com/support/docview.wss?uid=isg1IV97991 [http://www-01.ibm.com/support/docview.wss?uid=isg1IV97991] ) and set the value of health_time attribute to 1 sec using the chdev command.

Following the sequence of steps are to illustrate the SEA enhancement behavior with the versions 2.2.5.0 (or above) and the below versions during Network Switch reboot. We used three different setups, (i) Primary and Backup VIOS running VIOS V2.2.3.3 on POWER7 (ii) Primary and Backup VIOS running VIOS V2.2.5.10 on POWER7 & POWER8. 2 Cisco Nexus 5548 network switches that redundantly connected to all VIO Servers for this exercise. 

Test 1
a. Both the network switches are up and network traffic using both the switches
b. Rebooting the network switch 1
c. SEA failover and continue the network traffic using the switch 2. No network disruption
d. As soon as the network switch 1 comes back up, rebooting the network switch 2
e. Network outage occurred on the clients that hosted on VIOS V2.2.5.10 and no network
disruption on the clients that hosted on VIOS V2.2.3.3

Test 2
a. Both the network switches are back up and network traffic using both the switches
b. Rebooting the network switch 1
c. SEA failover and continue the network traffic using the switch 2. No network disruption
d. Waited for a total time (link_time + health_time + fb_delay) in seconds that assigned to
VIOS V2.2.5.10, after the network switch 1 comes back up
e. Rebooting the network switch 2
f. No network outage on the clients that hosted on either VIOS V2.2.5.10 or VIOS V2.2.3.3

For the Test 1, when the links came back UP for switch 1, SEAs initially move into UNHEALTHY state. The SEA doesn't move into PRIMARY/BACKUP state right away. It is allowed to move into PRIMARY/BACKUP if the links have been up for the link_time, health_time and fb_delay. So rebooting the network switch 2 before necessary wait period after the network switch 1 comes back up, resulted in network outage. SEA enhancement is implemented in VIOS V2.2.5.0 or above and that is the reason no impact on the clients that hosted on VIOS V2.2.3.3.

For the Test 2, there was a necessary wait period before rebooting the network switch 2. So there was no network outage on the clients.

One way to reduce the impact (network outage in this specific case) is to adjust link_time, health_time and fb_delay to minimum values.