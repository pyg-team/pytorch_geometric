Title: IBM Error 'Not enough memory' when Refreshing (F9) Excel link report - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 User launches Excel. User opens Excel link report (.XLS spreadsheet file). User clicks 'Controller - Logon'. User logs onto Controller. User clicks on 'Controller - Reports - Refresh F9'. Report takes a few minutes, but works OK.
Afterwards, user *again* clicks on 'Controller - Reports - Refresh F9'. After a few minutes, an error message appears. If the user clicks OK, another error messages appears. If the user clicks OK, another error messages appears... 
NOTE: 
* For Office 2000, the problem may appear after only a few successive refreshes (e.g. 2) 
* For Office XP, the problem may appear after only a few more successive refreshes (e.g. 5) 
* For Office 2003, the problem may require multiple successive refreshes (e.g. 21) 

SYMPTOM
The error messages are different, depending on which version of Excel the client PC is using: 

 
** Excel 2000 **

Error #1, 2, 3, ....10: 

 * 
 * 
 * Not enough memory
 * 
 * 
 * 


Error #11:  * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 


Error #12:  * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 


Error #13:  * 
 * 
 * Not enough system resources to display completely
 * 
 * 
 * 


Error #14, 15, 16...  * 
 * 
 * 
 * 
 * 


Error #17:  * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 


** Excel XP (2002) ** 

Microsoft Excel 
Excel cannot complete this task with available resources. Choose less data or close other applications. 
OK 

** Excel 2003 ** 

IBM Cognos 8 Controller Link 
Exception of type 'System.OutOfMemoryException' was thrown. 
OK 

Cognos 8 Controller Link 
Out of memory 
OK 

Microsoft Visual C++ Runtime Library 
Runtime Error! 
Program: C:\Program Files\Microsoft Office\Office11\Excel.exe 
This application has requested the Runtime to terminate it in an unusual way. 
Please contact the application's support team for more information 
OK 

CiceroUIWndFrame: Excel.exe - Application error 
The exception unknown software exception (0x40000015) occurred in the application at location 0x54b48b37. 
Click on OK to terminate the program 
Click on CANCEL to debug the program 
OK Cancel 

TIP: There also may be entries inside the Event Log on client PC, similar to:  * Event Type: Error
 * 
 * Event Source: Application Error
 * 
 * Event Category: (100)
 * 
 * Event ID: 1000
 * 
 * Date: 14/03/2008
 * 
 * Time: 16:25:16
 * 
 * User: N/A
 * 
 * Computer: SERVERNAME
 * 
 * Description:
 * 
 * Faulting application EXCEL.EXE, version 11.0.6560.0, faulting module pdm.dll, version 8.0.50727.42, fault address 0x00028b37
 * 



CAUSE
There are several possible causes/scenarios for errors similar to these. 

 * TIP: For more examples, see separate IBM Technote #1406746.


This IBM Technote shall deal specifically with the scenario where Microsoft Excel has run out of System Resources. 

Again, there are several possible causes for this: 

Cause #1 - The version of Excel being used is too old to support the complexity of the spreadsheet. 
Each instance of Microsoft Excel as fixed limit of 'internal heap space' memory. Each instance is also limited to 32,760 source cells when you perform a smart fill operation. When you copy or fill large sections of a worksheet, one or both of these limitations may affect the result.  * Excel 2000 - memory limit is 64 MB 
 * Excel 2002 (Excel XP) - memory limit is 128 MB 
 * Excel 2003 - memory limit is 1 Gb (1 Gigabtye) 
 * Excel 2007 & Excel 2010 (32-bit) - memory limit is 2 Gb (2 Gigabtyes)


Cause #2 - The Excel spreadsheet is too complex to be run on *any* version of Excel. 
Cognos Controller is a 32-bit product, and therefore it can only use 32-bit versions of Excel.  * Therefore, it will never be able to use more memory than the 32-bit limit (2Gb).


If the spreadsheet is extremely complex then Excel can run out of memory in its 'key buffers'.  * For example, Controller creates entries (and duplicates) in the key buffer when running fGetVal functions.  * Therefore, running too many of these fGetVals may cause out of memory errors.
   
   
 * One possible reason for why too many fGetVals are being run could be that the design of the spreadsheet is non-optimal  * Inefficiently-designed spreadshseets cause fGetVal functions to be unnecessarily repeated (executed more than once), which therefore exacerbates the problem.
   
   

ENVIRONMENT
The problem may only be seen when user(s) run/refresh a very large spreadsheet report.



RESOLVING THE PROBLEM
Fix: 

Depending on the customer's exact environment/needs, it may be necessary to perform one or both of the following: 

 
Cause #1
Upgrade client PC to a later version of Excel (which has a much larger memory capacity than previous version). 

 * TIP: Make sure that the new version of Excel is 32-bit, and is supported for your version of Controller (see Technote #7014433).

Cause #2 

Simplify (re-design / optimise) the spreadsheet to reduce the number of formulae (for example reduce the number of times each fGetVal gets processed). 

 * TIP: For a long list of optimisation techniques, see Method #1 of separate IBM Technote #1347497 (link below).


 * 
 *  In other words, data should only be updated on *one sheet only*, so that all data updates are executed simultaneously (i.e. ONCE). After this data is updated, then the other sheets should reference that data sheet (*rather than* having fGetVals on multiple sheets). 
 * 
 * a.datasheet
 * 
 * b.report
 * 
 * c.report
 * 
 *  If you do not obey this rule (in other words, you have fGetVal formulae inside 2 or more sheets, and make references between sheets) then the same fGetVal function(s) may get executed 2 or more times each! This is caused by the way that Microsoft Excel's decision tree works. 

Workaround:
There are several workaround that can help:


 * Workaround #1 - Split the large (single) report into several (separate) reports 

 * Workaround #2 - Use F10 instead of F9  * F10 refreshes only the current (and referenced) worksheet(s) 
    * NOTE: You would need to use F10 multiple times (once for each separate sheet).
   
   
 * Workaround #3 - Use manual calculation in the Excel-link workbook  * After doing this, you can 'Select All' worksheets in the workbook and then refresh with F9. 
   
   

RELATED INFORMATION
#1347360 - Error 'Attempted to read or write protected m [http://www.ibm.com/support/docview.wss?uid=swg21347360]
"Not enough memory" error messages when you copy formul [http://support.microsoft.com/kb/313275]
Proven Practices - IBM Cognos documentation [http://www.ibm.com/developerworks/data/library/cognos/cognosprovenpractices.html]
1406746 - Troubleshooting 'OutOfMemoryException' errors [http://www.ibm.com/support/docview.wss?uid=swg21406746]
7014433 - Cognos Controller Software Environments [http://www.ibm.com/support/docview.wss?uid=swg27014433]
1347497 - Controller Excel Report Performance Tips [http://www.ibm.com/support/docview.wss?uid=swg21347497]




HISTORICAL NUMBER
 1038666