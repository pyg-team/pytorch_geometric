Title: IBM Required BPEDB database definition updates for UTF-8 support and startup failure resolution for the HTM_PredefinedTaskMsg_xxxx and HTM_PredefinedTasks_xxxx applications. - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 If Business Process Choreographer is configured in a WebSphere Process Server profile with DB2 UDB for i5/OS as the database on an IBM i system, the predefined applications HTMPredefinedTaskMsg and HTMPredefinedTasks may fail to start up. Manual instructions are also provided for required BPEDB database definition updates for UTF-8 support to prevent future data loss for any workflow related applications. 

SYMPTOM
The predefined applications HTM_PredefinedTaskMsg_xxxx and HTM_PredefinedTasks_xxxx might not start and the SystemOut.log file shows an exception like the following: 

[6/19/08 16:21:48:748 UTC] 0000000a ContainerImpl E WSVR0501E: Error creating component null [class com.ibm.ws.runtime.component.ApplicationServerImpl]
com.ibm.ws.exception.RuntimeWarning: com.ibm.ws.exception.RuntimeWarning: could not start application HTM_PredefinedTaskMsg_V612_i5bch1b13p1_ProcSrv01_ProcSrv01 because of filter com.ibm.task.mbean.HumanTaskManager@38663866
at com.ibm.ws.runtime.component.ApplicationMgrImpl.startApplications(ApplicationMgrImpl.java:823)
at com.ibm.ws.runtime.component.ApplicationMgrImpl.start(ApplicationMgrImpl.java:564)
at com.ibm.ws.runtime.component.ContainerImpl.startComponents(ContainerImpl.java:977)
at com.ibm.ws.runtime.component.ContainerImpl.start(ContainerImpl.java:673)
at com.ibm.ws.runtime.component.ApplicationServerImpl.start(ApplicationServerImpl.java:191)
at com.ibm.ws.runtime.component.ContainerImpl.startComponents(ContainerImpl.java:977)
at com.ibm.ws.runtime.component.ContainerImpl.start(ContainerImpl.java:673)
at com.ibm.ws.runtime.component.ServerImpl.start(ServerImpl.java:526)
at com.ibm.ws.runtime.WsServerImpl.bootServerContainer(WsServerImpl.java:192)
at com.ibm.ws.runtime.WsServerImpl.start(WsServerImpl.java:140)
...

Depending on your deployment target, the applications will be named:
HTM_PredefinedTask_V<version>_<node_name>_<server_name>
HTM_PredefinedTask_V<version>_<cluster_name>
and
HTM_PredefinedTaskMsg_V<version>_<node_name>_<server_name>
HTM_PredefinedTaskMsg_V<version>_<cluster_name>
respectively.


CAUSE
Both the HTMPredefinedTaskMsg and the HTMPredefinedTasks application need to store language dependant messages in certain database tables in the database collection used by Business Process Choreographer. The character columns in the tables where the language dependent messages are stored inherit their CCSID value from the CCSID of the job that was executed to create the tables. In certain cases it is not possible to convert the language dependent messages to the CCSID of the database column in which they need to be stored. In such cases, an SQLException is thrown while trying to store the messages and it results in the applications failing to start.

Database records may be truncated when table columns are later altered with UTF-8 since an NLS character requiring a single byte may now require multiple bytes. It is advised then to immediately perform these schema definition update steps before production data is inserted into the BPEDB schema.
This problem occurs if the BPEDB schema is located on IBM i5/OS.
The WBI 6.1.2 process server may either be running locally on the same IBM i machine, remotely on IBM i, or remotely on another multiplatform machine.


RESOLVING THE PROBLEM
If you have an existing BPEDB schema that is already in production then after applying the iFix for APAR IZ25593 run the <install_root>/dbscripts/ProcessChoreographer/DB2iSeries/upgradeSchema610.sql script. The script will tag the necessary character columns with CCSID 1208 which is the UTF-8 codepage that can represent language dependent character strings correctly. 


IMPORTANT: If the DataSource for accessing your BPEDB database collection is configured to use the IBM Toolbox for Java JDBC driver, follow the instructions at the bottom of this section before you proceed with the following steps. 

Steps to perform: 

 1.  Apply iFix IZ25593 - "HTM_PredefinedTaskMsg_V612_xxxx and HTM_PredefinedTasks_V612_xxxx applications fail to start when the BPEDB database is located on IBM i". This will update the <install_root>/dbscripts/ProcessChoreographer/DB2iSeries/upgradeSchema610.sql script. See iFix download ftp://ps.boulder.ibm.com/ps/products/bpc/612/ [ftp://ps.boulder.ibm.com/ps/products/bpc/612/]. 
 2.  Make sure that you are using a user profile with *ALLOBJ and *SECADM special authorities. 
 3.  Back up the Business Process Choreographer database. 
     Run the following CL commands from an i5/OS command window:  1. CRTSAVF(QGPL/BPEDBBAK) 
      2. SAVLIB LIB(<BPEDB COLLECTION NAME>) DEV(*SAVF) SAVF(QGPL/BPEDBBAK) PVTAUT(*YES)
     
     
 4.  Copy the <install_root>/dbscripts/ProcessChoreographer/DB2iSeries/upgradeSchema610.sql to the IBM i system on which the database is hosted. 
 5.  Map a windows drive to the IBM i system and navigate to the location where the script was copied in the previous step. 
 6.  Edit the script and replace all occurrences of the @SCHEMA@ placeholder in the SQL statements with your Business Process Choreographer database collection name. 
 7.  Set up the IBM i system environment to automatically reply to any inquiry messages sent when running the ALTER table commands (inquiry messages typically require an interactive user response). 
 8.  Open an iSeries command line window. To automatically reply to any inquiry message enter the following two commands from a command line window:  1. CHGJOB INQMSGRPY(*SYSRPYL)
         (enter DSPJOB, select option 2 "Display job definition attributes " to see the original value for the "Inquiry message reply " value) 
      2. ADDRPYLE SEQNBR(nn) MSGID(CPA32B2) CMPDTA(*NONE) RPY(I)
         where nn is an unused sequence number in the System reply list.
     
     
 9.  Run the modified upgradeSchema610.sql SQL script.  1. Start a QShell session. Type STRQSH on a command line window and press Enter. 
      2. Change the directory to the location in the file system where the upgradeSchema610.sql script is located. 
      3. Execute the following command in QShell:
         db2 -tvf upgradeSchema610.sql
         
         You should see messages like the following:
         EXECUTING: ALTER TABLE <collection>.IMAIL_T ALTER BODY_TEXT SET DATA TYPE CLOB(4096) CCSID 1208
         **** CLI ERROR *****
         SQLSTATE: 01593
         NATIVE ERROR CODE: 460
         Truncation of data may have occurred for ALTER TABLE of IMAIL_T in <collection>.
         DONE!
         These messages indicate that the ALTER TABLE statements have been processed successfully.
     
     
 10. If there are any errors, or a failure is indicated in your database output, fix the reported errors and retry the previous step. 
 11. When the script completes successfully, enter the following CL command on the iSeries command line window:
     WRKRPLYLE
     This will list all the reply list entries. To restore the original "Inquiry message reply" value, select the reply that was added in step 8.2 above, and delete the entry from the System reply list:
     CHGJOB INQMSGRPY(< original value >)
     

Users of the IBM Toolbox for Java JDBC driver 
Note: Unlike the Native JDBC driver, the IBM Toolbox for Java JDBC driver does not throw the data truncation SQL exception during server startup. However, the database tables might contain corrupted data with respect to the HTMPredefinedTaskMsg and HTMPredefinedTasks applications. 
You must do the following to clear the database tables of this corrupted data.  1. Uninstall the HTMPredefinedTaskMsg and HTMPredefinedTasks applications using the administrative console. You might have to stop any running tasks before you can uninstall the applications. 
 2. Run the upgradeSchema610.sql script as described in the section above. 
 3. Reinstall the HTMPredefinedTaskMsg and HTMPredefinedTasks applications using the administrative console.


Users who are upgrading the WPS 6.1 product to the WBI 6.1.2 level 
After the WPS 6.1 product has been refreshed to the WBI 6.1.2 level and before starting the process server and BFM/HTM container applications perform the following steps for an automatic BPEDB schema upgrade: 
 1. Perform steps 1 and 2 listed here from above:  1. Make sure that you are using a user profile with *ALLOBJ and *SECADM special authorities. 
     2. Back up the Business Process Choreographer database. Run the following CL commands from an i5/OS command window:
        CRTSAVF(QGPL/BPEDBBAK)
        SAVLIB LIB(<BPEDB COLLECTION NAME>) DEV(*SAVF) SAVF(QGPL/BPEDBBAK) PVTAUT(*YES)
    
    
 2. Apply iFix for APAR IZ25593. See ftp://ps.boulder.ibm.com/ps/products/bpc/612/ [ftp://ps.boulder.ibm.com/ps/products/bpc/612/]. 
 3. Update the authentication alias user id for the "BPCdata source" datasource and grant it *ALLOBJ special authority.  1. Run following CL command :
        DSPUSRPRF USRPRF(<BPCdata source authentication alias user id>)
        Note any special authorities. 
     2. Run CL command :
        CHGUSRPRF USRPRF(<BPCdata source authentication alias user id>) SPCAUT(*ALLOBJ) 
    
    
 4. Start the stand-alone profile process server. If you have an ND environment start the deployment manager and node agents. Then start the clusters and servers that have a configured BFM/HTM container.
    In SystemOut.log look for the following messages: 
    TomDbMigratio I CWWBB0612I: Database migration started 610 to 612/0.
    TomDbMigratio I CWWBB0613I: Database migration: completed successfully 610/1 to 612/0. 
 5. After the BPEDB schema upgrade completes successfully restore the authentication alias user id special values to their original value.
    Run CL command :
    CHGUSRPRF USRPRF(<BPCdata source authentication alias user id>) SPCAUT(<original special authorities>)

RELATED INFORMATION
 iFix download page [ftp://ps.boulder.ibm.com/ps/products/bpc/612/]