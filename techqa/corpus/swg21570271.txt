Title: IBM Using WebSphere DataPower to Set JMS Properties in the MQRFH2 Header - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 I am using a stylesheet to set JMS specific data in the MQRFH2 header and sending to a backend MQ Series queue. The message does not contain MQRFH2 header. 

CAUSE
Not setting the format field of the MQMD header with correct string.

RESOLVING THE PROBLEM
The MQMD.Format must be set with a string as "MQHRF2" to indicate that the next header to follow is MQRFH2. If the format field of MQMD is not set correctly, the message will not conain MQRFH2 header. 

The MQRFH2 (Version 2 header) carries JMS-specific data and consistes of two parts, a fixed portion and a variable portion.

Fixed portion is modelled on the standard WebSphereÂ® MQ header pattern and consists of the following fields: StrucId, Version, StrucLength, Total length of MQRFH2 including the NameValueData fields, Encoding, CodedCharSetId, Format, Flags, NameValueCCSID.

The variable portion follows the fixed portion and contains a variable number of MQRFH2 message service folders. Each folder contains a variable number of elements or properties. The MQRFH2 headers created by JMS can contain up to three folders: The <mcd> folder which contains properties that describe the shape or format of the message. For example, the Msd property identifies the message as being Text, Bytes, Stream, Map, Object, or null. This folder is always present in the JMS MQRFH2 header. The <jms> folder is used to transport JMS header fields, and JMSX properties that cannot be fully expressed in the MQMD. This folder is always present in a JMS MQRFH2. The <usr> folder is used to transport any application-defined properties associated with the message. This folder is present only if the application has set some application-defined properties. For more details of these MQRFH2 header, refer to the link: http://publib.boulder.ibm.com/infocenter/wmqv6/v6r0/index.jsp?topic=%2Fcom.ibm.mq.csqzaw.doc%2Fuj25440_.htm [http://publib.boulder.ibm.com/infocenter/wmqv6/v6r0/index.jsp?topic=%2Fcom.ibm.mq.csqzaw.doc%2Fuj25440_.htm]. 

The following code snippets show how to set the MQRFH2 header in DataPower using custom stylesheet. 


(1) define a variable that contains MQMD header with a string of "MQHRF2" for the Format field

<xsl:variable name="MQMDStr">
<MQMD>
<Format>MQHRF2</Format>
</MQMD>
</xsl:variable>

(2) define the MQRFH2 structure with its JMS specific data

<xsl:variable name="RFH2">
<MQRFH2>
<StrucId>RFH</StrucId>
<Version>2</Version>
<Encoding>546</Encoding>
<CodedCharSetId>819</CodedCharSetId>
<Format>MQSTR</Format>
<Flags>0</Flags>
<NameValueCCSID>1208</NameValueCCSID>
<NameValueData>
<NameValue>
<mcd>
<Msd>jms_text</Msd>
</mcd> 
</NameValue>
<NameValue>
<jms>
<Dst>topic://IC/ent/chargeback/NOTIFY</Dst>
<Rto/>
<Tms/>
<Pri>0</Pri>
<Dlv>2</Dlv>
</jms>
</NameValue>
<NameValue>
<usr>
<From>
<xsl:value-of select="'From Business Partner'"/>
</From>
<To>
<xsl:value-of select="'To Business Partner'"/>
</To>
<ChargeBackType>
<xsl:value-of select="'credit'"/>
</ChargeBackType>
</usr>
</NameValue>
</NameValueData>
</MQRFH2>
</xsl:variable>

(3) Serilaize MQMD header

<xsl:variable name="MQMDStr2">
<dp:serialize select="$MQMDStr" omit-xml-decl="yes"/>
</xsl:variable>

(4) Serilaize MQRFH2 header

<xsl:variable name="rfh2Str">
<dp:serialize select="$RFH2" omit-xml-decl="yes"/>
</xsl:variable>

(5) set respective headers using DataPower extension functions in the request rule.
For response rule, "<dp:set-response-header..." extension function should used.

<dp:set-request-header name="'MQMD'" value="$MQMDStr2"/>
<dp:set-request-header name="'MQRFH2'" value="$rfh2Str"/>