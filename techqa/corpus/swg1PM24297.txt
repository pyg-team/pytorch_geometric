Title: IBM PM24297: LOADING A FILE AS INPUT STREAM FAILED - United States

Text:
 SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  If uploading a file as Input stream, it fails with the
   following exception:
   
   <openjpa-1.2.3-SNAPSHOT-r422266:907835 nonfatal general error>
   org.apache.openjpa.persistence.PersistenceException: DB2 SQL
   Error:
   SQLCODE=-204, SQLSTATE=42704, SQLERRMC=ADMINISTRATOR.SOMETABLE,
   DRIVER=3.50.152 {prepstmnt 955594997 INSERT INTO
   ADMINISTRATOR.SOMETABLE
   (content) VALUES (?) [params=(InputStream)
   java.io.ByteArrayInputStream@400c400c]} [code=-204,
   state=42704]SQLCA
   OUTPUT[Errp=SQLNQ1FC, Errd=-2145779603, 0, 0, 0, -10, 0]
   DB2 SQL Error: SQLCODE=-204, SQLSTATE=42704,
   SQLERRMC=ADMINISTRATOR.SOMETABLE, DRIVER=3.50.152
   DB2 SQL Error: SQLCODE=-727, SQLSTATE=56098,
   SQLERRMC=2;-204;42704;ADMINISTRATOR.SOMETABLE, DRIVER=3.50.152
   DB2 SQL Error: SQLCODE=-727, SQLSTATE=56098,
   SQLERRMC=2;-204;42704;ADMINISTRATOR.SOMETABLE, DRIVER=3.50.152
   FailedObject: com.ibm.jpa.MyEntity@74037403
   [5/31/10 11:10:37:468 IST] 0000002e SystemErr     R  at
   org.apache.openjpa.jdbc.sql.DBDictionary.narrow(DBDictionary.jav
   a:4246)
   [5/31/10 11:10:37:468 IST] 0000002e SystemErr     R  at
   org.apache.openjpa.jdbc.sql.DBDictionary.newStoreException(DBDic
   tionary.
   java:4211)
   [5/31/10 11:10:37:468 IST] 0000002e SystemErr     R  at
   org.apache.openjpa.jdbc.sql.DB2Dictionary.newStoreException(DB2D
   ictionar
   y.java:504)
   
   
    
   
   

LOCAL FIX
 *  Fix has identified and resolve the issue. Work around has also
   been provided and avail via detail to this pmr.
   
   
    
   
   

PROBLEM SUMMARY
 *  ****************************************************************
   * USERS AFFECTED:  All users of the Java Persistence API 2.0   *
   *                  feature of the IBM &#130; &#174; WebSphere &#130; &#174; Applicat
   *                  Server V7 Feature Pack for OSGi             *
   *                  Applications and Java Persistence API 2.0   *
   *                  who make use of InputStreams in their JPA   *
   *                  Entities and use DB2 as their database.     *
   *                                                              *
   ****************************************************************
   * PROBLEM DESCRIPTION: InputStreams not working from within    *
   *                      JPA Entities on DB2.                    *
   ****************************************************************
   * RECOMMENDATION:                                              *
   ****************************************************************
   OpenJPA does not properly handle InputStreams when DB2 is
   being used.  This fix adds proper support for using
   InputStreams on DB2.
   With this fix applied, you may see the following issue when
   using a very large Lob:
   
   java.io.IOException:[jcc][10120][11936][3.51.90] Invalid
   operation: Lob is closed.
   
   This exception is not a bug and has to do with the nature of
   DB2 and the way OpenJPA iterates over a results set.
   That is, JCC will automatically use 'progressive streaming' to
   retrieve the LOB data. With 'progressive streaming', the
   InputStream retrieved must be materialized before the next
   iteration and call to 'next' on the ResultSet.
   
   To work with large Lobs (and thus avoid the IOException) is
   to set fullyMaterializedLobData to true (example to follow),
   so that the JCC will materialize the whole Lob data into
   memory.  For example, when defining the
   openjpa.ConnectionProperties, you would set the DB2
   properties 'fullyMaterializeLobData' and 'progressive
   Streaming' as follows:
   
   <property name="openjpa.ConnectionProperties"
   value="DriverClassName=com.ibm.db2.jcc.DB2Driver,Url=jdbc:db2://
   localhost:50000/demodb3:fullyMaterializeLobData=true;progressive
   Streaming=NO;,Username=joe,Password=123" />
   
   
    
   
   

PROBLEM CONCLUSION
 *  With this fix, code has been added to properly support the use
   of InputStreams in JPA Entities when the backend is DB2.
   
   The fix for this APAR is currently targeted for inclusion
   in Fix Pack 1.0.0.3 for Feature Pack for OSGi Applications and
   Java Persistence API 2.0.
   
   Please refer to the recommended updates page for delivery
   information:
   http://www.ibm.com/support/docview.wss?rs=180&uid=swg27004980 [http://www.ibm.com/support/docview.wss?rs=180&uid=swg27004980]
   
   
    
   
   

TEMPORARY FIX

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   PM24297
   
   
 * REPORTED COMPONENT NAME
   JPA OSGI FEATUR
   
   
 * REPORTED COMPONENT ID
   5724J0857
   
   
 * REPORTED RELEASE
   700
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   NoPE
   
   
 * HIPER
   NoHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2010-10-11
   
   
 * CLOSED DATE
   2010-10-22
   
   
 * LAST MODIFIED DATE
   2010-10-22
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
    PM18530 [http://www-01.ibm.com/support/docview.wss?uid=swg1PM18530]
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
   
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   JPA OSGI FEATUR
   
   
 * FIXED COMPONENT ID
   5724J0857
   
   

APPLICABLE COMPONENT LEVELS
 * R700 PSY
   UP