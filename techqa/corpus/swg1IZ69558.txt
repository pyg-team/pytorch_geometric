Title: IBM IZ69558: NCO_P_SYSLOG PROCESS RUN AS "SETUID ROOT" - United States

Text:
 SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS FIXED IF NEXT.
    
   
   

ERROR DESCRIPTION
 *  Operating system is Redhat Linux.  Here is the contents of
   /etc/redhat-release:
   Red Hat Enterprise Linux Server release 5.3 (Tikanga)
   
   The ObjectServer version is irrelevant.  The output of the
   -version for the probe is:
   
   Netcool/OMNIbus Syslog probe - sion 7.2.1
   (C) Copyright IBM Corp. 1994, 2007
   
   Netcool/OMNIbus Probe API Library Version 7.2.1
   Release ID: 5.0.4066
   API Release ID: 5.11.18
   Software Compile Date: Tue Jan 22 10:25:05 GMT 2008 on
   l000147s.hursley.ibm.com (Linux 2.4.9-e.3smp #1 SMP Fri May 3
   16:48:54 EDT 2002)
   
   The syslog probe has a property called SendHUP which is used to
   send a SIGHUP
   signal to the UNIX syslogd process when the probe starts.  This
   is normally used
   when the syslog daemon is configured to write to a FIFO which
   our syslog probe
   will read .  If our probe is not currently running, the syslog
   daemon will get an error trying
   to write to the FIFO and will stop writing to it.  When our
   probe begins running, it will
   open the read side of the FIFO, then send the SIGHUP. The
   receipt of the SIGHUP
   forces the syslogd process to reread its configuration file and
   to resume writing to the FIFO.
   
   There is another property called SyslogPIDFile that tells the
   probe where to find
   the process ID of the syslogd process, since that can vary from
   operating system
   to operating system.
   
   Here are the specific properties from the syslog.props file
   ################################################################
   #######
   RulesFile               :
   "/opt/ibm/netcool/etc/rules/syslog.rules"
   SendHUP                 :       1
   FifoName                :
   "/opt/ibm/netcool/var/syslog.fifo"
   SyslogPIDFile           :       "/var/run/syslogd.pid"
   
   The "bug" is as follows:  When the nco_p_syslog process is run
   as root, everything
   works correctly.  However, when the nco_p_syslog process is run
   as "setuid root"
   it does not work correctly.  Here are the permissions on the
   probe binary:
   
   $ ls -l $OMNIHOME/probes/linux2x86/nco_p_syslog
   -rwsr-xr-x 1 root sys 56300 Nov  3 16:56
   /opt/ibm/netcool/omnibus/probes/linux2x86/nco_p_syslog
   
   The symptom is that the probe is unable to send the SIGHUP to
   the syslogd process.
   In fact, it cannot even read the PID file to determine the
   syslogd pid.
   
   The relevant line from the probe log file:
   
   11/10/2009 02:00:17 PM: Error: Failed to open syslog pid file :
   /var/run/syslogd.pid
   
   This is likely because it has given up its root permissions
   before doing so.  See the following:
   
   $ pgrep nco_p_syslog
   25850
   $ ps -p 25850 -o euser,ruser,suser,fuser
   EUSER RUSER SUSER FUSER
   netcool netcool root netcool
   
   Notice that the effective user ID is not root.  This correct
   behavior - the probe should give away
   root permissions after it does not need them;  I am guessing
   that it did that before trying to read
   the PID file, which would cause the error.
   
   The "out of the box" behavior of RHEL is to make the syslog
   daemon PID file not readable by world.
   
   We have a probe option, SendHUP that does not work "out of the
   box" when the probe is running in setuid root mode. This failure
   only occurs for RHEL.
   
   The Syslog probe will only gain root privilege automatically
   when it is sending the SIGHUP signal to the syslog daemon and
   not when it is reading the syslog PID file. In this case, the
   probe will not be able to read the PID file for the process ID
   and send the signal.
   
   The work-around is to modify the rc file (I think it's something
   like /etc/rc.d/syslog)
   to chmod the file once the syslog daemon has been forked off.
   
   
    
   
   

LOCAL FIX
 *  The work-around is to modify the rc file (I think it's something
   like /etc/rc.d/syslog)
   to chmod the file once the syslog daemon has been forked off.
   
   
    
   
   

PROBLEM SUMMARY
 *  ****************************************************************
   USERS AFFECTED:
   There is no code change. Change was made to README.
   ****************************************************************
   PROBLEM DESCRIPTION:
   Operating system is Redhat Linux.  Here is the contents of
   /etc/redhat-release:
   Red Hat Enterprise Linux Server release 5.3 (Tikanga)
   
   The ObjectServer version is irrelevant.  The output of the
   -version for the probe is:
   
   Netcool/OMNIbus Syslog probe - sion 7.2.1
   (C) Copyright IBM Corp. 1994, 2007
   
   
   Netcool/OMNIbus Probe API Library Version 7.2.1
   Release ID: 5.0.4066
   API Release ID: 5.11.18
   Software Compile Date: Tue Jan 22 10:25:05 GMT 2008 on
   l000147s.hursley.ibm.com (Linux 2.4.9-e.3smp #1 SMP Fri May 3
   16:48:54 EDT 2002)
   
   The syslog probe has a property called SendHUP which is used to
   send a SIGHUP
   signal to the UNIX syslogd process when the probe starts.  This
   is normally used
   when the syslog daemon is configured to write to a FIFO which
   our syslog probe
   will read .  If our probe is not currently running, the syslog
   
   daemon will get an error trying
   to write to the FIFO and will stop writing to it.  When our
   probe begins running, it will
   
   open the read side of the FIFO, then send the SIGHUP. The
   
   receipt of the SIGHUP
   forces the syslogd process to reread its configuration file and
   to resume writing to the FIFO.
   
   There is another property called SyslogPIDFile that tells the
   probe where to find
   the process ID of the syslogd process, since that can vary from
   
   operating system
   to operating system.
   
   Here are the specific properties from the syslog.props file
   ################################################################
   #######
   RulesFile  :
   "/opt/ibm/netcool/etc/rules/syslog.rules"
   
   SendHUP   : 1
   FifoName  :
   "/opt/ibm/netcool/var/syslog.fifo"
   
   SyslogPIDFile  : "/var/run/syslogd.pid"
   
   
   The "bug" is as follows:  When the nco_p_syslog process is run
   
   as root, everything
   
   works correctly.  However, when the nco_p_syslog process is run
   
   as "setuid root"
   
   it does not work correctly.  Here are the permissions on the
   probe binary:
   
   $ ls -l $OMNIHOME/probes/linux2x86/nco_p_syslog
   -rwsr-xr-x 1 root sys 56300 Nov  3 16:56
   /opt/ibm/netcool/omnibus/probes/linux2x86/nco_p_syslog
   
   The symptom is that the probe is unable to send the SIGHUP to
   the syslogd process.
   In fact, it cannot even read the PID file to determine the
   
   syslogd pid.
   
   The relevant line from the probe log file:
   
   11/10/2009 02:00:17 PM: Error: Failed to open syslog pid file :
   /var/run/syslogd.pid
   
   This is likely because it has given up its root permissions
   before doing so.  See the following:
   
   $ pgrep nco_p_syslog
   25850
   $ ps -p 25850 -o euser,ruser,suser,fuser
   
   EUSER RUSER SUSER FUSER
   netcool netcool root netcool
   
   Notice that the effective user ID is not root. This correct
   behavior - the probe should give away
   root permissions after it does not need them;  I am guessing
   that it did that before trying to read
   the PID file, which would cause the error.
   
   
   The "out of the box" behavior of RHEL is to make the syslog
   
   daemon PID file not readable by world.
   
   We have a probe option, SendHUP that does not work "out of the
   
   box" when the probe is running in setuid root mode. This
   failure
   only occurs for RHEL.
   
   The Syslog probe will only gain root privilege automatically
   when it is sending the SIGHUP signal to the syslog daemon and
   not when it is reading the syslog PID file. In this case, the
   
   probe will not be able to read the PID file for the process ID
   and send the signal.
   
   The work-around is to modify the rc file (I think it's something
   like /etc/rc.d/syslog)
   to chmod the file once the syslog daemon has been forked off.
   
   ****************************************************************
   RECOMMENDATION:
   There is no code change. Change was made to README.
   ****************************************************************
   
   
    
   
   

PROBLEM CONCLUSION

TEMPORARY FIX

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   IZ69558
   
   
 * REPORTED COMPONENT NAME
   SYSLOG PROBE
   
   
 * REPORTED COMPONENT ID
   5724P03SL
   
   
 * REPORTED RELEASE
   100
   
   
 * STATUS
   CLOSED FIN
   
   
 * PE
   NoPE
   
   
 * HIPER
   NoHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2010-02-04
   
   
 * CLOSED DATE
   2010-02-11
   
   
 * LAST MODIFIED DATE
   2010-02-11
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
   
   
   

FIX INFORMATION

APPLICABLE COMPONENT LEVELS
 * R100 PSN
   UP