Title: IBM Error when running Stagingprop due to incorrect STAG1540 trigger - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 Why is stagingprop failing with the following SqlSyntaxErrorException 

CAUSE
Incorrect STGKEY1NAME value in the staglog trigger 

When running Stagingprop in v8.0.0 or 8.0.1, if you see the following exception :

20161026-160434| <Error> The command failed to retrieve the change logs from the STAGLOG table.
<SQLException> DB2 SQL Error: SQLCODE=-206, SQLSTATE=42703, SQLERRMC=T.SHPMODCLCD, DRIVER=4.19.49
SQLState: 42703 Vendor Error Code: -206
Chained SQLException #1: DB2 SQL Error: SQLCODE=-727, SQLSTATE=56098,
SQLERRMC=2;-206;42703;T.SHPMODCLCD, DRIVER=4.19.49
Chained SQLException #2: DB2 SQL Error: SQLCODE=-727, SQLSTATE=56098,
SQLERRMC=2;-206;42703;T.SHPMODCLCD, DRIVER=4.19.49
Stack trace:
com.ibm.db2.jcc.am.SqlSyntaxErrorException: DB2 SQL Error: SQLCODE=-206, SQLSTATE=42703, SQLERRMC=T.SHPMODCLCD, DRIVER=4.19.49
at com.ibm.db2.jcc.am.kd.a(Unknown Source)
at com.ibm.db2.jcc.am.kd.a(Unknown Source)
at com.ibm.db2.jcc.am.kd.a(Unknown Source)
at com.ibm.db2.jcc.am.fp.c(Unknown Source)
at com.ibm.db2.jcc.am.fp.d(Unknown Source)
at com.ibm.db2.jcc.am.fp.a(Unknown Source)
at com.ibm.db2.jcc.am.gp.a(Unknown Source)
at com.ibm.db2.jcc.t4.bb.h(Unknown Source)
at com.ibm.db2.jcc.t4.bb.b(Unknown Source)
at com.ibm.db2.jcc.t4.p.a(Unknown Source)
at com.ibm.db2.jcc.t4.vb.i(Unknown Source)
at com.ibm.db2.jcc.am.fp.kb(Unknown Source)
at com.ibm.db2.jcc.am.gp.xc(Unknown Source)
at com.ibm.db2.jcc.am.gp.b(Unknown Source)
at com.ibm.db2.jcc.am.gp.kc(Unknown Source)
at com.ibm.db2.jcc.am.gp.executeQuery(Unknown Source)
at com.ibm.commerce.staging.StagingProp.fetchFromStagLogAndTable(StagingProp.java:2603)
at com.ibm.commerce.staging.StagingProp.propagateRows(StagingProp.java:2789)
at com.ibm.commerce.staging.StagingProp.transactRows(StagingProp.java:2156)
at com.ibm.commerce.staging.StagingProp.propagateFromStaglog(StagingProp.java:1856)
at com.ibm.commerce.staging.StagingProp.propagate(StagingProp.java:1962)
at com.ibm.commerce.staging.StagingProp.execute(StagingPropjava:838)
at com.ibm.commerce.staging.StagingProp.main(StagingProp.java:756)
at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:95)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:56)
at java.lang.reflect.Method.invoke(Method.java:620)
at com.ibm.ws.bootstrap.WSLauncher.main(WSLauncher.java:282)
20161026-160434| <Error> The command will not retry due to the nature of the error.
20161026-160434| <Error> The command failed to complete the propagation job.




ANSWER
The problem is the value in the trigger for STGKEY1NAME is incorrect. In the wcs.stage.trigger.sql file you can check and change the following section to resolve. 


CREATE TRIGGER STAG1540 AFTER DELETE ON SHPMODCLCD REFERENCING OLD AS O FOR EACH ROW
INSERT INTO STAGLOG (STGRFNBR, STGSTMP, STGTABLE, STGOP, STGMENBR, STGKEY1NAME, STGOKEY1)
VALUES (NEXTVAL FOR STAGESEQ, CURRENT TIMESTAMP, 'shpmodclcd', 'D', CASE O.SHPMODCLCD_ID WHEN 0 THEN 0 ELSE 1 END, 'shpmodclcd', O.SHPMODCLCD_ID)# 

 

Change it to the following:
CREATE TRIGGER STAG1540 AFTER DELETE ON SHPMODCLCD REFERENCING OLD AS O FOR EACH ROW
INSERT INTO STAGLOG (STGRFNBR, STGSTMP, STGTABLE, STGOP, STGMENBR, STGKEY1NAME, STGOKEY1)
VALUES (NEXTVAL FOR STAGESEQ, CURRENT TIMESTAMP, 'shpmodclcd', 'D', CASE O.SHPMODCLCD_ID WHEN 0 THEN 0 ELSE 1 END, 'shpmodclcd_id', O.SHPMODCLCD_ID)#


This fix has been included in WCS 8.0.3