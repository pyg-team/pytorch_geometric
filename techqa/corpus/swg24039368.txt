Title: IBM PI20317;8.5.5: illegalmonitorstateexception leads to corrupt destination in WAS - United States

Text:
PI20317; PI20317; PI20317 DOWNLOADABLE FILES

ABSTRACT
 When a Messaging engine is configured with a FileStore in certain scenarios an "IllegalMonitorStateException" is observed when persisting the data into the store. 

DOWNLOAD DESCRIPTION
PI20317 resolves the following problem:

ERROR DESCRIPTION: 
JMS application is unable to send messages to WebSphere Application Server v8.0 Service Integration Bus destination. The following errors are logged in the SystemOut.log: 

CNTR0020E: EJB threw an unexpected (non-declared) exception 
during invocation of method "publishEvent" on bean 
"BeanId(XXX)". Exception data: com.ibm.ws.sib.processor. 
exceptions.SIMPErrorException: com.ibm.websphere.sib.exception. 
SIErrorException: CWSIS1002E: An unexpected exception was 
caught 
during transaction completion. Exception: java.lang.Illegal 
MonitorStateException 
at com.ibm.ws.sib.processor.impl.PubSubInputHandler.localPut 
(PubSubInputHandler.java:1411) 
at com.ibm.ws.sib.processor.impl.PubSubInputHandler.internal 
HandleMessage(PubSubInputHandler.java:1128) 
at com.ibm.ws.sib.processor.impl.PubSubInputHandler.handle 
ProducerMessage(PubSubInputHandler.java:1061) 
at com.ibm.ws.sib.processor.impl.ProducerSessionImpl.send 
(ProducerSessionImpl.java:599) 
at com.ibm.ws.sib.api.jms.impl.JmsMsgProducerImpl.send 
Message(JmsMsgProducerImpl.java:1211) 
at com.ibm.ws.sib.api.jms.impl.JmsMsgProducerImpl.send 
(JmsMsgProducerImpl.java:725) 
Caused by: com.ibm.websphere.sib.exception.SIErrorException: 
CWSIS1002E: An unexpected exception was caught during 
transaction 
completion. Exception: java.lang.IllegalMonitorStateException 
at com.ibm.ws.sib.msgstore.transactions.MSDelegatingLocal 
Transaction.commit(MSDelegatingLocalTransaction.java:452) 
at com.ibm.ws.sib.processor.impl.PubSubInputHandler.local 
Put(PubSubInputHandler.java:1398) 
... 79 more 
Caused by: java.lang.IllegalMonitorStateException 
at java.util.concurrent.locks.ReentrantLock$Sync.tryRelease 
(ReentrantLock.java:138) 
at java.util.concurrent.locks.AbstractQueuedSynchronizer. 
release(AbstractQueuedSynchronizer.java:1250) 
at java.util.concurrent.locks.ReentrantLock.unlock 
(ReentrantLock.java:442) 
at com.ibm.ws.objectManager.ConcurrentSubList.addEntry 
(ConcurrentSubList.java:239) 
at com.ibm.ws.objectManager.ConcurrentLinkedList.addEntry 
(ConcurrentLinkedList.java:526) 
at com.ibm.ws.sib.msgstore.persistence.objectManager. 
PersistableImpl.addToStore(PersistableImpl.java:473) 
at com.ibm.ws.sib.msgstore.persistence.objectManager. 
PersistableImpl.addToStore(PersistableImpl.java:323) 
at com.ibm.ws.sib.msgstore.persistence.objectManager. 
BatchingContextImpl.insert(BatchingContextImpl.java:195) 
at com.ibm.ws.sib.msgstore.task.AddTask.persist 
(AddTask.java:371) 
at com.ibm.ws.sib.msgstore.persistence.objectManager. 
PersistentMessageStoreImpl.commit(PersistentMessageStore 
Impl.java:1710) 
at com.ibm.ws.sib.msgstore.transactions.MSDelegatingLocal 
Transaction.commit(MSDelegatingLocalTransaction.java:402) 

com.ibm.lconn.events.internal.publish.impl.JMSPublisher 
publishEvent CLFWY0151E: A JMS Exception occurred when 
publishing an event with ID 6d4b8b63-853d-417c-8110-bdd8 
36c162ef to topic XYZ 
javax.jms.JMSException: CWSIA0067E: An exception was received 
during the call to the method JmsMsgProducerImpl. 
<constructor>: com.ibm.ws.sib.processor.exceptions. 
SIMPDestinationCorruptException: CWSIK0027E: The destination 
with name connections.events is corrupt. 
at com.ibm.ws.sib.api.jms.impl.JmsMsgProducerImpl.<init> 
(JmsMsgProducerImpl.java:445) 
at com.ibm.ws.sib.api.jms.impl.JmsTopicPublisherImpl.<init> 
(JmsTopicPublisherImpl.java:59) 
at 
com.ibm.ws.sib.api.jms.impl.JmsTopicSessionImpl.instantiate 
Producer(JmsTopicSessionImpl.java:231) 
at com.ibm.ws.sib.api.jms.impl.JmsSessionImpl.createProducer 
(JmsSessionImpl.java:866) 
Caused by: com.ibm.ws.sib.processor.exceptions.SIMPDestination 
CorruptException: CWSIK0027E: The destination with name 
XYZ is corrupt 
at com.ibm.ws.sib.processor.impl.DestinationManager. 
getDestinationInternal(DestinationManager.java:1289) 
at com.ibm.ws.sib.processor.impl.DestinationManager. 
getDestination(DestinationManager.java:1085) 
at com.ibm.ws.sib.processor.impl.ConnectionImpl.internal 
CreateProducerSession(ConnectionImpl.java:1094) 
at com.ibm.ws.sib.processor.impl.ConnectionImpl.create 
ProducerSession(ConnectionImpl.java:1029) 
at com.ibm.ws.sib.processor.impl.ConnectionImpl.create 
ProducerSession(ConnectionImpl.java:958) 
at com.ibm.ws.sib.api.jms.impl.JmsMsgProducerImpl.<init> 
(JmsMsgProducerImpl.java:371) 

LOCAL FIX: 
NONE 

PROBLEM SUMMARY

USERS AFFECTED:
Users of the default messaging provider for IBM WebSphere Application Server with filestore as the message store.

PROBLEM DESCRIPTION:
When a Messaging engine is configured with a FileStore in certain scenarios an "IllegalMonitorStateException" is observed when persisting the data into the store. This exception has the potential of corrupting the destination at a later point of time.

RECOMMENDATION:
None

When a Messaging engine is configured with a FileStore, in certain scenarios an IllegalMonitorStateException" is observed when persisting the data into the store. This exception was resulting in a state where the messaging engine believes the data was persisted but infact there is no data corresponding to the token held. Due to this situation the when there is an attempt to retrieve the data corresponding to the token the data is not found and due to the inconsistency observed the destination is marked as corrupted.

PROBLEM CONCLUSION: 
The code has been fixed to rollback the complate transaction to avoid any inconsistency in the store. 

The fix for this APAR is currently targeted for inclusion in fix packs 7.0.0.37,8.0.0.10 and 8.5.5.4. Please refer to the Recommended Updates page for delivery information: http://www.ibm.com/support/docview.wss?rs=180&uid=swg27004980 [http://www.ibm.com/support/docview.wss?rs=180&uid=swg27004980]

PREREQUISITES
None

INSTALLATION INSTRUCTIONS
Please review the readme.txt for detailed installation instructions.

URL LANGUAGE SIZE(Bytes) Readme [ftp://public.dhe.ibm.com/software/websphere/appserv/support/fixes/PI20317/8.5.5.3/readme.txt] US English 9709 
DOWNLOAD PACKAGE


Download RELEASE DATE LANGUAGE SIZE(Bytes) Download Options 
What is Fix Central(FC)? [https://www.ibm.com/support/fixcentral/help?page=swfaqs] 8.5.5.0-WS-WASND-IFPI20317 02-09-2015 US English 260682 HTTP [http://www-933.ibm.com/eserver/support/fixes/fixcentral/swgquickorder?fixes=8.5.5.0-WS-WASND-IFPI20317&productid=WebSphere%20Application%20Server&brandid=5] 
TECHNICAL SUPPORT
 Contact IBM Support using SR (http://www.ibm.com/software/support/probsub.html [http://www.ibm.com/software/support/probsub.html]), visit the WebSphere Application Server support web site (http://www.ibm.com/software/webservers/appserv/was/support/ [http://www.ibm.com/software/webservers/appserv/was/support/]), or contact 1-800-IBM-SERV (U.S. only). 

 [/support/docview.wss?uid=swg24039368&aid=1]Problems (APARS) fixed [/support/docview.wss?uid=swg24039368&aid=2]Problems (APARS) fixed
PI20317