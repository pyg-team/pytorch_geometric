Title: IBM Sametime Embedded Client Token re-login failing - United States

Text:
SSO; Sametime; Login; Authentication; Token TECHNOTE (TROUBLESHOOTING)

PROBLEM
The Sametime client is able to initially log. If the user logs out due to the machine entering hibernation mode or some other disconnection. The client will attempt to log back in to the server using token but will fail to log in. 

SYMPTOM
Initial Token login works but when attempting to a second login this fails. Users were recieving the prompt:

User "UserName\Org" failed to log into SametimeHostname.com
Reason:
Unable to log in to community server because the authentication
token could not be retrieved. Try again later. If the problem
continues, contact the administrator


CAUSE
Configuration inconsistency 


ENVIRONMENT
Sametime 9.0.1 community server 



DIAGNOSING THE PROBLEM

Add additional tracing to the Notes client and to the Sametime community server as outlined below.

Client logs:

Additional information on client traces is detailed in the following document:
https://www.ibm.com/support/knowledgecenter/SSKTXQ_9.0.1/admin/trouble/rbl_client_log_trace.html [https://www.ibm.com/support/knowledgecenter/SSKTXQ_9.0.1/admin/trouble/rbl_client_log_trace.html] 

 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * To collect the client logs please run the collector utility from the client: 
 *  
   Help-> Support -> Collect Support Data 
   


Server logging: 

In sametime.ini file under [Debug] section:  * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 


To collect the server logs please run the collector utility:  * 
 * 



For Windows, this is C:\ibm\Domino by default.  * 
 * 


Note: Disable the trace (remove the line) after the test. 

Reproduce the issue and analyze the logs produced. 


The trace log shows that the user initially successfully logged in using the token method 

 * 
 * 17:24:38.386 FINER Starting auto login
   17:24:38.393 FINE Checking SSO account settings for community [TestName.com:CN=Aaa Bbb/OU=ccc/OU=Ddd/O=Eee] 
 * 17:24:38.394 FINE Account auth type [ST-DOMINO-SSO] Config auth type [ST-DOMINO-SSO]
   17:24:39.595 FINE Got login token from apache cookie: LtpaToken
   17:24:39.682 FINE CommunityInternal login in progress: st1022840::Sametime::TestName.com:CN=Aaa Bbb/OU=ccc/OU=Ddd/O=Eee::null
   17:24:39.694 FINE Connecting with direct connection
   17:24:40.524 FINE CommunityInternal login complete:st1022840::Sametime::TestName.com:CN=Aaa Bbb/OU=ccc/OU=Ddd/O=Eee::null
   17:24:40.524 FINE CommunityImpl.signedIn called for community [st1022840] my status is [active] my userid is [CN=Aaa Bbb/OU=ccc/OU=Ddd/O=Eee]


To reproduce the issue log out and on re-login you will see the following trace: 

 

 * 
 * 
 * 
 * WARNING User signed out from Community: st1022840::Sametime::
 * TestName.com
 * .com::
 * 
 * ::null
 * 
 * 2017-04-23T17:25:31.243+02:00 WARNING CLFRB0277W: Logout event received: Logout reason code [0] Logout reason name [ST_OK] Login in progress [false] Attempt reconnect [true] Logout message [A connection to the server cannot be made at this time. Log in again later.]
   
 * 


Then check the Sametime.ini file in the community server logs.  * 
 * 
 * 


In this case, an inconsistency was identified between the server hostname used for the initial login and the Hostname that the Server is configured to listen on. 

TestName in sample logs above and the parameter in the community server Sametime.ini file (for example)  * 
 * 


This mismatch is the cause of the issue.




RESOLVING THE PROBLEM

The re-login by token issue is caused by a hostname mismatch on the STCommunity server and the client.

1. The client is trying to connect to the host : TestName.com 

2. The Domino back-end of the STCommunity server has "TestName1.com" specified in its server document as fully qualified hostname. Domino Servers will check that the hostname that the client is trying to reach to confirm it is is the same as the Hostname(s) supported by the server. 

When the client reconnects it trys to get a new token from the Server, but the Server rejects this connection. That is why the client is registering "Server Unavailable" as the domino back-end which needs to validate the SSO request is refusing the connection.

This can be fixed in 3 ways :

1. Add the following setting to the notes.ini of the STCommunity server :
NETWORK_SPRAYER_ADDRESS=TestName1.com

This setting will inform the domino back-end that both hostnames should be accepted for this server. This is normally used in cases where a front end Load balancer is used and has a specific Hostname.

2. Correct the Hostname on the domino server document to the one used by the clients or vice versa.

3. Modify the client to use TestName1.com as STCommunity hostname (if the authserver field is set, use this same hostname or leave it blank)

For the 2 first options, the domino server needs to be restarted to take the change into account.
For the last option, the change applies to the client so no server restart is required. It is possible to push this change to all clients via managed-community-configs.xml.