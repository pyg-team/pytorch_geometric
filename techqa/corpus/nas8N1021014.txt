Title: IBM After Applying PTFs for 5733SC1, SSH/SFTP/SCP Connections to/from IBM i May Fail with Cipher Errors - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Applying PTFs to 5733SC1 (OpenSSH) can cause SSH/SFTP/SCP connections to fail with error messages in regards to not matching ciphers. This will only happen where the partner SSH server or client on the connection is running a very old version of the SSH / OpenSSH code. 

SYMPTOM
Errors on connection with "No matching cipher found", or "No matching MAC algorithm found", or occasionally "No matching kex algorithm found".


CAUSE
The following PTFs, or their supersedes, upgrade OpenSSH on the IBM i from an earlier release to 6.9p1: 

o R610 - SI57920 (1000)
o R710 - SI57762 (5317) 
o R720 - SI57771 (5310)

Important Note: The R710 and R720 PTFs are on a cumulative package; therefore, applying that package will also upgrade OpenSSH.

The previous release of OpenSSH on these releases was 6.6p1. In OpenSSH 6.7 and subsequent releases, changes were made to the default set of ciphers. The release notes at http://www.openssh.com/txt/release-6.7 [http://www.openssh.com/txt/release-6.7] state the following:

Changes since OpenSSH 6.6
=========================

Potentially-incompatible changes

* sshd(8): The default set of ciphers and MACs has been altered to
remove unsafe algorithms. In particular, CBC ciphers and arcfour*
are disabled by default.

The full set of algorithms remains available if configured
explicitly via the Ciphers and MACs sshd_config options.

If the SSH client/SSH server is older and does not yet support the safer ciphers and MACs, and wants to use one of the unsafe ciphers/MACs disabled by default, the connection will fail.

Issues have also been seen with Key Exchange Algorithms (kex) failing on a connection attempt.

NOTE : The upgrade to OpenSSH 6.9p1 was necessary in order to fix several published CVE vulnerabilities in the OpenSSH code and ensure PCI compliance.


ENVIRONMENT
OpenSSH 6.9p1 has the following algorithms available as default. This information is taken from the OpenSSH manual page [http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/sshd_config.5?query=sshd_config&sec=5] for sshd_config: 

 

Ciphers

chacha20-poly1305@openssh.com, 
aes128-ctr,aes192-ctr,aes256-ctr, 
aes128-gcm@openssh.com,aes256-gcm@openssh.com 

 

MACs 

umac-64-etm@openssh.com,umac-128-etm@openssh.com, 
hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com, 
umac-64@openssh.com,umac-128@openssh.com, 
hmac-sha2-256,hmac-sha2-512 

 

KexAlgorithms 

curve25519-sha256@libssh.org, 
ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521, 
diffie-hellman-group-exchange-sha256, 
diffie-hellman-group14-sha1


RESOLVING THE PROBLEM
There are two potential solutions to this issue. From a security viewpoint, Option 1 must be preferred as it uses the secure algorithms and does not introduce back in unsafe algorithms. Unsafe means that security vulnerabilities have been found in the algorithms being used. Option 2 is recommended only as a stop-gap to allow time to upgrade the client or server software, and then you should remove the changes from the configuration file: 

1. Upgrade the SSH client/server to a version where it uses the safe algorithms in the default lists above. Refer to your SSH client/server provider for information on how to do this, and which version you will need. 

2. Modify the appropriate OpenSSH configuration file on the IBM i to add back in the unsafe algorithms required to have the client connect. 

If the IBM i is the SSH Server, modify the sshd_config file 

If the IBM i is the SSH Client, modify the ssh_config file 

The configuration file will be found in the following locations per release: 


V6R1 - /QOpenSys/QIBM/UserData/SC1/OpenSSH/openssh-3.8.1p1/etc/ 
V7R1 - /QOpenSys/QIBM/UserData/SC1/OpenSSH/openssh-4.7p1/etc/ 
V7R2+ - /QOpenSys/QIBM/UserData/SC1/OpenSSH/etc/ 

 

Using WRKLNK, locate the file, and select Option 2 (=Edit) against it. You will need to add in the appropriate keyword, specify the default algorithms that you still need it to use, and then add one or more of the unsafe algorithms (comma separated) to the end of the defaults. 

For example: 
[/support/docview.wss?uid=nas8N1021014&aid=1] [/support/docview.wss?uid=nas8N1021014&aid=1]

Take similar action if you need to add the MACs or KexAlgorithms keywords to the file.

The algorithm you add will still need to be one of the algorithms that the system supports. To get a list of all the supported algorithms, you can run the following from QSH or CALL QP2TERM:

ssh -Q cipher
ssh -Q mac
ssh -Q kex

If you want to create a comma separated list of all the supported algorithms to use with the appropriate keyword, you can run the following from QSH or CALL QP2TERM command line:

ssh -Q cipher | xargs echo | sed 's| |,|g'

Note this example is for ciphers; you should adjust accordingly for MAC or KexAlgorithms.




Cross reference information Segment Product Component Platform Version Edition Operating System IBM i 7.2 Operating System IBM i 7.1 Operating System IBM i 6.1