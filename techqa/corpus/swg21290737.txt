Title: IBM How to extract data if your DB2 LUW database becomes corrupted - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 
My database has been marked bad or damaged by DB2, it may be corrupted. How do I salvage as much data as possible if my database is corrupt? 

CAUSE

Most corruption problems are typically hard disk related and DB2 is the victim of some corruption on disk. However, it is also the case that a programming error can cause a page to be laid out on disk different that how it is expected to be read back.

Disk corruption can occur for various reasons. Power fluctions/failures are a frequent cause for disk corruption. Modern disk configurations such as RAID help to avoid the problem of data corruption by using redundant disks to back up data, but the problem can still exist. 

When sectors are bad on the disk, the contents of that sector will be copied to another, good sector, and the previous sector is marked unusable, typically before the sector is completely unreadable. If the sector is no longer readable and that data was not copied off to a good sector, data loss can be the result. 

This activity results in gradual failure as, over time, sectors are marked bad until the entire disk may become unreadable. Its not uncommon for most drives to eventually fail.

For preventative maintenance or to repair a damaged disk, you may consider running various disk recovery utilities.


ANSWER
 

In a Windows environment use the chkdsk utility. Running the chkdsk utility will attempt to locate bad sectors, repair soft errors and recover any readable information off bad sectors and move them to good ones.

To run this, open a command Window (Start->Run->cmd) and type: chkdsk volume:/r

Further instructions on checking your hard disk drive can be found in the following technote from Microsoft: How to perform disk error checking in Windows XP [http://support.microsoft.com/kb/315265]


NOTE: If you experience frequent crashing of your DB (with marked bad or damaged errors) and your hardware seems to be fine, make sure you do not have any software scanning the system that could lock DB2 files. Frequently in Windows based environments users will have anti-virus or security software scanning the system. Omit DB2 directories from this, or only scan them when you have shut down DB2, do not scan while DB2 is up and running.

On Unix based systems or GNU/Linux based systems, you may want to run the fsck utility to verify the consistency of a file system. 

Run the fsck utility specifying the particular file system you want to check. You can use something like the df command to check where the FS you want to check is mounted.


Example (Linux): 

 * 
 * $ df -kh
 * 
 * Filesystem Size Used Avail Use% 
 * Mount
 * ed on
 * 
 * /dev/sda5 38G 32G 3.6G 90% /
 * 
 * 
 * fsck -f /dev/sda5


NOTE: It is advisable to run fsck on an unmounted disk, if you are running it for recovery purposes, typically it can be run in a "recovery" or "safe" mode, as an option to boot into. Refer to your systems man pages for options to remove bad blocks along with other options.  * 

For more instructions on running this utility contact your Unix/Linux vendor. 

If you have a database that has been marked bad and encountered corrupted pages, use the db2dart utility report to understand the extent and nature of corruption before you proceed to fix it; or to extract as much data as possible to rebuild the database. Generally, the details for why a database has been marked bad can be found by reviewing a db2dart report to see the extent of the problems. To generate the db2dart report run the following command:



 * db2dart <db_name> /DB
 * 
 * 
 * 
 * NOT 
 * 
 * 
 * 
 * db2dart - Database Analysis and Reporting Tool Command


If you receive any errors after generating the DB2DART report, you should contact DB2 Technical Support for further assistance if needed. In most situations, the best option is to restore from the most recent good backup. However, in reviewing the db2dart report, you may be able to determine the scope of any damage. 

For example, a typical case is that an index may be corrupted. This can simply be marked bad and rebuilt, the following snippet is an example that suggests index corruption: 

 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * Index inspection
 * 
 * 
 *  Error: Unable to read pool page 32641
 * 
 * 
 *  Error: 
 * parent
 *  pool 3,
 *  object ID 91, object type Index
 * 
 * 
 * 
 * 
 * 
 * 


At this point, you can run the db2dart with the /MI option, this will mark the indexes invalid, then issue a restart on the database for the indexes to be rebuilt (assuming INDEXREC cfg setting is set to "RESTART"). 

 * 
 * 
 * 
 * 
 * 
 * object ID
 * 
 * tablespace ID
 * 
 * 
 * 91, 3


If you run the db2dart and the report looks like it may be a problem with the data page, you will see an entry similar to this: 

 * 
 * 
 * 
 * Data inspection
 * 
 * 
 * Error: Unable to read pool page 22528
 * 
 * 
 * 
 * parent pool 3, object ID 68
 * 
 * 
 * 
 * 
 * 
 * 
 * 


In this case you have a few options. The first option is to try to export out the data from the effected table, drop, recreate, and load it back. 

However, if you are not even able to export out the data from the effected table, it is likely damaged, and you may want to use db2dart to extract out as much data as possible. 

 * NOTE:
 *  If you need to drop a table and want to generate the DDL for it, use db2look:
 * 
 * 
 * db2look -d DBNAME -t TABLENAME -e -u SCHEMA_NAME -e -o OUTPUTFILE 
 * 
 * 
 * db2look - DB2 Statistics and DDL Extraction Tool Command
 * 


A data page corruption issue might look like the above example, or something closer to the following: 

 * 
 * 
 * Error: BPS check read error for pool page 
 * 3342774
 * , from object ID 
 * 2
 * , pool 
 * 26
 * ,
 * 
 * 


From the above, the object ID is just that, the ID of the database object. The pool ID identifies the tablespace that the database object resides in, and the "page" is the corrupted page that can no longer be read. 

You can use the db2dart tool to read the uncorrupted pages and salvage most data with the /DDEL option. Here is an example of a command you might run based on the above db2dart output. 

 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 2
 * 
 * 26
 * 
 * 3


The above command will export the data starting from page 0 up to the page just before the corrupted page. This will dump data to a file, you can specify a file for each iteration of the db2dart command, or it will just append data on to the default file. 

You will run another db2dart command to read the pages after the corrupted page, basically skipping over the bad page. 

 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 2
 * 
 * 26
 * 
 * 5
 * 
 *  


The reason for picking a very large number is to read the remainder of the pages. 

This note serves more as a reference if you are requested to perform the above by IBM DB2 Technical Support. If you have a database that is crashing and being marked bad, please contact DB2 Support to assist you further on resolving the issue if needed.