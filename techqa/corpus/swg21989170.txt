Title: IBM CMN3101E: DuplicateKeyException when trying to update a user's password using the Organization Administration Console - United States

Text:
CMN3101E: DuplicateKeyException; USERPWDHST TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 When trying to update a user's password using the Organization Administration Console, a duplicate key exception is thrown against the USERPWDHST table. 

SYMPTOM
 

The following exception is found in SystemOut.log after trying to update a user's password: 

_ERR_CREATE_EXCEPTION User CMN3101E The system is unavailable due to "javax.ejb.DuplicateKeyException: DB2 SQL Error: SQLCODE=-803, SQLSTATE=23505, SQLERRMC=2;WCPREUSR.USERPWDHST, DRIVER=4.14.113DSRA0010E: SQL State = 23505, Error Code = -803 at com.ibm.ws.rsadapter.cci.WSRelationalRAAdapter.executeCreate(WSRelationalRAAdapter.java:400) at com.ibm.ws.ejbpersistence.dataaccess.DataAccessRequestImpl.execute(DataAccessRequestImpl.java:191) at ...
..
System The following create operation exception has occurred during processing: "javax.ejb.DuplicateKeyException: DB2 SQL Error: SQLCODE=-803, SQLSTATE=23505, SQLERRMC=2;WCPREUSR.USERPWDHST, DRIVER=4.14.113DSRA0010E: SQL State = 23505, Error Code = -803



CAUSE

The duplicate key exception can occur when the values for USERREG.PASSWORDCREATION and USERPWDHIST.PASSWORDCREATION match.

If an error occurs while changing a password, the USERREG.PASSWORDCREATION can be entered into the USERPWDHIST table resulting in the DuplicateKeyException when trying the process again.



RESOLVING THE PROBLEM
 

Use the following query to find the affected users:

SELECT userpwdhst.users_id, userpwdhst.userpwdhst_id, userreg.passwordcreation 
FROM userpwdhst, 
userreg 
WHERE userpwdhst.passwordcreation = userreg.passwordcreation
AND userpwdhst.users_id = userreg.users_id 

For those users returned with the query, update the USERPWDHST.PASSWORDCREATION records to a timestamp other than that of the USERREG.PASSWORDCREATION.