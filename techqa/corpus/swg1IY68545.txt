Title: IBM IY68545: MULTIPLE WRMSENDMSG - TIME_WAIT, CLOSE_WAIT AND FIN_WAIT2       NULLPOINTEREXCEPTION - United States

Text:
AIX SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  Environment
   TEC - ANY as problem is on reception of events at RM engine
   RM  4.2 FP01
   OS  SuSE SLES-8 (i386)
   VERSION = 8.1
   I've tried it on AIX 5.1 too and got the same problem.
   Description
   If I send several thousand events to the agent using wrmsendmsg
   then either the agent crashes after some time or the admin port
   is going down. This occurs on the client as well as on the
   server when I force some queuing (the agent is writing events
   to the persistencestore)
   .
   
   Other relevant information
   Errors:
   <Trace Level="ERROR">
    <Time Millis="1108461565444"> 2005.02.15
   10:59:25.444+01:00</Time>
    <Component>event_monitor</Component>
    <LogText><!&#65436;CDATA&#65436;java.io.FileNotFoundException:
   /applications/Tivoli/rmclient/RISKMGR/persiste
   nce/LOG_FILE_MONITOR_messages.test.check (Too many open files)]]
   ></LogText>
    <Source FileName="com.tivoli.RiskManager.EventMonitor.Monitor.
   EventMonitorSourceLog&#65469;Checkpoint"
    Method="public flush()"/>
    <Thread>LOG_FILE_MONITOR</Thread>
    <Exception><!&#65436;CDATA&#65436;java.io.FileNotFoundException:
   /applications/Tivoli/rmclient/RISKMGR/persis
   tence/LOG_FILE_MONITOR_messages.test.check (Too many open files)
   or
    <Server Format="IP">secmon2.ose.eur.deuba.com</Server>
    <ProductId>HRM</ProductId>
   I used only one event source and a connection straight to the
   sender.
   When I found this issue I was stress testing the TEC and wanted
   some
   events in sender queue to send a big amount of events in short
   time.
   I used the following to send the events to the agent:
   .
   perl -ne 'chomp; system("wrmsendmsg","-f",&#65469;_)' wtdumprl.out.1
   wtdumprl.out.1 contains approx. 36 000 events in the needed
   format.
   First I stop the eif_sender to force queuing and then start perl
   ...
   During my last tests I found a lot of connections to port 5529
   (local_only_receiver) with state TIME_WAIT, CLOSE_WAIT and
   FIN_WAIT2.
   That would explain the "too many open files" error. But why are
   so many
   connections in CLOSE_WAIT and FIN_WAIT2 ?
   Furtheron I found some java.lang.NullPointerException . Afaik
   such
   errors shouldn't ocurr ... in no case. Am I right in this point?
   wrmsendmsg is opening a new connection for each event and
   problems are
   experienced closing them - waiting for timers to expire.
   First error in msgHRM.log is
   <Message Id="HRMAG0092E" Severity="ERROR">
    <Time Millis="1108634223022"> 2005.02.17
   10:57:03.022+01:00</Time>
    <Component></Component>
    <LogText><!&#65436;CDATA&#65436;HRMAG0092E Caught exception
   java.io.FileNotFoundException:
   /applications/Tivoli/rmclient/RISKMGR/persistence/sender/eif_sen
   der/1108
   633811.rm (Too many open files).]]></LogText>
    <Source FileName="com.tivoli.RiskManager.Agent.rmaPersistFile"
   Method="setFileName(String, boolean, int)"/>
    <TranslationInfo Type="JAVA" Catalog="rmagent_msg"
   MsgKey="HRMAG0092E"><Param><!&#65436;CDATA&#65436;java.io.FileNotFoundExceptio
   n:
   /applications/Tivoli/rmclient/RISKMGR/persistence/sender/eif_sen
   der/1108
   633811.rm (Too many open files)]]></Param></TranslationInfo>
    <Principal></Principal>
   </Message>
   So looks like problems with persistence file is indicated but
   due to 'too many files'
   .
         I think wrmsendmsg does open a new connection each time it
   is called,
   but it still sounds like there may be a problem closing the
   connections,
   and the null pointer exception should not be happening.
   .
   level3 agreed  TW
   doc   documentation on l2l3 in PMRs/45468,075,724
   
   
    
   
   

LOCAL FIX

PROBLEM SUMMARY
 *  Customer configured a bare client system, receiver and sender.
   
   After starting the RM agent, the sender component is stopped, to
   force queueing on the sender queue. Customer then ran a Perl
   script to send 36878 RM events to the RM agent via calls to
   wrmsendmsg, with no time delay between each event. Each
   invocation of wrmsendmsg (once per event) opens a socket
   connection, sends the event, then closes the socket connection.
   wrmsendmsg uses TEC EEIF C APIs to open-send-close connections
   to the RM agent.  RM agent uses TEC EEIF Java APIs to accept
   socket connections and receive events.
   
   Given the above test scenario, the customer reported symptoms:
   - a lot of connections to port 5529 (local_only_receiver for RM
   agent) with state TIME_WAIT, CLOSE_WAIT and FIN_WAIT2.
   
   - RM agent admin port (5531) stops accepting connections from
     wrmadmin and wrmqueue CLIs
   - RM agent terminates
   - exceptions in the trace/msg logs, including
   FileNotFoundException and NullPointerException
   
   
    
   
   

PROBLEM CONCLUSION
 *  Added the following function to rmagent.jar:
   - Eliminated likelihood of NullPointerException occuring in
   rmagent and rmaQMgrPersistent classes
   - Send queue failure message to TEC when a fatal queue error
   occurs
   - Keep command receiver listener active when number of open
   sockets exceeds system limits
   
   The fix for this APAR will be contained in the following
   maintenance package:
       | interim fix | 4.2.0-RMG-0010
   
   
   Note: Search the IBM Technical support web site for maintenance
   package availability
   
   
    
   
   

TEMPORARY FIX

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   IY68545
   
   
 * REPORTED COMPONENT NAME
   TIVOLI RISK MGR
   
   
 * REPORTED COMPONENT ID
   5698RMG02
   
   
 * REPORTED RELEASE
   420
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   NoPE
   
   
 * HIPER
   NoHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2005-03-01
   
   
 * CLOSED DATE
   2005-07-12
   
   
 * LAST MODIFIED DATE
   2008-11-14
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
   
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   TIVOLI RISK MGR
   
   
 * FIXED COMPONENT ID
   5698RMG02
   
   

APPLICABLE COMPONENT LEVELS
 * R420 PSY
   UP