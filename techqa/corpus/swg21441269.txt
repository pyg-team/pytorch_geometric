Title: IBM Control the amount of keep alive messages, and to avoid flooding WAN routers - United States

Text:
stmux; keep-a-live TECHNOTE (TROUBLESHOOTING)

PROBLEM
TCP keep-alive packet bursts are causing overflow in routers

SYMPTOM
WAN routers flooding with TCP-ACK packets burst with the PSH bit set each 60 seconds, causing overflows and traffic on 1533 port to have packet drops


DIAGNOSING THE PROBLEM
See in the \trace\stmux*.txt trace files that the error is received when the ST Mux is sending thousands of keep-alives: 
110126_135818.059,INF,VPK ,SendKeep(11960) 
110126_135818.059,INF,UCM ,WSASend returned immediate success for sId=11960. RequestedBytes=1,SentBytes=1 
110126_135818.059,INF,UCM ,sentBytes equals outBufLen, not skipping 
110126_135818.059,INF,VPK ,SendKeep(36536) 
110126_135818.059,INF,UCM ,WSASend returned immediate success for sId=36536. RequestedBytes=1,SentBytes=1 
110126_135818.059,INF,UCM ,sentBytes equals outBufLen, not skipping 
110126_135818.059,INF,VPK ,SendKeep(44728) 
110126_135818.059,INF,UCM ,WSASend returned SOCKET_ERROR for sId=44728. RequestedBytes=1, SentBytes=0 
110126_135818.059,INF,UCM ,ST return code=2, Winsock Error=WSAENOBUFS (10055) No buffer space available. An operation on a socket could not be performed because the system lacked sufficient buffer space or because a queue was full. 
110126_135818.059,INF,UCM ,broken 44728 (2) 
110126_135818.059,INF,VPMX ,Lost incoming connection -1 (rc 2) 




RESOLVING THE PROBLEM
The following feature was added to 8.5.x ST Mux:
All the VP clients connected to ST server are divided into one or more groups. 
The number of groups is set by the VPMX_NUM_OF_SUBGROUPS_IN_INTERVAL setting in the [Debug] section of sametime.ini. The default value is 1.


Until now the keep alive messages to all VP client were sent in one big burst. The interval between the keep alive messages is set by the VPMX_TIMER_INTERVAL setting. The default value is 60 seconds.

Now after the change, the keep alive messages to clients from the same group are sent together (in one burst) and keep alive messages to clients belonging to other groups are sent in a different time. This is achieved by dividing the time interval set by VPMX_TIMER_INTERVAL to X sub intervals (X equals to VPMX_NUM_OF_SUBGROUPS_IN_INTERVAL). In each sub interval keep alive messages are sent to clients of a single group solely.

The interval between keep alive to a specific client wasn't affected and it is still equal to VPMX_TIMER_INTERVAL.

The number of the keep alive messages sent at the same time is now:
"number of all VP clients"/VPMX_NUM_OF_SUBGROUPS_IN_INTERVAL.

Note: This new setting should be used only for environment with large number of users and routers which are not strong enough to handle the amount of keep alive messages. For the common environment this setting is not recommended.