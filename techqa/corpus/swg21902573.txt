Title: IBM MustGather: Search Rules (REST) related issues for WebSphere Commerce - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 MustGather: Search Rules (REST) related issues for WebSphere Commerce 

RESOLVING THE PROBLEM


Gathering this MustGather information before calling IBM Support will help familiarize you with the troubleshooting process and save you time. 
Note: This MustGather is for collecting search rules data when using REST framework. If you are using the BOD framework, use MustGather: Search Rules [http://www-01.ibm.com/support/docview.wss?uid=swg21902252]


 Considerations before collecting data 
Take note of the following before collecting the information described below:

 * Performance  * Runtime tracing may be verbose, and it could impact performance during peak time. If possible, reproduce the problem on a non-production environment to capture tracing.
      
   
    *  If using WebSphere Version 8, there is an option to utilize High Performance Extensible Logging(HPEL) to minimize the impact of logging and tracing. The logs need to be formatted using the logViewer utility [https://www-01.ibm.com/support/knowledgecenter/SSAW57_8.5.5/com.ibm.websphere.nd.doc/ae/rtrb_logviewer.html] before uploading to IBM. For more information on enabling HPEL, refer to WebSphere Knowledge Center Using HPEL to troubleshoot applications [ https://www-01.ibm.com/support/knowledgecenter/SSAW57_8.5.5/com.ibm.websphere.nd.doc/ae/ttrb_usinghpel.html].
   
   

 * Security  * Some trace strings could capture sensitive or personal infomation. Be sure to sanitize the logs before uploading to IBM. Commerce uses data masking to help mask sensitive data. See Knowledge Center Masking Sensitive data in traces [http://www-01.ibm.com/support/knowledgecenter/SSZLC2_7.0.0/com.ibm.commerce.developer.doc/concepts/csdlogging.htm?lang=en]
   
   


 COLLECTING DATA 



 I. Configure environment 

Follow the instructions below to configure your environment to capture the required diagnostic information: 

 1. Update the size of the trace files to 20MB and the number of historical trace files retained to 20 . If using HPEL, set maximum size to at least 500MB.
 2. Enable the following trace string on the Commerce Server:
    
    *=info: com.ibm.commerce.catalog.*=all: com.ibm.commerce.foundation.*=all: com.ibm.commerce.catalog.facade.server.services.dataaccess.bom.mediator.solr.*=info: com.ibm.commerce.foundation.internal.server.services.search.config.solr.*=info: com.ibm.commerce.foundation.server.services.search.config.solr.*=info: com.ibm.commerce.marketing.*=all 
 3. Enable the following trace string on the Solr Server:
    
    *=info: com.ibm.commerce.foundation.*=all: com.ibm.commerce.foundation.internal.server.services.search.config.solr*=info: com.ibm.commerce.foundation.server.services.search.config.solr*=info: com.ibm.commerce.rest.*=all  *  - [http://www.ibm.com/i/c.gif]Enabling trace What is this data These trace components increase the amount of diagnostic data logged to the WebSphere server trace file. Why do I need this data This data will capture more detailed diagnostic trace information for the subject component. Where can I find this data Please look at the following Commerce Information Center documentation for more information on enabling Commerce trace components:  1.  Configuring logging in WebSphere Commerce [http://publib.boulder.ibm.com/infocenter/wchelp/v7r0m0/index.jsp?topic=/com.ibm.commerce.admin.doc/tasks/tlslogging.htm] 
       
       
    
    
    






II. Reproduce the problem 

Note the specific steps used to reproduce the problem and any details that may be relevant. Execute the search scenario. 


Ill. Validate the issue was captured 
Before sending logs to IBM, ensure that the issue being reported was captured. Recommend to review the following documents to help facilitate proper log collection: Avoiding pitfalls when collecting traces. [http://www-01.ibm.com/support/docview.wss?uid=swg21648137] 




IV. Collect data Include the general information requested in MustGather: General Issues in WebSphere Commerce [https://www-304.ibm.com/support/docview.wss?uid=swg21440709] alongside the component-specific information requested below.


 1. Collect the following files from the system:  * WAS_installdir/profiles/WC_profiledir/logs/server_name/trace.log
     * WAS_installdir/profiles/Search_profiledir/logs/search_server_name/trace.log
     * WC_eardir/xml/config/com.ibm.commerce.catalog-ext/wc-search.xml
     * WC_eardir/xml/config/com.ibm.commerce.catalog-fep/wc-search.xml
     * Search_eardir/xml/config/com.ibm.commerce.catalog-ext/wc-search.xml
     * Search_eardir/xml/config/com.ibm.commerce.catalog/wc-search.xml
    
    
 2. Naming conventions can be found here [http://www-01.ibm.com/support/knowledgecenter/SSZLC2_7.0.0/com.ibm.commerce.base.doc/misc/mabhelp.htm?lang=en].
 3. 
 4. Run the following database queries to collect the necessary information from your database (output results in CSV format): Query Output file name SELECT * FROM EMSPOT WHERE USAGETYPE = 'SEARCH' EMSPOT.csv SELECT * FROM DMELEMENT DMELEMENT.csv SELECT * FROM DMELEMENTNVP DMELEMENTNVP.csv 




 SUBMITTING DATA TO IBM SUPPORT 
To diagnose or identify a problem, it is sometimes necessary to provide Technical Support with data and information from your system. In addition, Technical Support might also need to provide you with tools or utilities to be used in problem determination. You can submit files using one of following methods to help speed problem diagnosis:

 * IBM Support Assistant (ISA)
 * Service Request (SR)
 * E-Mail
 * FTP to the Enhanced Customer Data Repository (ECuRep)

Exchanging information with IBM Technical Support for problem determination [http://www.ibm.com/software/support/exchangeinfo.html] 


 GETTING STARTED 
Now that you have collected this data, there are specific phrases that you can search for in the tracing captured to tell you more about your scenario and possible causes for the issue you are seeing. You can also ask yourself the associated questions to determine if this is the cause of the issue you are seeing:

 *  Search for _mkt:ShowMarketingSpotDataDataAreaType in the Commerce tracing collected to find the BOD response of the request for search rule data.
   
    * In the BOD response, you should see _mkt:DataType>SearchQuery to indicate that this response is specifically for search rule data (rather than a request for other marketing data).
   
   
 *  Search for SolrSearchProfileConfig$ProviderConfig getProviders() RETURN in the Search tracing collected to verify that search rules will be properly processed.
   
    * If you do not see SolrRESTSearchBasedMerchandisingExpressionProvider being mentioned, then search rules will not be applied to the search.
   
   
 *  Search for SolrSearchConfigurationRegistry getSolrSearchProfileConfiguration(String) RETURN in the Search tracing collected to verify that the expected search profile is being used.
   
    * You should see your expected search profile being mentioned in here as well as SolrRESTSearchBasedMerchandisingExpressionProvider to confirm that search rules will be applied to this search. If you don't see SolrRESTSearchBasedMerchandisingExpressionProvider, you can check wc-search.xml to verify if this expression provider is defined for the search profile.
   
   
 *  Search for RestHandlerHelper internalIssueRESTServiceRequest(String,MessageContext,boolean,Map in the Search tracing collected to verify that a REST request is being sent to retrieve the search rule data from the Commerce server and returning the expected search rule to use. 
   
    * In internalIssueRESTServiceRequest(String,MessageContext,boolean,Map you should see a URL like the following being used: hostname/wcs/resources/store/store_id/espot/search_phrase/type/search
    * In internalIssueRESTServiceRequest(String,MessageContext,boolean,Map , you should see a JSON object with the search rule returned. You can check that this contains the search rule's name, the search term it is applied to, and the result of the search rule.
   
   
 *  Search for com.ibm.commerce.foundation.server.services.rest.search.expression.solr.SolrRESTSearchBasedMerchandisingExpressionProvider in the Search tracing collected to get information on how this expression provider is processing the search rules.
   
    * SolrRESTSearchBasedMerchandisingExpressionProvider searchRulesExist (String astrSearchPhrase) ENTRY will let you know what search phrase it is checking to verify if search rules exist for.
    * SolrRESTSearchBasedMerchandisingExpressionProvider searchRulesExist(String astrSearchPhrase) RETURN will let you know if this search phrase has search rules associated to it. If this is false, then you will need to review the Commerce tracing to confirm why it wasn't able to retrieve a search rule associated to the search phrase.
    * SolrRESTSearchBasedMerchandisingExpressionProvider$MySearchRuleQueryFragments runSearchRulesAndGetSearchQuery(List alQueryParameters) RETURN Query fragment: will let you know the result of the search rule. For example, if your search rule will push product with catentry_id 12345 to the top, then you may see something like q=catentry_id:"12345"^10000.
   
   


ADDITIONAL RESOURCES
 * Working with Search Rules [http://www-01.ibm.com/support/knowledgecenter/SSZLC2_7.0.0/com.ibm.commerce.management-center.doc/tasks/tsbsearchsupert.htm?lang=en]
 * Search Rule Evaluation [http://www-01.ibm.com/support/knowledgecenter/SSZLC2_7.0.0/com.ibm.commerce.management-center.doc/refs/rsbsearchruleprec.htm?lang=en]