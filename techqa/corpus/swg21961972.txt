Title: IBM ANS9365E API return code   : 26 VM snapshot not deleted - United States

Text:
zztsm tsm4ve tdp4ve snapshot disconnect quiesce tsm TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 The VM guest snapshot deletion at the end of the backup is not happening due to connection errors to the ESXi host. 

SYMPTOM
The dsmerror.log of the data mover node performing the VM backup will display the following message : 

ANS9365E VMware vStorage API error for virtual machine <VMname>'.
TSM function name : VixDiskLib_Cleanup
TSM file : vmvddksdk.cpp (1619)
API return code : 26
API error message : Unable to connect to the host


CAUSE
VMware ESXi host defect :
"Backing up a virtual machine with Changed Block Tracking (CBT) enabled fails after upgrading to or installing VMware ESXi 6.0"
http://kb.vmware.com/kb/2114076 [http://kb.vmware.com/kb/2114076]


DIAGNOSING THE PROBLEM
When the above VMware defect is experienced, the following can be seen in an IBM Spectrum Protect client trace at the moment the client wants to close the connection to the VM guest vmdk file on the ESXi host in order to clean up the snapshot as the next step : 


<timestamp> : ..\..\common\vm\vmbackvddk.cpp(12480): vmVddkFullVMCloseVMDKs: Closing disks for vm '<vmname>'
<timestamp> : vmvddksdk.cpp (1168): VixDiskLib: VixDiskLib_Close: Close disk.
<timestamp> : vmvddksdk.cpp (1168): VixDiskLib: VixDiskLib_Disconnect: Disconnect.
<timestamp> : vmvddksdk.cpp (1168): VixDiskLib: VixDiskLib_Cleanup: Remove previous mount points and clean up .
<timestamp> : vmvddksdk.cpp (1168): VixDiskLib: VixDiskLib_Connect: Establish connection.
<timestamp> : vmvddksdk.cpp (1168): <timestamp> [03084 error 'HttpConnectionPool-000000'] [ConnectComplete] Connect failed to <cs p:0000000005609f30, TCP:<vcenter_host>:443>; cnx: (null), error: class Vmacore::Ssl::SSLException(SSL Exception: error:140000DB:SSL routines:SSL routines:short read)?
<timestamp> : vmvddksdk.cpp (1168): <timestamp> [03084 error 'HttpConnectionPool-000000'] [ConnectComplete] Connect failed to <cs p:0000000005609980, TCP:<vcenter_host>:443>; cnx: (null), error: class Vmacore::Ssl::SSLException(SSL Exception: error:140000DB:SSL routines:SSL routines:short read)?
<timestamp> : vmvddksdk.cpp (1168): VixDiskLib: VixDiskLib_Cleanup: Error occurred during cleanup operation. Error 26 at 3143.
<timestamp> : vmvddksdk.cpp (1168): VixDiskLib: VixDiskLib_Disconnect: Disconnect.
<timestamp> : vmvddksdk.cpp (1024): vddksdkPrintVixError(): VM name '<vmname>'.
<timestamp> : vmvddksdk.cpp (1054): 
ANS9365E VMware vStorage API error for virtual machine '<vmname>'.
TSM function name : VixDiskLib_Cleanup
TSM file : vmvddksdk.cpp (1619)
API return code : 26
API error message : Unable to connect to the host

Code 26 means: VIX_E_HOST_NOT_CONNECTED - Unable to connect to the host.

Due to this error the snapshot is not deleted and, after several additional backup runs, these accumulated snapshots will slow down the backup process and ultimately fail when the datastore storage space will be used up.


RESOLVING THE PROBLEM
Update the ESXi host to : 


VMware ESXi 6.0, Patch ESXi600-201505401-BG: Updates esx-base
http://kb.vmware.com/kb/2116126 [http://kb.vmware.com/kb/2116126]