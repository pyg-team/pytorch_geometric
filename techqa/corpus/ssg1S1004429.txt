Title: IBM Degraded Performance of Storwize V7000 Unified V1.4.1.X due to 10 GbE Emulex Card - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Specific performance issues may be observed on Storwize V7000 Unified when using 10 GbE interfaces on the Emulex card after upgrade to V1.4.1.0 or V1.4.1.1. This may impact some NAS protocols, but not all. 

SYMPTOM
Reported performance issues which may reflect the degraded performance: 

 *  Slow mounting 
 *  Slow meta data commands on the mount like "ls" 
 *  Slow reads using protocols like SCP (copying files off Storwize V7000 Unified as an SCP target) 
 *  Slow Async Replication between clusters


ENVIRONMENT
The issue is exposed in Storwize V7000 Unified 1.4.1.x. This is where the Emulex firmware was updated to 4.0.1062.0.

DIAGNOSING THE PROBLEM
If you are on one of the impacted releases, then check the firmware level of ethernet card. 


Driver and Firmware check
Access the active management node as "root". Execute below commands. 
[mgmt]# intlist=`lsnode -Y |egrep 'interface' |cut -d ':' -f 7 |sort` ; echo $intlist
[mgmt]# for node in $intlist; do for adapter in $(lsnwinterface -x -Y | egrep "SUBORDINATE" | grep ${node} | cut -d: -f8); do echo node ${node} adapter ${adapter}; ssh ${node} ethtool -i ${adapter}; echo ""; done ; done | less 

Typical output for affected card :
node mgmt001st001 adapter ethXsl0_0
driver: be2net <---emulex driver
version: 4.2.324.11 <---this is the driver version that normally comes with the firmware version 4.0.1062.0. 
firmware-version: 4.0.1062.0 <---this is the firmware version that IS exposed to the performance issue
bus-info: 0000:1f:00.0 

Typical output for non-affected cards, but needs firmware upgrade.
node mgmt001st001 adapter ethXsl0_1
driver: be2net <---emulex driver
version: 2.103.298r <---Downlevel - Needs Updated
firmware-version: 3.103.397.31 <---Downlevel - Needs Updated
bus-info: 0000:1f:00.0 


Performance Check
Additionally, you may check performance by conducting simple test.
The issue can be most obviously observed with doing an scp copy of a reasonable size file (200 MB or larger). You want to have the copy "pull" from the Storwize V7000 Unified file module which has the impacted firmware. This is because the issue impacts reads from system via SCP.

a) Transfer rates are low (normally not higher than 15 MB/s ). Normal speeds can vary, but common normal is 100+ MB/s.
b) In a second window, if you ping the file module before the data transfer, times should be normal (in the low ms level). If you ping the system while the SCP transfer, you will see times go into 150 to 500 ms range (considerable change). In this case, you likely have the issue.
c) When you stop the SCP copy, ping times come right back down to normal.

If you want to test file module to file module instead of using a remote client, ensure you use the public IP for the other file module and not the internal node name. So it would be:

scp root@<ctdb public ip>:/<file or wildcard> <target directory>

Example:
scp root@10.18.0.147:/var/log/messages* /tmp


RESOLVING THE PROBLEM
This issue is fixed with IBM Storwize V7000 Unified V1.4.2.0. It is recommended to upgrade to this code level to resolve this problem. 



Alternatively, the following procedure may be executed to resolve the problem in case the system is impacted by this issue and upgrading to V1.4.2.0 to resolve the problem is not immediately possible.

Follow below procedures on the file modules, where you found affected card, or cards which needs firmware upgrade.
Get the interim fix from FixCentral (Follow the link provided at the bottom - "Related information" section).

Note 1: If both file modules are affected, start with the passive management node first. Once the reboot and resume of the node is completed, perform the node failover (follow IBM Storwize V7000 Unified Version 1.4.1 [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/ifs_ichome_141.html] > Troubleshooting [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/svc_webtroubleshooting_21pbmm.html] > File module [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/ifs_trbfilemodule_6731pb.html] > File module software problems [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/ifs_trbfilenodesfwprobs.html]> Management node role failover procedures [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/trbl_mgmt_flovr_prcdrs.html]) and repeat below procedure. 
Note 2: If only one file module is affected and if it active management node, perform the node failover (follow IBM Storwize V7000 Unified Version 1.4.1 [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/ifs_ichome_141.html] > Troubleshooting [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/svc_webtroubleshooting_21pbmm.html] > File module [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/ifs_trbfilemodule_6731pb.html] > File module software problems [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/ifs_trbfilenodesfwprobs.html] [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.130.doc/ifs_trbfilenodesfwprobs.html]> Management node role failover procedures [http://pic.dhe.ibm.com/infocenter/storwize/unified_ic/topic/com.ibm.storwize.v7000.unified.141.doc/trbl_mgmt_flovr_prcdrs.html]) and perform below procedure.

1. Upload the interim fix on the active management node.
2. From the active Management node, Suspend the affected node. 

 *  [mgmt]# suspendnode <node> (IF NOT ALREADY SUSPENDED)

3. Apply the interim fix. The fix will be applied only on suspended node.  *  [mgmt]#
 * applysoftware /<full path to>/IBM2851_INSTALL_1.4.1.0_emulex_perf_efix

4. If you do not see the following message, please contact IBM Support, else proceed to step 5 and 6:  *  "Efix for performance issue with Emulex adapter applied successfully on <node name>"

5. From active management node reboot the affected node using the "stopcluster -n <node> --restart" command.  * [mgmt]# stopcluster -n <node> --restart
 * 
 * Note:
 * 

6. From active management node resume the affected node after the reboot is completed successfully.  * [mgmt]# resumenode <node>
 * 
 * 
 * 

RELATED INFORMATION
#Emulex Fix on FixCentral [http://www-933.ibm.com/support/fixcentral/swg/downloadFixes?parent=Mid-range+disk+systems&product=ibm/Storage_Disk/IBM+Storwize+V7000+Unified&release=All&platform=All&function=fixId&fixids=StorageDisk-2073-EmulexFix&includeRequisites=1&includeSupersedes=]