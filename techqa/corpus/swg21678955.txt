Title: IBM Procedure for replacing a server in a TSAMP/RSCT cluster - United States

Text:
tsa; tsamp; samp; rsct; replace; startrpdomain -L; recfgct; remove; reload TECHNOTE (FAQ)

QUESTION
 This technote will assist with re-integrating a new server into an existing cluster configuration. You may need to adjust the steps to suit your specific environment. The steps below are based on a DB2 HADR two node cluster. 

ANSWER
Unless specifically stated, all commands should be issued by the root user (not sudo).


Its expected that CT_MANAGEMENT_SCOPE is exported to a value of 2 in all shells where commands are run. If you are unsure check the value:
echo $CT_MANAGEMENT_SCOPE

If it comes back as a "2" you are all set. If not please export it and consider adding this to the default profile for all users on these nodes:
export CT_MANAGEMENT_SCOPE=2 

 

For simplicity's sake I will be referring to the nodes in the following manner: 

node01 - Node to remain 

node02 - Node to be replaced

Step 1. Find and retain the node ID for the node to be replaced 

lsrpnode -i 

Or if the domain/cluster is offline you can use:
/usr/sbin/rsct/bin/lsnodeid
or you can also look at the following file:
cat /var/ct/cfg/ct_node_id

The first command can be issued from either node, the second and third command must be issued on node02.

Make a copy of this hexadecimal number and save it off as its critical for this procedure to complete correctly. 

 

Step 2. Offline all resources on the node to be replaced 

Issue the chrg command to change the nominal state of all resources that reside on node02, for example, the db2 instance resource that is a fixed resource on node02. 

chrg -o offline <resource_group_name> 

Verify with lssam that the resources in the above resource group go to a state of offline. 

Ensure with lssam command that no resources are currently running on node02. 

 

Step 3. Set CritRsrcProtMethod to 5
chrsrc -c IBM.PeerNode CritRsrcProtMethod=5

This will ensure that RSCT will not reboot a node should a critical resource exit abnormally.


Step 4. Tell DB2 that the cluster is going away for a bit 

As the DB2 instance owner issue the following command on both nodes in the cluster: 

db2haicu -disable 

This notifies that DB2 that it should not rely on TSAMP to perform basic DB2 functions like takeover. 


Step 5. Stop the domain only on node02 

stoprpnode node02 

Verify that the cluster on node02 has stopped with "lsrpdomain" on node02 and "lsrpnode" on node01. 

 

Step 6. Perform the maintenance/rebuild/replacement 

Take note that the new server must be named exactly the same as the old server. The /etc/hosts should be copied over, all DB2 configuration should be identical to the way node02 had been configured before this maintenance action. 

 

Step 7. Reinstall the same TSAMP version on node02 

Using the installation media that was previously used and ensuring that you are also using a valid license for this node install TSAMP using typical installation methods. 

Also during this step you should ensure that DB2 or other applications are working correctly, for example, DB2 HADR should be back in a peer connected state. 

 

Step 8. Assign the original nodeid back to the new node02 

The following command will reset all cluster configuration on the node and assign the specified nodeid back to the node:
/usr/sbin/rsct/install/bin/recfgct -i <nodeid from step 1>
Verify that this has worked with the following command showing the new nodeid:
/usr/sbin/rsct/bin/lsnodeid

Step 9. Preprpnode on node02
In preparation for the cluster to be configured on this node run the following command on both nodes:
preprpnode node01 node02

To ensure that all is setup correctly you can also do the preprpnode command on node01.
This ensures that all is ready and both nodes should sync up.

Step 10. Start the domain (copies the cluster config to the new node02)
On node01, you must stop the domain in order to bring node02 back into the domain.

To stop the domain that is currently online on node01, issue the following command on node01:
stoprpdomain <domain_name>
Verify domain is stopped with "lsrpdomain" command.

Start the domain with the following command, issued on node01
startrpdomain -L <domain_name>
Note: the -L option forces the domain configuration from node01 (current node) to be copied to node02.

Verify that the domain is online on node01 with lsrpdomain. Once online check lsrpdomain status on node02. Both should be showing the domain online. 

Re-enable CritRsrcProtMethod:
chrsrc -c IBM.PeerNode CritRsrcProtMethod=3

Step 11. Re-integrate TSAMP and DB2 HADR
On both nodes issue the following command as the DB2 instance owner:
db2haicu
If it brings you to the menu prompt you do not need to do anything other then choose TSA as the cluster provider and then exit.

Step 12. Verify things are looking good with lssam output
Check the status of the cluster with lssam and verify all resources have an expected state