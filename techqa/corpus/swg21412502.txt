Title: IBM Unable to process a return for register user with administrator roles - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 When processing a return for an order submitted by a registered user with an administrator role the following error occurs on WebSphere Commerce Accelerator:

"CMN0207E The value of the parameter "forUser (ADMIN_USER)" is not correct" 

SYMPTOM
To reproduce the problem: 


1. Log on as a user with an administrator role: 

Example:
ROLE_ID NAME
-29 'Registered Customer' 
-15 'Returns Administrator' 
-14 'Customer Service Supervisor' 

Submit an order.

2. Process the order ensuring that it is in a state that returns are allowed.

3. Log on to the WebSphere Commerce Accelerator as a different administrator. In WebSphere Commerce Accelerator, click Operations -> Find Orders -> Find the order you submitted. Select the check box next to the order and click New Return. Complete the quantities on the next page, and click OK.

A window is displayed with the following message: 
"CMN0207E The value of the parameter "forUser (ADMIN_USER)" is not correct"

In the log files the following errors are displayed:
[11/5/09 18:31:59:653 CST] 0000119f WC_SERVER 3 AccManager canUserExecuteCommand Cannot do forUser against a user with registration type 'A' or 'S'
[11/5/09 18:31:59:653 CST] 0000119f CommerceSrvr A AccManager canUserExecuteCommand CMN0207E The value of the parameter "forUser (ADMIN_USER)" is not correct.
[11/5/09 18:31:59:660 CST] 0000119f SystemErr R
[11/5/09 18:31:59:660 CST] 0000119f SystemErr R Correlation Identity: cb6997e0-ca6b-11de-8b2b-86734aef9de6
[11/5/09 18:31:59:661 CST] 0000119f SystemErr R Additional Data:
[11/5/09 18:31:59:661 CST] 0000119f SystemErr R null
[11/5/09 18:31:59:661 CST] 0000119f SystemErr R Current exception:
[11/5/09 18:31:59:661 CST] 0000119f SystemErr R Message:
[11/5/09 18:31:59:661 CST] 0000119f SystemErr R _ERR_CMD_INVALID_PARAM
[11/5/09 18:31:59:661 CST] 0000119f SystemErr R Stack trace:
[11/5/09 18:31:59:662 CST] 0000119f SystemErr R com.ibm.commerce.exception.ECApplicationException: CMN0207E The value of the parameter "forUser (ADMIN_USER)" is not correct.
at java.lang.Throwable.<init>(Throwable.java:179)
at java.lang.Exception.<init>(Exception.java:29)
at com.ibm.websphere.exception.DistributedException.<init>(DistributedException.java:136)
at com.ibm.websphere.command.CommandException.<init>(CommandException.java:126)
at com.ibm.commerce.exception.ECException.<init>(ECException.java:262)
at com.ibm.commerce.exception.ECApplicationException.<init>(ECApplicationException.java:445)
at com.ibm.commerce.exception.ECApplicationException.<init>(ECApplicationException.java:391)
at com.ibm.commerce.exception.ECApplicationException.<init>(ECApplicationException.java:106)
at com.ibm.commerce.accesscontrol.AccManager.canUserExecuteCommand(AccManager.java:122)
at com.ibm.commerce.command.AbstractECTargetableCommand.accessControlCheck(AbstractECTargetableCommand.java:80)
at com.ibm.commerce.command.ECCommandTarget.executeCommand(ECCommandTarget.java:72)
at com.ibm.ws.cache.command.CommandCache.executeCommand(CommandCache.java:329) 

....


CAUSE
The user who owns this order is of register type 'A' or 'S', you can confirm by checking the column USERS.registertype in database. AccManager.canUserExecuteCommand(AccCommand) command checks the register type of forUserId, if it's 'A' or 'S', means it is an administrative user, then this exception is thrown in the logs:

"Cannot do forUser against a user with registration type 'A' or 'S'".

In this case, the owner of the order is regarded as the forUser. According to the access control policy any execution on behalf of an administrator is not allowed.


RESOLVING THE PROBLEM
Remove all administrator roles for the user that purchased the order and only have Registered Customer role or Guest Customer role only: 


Example:
ROLE_ID NAME
-29 'Registered Customer' 

To remove roles from a customer:
1. Open the Organization Administration Console [http://publib.boulder.ibm.com/infocenter/wchelp/v6r0m0/topic/com.ibm.commerce.admin.doc/tasks/ttfbsopb.htm].
2. Select Access Management > Find Users.
3. In the Find Dialog page, provide search criteria and click Find. A list of users displays.
4. Select the check box next to the user that you want to work with and click Roles. The Roles 
dialog opens.
5. From the Selected roles list, select the role and organization combination that you want to remove
and click Remove. The role and organization combination moves from the Selected roles list and 
the user is no longer assigned this role. 
6. Click OK after you have defined all roles for the user. 

Once the role of the user is updated you will be able to return the order.