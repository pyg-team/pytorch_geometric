Title: IBM PK86875: CSQM064I INTRA-GROUP QUEUING AGENT PUT MESSAGES TO DEAD-LETTER  QUEUE. THE DLH RC IS MQFB_XMIT_Q_MSG_ERROR - United States

Text:
z/os  A FIX IS AVAILABLE
Obtain the fix for this APAR.


SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  POK has two queue managers, one recently migrated to V7 and one
   V6, both running on z/os 1.10 LPARS, members of a cluster and
   members of a queue sharing group.  Some of their messages
   started failing when they would default to use the intra queue
   agent. Disabling the intra queue agent in the queue manager
   sending the message works as a workaround. Messages land in the
   dead letter queue of the queue manager receiving the message
   with a reason code of MQFB_XMIT_Q_MSG_ERROR, the field for
   orginal format doesn't show up properly and the fields
   Destination queue and destination queue manager show blank. If
   they disable intra queue agent, message arrives at the proper
   queue with MQSTR in the format.
   .
   The Change Team reviewed the doc determined the following:
   This problem is caused by module CSQMPRPF inserting an MQRFH2
   immediately following the MQMD if an MQMDE does not exist in
   the message and totally ignoring the presence of an MQXQH
   which will exist if we are putting via a qsgdisp=shared XMITQ
   (which IGQ uses (SYSTEM.QSG.TRANSMIT.QUEUE)). Module CSQMIGQA
   expects an MQXQH immediately after the MQMD, but finds an ASCII
   MQRFH2 which he does not consider valid - Hence the CSQM064I
   message when he puts the input message to the DLQ with reason
   code MQFB_XMIT_Q_MSG_ERROR.
   CSQX548E Messages sent to local dead-letter queue,
   channel channel-name, reason=271
   
   
    
   
   

LOCAL FIX

PROBLEM SUMMARY
 *  ****************************************************************
   * USERS AFFECTED: All users of WebSphere MQ for z/OS Version 7 *
   *                 Release 0 Modification 0 and Modification 1  *
   ****************************************************************
   * PROBLEM DESCRIPTION: Multiple problems with messages that    *
   *                      contain RFH2 headers or message         *
   *                      properties, and also contain either an  *
   *                      XQH and/or MDE                          *
   *                                                              *
   *                      At v700 the following problems have     *
   *                        been identified:                      *
   *                      - Messages put to a shared queue        *
   *                        contain the RFH2 and XQH/MDE headers  *
   *                        in the wrong order, preventing them   *
   *                        from being successfully gotten.       *
   *                      - Messages put to a shared queue that   *
   *                        contain the RFH2 and XQH/MDE headers  *
   *                        in the correct order (for example,    *
   *                        put by a v6 qmgr) are returned by an  *
   *                        MQGET with the headers in the wrong   *
   *                        order.                                *
   *                      Symptoms of these problems include      *
   *                        message CSQM064I, and                 *
   *                      - messages written to the DLQ with RC   *
   *                        MQFB_XMIT_Q_MSG_ERROR                 *
   *                      - Messages got from a queue which also  *
   *                        contains a message with an MDE which  *
   *                        is 'not suitable' for the getter (for *
   *                        example, the groupid does not match   *
   *                        the search criteria) may result in an *
   *                        additional 48 bytes of nulls being    *
   *                        added to a subsequently returned      *
   *                        suitable message.                     *
   *                      At v700 and v701 the following problem  *
   *                        has been identified:                  *
   *                      - Messages containing an RFH2 header or *
   *                        message properties, and both an XQH   *
   *                        and MDE abend 5C6-00D40095 when put   *
   *                        to a shared queue.                    *
   ****************************************************************
   * RECOMMENDATION:                                              *
   ****************************************************************
   During MQPUT of a message with properties OR an RFH2 header to
   a SHARED QUEUE in a QSG, the properties are 'flattened' by
   module CSQMPRPF and written as an RFH2 as part of the message
   body. When an MDE or an XQH is also present the RFH2 is
   incorrectly positioned before the XQH/MDE. The message is
   written in this BAD format to the CF - so even a V600 QMGR in
   the same QSG will see the problem. At MQGET by a channel or IGQ
   the message CSQM064I will result and the message will be put to
   the DLQ with feedback MQFB_XMIT_Q_MSG_ERROR. For GROUP messages
   the grouping information may be ignored.
   As well as the above problems at PUT time, even a validly
   formatted message on a SHARED queue (e.g put by a V6 QMGR) that
   contains an RFH2 with an MDE or XQH is not returned correctly
   by MQGET.
   The above problems are fixed at V701 by Apar PK97364 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK97364], but there
   is an additional problem fixed by THIS Apar :-
   FOR A GROUP MESSAGE WITH AN RFH2 PUT TO A REMOTE QUEUE VIA A
   SHARED XMITQ or IGQ anAbend 5C6-00D40095 will result at PUT
   time due to all the freespace in the MDMCI control block
   having been used because the free offset is not properly
   decremented when an entry is deleted.
   During testing at V700 an additional problem was discovered
   where when an 'unsuitable' (i.e MsgId/CorrelId mismatch) message
   with an MDE exists on a LOCAL (QMGR) queue that is skipped over
   before a valid message is found causes an extra 72 bytes to be
   appended to the retrieved message. This has also been fixed in
   this Apar by correctly initialising a re-used irh8_info block
   in csqimge9 (This fix is already in Base V701 code).
   
   
    
   
   

PROBLEM CONCLUSION
 *  At V700 level
     Code is added to module CSQMPRPF to correctly chain the MQMD,
     MQXQH, MQMDE AND RFH2, and to order the entries in the MDMCI
     correctly.
     Code is added to module CSQIMPUS to correct the order in
     which the MDMCI entries are written to the CF.
     Code is added to module CSQMHDRS to return the RFH2 to mqget
     in the correct position in the user's buffer.
       ALL the above changes are included in Apar PK97364 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK97364] at V701
     Code is added to module CSQIMGE9 in proc generate_handle to
     correctly initialise the irh8_info structure when it is
     re-used.
       This change is already present in the V701 base code.
   At V700 and V701 levels
     Code is added to module CSQMPOM to bypass adding the chained
     headers entry to the MDMCI when the queue is a shared queue.
     This prevents the Abend 5C6-00D40095 when messages with an
     XQH, MDE, and RFH2 are put to a shared queue.
   000Y
   010Y
   CSQIMGE9
   CSQIMPUS
   CSQMHDRS
   CSQMPOM
   CSQMPRPF
   
   
    
   
   

TEMPORARY FIX
 *  *********
   * HIPER *
   *********
   
   
    
   
   

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   PK86875
   
   
 * REPORTED COMPONENT NAME
   WMQ Z/OS V7
   
   
 * REPORTED COMPONENT ID
   5655R3600
   
   
 * REPORTED RELEASE
   000
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   NoPE
   
   
 * HIPER
   YesHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt
   
   
 * SUBMITTED DATE
   2009-05-18
   
   
 * CLOSED DATE
   2009-11-27
   
   
 * LAST MODIFIED DATE
   2010-01-05
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
    UK52366 UK52367
   
   

MODULES/MACROS
 *  CSQIMGE9 CSQIMPUS CSQMHDRS CSQMPOM  CSQMPRPF
   
   
    
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   WMQ Z/OS V7
   
   
 * FIXED COMPONENT ID
   5655R3600
   
   

APPLICABLE COMPONENT LEVELS
 * R000 PSY UK52366 [HTTPS://WWW14.SOFTWARE.IBM.COM/WEBAPP/SET2/ORDERMEDIA/SHOPCART?PTFS=UK52366]
   UP09/12/11 P F912
   
   
 * R010 PSY UK52367 [HTTPS://WWW14.SOFTWARE.IBM.COM/WEBAPP/SET2/ORDERMEDIA/SHOPCART?PTFS=UK52367]
   UP09/12/11 P F912
   
   

FIX IS AVAILABLE
 * SELECT THE PTF APPROPRIATE FOR YOUR COMPONENT LEVEL. YOU WILL BE REQUIRED TO SIGN IN. DISTRIBUTION ON PHYSICAL MEDIA IS NOT AVAILABLE IN ALL COUNTRIES.