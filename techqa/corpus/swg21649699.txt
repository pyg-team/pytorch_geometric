Title: IBM The db2ckupgrade or db2iupgrade tools take a long time to complete when upgrading to the DB2 v10.1 or v10.5 products - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 The db2ckupgrade or db2iupgrade tools appear to hang or take a very long time to complete when upgrading to the DB2 v10.1 or v10.5 products. 

CAUSE
An additional check for tables in load pending state has been added to the db2ckupgrade tool in the DB2 v10.1 and v10.5 products. A query against the administrative view, SYSIBMADM.ADMINTABINFO, is used to obtain this information from the database.
This check can take a long time if a database has a large number of tables, defined indexes and hosts a considerable amount of data.

In return, the db2iupgrade tool is calling the db2ckupgrade tool during instance upgrade.


DIAGNOSING THE PROBLEM
Looking at the db2diag.log file shows that the db2ckupgrade tool is spending a lot of time using the sqlemCkTableLoadPending() function. 


The following example from the db2diag.log file shows a gap of 2 hours between the beginning and end message for the sqlemCkTableLoadPending function:

2013-02-16-09.44.55.802740+000 I161183A335 LEVEL: Warning
PID : 5178038 TID : 1 PROC : db2ckupgrade64_exe
INSTANCE: db2inst NODE : 000
APPID : *N0.db2inst.130216094415
EDUID : 1
FUNCTION: <0>, <0>, <0>, probe:4138
DATA #1 : <preformatted>
DB2CKUPGRADE: Begin: sqlemCkTableLoadPending

2013-02-18-09.46.20.491662+000 I64434131A309 LEVEL: Warning
PID : 5178038 TID : 1 PROC :
db2ckupgrade64_exe
INSTANCE: db2inst NODE : 000
APPID : *N0.db2inst.130216094415
EDUID : 1
DATA #1 : <preformatted>
DB2CKUPGRADE: End: sqlemCkTableLoadPending with rc = 0


While the issue actually occurs during the execution of the db2ckupgrade or db2iupgrade tools, only one initiate see the begin message for the sqlemCkTableLoadPending function.
Additional active SQL monitoring will show following statement running:

"select tabname from SYSIBMADM.ADMINTABINFO where load_status is not NULL"[



RESOLVING THE PROBLEM
 

APAR IC86755, sysrouted to IC94505,IC94506,IC94507 is a possible permanent fix for the issue. The fix presented in the APAR requires both patch to the downlevel server, as well as patching the db2ckupgrade tool from the target server.


You can also use a temporary work around for the issue. Starting with the v10.1 Fix Pack 3 and v10.5 Fix Pack 3 versions of the DB2 product, the db2ckupgrade and db2iupgrade tools have an internal option , -b, which bypasses the check for tables in load pending state.

Caution! The -b option should only be used after making sure there are no tables in the database which are in the load pending state. If the database is upgraded and there are tables in load pending state, then it is impossible to bring the table out of load pending state after an upgrade. The only remedy is to restore the database from a backup to the downlevel server. You can then bring the table out of the load pending state and upgrade the server.

You can use the following code to verify that there are no tables in load pending state:
db2 "select tabname from SYSIBMADM.ADMINTABINFO where load_status is not NULL"
Note: The -b option should only be used if ,the above query return 0 records. The query to ADMINTABINFO might take a long time, especially if the database is huge with lots of objects. We are off-loading this query outside of the db2ckupgrade tool with the -b option, so the db2iupgrade tool (which internally calls db2ckupgrade) run time will be reduced, thus shortening the instance upgrade duration.

One example of this phenomenon might look like the following:
db2ckupgrade <dbname> -b -l <mylog.log> -u <userid> -p <password>
db2iupgrade -b <myinstance>

RELATED INFORMATION
 DB2 v10.1 Information Center - db2ckupgrade [http://pic.dhe.ibm.com/infocenter/db2luw/v10r1/topic/com.ibm.db2.luw.admin.cmd.doc/doc/r0002028.html]
DB2 v10.1 Information Center - db2iupgrade [http://pic.dhe.ibm.com/infocenter/db2luw/v10r1/topic/com.ibm.db2.luw.admin.cmd.doc/doc/r0002055.html]
DB2 v10.5 Information Center - db2chkupgrade [http://pic.dhe.ibm.com/infocenter/db2luw/v10r5/topic/com.ibm.db2.luw.admin.cmd.doc/doc/r0002028.html]
DB2 v10.5 Information Center - db2iupgrade [http://pic.dhe.ibm.com/infocenter/db2luw/v10r5/topic/com.ibm.db2.luw.admin.cmd.doc/doc/r0002055.html]
DB2 v10.1 APAR IC86755 [http://www-01.ibm.com/support/docview.wss?uid=swg1IC86755]
DB2 v10.5 APAR IC94507 [http://www-01.ibm.com/support/docview.wss?uid=swg1IC94507]
DB2 v9.8 APAR IC94506 [http://www-01.ibm.com/support/docview.wss?uid=swg1IC94506]
DB2 v9.7 APAR IC94505 [http://www-01.ibm.com/support/docview.wss?uid=swg1IC94505]