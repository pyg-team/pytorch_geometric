Title: IBM Obtaining the results from MS SQL stored procedure that returns @@ROWCOUNT - United States

Text:
@@ROWCOUNT; stored procedure; sql; database; mssql; microsoft; datapower TECHNOTE (FAQ)

QUESTION
 I am using the IBM WebSphere DataPower SOA appliance to execute a stored procedure defined in the Microsoft SQL Server database. The stored procedure has been defined to return the value of @@ROWCOUNT. When I call the stored procedure, I get the following which does not include the @@ROWCOUNT value.

<sql result="success">
<parameter position="1" />
</sql>

How can I get the value of @@ROWCOUNT? 

CAUSE
'SET NOCOUNT ON' is missing in the stored procedure definition on the Microsoft SQL Server.

ANSWER
To successfully get the returned value of @@ROWCOUNT, the following steps will have to be used: 

1. Define the SQL statement that DataPower will execute to start with '?='.
Ex: {?=CALL store_proc_name(?)} 


2. Make <argument mode="OUTPUT"/> the first argument in the DataPower 'sql-execute' extension element. 


3. Ensure 'SET NOCOUNT ON' is included in the stored procedure definition on the Microsoft SQL Server.


Sample Microsoft SQL stored procedure definition:
---------------------------------------------------------------------------------------------------------
CREATE PROCEDURE [dbo].[store_proc_name]( @value int)
AS
BEGIN
-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
SET NOCOUNT ON

UPDATE [SQL].[dbo].[table_name]
SET [test] = 'test'
WHERE value =@value

SELECT @@ROWCOUNT as update_success
END




Sample XSL snippet with SQL statement to be executed by DataPower:
---------------------------------------------------------------------------------------------------------
<xsl:variable name="statement"> 

 {?=CALL store_proc_name(?)} 

</xsl:variable> 

<db-results> 

 <dp:sql-execute statement="$statement" source="'MSSQL_DS'"> 

 <arguments> 

 <argument mode="OUTPUT"/> 

 <argument type="SQL_INTEGER" mode="INPUT"> 

 <xsl:value-of select="2" /> 

 </argument> 

 </arguments> 

 </dp:sql-execute> 

</db-results> 

 

More information on the dp:sql-execute extension element can be found in the IBM WebSphere DataPower SOA Appliances product documentation portal [http://www.ibm.com/software/integration/datapower/library/documentation/].