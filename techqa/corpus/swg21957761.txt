Title: IBM FreeMbytes not matching value from Perfmon - United States

Text:
FreeMbytes not matching TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Failure to alert on critical diskfreespace condition when FreeMbytes does not match value from Perfmon 

SYMPTOM
KNTCMA agent did not alert on disk full condition.


CAUSE
The agent reads the data from the Logical Disk performance counter. This particular counter has some latency problems as described in the Microsoft Windows Server 2003 Performance guide, 

 
------------------------------------------------------------------------ 
Disk Space Usage Measurements 
Two important disk space usage measurements are available in the Logical Disk object: % Free Space and Free Megabytes. Because running out of disk space is almost always catastrophic, monitoring the Free Space available on your logical disks is critical. 

Because disk space tends to be consumed gradually, you usually don't have to monitor disk free space as frequently as you do for many of the other performance indicators you will gather. Monitoring disk free space hourly or even daily is usually sufficient. Note that the Performance Library responsible for computing the Free Megabytes and % Free Space counters, Perfdisk.dll, refreshes these measurements at a slower pace because the counter values themselves tend to change slowly. By default, these disk space measurements are refreshed once every 5 minutes, independent of the Performance Monitor data collection interval. Using Performance Monitor to gather these counters at a rate faster than approximately 5 minutes per sample, you will retrieve counter values that are duplicates, reflecting the slow rate of data gathering by the Perfdisk.dll Performance Library. Both the high overhead associated with calculating Free Megabytes on very large file systems and the normally slow rate at which these counter values change are the important factors that this slower rate of data gathering reflects. Table 3-30 describes the Logical Disk(n)\Free Megabytes counter. 

Note 
Because of the high overhead associated with calculating % Free Space and Free Megabytes on very large file systems, and the normally slow rate at which these counter values change, these counters are normally measured only once every 5 minutes. If you need more frequent measurements to track file system growth, you can add a binary Registry field at HKLM\System\CurrentControlSet\Services\Perfdisk\Performance\VolumeRefreshInterval and change the VolumeRefreshInterval to a more suitable value. Code the number of seconds you would like to wait between recalculations of the Logical Disk % Free Space and Free Megabytes metrics. The default VolumeRefreshInterval is 300 seconds. 
------------------------------------------------------------------------ 

Should you need to change the VolumeRefreshInterval value from the default, you will need to add the key with the desired value. Use the right-click menu -> New and select the DWORD (32-bit) Value. Here is the Registry Editor view showing the key with value 240 seconds (4 minutes): 

[/support/docview.wss?uid=swg21957761&aid=1] [/support/docview.wss?uid=swg21957761&aid=1]

------------------------------------------------------------------------ 

For this reason, the agent checks the Free MB value coming from performance counters with the one retrieved by api GetDiskFreeSpaceEx. If these values differs by 10% or more, the agent set the row of the disk as NOT COLLECTED for THIS data collection and the disk is not sent to the server, so that it do not appear. 

In this case, for C: we have: divergence: 
GetDiskFreeSpace() = 3328 ; From Perfmon = 3816 +14.66 % 
GetDiskFreeSpace() = 2819 ; From Perfmon = 3298 +16.99 % 
GetDiskFreeSpace() = 3862 ; From Perfmon = 2819 -27.00 % 
GetDiskFreeSpace() = 3360 ; From Perfmon = 3700 +10.11 % 
GetDiskFreeSpace() = 3878 ; From Perfmon = 3333 -14.05 % 
GetDiskFreeSpace() = 3133 ; From Perfmon = 4159 +32.74 % 

In these cases the data coming from perfmon and from the APIs diverge considerably. If the agent used simply the free space coming from the APIs, it would not be congruent with other attributes. 



DIAGNOSING THE PROBLEM
The following trace errors are seen in the kntcma agent log file - 

(Friday, May 8, 2015, 2:49:00 PM-{3EAC}knt06agt.cpp,881,"DiskSizeMb") FreeMbytes not matching with value from Perfmon. 
(Friday, May 8, 2015, 2:49:00 PM-{3EAC}knt06agt.cpp,882,"DiskSizeMb") From GetDiskFreeSpace() = 9895 ; From Perfmon = 8958 
(Friday, May 8, 2015, 2:49:00 PM-{3EAC}knt06agt.cpp,883,"DiskSizeMb") Drive D: will be removed. (Friday, May 8, 2015, 2:49:00 PM-{3EAC}knt06agt.cpp,894,"DiskSizeMb") Requesting the RegCloseKey 


RESOLVING THE PROBLEM
 

The only reasonable recourse is to set the situations on Logical Disks with an interval greater than 5 minutes or to regulate the registry value quoted by Microsoft to trigger the recalculation. 



HISTORICAL NUMBER
 27823
499
000 

PRODUCT ALIAS/SYNONYM
 ITM Windows OS Agent