Title: IBM CSPA202E SSL handshake failure, reason=GSK_ERR_INCORRECT_KEY_USAGE after upgrading to z/OS V1.11 - United States

Text:
STERLINGNFX TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 CSPA202E SSL handshake failure, reason=GSK_ERR_INCORRECT_KEY_USAGE after upgrading to z/OS V1.11 

SYMPTOM


A Secure+ SSL / TLS connection which had been working successfully, fails after one side upgrades their z/OS operating system to V1.11.

In trace will see Secure+ error REQ=SSLSOINI RC=440 RS=GSK_ERR_INCORRECT_KEY_USAGE after upgrading to z/OS V1.11

Error Message CSPA202E SSL handshake failure, reason=GSK_ERR_INCORRECT_KEY_USAGE


RESOLVING THE PROBLEM


RFC 2459 created a standard for Key Usage fields within SSL Certificates. RFC 3280 was created to provide new support for Key Usage and extended Key Usage fields within SSL Certificates. z/OS v1.11 began to enforce the RFC 3280 standard. This caused some certificates that passed the old Key Usage standard in older releases of z/OS to fail in z/OS v1.11 using the RFC 3280 standard.

IBM APAR Identifier OA30417 documents and fixes this problem. Information from the APAR ERROR DESCRIPTION: gsk_secure_socket_init returns 440 on R11, but not on earlier releases with the same certificate. The return code 440 means 'Incorrect key usage.' The problem is that in r11 of System SSL, new support has been added for RFC 3280. The default setting for the new GSK_CERT_VALIDATION_MODE is GSK_CERT_VALIDATION_MODE_ANY. But the code in routine send_v3_client_messages is treating GSK_CERT_VALIDATION_MODE_ANY as if it were GSK_CERT_VALIDATION_MODE_3280 and thus checks the Extended Key Usage extension for the presence of either the 'Server Authentication' oid or the 'Client Authentication' oid, depending on the connection type. In this case, the certificate had 'Server Authentication' but was being used as a client certificate. LOCAL FIX: Set the environment variable GSK_CERT_VALIDATION_MODE=2459 . . . See IBM APAR for more information . . . How to set the Workaround environment variable in Connect:Direct 

1.) Create a PDS formatted DCB is RECFM=VB LRECL=137 BLKSIZE=27998 DSORG=PO. This file will be used to change the USS Environment Parameters. 2.) Add member to new PDS using the following parameter entry: GSK_CERT_VALIDATION_MODE=2459 3.) Add the //ENVIRON DD DISP=SHR,DSN=PDS created in step1(member created in step2) to the Connect:Direct Job. The above parameter setting will use the RFC 2459 standard for SSL certificates. This workaround will allow the certificate that had worked at a previous z/OS release to work in z/OS v1.11 until the APAR can be applied or a new certificate can be created and added to the Connect:Direct Parmfile on the Local or the Remote side of the connection. See IBM z/OS V1R11.0 System SSL Programming Guide for more information about SSL Environment Variables.  

HISTORICAL NUMBER
 NFX8984 

PRODUCT ALIAS/SYNONYM
 

Severity


Normal