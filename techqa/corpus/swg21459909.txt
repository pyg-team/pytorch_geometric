Title: IBM System P agent data provider fails to start as non-root user - United States

Text:
Spmi.lock tmp TEP Portal spmi consumers system P CEC Base HMC Premium AIX VIOS root non-root permissions shared memory data provider aixdataprovider cecdataprovider hmcdataprovider TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Starting the system P agent as a non-root user, the data provider does not start, but instead spawns a defunct process. 

SYMPTOM
No data for the system P agent in the Tivoli Enterprise Portal.


CAUSE
AIX APAR IZ89719 describes a problem where the file /tmp/Spmi.lock is being created with wrong permissions: 

https://www-304.ibm.com/support/docview.wss?uid=isg1IZ89719 [https://www-304.ibm.com/support/docview.wss?uid=isg1IZ89719]

This usually occurs when the agent has been started in the past with root user, leading to permissions where only the root user is able to access this file. This file is created when a SPMI consumer (like the system P agent) is started.


ENVIRONMENT
System P agents (CEC Base, AIX Premium, VIOS Premium, HMC Base) running as non-root



DIAGNOSING THE PROBLEM
There are no meaningful messages or errors in the agent logs and traces. 

Permissions should be -rwSr--r-- , and owned by the user running the agents.
In case permissions are like this, and/or the file is owned by root, the agent user (non-root) will not be able to access the file.


RESOLVING THE PROBLEM
You can try changing the permissions for /tmp/Spmi.lock, so they match the above recommendation. 

Best would be to delete this file, since it will be recreated next time the agent restarts, with correct permissions.
There can be cases that this issue causes shared memory locks, so you should clear the shared memory as well, by following this procedure:

1° Run:
genld -l | grep -p spmi | grep Proc_pid
=> command output will list all the processes using SPMI

2° Stop all the processes returned above, and also others which might use the SPMI shared library (topasrec, xmtopas, xmtopasagg, xmservd,filtd, xmperf, 3dmon, ptxrlog, harmd, topas, any PSSP process, ITM System P agents) if they are currently running on your system.

3° Check if there are any defunct processes still running:
ps -ef | grep defunct
and kill each of them.

4° SU to root, run "ipcs -m" command and check for any segment "KEY" that begins with '0x78', as listed below:
T ID KEY
m 0 0xc76283cc
m 1 0x78002323

If there are any such segments, make sure the process which uses those shared segments is stopped:
ipcrm -m <ID #>
=> will clear up those shared memory segments.

5° Check whether there are still processes using SPMI:
genld -l | grep -p Spmi | grep Proc | awk '{ print $2 }' | xargs kill
=> will kill them

6° Run "slibclean"

7° Change the ownership of /tmp/Spmi.lock to your non-root user, and set permissions to -rwSr--r--.
You can use these commands, supposing that your user is tivadmin, belonging to the staff group:
chown tivadmin:staff /tmp/Spmi.lock
chmod u+r /tmp/Spmi.lock

Permissions should look like:
-rwSr--r-- 1 tivadmin staff 0 Jan 05 10:16 Spmi.lock

8° As your agent user, start the system P agent again