Title: IBM Purescale CF cannot be stated due to the Mellanox adapter registration memory limit - United States

Text:
CF start failed; register_notify_memory; -2146893782; 0x8009002a TECHNOTE (TROUBLESHOOTING)

THIS DOCUMENT APPLIES ONLY TO THE FOLLOWING LANGUAGE VERSION(S):
 English 

PROBLEM(ABSTRACT)
 Purescale CF cannot be stated due to the Mellanox adapter registration memory limit 

SYMPTOM
"db2instance -list" output shows the CF is in "ERROR" state. You should see following alert: 

$ db2cluster -cm -list -alert 
1. 
Alert: The cluster caching facility (CF) failed to start on the host.
Host: 'AAPS3PPD'. CF: '128'.


db2diag.log shows error messages as below, error code is -2146893782:

2014-08-14-16.45.27.527334+480 I11010E516 LEVEL: Error
PID : 32560 TID : 47147934016672 PROC : ca-wdog 128 [db2pure]
INSTANCE: db2pure NODE : 128
HOSTNAME: HOSTNAME1
FUNCTION: DB2 UDB, RAS/PD component, pdLogCaPrintf, probe:876
DATA #1 : <preformatted>
CA Configure command failed: mrb rc = (-2146893782)
DATA #1 : <preformatted>
If a CF return code is displayed above and you wish to get
more information then please run the following command:

db2diag -cfrc <CF_errcode>

2014-08-14-16.45.27.529735+480 E11527E420 LEVEL: Severe
PID : 32560 TID : 47147934016672 PROC : ca-wdog 128 [db2pure]
INSTANCE: db2pure NODE : 128
HOSTNAME: HOSTNAME1
FUNCTION: DB2 UDB, Shared Data Structure Abstraction Layer for CF, sqleSendCFServerConfig, probe:2687
MESSAGE : ECF=0x97C9002A=-1748434902
DATA #1 : String, 43 bytes
Unable to configure and start the CF server


CAUSE
This is likely caused by the Mellanox adapter registration memory limit. 



ENVIRONMENT
Purescale server on Linux



DIAGNOSING THE PROBLEM
 

1. Collect db2support . -purescale 

2. From cfdiag.xxx.log, you sould find register_notify_memory() failed with error code 0x8009002a: 


2014-08-15-09.01.52.0037546570+480 E123456789A313 LEVEL : Error
PID : 3363 TID : 1546295264
HOSTNAME : HOSTNAME1
FUNCTION : CA trace, log_error
MESSAGE : CA server has encountered an error.
DATA #1 :
register_notify_memory() Local Memory Region Create (dat_lmr_create) failed. DAT Status: 0x30000

2014-08-15-09.01.52.0037588678+480 E123456789A304 LEVEL : Error
PID : 3363 TID : 1546295264
HOSTNAME : HOSTNAME1
FUNCTION : CA trace, log_error
MESSAGE : CA server has encountered an error.
DATA #1 :
register_notify_memory() Notify Memory Registration failed on HCA 0. status: 0x8009002a

2014-08-15-09.01.52.0037609689+480 E123456789A325 LEVEL : Error
PID : 3363 TID : 1546295264
HOSTNAME : HOSTNAME1
FUNCTION : CA trace, log_error
MESSAGE : CA server has encountered an error.
DATA #1 :
mgmnt_castart() CA Server start-up aborted due errors during start-up and initialization. Status: 0x8009002a


RESOLVING THE PROBLEM
To increase the size, you could follow step 5 in IC: 


http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/r0057204.html?lang=en [http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/r0057204.html?lang=en]

Increase the Mellanox HCA driver mlx4_core parameter log_mtts_per_seg value from 3 (the default) to 7 on the host where the cluster caching facility (CF) resides. To increase the size, issue this command as root:


 *  On SUSE:


echo "options mlx4_core log_mtts_per_seg=7" >> /etc/modprobe.conf.local 
 *  On RHEL:


echo "options mlx4_core log_mtts_per_seg=7" >> /etc/modprobe.d/modprobe.conf 
options mlx4_core log_mtts_per_seg=7 

For this change to take effect, you must reboot the server. To check whether your change is effective on the module, issue this command: 

<host-name>/sys/module/mlx4_core/parameters # cat /sys/module/mlx4_core/parameters/log_mtts_per_seg 
7 RELATED INFORMATION
#Preinstallation checklist for DB2 pureScale Feature (Li [http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/r0057204.html?lang=en]