Title: IBM PK51106: IDLE SSL SESSIONS IN RECV STATE (USING PERSISTENT SOCKETS) GET DISCONNECTED AFTER APPLYING APAR PK43233 07/12/05 PTF PECHANGE - United States

Text:
 SUBSCRIBE
You can track all active APARs for this component.



APAR STATUS
 * CLOSED AS PROGRAM ERROR.
    
   
   

ERROR DESCRIPTION
 *  After client connects, we read in a message from the client and
   send it onto IMS.
   If its not a SENDONLY then ofcourse, we go into CONN state and
   start a TIMER.
   If its a SENDONLY request then we simply proceed to read the
   next input message from the client.
   And we continue processing without any problems.
   At somepoint we go into RECV state to READ the next input from
   the client and the session is idle (i.e. no input from the
   client), at that time the session gets disconnected.
   For SSL here is the module flow to do the READ:
   HWSSDRCV -> HWSLEPS0 -> HWSSSL00 (  GSK_SECURE_SOCKET_READ()  )
   Since the session is idle, the READ results in EWOULDBLOCK
   return code i.e decimal 502 (or x'1F6').
   EWOULDBLOCK on a READ call means there is no input from the
   client. We return to HWSSDRCV with return code 502.
   HWSSDRCV then calls routine SELECT00 to issue the SELECT call
   with AIOTIMEOUT set to 1 second (the 1 second was code added by
   APAR PK43233 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK43233]).
   Again because there is no input from the client, the SELECT
   times out (ETIMEDOUT or decimal 1127 is the return code)
   But for some strange reason in SELECT00 routine we treat the
   timeout as ok, i.e. we return with R15 set to 0.
   And when we return back to HWSSDRCV at label LEPSI000, we
   reissue the READ??
   Well since the SELECT timed out, the READ is not going to do any
   better and it results in a EWOULDBLOCK (or decimal 502 return
   code). So we go back to HWSSDRCV, where we do the SELECT again.
   It times out after 1 second.
   We reissue the READ, get the 502 return code.
   Issue the SELECT again and on and on we go.
   Now this is not a loop.
   Because when we retry the READ (despite the fact that the SELECT
   timed out), APAR PK43233 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK43233] has extensive computation
   to determine timeout based on HCDB_TIMEOUT value.
   And so eventually the session gets disconnected.
   *
   So to summarize, here are the issues:
   1) SELECT00 should not return R15=0 if the SELECT call
   times out.
   2) If SELECT call times out we probably shouldn't be issuing a
   READ call because its only going to fail with a 502(EWOULDBLOCK)
   3) Granted APAR PK43233 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK43233] has extensive mathematical computation
   to determine timeout value but for a persitent socket, just
   because its idle on subsequent READS (i.e. no input from the
   client), does not mean we should timeout the connection.
   4) For initial READs following a connection, if the config
   TIMEOUT value was non-zero then we used to issue a TIMER before
   doing the READ (this was for a DELDUMMY client).
   But with PK43233 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK43233] we don't do that anymore.
   The extensive mathematical computation to determine timeout
   should only apply to initial reads after connection
   
   
    
   
   

LOCAL FIX

PROBLEM SUMMARY
 *  ****************************************************************
   * USERS AFFECTED: All IMS V9 users of IMS Connect SSL port     *
   *                 with PK43233 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK43233] (PTF UK27783).                  *
   ****************************************************************
   * PROBLEM DESCRIPTION: A persistent SSL socket in RECV state   *
   *                      is disconnected erroneously after       *
   *                      the period specified by the TIMEOUT     *
   *                      parameter value in the IMS Connect      *
   *                      configuration member has expired.       *
   ****************************************************************
   * RECOMMENDATION: INSTALL CORRECTIVE SERVICE FOR APAR/PTF      *
   ****************************************************************
   After one input was processed on a persistent socket, the
   connection should be kept until there is a disconnect by an
   error or a command.
   After PK43233 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK43233] (PTF UK27783) was installed, a persistent socket
   is disconnected after the TIMEOUT value has expired.
   Additional Symptom:
   With PK44346/UK25422 installed, STOPPORT command results
   in an ABEND0C4 in module HWSSSTP0 at offset +X'4E0'
   (at label CHKSVT).
   
   
    
   
   

PROBLEM CONCLUSION
 *  AIDS: RIDS/SYS RIDS/CNTRL SYS CNTRL
     GEN:
   
   *** END IMS KEYWORDS ***
   HWSSDRCV was modified to not detect the timeout
   and to not use AIOTIMEOUT when the SVT_SYNINIT bit is on.
   HWSSSTP0 was modified to make STOPPORT command support
   AIOTIMEOUT usage instead of BPETIMER for a SSL port
   in HWSSDRCV.
   
   
    
   
   

TEMPORARY FIX
 *  *********
   * HIPER *
   *********
   
   
    
   
   

COMMENTS

APAR INFORMATION
 * APAR NUMBER
   PK51106
   
   
 * REPORTED COMPONENT NAME
   IMS V9
   
   
 * REPORTED COMPONENT ID
   5655J3800
   
   
 * REPORTED RELEASE
   900
   
   
 * STATUS
   CLOSED PER
   
   
 * PE
   YesPE
   
   
 * HIPER
   YesHIPER
   
   
 * SPECIAL ATTENTION
   NoSpecatt / Xsystem
   
   
 * SUBMITTED DATE
   2007-08-15
   
   
 * CLOSED DATE
   2007-10-19
   
   
 * LAST MODIFIED DATE
   2008-04-30
   
   

 * APAR IS SYSROUTED FROM ONE OR MORE OF THE FOLLOWING:
   
   
   
 * APAR IS SYSROUTED TO ONE OR MORE OF THE FOLLOWING:
    PK51518 [http://www-01.ibm.com/support/docview.wss?uid=swg1PK51518] UK30461 PK59072
   
   

MODULES/MACROS
 *  HWSSDRCV HWSSSTP0
   
   
    
   
   

FIX INFORMATION
 * FIXED COMPONENT NAME
   IMS V9
   
   
 * FIXED COMPONENT ID
   5655J3800
   
   

APPLICABLE COMPONENT LEVELS
 * R900 PSY UK30461
   UP07/10/26 P F710 Â«