Title: IBM REDISTRIBUTE utility might not work properly when used for reducing partitions - United States

Text:
db2; redistribute; database; data; partition; warehouse TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 
The most common use for the REDISTRIBUTE utility is to increase partitions of a database. However, even though reducing the partitions is also allowed, it might cause issues when doing it on a large data warehouse. This Technote is to provide instructions in case you encounter a failure during the REDISTRIBUTE utility when either increasing or reducing partitions.



SYMPTOM
 

One of the expected entries in db2diag.log are:


 *  sqlcode: -901
   
   FUNCTION: DB2 UDB, database utilities - Redistribute
   MESSAGE : ZRC=0x80580003=-2141716477=SQLKD_INTERRUPT 
   
   FUNCTION: DB2 UDB, database utilities - Redistribute
   MESSAGE : ZRC=0x82B00001=-2102394879=SQLUC_ZRC_ERROR_GENERIC_PROGRAMMING_ERROR 
   


CAUSE
 Most common cause is related to timing issues. Other possible reasons are disk full, container inaccessible, etc.



DIAGNOSING THE PROBLEM
 

When running the actual redistribute command, if you hit a problem you'll need to collect data for further investigation. It needs to be collected before you take recovery actions like running commands such as: redistribute CONTINUE / redistribute ABORT. 

 

The data required are: 

 * All data under$HOME/sqllib/redist.



 * db2support with the "-r" option:


 *   *   *   *  db2support . -d <dbname> -s -r 
         
         
      
      
   
   
 *  
 *  
   Note: It is important to run the above command from all physical nodes. You can either use "db2_all" or the clause "-allmembers" in the db2support command. 
   It will collect:  - Contents from dbpath/redistribute folder: These log files contain important information about state of operation, as required for CONTINUE/ABORT processing. 
   
    - Contents from sqllib/redist folder: These log files are created while redistribute runs. They can be useful to monitor progress and quickly find the table NAME and ID for which redistribute failed on.
   
   
 * 
 * 
 *  db2dart of all pages mentioned in db2diag.log error report (if any).


 *   *   *   *   *  db2dart /DB <dbname> /DP 
            
            
         
         
      
      
   
   
 *  
 *  
   Note: Action /DP requires three input values consisting of table space ID, page number to start with, and number of pages. 
   
   Redistribute should dump that information on the db2diag.log file. 
 * 
 * 
 *  Core file (if generated).


 *  In case redistribute crashed with some sort of memory corruption. It should be located under the FODC path. It is also informed in the server logs the location of the core file.  
   
   
   
   
   

RESOLVING THE PROBLEM
 

Once REDISTRIBUTE encounters an issue, you can either choose the options: REDISTRIBUTE CONTINUE or REDISTRIBUTE ABORT.
If REDISTRIBUTE CONTINUE still fails, determine which table it is failing on (check the db2diag.log and log files under sqllib/redist to find out which one) and then:

A. ABORT operation on this table only - to cleanup redistribute-in-progress state and make it accessible. A sample command, for example, if table t3 is the table in question. 



 *   *   * db2 "redistribute database partition group ibmdefaultgroup not rollforward recoverable abort table (t3) only"
       * 
      
      
   
   


B. CONTINUE operation excluding the table with failure. Redistribute should complete and indicate success with a warning that there is one or more tables to be done. Following the example, the command would be: 

 *   *   * db2 "redistribute database partition group ibmdefaultgroup not rollforward recoverable continue exclude (t3)"
       * 
      
      
   
   




After that, the database partition group will be partially redistributed (as there are table(s) remaining), but at least all remaining tables are done. The table in question is also accessible. 

At this point: 


1. Choose one of the following: 

 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 



2. Do post-redistribute steps on all tables, even if there are table remaining to be redistributed. 


3. If CONTINUE fails and ABORT is not acceptable, then you have no choice but to restore from a backup and go back to were you were before the REDISTRIBUTE started. 

RELATED INFORMATION
 LOAD command [http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0008305.html]
IMPORT command [http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0008304.html]
EXPORT command [http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0008303.html]
REDISTRIBUTE DATABASE PARTITION GROUP command [http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0002069.html]
db2dart - Database analysis and reporting tool command [http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0003477.html]