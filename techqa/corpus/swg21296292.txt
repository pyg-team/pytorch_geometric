Title: IBM Unable to run Mttrapd Probe on AIX as non-root user - United States

Text:
nco_p_mttrapd; SNMP probe; setuid root; nonroot; netcool user TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 On starting the SNMP probe as a non-root user, the probe stops immediately. 

SYMPTOM
The following error is seen in the probe log file - 

02/18/08 11:20:39: Error: SNMP Message (priority=3): UDP snmp_open: Unknown host (Permission denied)


CAUSE
Non-root users do not have permission to open port 162. 


RESOLVING THE PROBLEM
These directions are for AIX only as the crle command does not exist on AIX. 


1. As root, change the owner of the probe binary using chown root nco_p_mttrapd. (This must be done in the $OMNIHOME/probes/aix5 directory.) 
2. As root, enable the probe binary to run as setuid root, using chmod +s nco_p_mttrapd. (This must be done in the $OMNIHOME/probes/aix5 directory.) 
3. The probe libraries must be copied to a trusted directory. For a list of trusted directories, look at the path listed in "dump -Hv $OMNIHOME/probes/aix5/nco_p_mttrapd". In this example, we will use the default libnetcool path /usr/netcool/omnibus/platform/aix5/lib. Note, a system trusted directory should not be used or this can conflict with other applications.

Copy the required Omnibus libraries from $NCHOME/platform/aix5/lib into a trusted library directory such as /usr/netcool/omnibus/platform/aix5/lib. Below is a list of the required Omnibus libraries that would need to be copied to /usr/netcool/omnibus/platform/aix5/lib. 

-rwxr-xr-x 1 root system 387672 Feb 11 17:02 libnetcool_r.so 
-rwxr-xr-x 1 root system 305674 Feb 12 11:06 libOpl_r.so 
-rwxr-xr-x 1 root system 90514 Feb 12 11:08 libPa_r.so 
-rwxr-xr-x 1 root system 237134 Feb 12 11:09 libtre.a 
-rwxr-xr-x 1 root system 259102 Feb 12 11:10 libsybtcl_r.so 
-rwxr-xr-x 1 root system 687617 Feb 12 11:10 libsybsrv_r.so 
-rwxr-xr-x 1 root system 49162 Feb 12 11:10 libsybintl_r.so 
-rwxr-xr-x 1 root system 809044 Feb 12 11:10 libsybct_r.so 
-rwxr-xr-x 1 root system 129822 Feb 12 11:10 libsybcs_r.so 
-rwxr-xr-x 1 root system 1063341 Feb 12 11:10 libsybcomn_r.so 
-rwxr-xr-x 1 root system 163774 Feb 12 11:10 libsybblk_r.so 
-rwxr-xr-x 1 root system 32427 Feb 12 11:11 libslclient_r.so -rwxr-xr-x 1 root system 729519 Feb 12 11:11 libsybunic.so 

Also, create the following softlinks in /usr/netcool/omnibus/platform/aix5/lib 

lrwxrwxrwx 1 root system 15 Feb 11 17:02 libnetcool_r.so.a -> libnetcool_r.so 
lrwxrwxrwx 1 root system 11 Feb 12 11:07 libOpl_r.so.a -> libOpl_r.so 
lrwxrwxrwx 1 root system 10 Feb 12 11:08 libPa_r.so.a -> libPa_r.so 
lrwxrwxrwx 1 root system 8 Feb 12 11:09 libtre.so.4 -> libtre.a 

Omnibus 7.2.1 has slightly different libraries than previous Omnibus versions. For Omnibus 7.2.1, also copy the libraries listed below from $NCHOME/platform/aix5/lib in addition to the libraries listed above. Note, the libraries libsybblk_r.so and libsybunic.so listed above do not exist in Omnibus 7.2.1.

-rwxr-xr-x 1 root system 2538181 Mar 11 19:37 libicuuc38.1.a 
-rwxr-xr-x 1 root system 3905427 Mar 11 19:37 libicui18n38.1.a 
-rwxr-xr-x 1 root system 11360018 Mar 11 19:37 libicudata38.1.a

On Omnibus 7.2.1, also create the softlinks below in /usr/netcool/omnibus/platform/aix5/lib

lrwxrwxrwx 1 root system 14 Mar 11 19:37 libicuuc.a -> libicuuc38.1.a 
lrwxrwxrwx 1 root system 16 Mar 11 19:37 libicui18n.a -> libicui18n38.1.a
lrwxrwxrwx 1 root system 16 Mar 11 19:37 libicudata38.a -> libicudata38.1.a
lrwxrwxrwx 1 root system 14 Mar 11 19:37 libicuuc38.a -> libicuuc38.1.a 

Omnibus 7.3 and 7.3.1 has slightly different libraries than other versions. For Omnibus 7.3, also copy the libraries listed below from $NCHOME/platform/aix5/lib in addition to the first libraries listed above. Note, the libraries libsybblk_r.so and libsybunic.so listed above do not exist in Omnibus 7.3.x.

-rwxr-xr-x 1 root system 2605986 Dec 20 14:04 libicuuc40.1.a
-rwxr-xr-x 1 root system 4525138 Dec 20 14:04 libicui18n40.1.a
-rwxr-xr-x 1 root system 13912098 Dec 20 13:51 libicudata40.1.a
-r-xr-xr-x 1 root system 74266 Dec 20 13:55 libncrypt.so

On Omnibus 7.3 and 7.3.1, also create the softlinks below in /usr/netcool/omnibus/platform/aix5/lib

lrwxrwxrwx 1 root system 14 Dec 20 14:10 libicuuc.a -> libicudata40.1.a
lrwxrwxrwx 1 root system 16 Dec 20 14:11 libicudata40.a -> libicudata40.1.a
lrwxrwxrwx 1 root system 16 Dec 20 14:18 libicui18n40.a -> libicui18n40.1.a
lrwxrwxrwx 1 root system 16 Dec 20 14:11 libicui18n.a -> libicui18n40.1.a
lrwxrwxrwx 1 root system 14 Dec 20 14:11 libicuuc40.a -> libicuuc40.1.a

On Omnibus 7.3.1, also copy the libraries listed below to /usr/lib
lrwxrwxrwx 1 root system 57 Sep 13 18:16 libgsk8cms.so -> /opt/christina/netcool731/platform/aix5/lib/libgsk8cms.so
lrwxrwxrwx 1 root system 58 Sep 13 18:15 libgsk8iccs.so -> /opt/christina/netcool731/platform/aix5/lib/libgsk8iccs.so
lrwxrwxrwx 1 root system 57 Sep 13 18:16 libgsk8ssl.so -> /opt/christina/netcool731/platform/aix5/lib/libgsk8ssl.so
lrwxrwxrwx 1 root system 57 Sep 13 18:16 libgsk8sys.so -> /opt/christina/netcool731/platform/aix5/lib/libgsk8sys.so

4. Run the probe as a normal user using $OMNIHOME/probes/aix5/nco_p_mttrapd. (This must be done in the $OMNIHOME/probe/aix5 directory.) 

The reason to do this is because when the setuid is used the probe doesn't use the environment variables (LIBPATH) and only looks for libraries in a directory structure hard-coded in the probe binary. 


Note: The probe can also be run as non-root with a port greater than 1024 or the probe can be run as root with the standard port 162.