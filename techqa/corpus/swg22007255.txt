Title: IBM CBR_TS_DEFER_INDEXING_REBALANCING error when indexing IBM Content Collector email - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Indexing IBM Content Collector (ICC) emails result in indexing errors. Emails are stuck in the indexing queue in retry status. 

SYMPTOM
The following message is reported on the failing indexing item: 

 * 
 * Indexing batch failed;
   An IBM Content Search Services server could not complete an indexing operation while accessing the C:\IndexAreas/P8SMTP_Document_20170727235012_FA8A38F96F5F48FA8E446F4B3708C7EF index for the server that runs on the p8server1.svl.ibm.com:8,191 host and port. Content Engine failed to index batch "5" because of the following error: "Batch job error. Task id :5 with indexing error :IQQI0070E An error occurred during execution of task 5. The collection is currently unavailable for indexing. This error may require the involvement of an administrator.
 * 
 * IQQG0194E Constructor [ContentCollector4Email] cannot populate the list of documents with collection ID [C:\IndexAreas\P8SMTP_Document_20170727235012_FA8A38F96F5F48FA8E446F4B3708C7EF]. Error details: AFUI0100E The document '{D451E715-8532-4E4F-98BB-6E1BDDC73B37}#{712C33B3-50DF-42AC-81AB-DEC0F155EDB3}#ICCMail3#FilteredDir_6131611107357112942' could not be processed. Reason: AFUI0043E The document '{D451E715-8532-4E4F-98BB-6E1BDDC73B37}' (AFU6205668158296379249.eml) could not be processed as a regular email.
 * 
 * Contact IBM Software Support.
 * 
 * IQQG0020E com.ibm.ecmts.constructor.exceptions.PopulateDocumentsException: AFUI0100E The document '{D451E715-8532-4E4F-98BB-6E1BDDC73B37}#{712C33B3-50DF-42AC-81AB-DEC0F155EDB3}#ICCMail3#FilteredDir_6131611107357112942' could not be processed. Reason: AFUI0043E The document '{D451E715-8532-4E4F-98BB-6E1BDDC73B37}' (AFU6205668158296379249.eml) could not be processed as a regular email.
 * 
 * Contact IBM Software Support.". For information about the location of this log, see "Viewing the IBM FileNet P8 log files" in the IBM FileNet P8 information center. If you cannot determine the cause of the error, contact IBM Software Support.


In P8 server log, the following error may also be observed: 
 * FNRCB0085E:
 * 
 * CBR_TS_DEFER_INDEXING_REBALANCING: IBM Content Search Services indexing
 * 
 * is rebalancing index P8SMTP_Document_20170310053928_57B819190B614C5FB6A694BF9D931492 on index area P8SMTP_Index_Area5 and object store P8SMTP to another server.


CAUSE
 

 * When indexing ICC emails using the ICC Content Search Services (CSS) Support, ICC may encounter an error. The error can be thrown to CSS at either document level or batch level. 
 * At a document level error, CSS will set the appropriate Indexing Failure Code to the document. The document will be removed from the indexing queue. 
 * At a batch level error, CSS will not only set Indexing Failure Code to 1 (OTHER), the document will also remain in the indexing queue for retry. Furthermore, all other documents that were being indexed in that same batch will also be marked as failed and wait for retry in the indexing queue. 
 * There are currently a few known issues that can cause ICC to throw a batch level error to CSS:  * Case 1a: 
      In the ICCMail3 objects, there are no objects set for the ICCMailInstanceReference property. 
    * Case 1b:
      Even if there is an object set in the ICCMailInstanceReference property, the value of ICCMailboxID property is missing in the corresponding ICCMailInstance3 object. 
    * Case 2:
      The header of the email is invalid or too long. 
    * Case 3:
      There is no mime type set for the email content element. 
   
   
 * The indexing throughput can be severely impacted if you are experiencing the above error repeatedly and for many documents. 
 * The above cases could also indicate an issue with ICC task route archiving. Contact IBM support for root cause analysis before attempting to resolve the problem on your own. 


ENVIRONMENT
IBM Content Collector 

IBM FileNet P8 5.2.x with Content Search Services 


DIAGNOSING THE PROBLEM
To determine if you may be running into any of the above situations, please collect the following information to IBM Support for root cause analysis: 

 * Identify the document that is causing the failure. 
 * From the P8 administrative console ACCE, locate or search for that document. 
 * In the document Content Elements, download and collect all content elements. It should contain an email file (.csn, .msg, or .eml) and zero or more attachment files. 
 * In the document Properties, check if there is any object reference set for ICCMailInstanceReference property. 
 * If there are, navigate to each of those ICCMailInstance3 objects and check if it has any value in the ICCMailboxID property. 


RESOLVING THE PROBLEM
There are a few parameters that can be used to change ICC behavior to throw a document level error, instead of a batch level error. Recommend that you proceed with the following changes only under the direction of IBM Support. 


On the ICC Server: 

 * Open Configuration Manager. 
 * Navigate to General Settings > Content Search Service Support > Support for Email > Custom Settings and add the following entries below the custom attributes and custom archive attributes:  * 
    * [Settings]
    * 
    * ; Case 1a: missing ICCMailInstanceReference
    * 
    * ; Case 1b: missing ICCMailboxID
      *
    * MandatoryAttributeWithoutValueAborts
    * =false 
    * 
      
    * 
    * ; Case 2: invalid email header or header too long. 
    * 
    * ; Cannot be processed as regular email error. 
    * 
    * *
    * EmailParserExceptionThrows=false
    * 
    * 
    * ; Case 3: mime type not set for email 
    * 
    * *EmailProcessUnknownMimeTypes=true 
    * 
   
   
 * Keep the asterisk (*) character at the beginning of the line. 
 * Save the changes in Configuration Manager. Restart of ICC services is not necessary. 
 * Restart all CSS instances (indexing servers) to take effect. 


When the failing documents get indexed again and ICC encounters the same error, it will throw a document level error.