Title: IBM When Power HMC Save Upgrade Data Fails - Additional Clean-up Operations - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 What can I do when saveupgdata fails with "no space on device" error? 

CAUSE

The HMC save upgrade data (saveupgdata) operation is designed to store configuration files and user files on a protected disk partition prior to performing an upgrade of the console. The disk partition, mounted on /mnt/upgrade, is only 2 GB in size. Original intent was to have sufficient space for HMC configuration data, some diagnostic files and users. When the operation fails most of the time it can be traced to some excessively large file or files that were stored in a user's home directory which might have been placed there for one time use. Examples include corrective service updates, firmware updates or backups of some other system which were temporarily stored on the HMC and then forgotten about. With the increased use of Performance and Capacity Monitoring tools we do also see issues where the files related to the collection of such data grow very large and needs to also minimized prior to an upgrade.


ANSWER
 

The typical commands you have as an HMC superadmin user such as hscroot include chhmcfs, ls and rm for dealing with file issues. The command to remove old archived diagnostic files commonly used to minimize size of an HMC backup is chhmcfs. 

chhmcfs -o f -d 0 

Its a good practice to run this, but it really does not attack files that are saved in a save upgrade data operation. The best thing you can do first is to make sure user's home directories are clear of any large files. You can do this as hscroot using the ls command with various options then request users you don't have file permissions for to remove any large files you find. Likely it better just to become root and clear files that shouldn't be laying around in the first place. The HMC does not use any files in a user's $HOME other than those stored under the user's .ssh subdirectory. To become root you will need to have pesh access and that typically requires you to call IBM Support to request the pesh passwords. You will want to provide support with the output of "lshmc -v" so they can generate the appropriate pesh passwords for your HMC. 

 

To do the clean-up you will generally start looking for large files as follows. 


1. Become root and remove user files, diagnostic files as well as data utilization files. 

a. You might start by looking at the save upgrade data log file to see where the operation stopped. Its only going to give you a clue and you would really have to know more about the order that save upgrade data stores files to understand what didn't happen and this is not something that is documented. However, clues are good.

tail /var/hsc/log/saveUpgradeFiles.log 

b. If you can determine where to look after examining the log file then you might be able to go right to the source and remove the file that caused saveupgdata to fail. If not continue on.

c. Remove user files in HOME directories. 

(1) Search each and every home directory for all users. The only data that should be in home directories on an HMC are under the .ssh directory and any file related to keys under that path. Any other type of file (zip archives, backups of mksysb, fixes, etc) are not expected to be stored on an HMC and need to be removed before upgrading.

(2) If you need to save the data off to some other server then do so, but understand the HMC has no practical use for them whatsoever.

d. Remove data utilization files. 

(1) if data utilization has been enable and running for several years then the amount of data can grow very large. Disable data utilization collection on all servers then remove the associated files. 

(2) Look at the directory names for each server's utilization files.

ls -la /opt/hsc/data/utilization 

(3) To disable data utilization collection run the following commands. 
(Do this as hscroot) 
chlparutil -r config -s 0 

(4) Go into each server's sub directory and remove the utilization files. (Do this as root) 

cd /opt/hsc/data/utilization/<make-model*serial> 

rm *_D 
rm *_H 
rm *_M 
rm *_S 

Note: leave the .ENABLE_UTILIZATION2 file alone. You are just removing the data collection files that end in the character stings referenced above. 

(5) Then you can enable data collection again using chlparutil command as hscroot.

chlparutil -r config -s 60

Note: you can use other sample rates if needed. See the man page for chlparutil for other options or rate choices. 

e. Remove old diagnostic files (as root). 

cd /opt/ccfw/data/vr 
chsvcevent -o closeall 
rm -r [0123456789]* 

2. Reboot the HMC and make sure it comes back up cleanly then try the 
save upgrade data task again. 

hmcshutdown -t now -r 

3. Post reboot either run the saveupgdata command or GUI task for Save Upgrade Data.

saveupgdata -r disk

If you had successfully cleaned up the disk spaces and files that saveupgrade data stores in its archives then the command should complete quickly. If it seems to run for a long time you can monitor using the monhmc command by running it in a different shell.

monhmc -r disk
(use Ctrl-C to exit)

4. If you are curious about the files that saveupgdata stores you can review the log file it creates.

less /var/hsc/log/saveUpgradeFiles.log

5. If still unable to get the save upgrade data operation to complete then it might be prudent to call IBM Support for additional assistance.