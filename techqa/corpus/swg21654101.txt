Title: IBM Configure new TDS instance with an existing DB2 database - United States

Text:
tds; existing database; configure TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 If for some unknown reason, ibmslapd.conf file gets corrupt or unknowingly, overwritten from another environment then an attempt to start the server will display following error message:

GLPCTL104E The configuration key stash file data is inconsistent with the associated encrypted data in the configuration file "<Location>/idsslapd-<Name>/etc/ibmslapd.conf".
GLPSRV088E The server is unable to run because of initialization error. 

RESOLVING THE PROBLEM
 

You can follow these steps to recover from this problem:

1) Identify your directory instance

# idsilist -a
Directory server instance(s):

--------- Example output ---------------------
Instance 1:

Name: ldapdb02
Version: 6.3
Location: /home/ldapdb02
Description: IBM Tivoli Directory Server Instance V6.3
IP Addresses: All available
Port: 389
Secure Port: 636
Admin Server Port: 3538
Admin Server Secure Port: 3539
Type: Directory Server

2) Try and start the IDS server:

# ibmslapd -I ldapdb02 -n
--------- Example output ---------------------
GLPCTL104E The configuration key stash file data is inconsistent with the associated encrypted data in the configuration file '/home/ldapdb02/idsslapd-ldapdb02/etc/ibmslapd.conf'.
GLPSRV088E The server is unable to run because of initialization error.

How can you resolve an issue like this?

1) Check for the database name for instance, ldapdb02 in this example
Login to the server as instance owner
# su - ldapdb02
$ db2 list db directory

------------ Example output-------------
System Database Directory

Number of entries in the directory = 2

Database 1 entry:

Database alias = LDAPDB02
Database name = LDAPDB02
Local database directory = /home/ldapdb02
Database release level = d.00
Comment =
Directory entry type = Indirect
Catalog database partition number = 0
Alternate server hostname =
Alternate server port number =

Database 2 entry:

Database alias = LDAPDB2B
Database name = LDAPDB02
Local database directory = /home/ldapdb02
Database release level = d.00
Comment =
Directory entry type = Indirect
Catalog database partition number = 0
Alternate server hostname =
Alternate server port number =

3) Here is how we are going to extract the salt from the database.

$ db2 connect to ldapdb02

--------------- Example output ----------------
Database Connection Information

Database server = DB2/LINUXX8664 9.7.2
SQL authorization ID = LDAPDB02
Local database alias = LDAPDB02

$ db2 list tables | grep -i cryptosalt
CRYPTOSALT LDAPDB02 T 2013-05-22-11.06.11.045546

$ db2 describe table CRYPTOSALT

--------------- Example output ----------------

Data type Column
Column name schema Data type name Length Scale Nulls
------------------------------- --------- ------------------- ---------- ----- ------
EID SYSIBM INTEGER 4 0 No 

1 record(s) selected.

$ db2 "select * from CRYPTOSALT"

--------------- Example output ----------------

EID 
-----------
10

1 record(s) selected.

$ db2 "select * from LDAP_ENTRY where eid=10" | grep -i ibm-slapdCryptoSalt
ibm-slapdCryptoSalt: YxOjAW_G^*d.

After the above commands complete, type exit and come to root terminal.

4) Drop the directory instance and leave the database as it was.

# idsidrop -I ldapdb02 
--------------- Example output ----------------
GLPIDP045I You have opted to delete an existing directory server instance. All information regarding how the directory server instance was configured will be removed. This means the configuration file, schema files, log files, and key stash files associated with this directory server directory will be removed.

Do you want to....
(1) - Continue and delete the directory server instance, or
(2) - Exit this task without changes:1

GLPIDP047I Do you want to delete the database instance and database associated with the directory server instance. Note: This will delete all data from the directory server instance.

Do you want to....
(1) Leave this database instance on your system, or
(2) Completely erase the database instance (and all databases)?:1

GLPWRP123I The program '/opt/ibm/ldap/V6.3/sbin/64/idsidrop' is used with the following arguments '-I ldapdb02'.
You have chosen to perform the following actions:

GLPIDP043I The directory server instance 'ldapdb02' will be deleted. Note: The configuration file, the schema files, the log files, and key stash files associated with this directory server instance will be deleted. All information regarding how the directory server instance was configured and how the directory data was encrypted will be lost.
...

Do you want to....
(1) Continue with the above actions, or
(2) Exit without making any changes:1

GLPIDP002I Deleting directory server instance: 'ldapdb02'.
...
...
GLPIDP040I Unregistered directory server instance: 'ldapdb02'.
GLPIDP003I Deleted directory server instance: 'ldapdb02'.

5) Create a new directory instance using the salt obtained from the database as above

# idsicrt -I ldapdb02 -e abc0123456789 -g 'YxOjAW_G^*d.' -t ldapdb02 -l /home/ldapdb02
--------------- Example output ----------------
GLPWRP123I The program '/opt/ibm/ldap/V6.3/sbin/64/idsicrt' is used with the following arguments 'idsicrt -I ldapdb02 -e ***** -g ***** -t ldapdb02 -l /home/ldapdb02'.
You have chosen to perform the following actions:

GLPICR020I A new directory server instance 'ldapdb02' will be created.
...
...
GLPICR021I Database instance 'ldapdb02' will be configured.

Do you want to....
(1) Continue with the above actions, or
(2) Exit without making any changes:1

GLPICR028I Creating directory server instance: 'ldapdb02'.
GLPICR025I Registering directory server instance: 'ldapdb02'.
GLPICR026I Registered directory server instance: : 'ldapdb02'.
...
...
GLPICR052I Creating DB2 instance link for directory server instance: 'ldapdb02'.
GLPICR053I Created DB2 instance link for directory server instance: 'ldapdb02'.
GLPICR032I Added database instance 'ldapdb02' to directory server instance: 'ldapdb02'.

6) Configure the newly created directory instance with the existing database ldapdb2

# idscfgdb -I ldapdb02 -a ldapdb02 -w ldapdb02 -t ldapdb02 -l /home/ldapdb02
--------------- Example output ----------------
GLPWRP123I The program '/opt/ibm/ldap/V6.3/sbin/64/idscfgdb' is used with the following arguments '-I ldapdb02 -a ldapdb02 -w ***** -t ldapdb02 -l /home/ldapdb02'.
You have chosen to perform the following actions:

GLPCDB023I Database 'ldapdb02' will be configured.
GLPCDB024I Database 'ldapdb02' will be created at '/home/ldapdb02'

Do you want to....
(1) Continue with the above actions, or
(2) Exit without making any changes:1

GLPCDB035I Adding database 'ldapdb02' to directory server instance: 'ldapdb02'.
GLPCTL017I Cataloging database instance node: 'ldapdb02'.
GLPCTL018I Cataloged database instance node: 'ldapdb02'.
...
...
GLPCTL008I Starting database manager for database instance: 'ldapdb02'.
GLPCTL009I Started database manager for database instance: 'ldapdb02'.
GLPCDB003I Added database 'ldapdb02' to directory server instance: 'ldapdb02'.

7) Configure admin DN and password

# idsdnpw -I ldapdb02 -u cn=root -p root -n
--------------- Example output ----------------
GLPWRP123I The program '/opt/ibm/ldap/V6.3/sbin/64/idsdnpw' is used with the following arguments '-I ldapdb02 -u cn=root -p ***** -n'.
You have chosen to perform the following actions:

GLPDPW004I The directory server administrator DN will be set.
...
...
GLPDPW007I Directory server administrator password was set.

8) Start the directory server

# ibmslapd -I ldapdb02 -n
--------------- Example output ----------------
GLPSRV041I Server starting.
...
...
GLPCOM003I Non-SSL port initialized to 389.
------------------------------------------------------

Now, you can see that the server has started successfully with your old database and you can access your old TDS data.