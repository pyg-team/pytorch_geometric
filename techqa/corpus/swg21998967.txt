Title: IBM Scheduled C&DS Jobs are being held in queued state - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Overnight, scheduled jobs were showing up in a Queued status.

Stopping and starting C&DS caused each job that was in a Queued status to change to an Error status.

Why is this occurring? Jobs can run now after stopping/starting C&DS. 

SYMPTOM
All scheduled jobs end up in a Queued status when the job is scheduled to run.


CAUSE
The connection to the C&DS Repository database had been terminated multiple times.

ENVIRONMENT
C&DS 7.0
MS SQL Server 2012.
Websphere


DIAGNOSING THE PROBLEM
In general when C&DS loses a connection to its repository database, C&DS will attempt to reconnect with a database iteratively. When the database is available C&DS will make the connection and jobs in a queued status will begin to be run until the job processing is caught up. 




However, there may be circumstances as noted below, where a connection may fail to occur. In this specific case, the C&DS repository database went down multiple times after C&DS had re-established a connection. This action looks to have left some services in a bad state.


The Application Server is WebSphere. Reviewing WebSphere's systemout.log file, messages indicate a JDBC connection was lost similar to: "Your connection was terminated". 

There may be any number of reasons why the connection was lost. 


SYSTEMOUT.log (Oracle)
0000008a ConnectionEve W J2CA0206W: A connection error occurred. To help determine the problem, enable the Diagnose Connection Usage option on the Connection Factory or Data Source. This is the multithreaded access detection option. Alternatively check that the Database or MessageProvider is available.
0000008a ConnectionEve A J2CA0056I: The Connection Manager received a fatal connection error from the Resource Adapter for resource jdbc/spss/PlatformDS. The exception is: java.sql.SQLNonTransientConnectionException: [SPSSOEM][Oracle JDBC Driver]No more data available to read.

SYSTEMOUT.log (MS SQL Server)
000000f6 ConnectionEve W J2CA0206W: A connection 
error occurred. To help determine the problem, enable the Diagnose Connection 
Usage option on the Connection Factory or Data Source. This is the 
multithreaded access detection option. Alternatively check that the Database or 
MessageProvider is available. 
000000f6 ConnectionEve A J2CA0056I: The Connection 
Manager received a fatal connection error from the Resource Adapter for 
resource jdbc/spss/PlatformDS. The exception is: 
java.sql.SQLNonTransientConnectionException: [SPSSOEM][SQLServer JDBC 
Driver]Your connection was terminated.:java.sql.SQLException: 
[SPSSOEM][SQLServer JDBC Driver]The database server took longer to respond than 
the specified network timeout value. 



FFDC
FFDC Exception:java.sql.SQLException SourceId:com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.destroy ProbeId:1005 Reporter:com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl@468c3888
java.sql.SQLException: [SPSSOEM][SQLServer JDBC Driver]Object has been closed. 

 

 

These messages are indicative to WebSphere and recorded in the systemout.log. The CDS_BUS is shutting. 

 

This is what leaves the jobs in a queued state:
00000089 SibMessage I [CDS_BUS:cds013Node03.server1-CDS_BUS] CWSIS1519E: Messaging engine cds013Node03.server1-CDS_BUS cannot obtain the lock on its data store, which ensures it has exclusive access to the data.
0000006e SibMessage E [CDS_BUS:cldd013Node03.server1-CDS_BUS] CWSID0046E: Messaging engine cldd013Node03.server1-CDS_BUS detected an error and cannot continue to run in this server.
0000006e SibMessage I [CDS_BUS:cldd013Node03.server1-CDS_BUS] CWSID0016I: Messaging engine cds013Node03.server1-CDS_BUS is in state Stopping.
0000006e SibMessage I [CDS_BUS:cldd013Node03.server1-CDS_BUS] CWSID0016I: Messaging engine cds013Node03.server1-CDS_BUS is in state Stopping.
0000006e SibMessage I [CDS_BUS:cldd013Node03.server1-CDS_BUS] CWSID0016I: Messaging engine cds013Node03.server1-CDS_BUS is in state Stopped. 

 

 

C&DS attempts to recover:
0000025d SibMessage I [CDS_BUS:cldd013Node03.server1-CDS_BUS] CWSID0016I: Messaging engine cldd013Node03.server1-CDS_BUS is in state Starting.
0000025d SibMessage I [CDS_BUS:cldd013Node03.server1-CDS_BUS] CWSID0055I: Probing connection to database 2 of 5 time(s)
0000025d SibMessage I [CDS_BUS:cldd013Node03.server1-CDS_BUS] CWSID0056I: Connection to database is successful 



Then fails immediately again, and subsequently reconnects and fails again twice within moments.
000000fd ConnectionEve W J2CA0206W: A connection error occurred. To help determine the problem, enable the Diagnose Connection Usage option on the Connection Factory or Data Source. This is the multithreaded access detection option. Alternatively check that the Database or MessageProvider is available. 


This message indicates transactions have become unstable and can not recover this time.
SYSTEMOUT.log
[2/12/17 6:47:46:097 EST] 0000b336 FfdcProvider W com.ibm.ws.ffdc.impl.FfdcProvider logIncident FFDC1003I: FFDC Incident emitted on C:\IBM\WebSphere\AppServer\profiles\AppSrv01\logs\ffdc\SPSS_CDS_ef5afc5_17.02.12_06.47.46.0816143673440905281049.txt com.ibm.ejs.j2c.MCWrapper.cleanup 706
[2/12/17 6:47:46:097 EST] 0000b336 MCWrapper E J2CA0081E: Method cleanup failed while trying to execute method cleanup on ManagedConnection WSRdbManagedConnectionImpl@de9d2250 from resource jdbc/spss/PlatformDS. Caught exception: com.ibm.ws.exception.WsException: DSRA1130E: A fatal connection error occurred on another connection while this connection was active. This connection cannot be reset to a usable state. 

 

FFDC
2/12/17 6:47:46:081 EST] Exception:com.ibm.ws.rsadapter.exceptions.DataStoreAdapterException SourceId:com.ibm.ejs.j2c.MCWrapper.cleanup ProbeId:706 Reporter:com.ibm.ejs.j2c.MCWrapper@e27c0203
com.ibm.ws.exception.WsException: DSRA1130E: A fatal connection error occurred on another connection while this connection was active. This connection cannot be reset to a usable state.



RESOLVING THE PROBLEM
In this case C&DS will need to be stopped. When the database is available C&DS will need to be started. All jobs that were in a "Queued" and "Runnning" state will show a status of "Error" when C&DS is restarted. Those jobs will need to be manually resubmitted or wait until the next scheduled event. If many jobs are scheduled and have not run, when C&DS is started it will recognized all the scheduled jobs that are past due. C&DS will submit those scheduled jobs. If there are many many jobs, then again it will be seen where some jobs are running and others go into a queued status due to the influx of jobs being submitted simultaneously. Jobs in a running status will eventually complete and other jobs in a Queued status will move to a Running status. Depending on the number of jobs and length of time those jobs run, this could be hours. If WebSphere is the application server and the initial behavior looks to be repeating, then what may be causing the intermittent loss of C&DS's repository database is the number of pooled connections for the JDBC data source defined within the WebSphere admin console. 

 

Consult with your middleware support team or documentation on making adjustments to this setting prior to changing from the default value of 100. 

 

WAS admin console, Resources > JDBC Providers > CDS Providers > Data sources > CDS_Datasource > connection pools and value Maximum Connections which defaults to 100. 

 

If C&DS were to acquire and hold a connection to the C&DS database repository prior to it being stop/started, depending on the time C&DS was in this state, this situation is similar to what is described above. Give the job status indicators time to move from Queued/Running status into a Running/Completed state. Depending on job load and circumstance this may take quite awhile.