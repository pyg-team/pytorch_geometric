Title: IBM Unable to remove the last replica of the family - United States

Text:
rmreplica; db_vista; 2GB; vista.tjf; 1128018; RATLC01036645; transaction journaling TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 This technote explains why the IBM® Rational® ClearCase MultiSite® multitool rmreplica command fails to remove the last replica in a family and causes db_VISTA database error -912 and or -925. 

SYMPTOM
 

Attempts to remove the replica of a previously synchronized VOB using the multitool rmreplica command results in the following error:

multitool: Error: Error from VOB database: "\test_vob".



OTHER SYMPTOMS: 

 * Taking a closer look at the VOB storage directory shows that the vista.tjf file has grown larger then 2 GB:
   
   18-Feb-2003 08:14 5,154 vista.taf
   18-Feb-2003 07:57 4,096 vista.tcf
   18-Feb-2003 08:14 2,147,494,010 vista.tjf


 * In the db_server_log file the following entries may be found:
   
   02/03/03 06:34:11 db_server(19351): Ok: *** db_VISTA database error -925 - error in Transaction Journaling File
   02/03/03 06:34:11 db_server(19351): Error: Transaction journal file a suspicious length 2147494010
   
   AND - OR
   
   21/03/02 10:41:26 AM vobrpc_server(29497): Ok: *** db_VISTA database error -912 - error seeking in database file
   21/03/02 10:41:26 AM vobrpc_server(29497): Error: TJF pre truncate write failed: errno = 22
   21/03/02 10:41:26 AM vobrpc_server(29497): Error: DBMS error in "../db1.c" line 1100
   21/03/02 10:41:26 AM vobrpc_server(29497): Error: DBMS error in /vol01/vobstore/test.vbs/db.



CAUSE
 

These problems are the result of removing the last replica in the family. 

The rmreplica command has exceeded the transaction journaling limit. 

Note: Even if the -journal_file_limit was set in the db.conf, you could still run into this problem because rmreplica is treated as a single transaction. 

 

Review the ClearCase Command Reference Guide on the topic of config_ccase [http://publib.boulder.ibm.com/infocenter/cchelp/v7r0m1/index.jsp?topic=/com.ibm.rational.clearcase.cc_ref.doc/topics/config_ccase.htm] (cleartool man config_ccase) for more information about the db.conf file


RESOLVING THE PROBLEM
 

Follow these steps to scrub the oplogs to avoid overflowing the transaction journaling file during replica removal. 

 

 1.  Lock the VOB
     
     Note: If receiving errors from the lock command, proceed to step 2.
     
     
 2.  Unmount the VOB 
     
     
 3.  OPTION 1: Stop the vob_server processes for the VOB in question
     or 
     OPTION 2: Stop ClearCase services
     
     Note: If OPTION 1 is chosen, use the albd_list utility to help find all the server processes related to the VOB in question. Review technote 1148639 [http://www-1.ibm.com/support/docview.wss?rs=984&uid=swg21148639] for more information about albd_list.
     
     
 4.  Move the vista.tjf, vista.tcf and vista.taf files out of the db directory for the VOB in question.
     
     Note: Start ClearCase if it was stopped in step 3. 
     
     
 5.  Remount the VOB
     
     
 6.  The files will be recreated and the VOB will now be functional
     
     
 7.  Set the scrubbing parameters by modifying the oplog entry in the vob_scrubber_params [http://publib.boulder.ibm.com/infocenter/cchelp/v7r0m1/index.jsp?topic=/com.ibm.rational.clearcase.cc_ref.doc/topics/vob_scrubber.htm]file:
     
     ccase_home_dir/config/vob/vob_scrubber_params 
     
     Modify the last line as follows:
     FROM: oplog -keep forever
     TO: oplog -keep 120
     
     Note: The file above when located in the default directory controls the parameters for all VOBs on that host. To specify a per-VOB setting, create the file in the VOB's storage directory. 
     
 8.  Unlock the VOB
     
     
 9.  Run the command vob_scrubber <vob-storage-dir-pname> 
     
     Review the Rational ClearCase Reference Guide on the topic of vob_scrubber (cleartool man vob_scrubber) for more information.
     
     
 10. Change the -keep value in the vob_scrubber_params file to 90 and repeat step 9.
     
     FROM: oplog -keep 120
     
     TO: oplog -keep 90
     
     
 11. Change the -keep value in the vob_scrubber_params file to 60 and repeat step 9.
     
     FROM: oplog -keep 90
     
     TO: oplog -keep 60
     
     
 12. Change the -keep value in the vob_scrubber_params file to 30 and repeat step 9.
     
     FROM: oplog -keep 60
     
     TO: oplog -keep 30
     
 13. It is also suggested that you scrub the export_sync records by setting the export_sync [http://publib.boulder.ibm.com/infocenter/cchelp/v7r0m1/index.jsp?topic=/com.ibm.rational.clearcase.cc_ms_admin.doc/c_export_synch_scrubbing.htm]parameter and repeat step 9.
     
     export_sync -keep 7
     
     Review the ClearCase MultiSite Administrators Guide on the topic of export_sync scrubbing [http://publib.boulder.ibm.com/infocenter/cchelp/v7r0m1/index.jsp?topic=/com.ibm.rational.clearcase.cc_ms_admin.doc/c_export_synch_scrubbing.htm] for more information.
     
     
 14. Change the -keep value in the vob_scrubber_params file back to what is was prior to the above changes (suggest that it be no lower than 90). 
     
     Note: If you modified the host-wide vob_scrubber_params configuration file (by default: ccase_home_dir/config/vob/vob_scrubber_params), changes you make may impact other replicas on the same VOB server. Refer to the IBM Rational Command Reference Manual under the topic of vob_scrubber [Host-wide%20config%20file]and the IBM Rational ClearCase MultiSite Administrators Guide under the topic of Oplog Scrubbing [http://publib.boulder.ibm.com/infocenter/cchelp/v7r0m1/index.jsp?topic=/com.ibm.rational.clearcase.cc_ms_admin.doc/c_oplog_scrubbing.htm]for further details.


The multitool rmreplica command will now run successfully.



RELATED INFORMATION
#About db_VISTA -925 [http://www.ibm.com/support/docview.wss?uid=swg21133944]
About db_VISTA -912 [http://www.ibm.com/support/docview.wss?uid=swg21123349]






Cross reference information Segment Product Component Platform Version Edition Software Development Rational ClearCase Database