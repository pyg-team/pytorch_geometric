Title: IBM DataPower Mustgather for intermittent MQ failures. - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

THIS DOCUMENT APPLIES ONLY TO THE FOLLOWING LANGUAGE VERSION(S):
 English 

PROBLEM(ABSTRACT)
 How do I capture the necessary information for occasisional MQ connection errors, queue failures, or other events that are difficult to capture or predict? 

SYMPTOM
Infrequent errors such as these can be difficult to capture in high traffic environments or when seen intermittently. 

[mq][error] mq-qm(QueueManager): tid(43999265): Queue Manager Error: 'MQHost:1414' 'MyQueue'. Reason code - 2059

[network][error] xmlmgr(default): tid(43999265): Host connection failed to establish: MQHost : tcp port 1414 

[mq][error] mpgw(MyMPGW): tid(26743983)[10.10.10.10]: The get call timed out before receiving any messages (Reason Code 2033) 

[mq][error] mq-qm(MyQM): tid(44084465): Queue Manager Error: 'MQServer.corp:1414' 'MyQM'. Reason code - 2059 

Also notice the log category noted some of these are see within mq error levels while others may be network errors related to the MQ server. There are many other log events that may behave this way. 





DIAGNOSING THE PROBLEM
There are a few options but one of the best methods to simply capture this is through a custom log target. To do this reliably and prevent false positives we must take a few steps: 

1- We must pick the log event that we want to trigger on and get the event code for that log. There are two ways. Some firmware versions and log types already include the event code such as:
[0x80e0015f][mq][error] mq-qm(MyQM): tid(5218535): test connection failed (2059)
Some log target types may not include the event code. A simple method to get the event code regarless of firmware version is through an XML log target type. 

Re capture the problem using the log format of XML and confirm the event code that you want to 'trap' based on. 

 

2- For this example we will use the event code 0x80e0015f noted above. This new custom log target must use the log event subscription of 'mq' 'error'. If you do not capture the mq error level logs then this log event will not be seen and the trigger will not work. 

 

3- Here is an example of the log target configured using the command line interface:
logging target "MQDebugLog"
type file
format text
timestamp syslog
size 50000
local-file "logtemp://MQDebug.log"
rotate 2
trigger "0x80e0015f" "" "on" "on" "co;no packet-capture-advanced all temporary://mq.cap;echo HELP!;logging target MQDebugLog; admin-state disabled; exit; save error-report"
event "all" "debug"
exit 

 

In the above example we are capturing the log event subscription of 'all' 'debug' which includes mq error events. 

The trigger string will do a few things:
- no packet-capture-advanced, will halt a continuous rotating packet trace that would have been started with the command:
packet-capture-advanced all temporary://mq.cap -1 30000 9000 "port 1414" 

- the cli command echo will write out the word "HELP!" which can easily be found in the log and gives a great reference point in time. 

- the admin-state of the MQDebugLog target will also be disabled which will halt and prevent further logging from rolling the log and possibly dropping key information 

- an error report is generated 

 

4- Once this event triggers there will be three basic things to collect:
- the error report 
- the MQDebug log file
- the packet trace mq.cap


 

5- Optional changes that may help depending on the problem and the event trigger used. 

You may also want to consider using the Object filter. For the above log target trigger to STOP a packet trace this log target must be configured in the default domain. The default domain can see all objects which can generate a lot of traffic so using a object filter of, for example, an object filter MultiProtocolGateway with the name of the MPGW being debugged. 

Be sure to check the option "Add Referenced Objects" 

Via the webgui the option can be seen here:
[/support/docview.wss?uid=swg21690475&aid=1] [/support/docview.wss?uid=swg21690475&aid=1] 

The setting MUST be turned on, but while in the default domain, clicking apply will change this setting to off. Do not be alarmed this is by design and due to the use of default domain object filter.