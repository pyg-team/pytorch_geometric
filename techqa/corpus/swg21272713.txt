Title: IBM MS SChannel return code 0x8009030D (The credentials supplied to the package were not  recognized) is received during SSL negotiation (handshake). - United States

Text:
AMQ9698 0x8009030D SChannel Microsoft MSCAPI MS CAPI rrcE_SSL_SSPI_FAILED_HANDSHAKING credentials not recognized TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 You attempt to start a SDR channel to a RCVR channel configured with SSLCAUTH(REQUIRED), but the channel goes into a RETRYING status. Inspection of the QMgr's error logs shows an AMQ9698 error message reporting the MS SChannel return code 0x8009030D (The credentials supplied to the package were not recognized). 

CAUSE
This can occur, if the "Protected Storage" service is not started and/or the 'MUSR_MQADMIN' account does not have the proper authority to access the certificate in the QMgr's keystore. 


Furthermore, the personal certificate and full chain are not specifically in the Local Computer’s Personal store (MY) and Root store for the user 'MUSR_MQADMIN'. 

In some instances where the personal certificate that you want to assign to your QMgr is issued as an individual subscriber certificate (Example: VeriSign Class 1 Individual Subscriber CA - G2), the certificate and its associated private key are retrieved from the specific stores that are variously assumed to be default locations for “Personal” certificates by MS CAPI.

Note: WebSphere MQ 5.3 on MS Windows uses MS CAPI as the cryptographic SSL provider.


RESOLVING THE PROBLEM
First verify that the MS "Protected Storage" service is started and set to automatic startup. Then add the 'MUSR_MQADMIN' user account to the local 'Administrators' group. Refresh security on the Queue Manager by issuing the MQSC command "REFRESH SECURITY". 


If the above does not help to resolve the problem, please do the following.

1. Change the 'MUSR_MQADMIN' users password on each of the nodes. It would be best to make the 
new passwords the same, but totally optional. 

2.. Once the password for 'MUSR_MQADMIN' has been successfully changed, please update the 
MQSeries configuration in DCOM with said password. 

For Windows 2000 and NT: 
Open a command prompt, and type: dcomcnfg. Once the Distributed COM 
Configuration Properties window opens, double-click "IBM MQSeries 
Services". 

Enter 'MUSR_MQADMIN's new password under the 'Identity' tab. Click 
APPLY and then OK. 

3. Log off the MS Windows box and log in to the MS Windows desktop using 
the 'MUSR_MQADMIN' account. This will create the profile, etc. 

4. Add the personal certificate and all certificates in it's chain (if needed) to the MUSR_MQADMIN's 
system keystores. This is done easily by simply double clicking on the actual personal certificate file. 
You should be prompted to install the certificate. 

* If you are running in a MSCS environment, the nodes do not need to be failed over. That is because 
the QMgr will still be running under the same user 'MUSR_MQADMIN'; we did not generate a new 
'MUSR_MQADMIN' with new SSID.

Additional Information

QMgr Error Log:

AMQ9698: An SSL security call failed during SSL handshaking. 

EXPLANATION: 
An SSPI call to the Secure Channel (Schannel) SSL provider failed during
SSL handshaking. The failure has caused WebSphere MQ channel name 
'(insert one)' to be closed. If the name is '????' then the name 
is unknown. 

ACTION: 
Consult the Windows Schannel reference manual to determine the meaning 
of status 0x8009030D (The credentials supplied to the package were not 
recognized) for SSPI call AcquireCredentialsHandle. Correct the failure 
and if necessary re-start the channel. 

Trace output:

001BEAC7 13:50:38.819376 11136.1 ----------{ rrxError 
001BEACB 13:50:38.821065 11136.1 RetCode = 20009698, rc1 = 
-2146893043, rc2 = 0, Comment1 = 'MSSPBC01.1CPHPTA79', Comment2 = 
'AcquireCredentialsHandle', Comment3= '0x8009030D (The credentials
supplied to the package were not recognized )', File= 
'F:\Build\SOURCE\lib\comms\pc\winnt\amqccisn.c', Line= '2745' 
001BEACF 13:50:38.824595 11136.1 ----------}! rrxError 
(rc=rrcE_SSL_SSPI_FAILED_HANDSHAKING) 

SYSTEM Event Log entries: 

A fatal error occurred when attempting to access the SSL server
credential private key. The error code returned from the 
cryptographic module is 0x2 

A fatal error occurred when attempting to access the SSL client
credential private key. The error code returned from the 
cryptographic module is 0xffffffff.



HISTORICAL NUMBER
 08195
7TD
000 

PRODUCT ALIAS/SYNONYM
 MQSeries WebSphere MQ WMQ