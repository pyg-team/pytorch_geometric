Title: IBM When enabling Kerberos authentication with Big SQL through Ambari, IBM JDK kinit may fail if you specify aes256-cts-hmac-sha1-96 encryption for your cluster during kerberizing through Ambari wizard - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 After enabling Kerberos for Big SQL through Ambari you may notice the following java.lang.NullPointerException when executing kinit for BigSQL service. 

$/home/bigsql/sqllib/java/jdk64/jre/bin/kinit -k -f -t /etc/security/keytabs/bigsql.service.keytab bigsql/<host>@<realm>
java.lang.NullPointerException 

The bigsql kinit fails to generate the ticket cache, which can be listed using:

$/home/bigsql/sqllib/java/jdk64/jre/bin/klist
Credentials cache /home/bigsql/krb5cc_bigsql cannot be found

Because of missing ticket cache credentials, BigSQL queries will result in GSS errors when BigSQL attempts to communicate with other Hadoop services. The bigsq.log will show similar errors : 

Caused by: javax.security.sasl.SaslException: GSS initiate failed [Caused by org.ietf.jgss.GSSException, major code: 11, minor code: 0
major string: General failure, unspecified at GSSAPI level
minor string: Error: java.lang.Exception: Error: `java.lang.NullPointerException]`
at com.ibm.security.sasl.gsskerb.GssKrb5Client.evaluateChallenge(GssKrb5Client.java:223)
at org.apache.hadoop.security.SaslRpcClient.saslConnect(SaslRpcClient.java:414)
at org.apache.hadoop.ipc.Client$Connection.setupSaslConnection(Client.java:595)
at org.apache.hadoop.ipc.Client$Connection.access$2000(Client.java:397)
at org.apache.hadoop.ipc.Client$Connection$2.run(Client.java:762)
at org.apache.hadoop.ipc.Client$Connection$2.run(Client.java:758)
at java.security.AccessController.doPrivileged(AccessController.java:686)
at javax.security.auth.Subject.doAs(Subject.java:569)
at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1866)
at org.apache.hadoop.ipc.Client$Connection.setupIOstreams(Client.java:758)
... 25 more


SYMPTOM
You may notice that queries to hadoop tables hang.


CAUSE
As part of the Kerberos setup through Ambari Wizard, the /etc/krb5.conf will be setup to support the default encryption types such as aes des3-cbc-sha1 rc4 des-cbc-md5. 


If your krb5.conf is setup to only permit certain encryption types such as aes256-cts-hmac-sha1-96, you will need to update the default limited JCE Policy files under /home/bigsql/sqllib/java/jdk64/jre/lib/security 

with the Unrestricted JCE Policy files for this encryption type.



RESOLVING THE PROBLEM
Please check and ensure the following two files are under the following directory: 


/home/bigsql/sqllib/java/jdk64/demo/jce/policy-files/unrestricted
local_policy.jar
US_export_policy.jar

If they are not available in the location above, you may need to download from the following location: 
https://www-01.ibm.com/marketing/iwm/iwm/web/preLogin.do?source=jcesdk [https://www-01.ibm.com/marketing/iwm/iwm/web/preLogin.do?source=jcesdk]

Once the files are available, you can run the following steps to recover from this issue: 

1) Shutdown BigSQL.
2) As root replace in/home/bigsql/sqllib/java/jdk64/jre/lib/security/
Note: Please maintain the permissions/ownership as they were in 

/home/bigsql/sqllib/java/jdk64/demo/jce/policy-files/unrestricted directory. 
ls -l /home/bigsql/sqllib/java/jdk64/jre/lib/security/*.jar
-r--r--r-- 1 bin bin2721 Dec 1 08:23 
/home/bigsql/sqllib/java/jdk64/jre/lib/security/local_policy.jar
-r--r--r-- 1 bin bin2240 Dec 1 08:23 /home/bigsql/sqllib/java/jdk64/jre/lib/security/US_export_policy.jar

3) Do the same for all BigSQL worker nodes.
4) Start BigSQL
5) Check if bigsql cache was recreated, ie: /home/bigsql/sqllib/java/jdk64/jre/bin/klist
6) Run the hive queries which were hanging previously