Title: IBM WebSphere Commerce java.lang.StackOverflowError when JSON object has reference to itself - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 In IBM WebSphere Commerce, you receive a java.lang.StackOverflowError exception when a JSON object has a reference to itself. 

SYMPTOM
The exception trace is similar to the following sample:

[4/28/09 1:51:30:218 EDT] 00000039 servlet 

E com.ibm.ws.webcontainer.servlet.ServletWrapper 

service SRVE0068E: Uncaught exception created 

in one of the service methods of the servlet 

/test/JsonTagTest_nestedObjects.jsp in application WC. Exception created : com.ibm.websphere.servlet.error. 

ServletErrorReport: java.lang.StackOverflowError
at org.apache.jasper.runtime. 

PageContextImpl.handlePageException(PageContextImpl.java:695)
at com.ibm._jsp._JsonTagTest_5F_nestedObjects. 

_jspService(_JsonTagTest_5F_nestedObjects.java:111)
at com.ibm.ws.jsp.runtime.HttpJspBase.service(HttpJspBase.java:98)
at javax.servlet.http.HttpServlet.service(HttpServlet.java:831)
at com.ibm.ws.cache.servlet.ServletWrapper. 

serviceProxied(ServletWrapper.java:307)
...
Caused by: java.lang.StackOverflowError
at java.util.HashMap.entrySet(HashMap.java:479)
at java.util.AbstractMap.hashCode(AbstractMap.java:434)
at java.util.MapEntry.hashCode(MapEntry.java:75)
at java.util.AbstractMap.hashCode(AbstractMap.java:436)
at java.util.MapEntry.hashCode(MapEntry.java:75)
at java.util.AbstractMap.hashCode(AbstractMap.java:436)
...

An example of what would cause this is the following:

<%@ page import="javax.servlet.*,java.util.*"%>
<%@ page session="false"%>
<%@ page pageEncoding="UTF-8"%>
<%@ taglib uri="http://commerce.ibm.com/foundation" prefix="wcf"%>

<%

Map aMap = new HashMap();
Map bMap = new HashMap();
List aList = new ArrayList();

aList.add(new Integer(1));
alist.add(new Integer(2));

aMap.put("firstElement", aList);
aMap.put("secondElement", bMap);
aMap.put("thirdElement", aMap);
aMap.put("fourthElement", "this is a string"); 

>%

<p>This is a map that references itself: <wcf:json object="<%=aMap%>"/></p>



The problematic code section that causes the JSON object to reference itself is:
aMap.put("thirdElement", aMap);


CAUSE
There is a current limitation that JSON objects cannot have a reference to itself.


RESOLVING THE PROBLEM
This problem can be resolved by removing the code that makes the JSON object have a reference to itself.