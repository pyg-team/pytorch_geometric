Title: IBM V10.1 以降では、静止状態のデータベースのオフライン・バックアップが SQL1035N で失敗することがある - United States

Text:
 TECHNOTE(トラブルシューティング)

問題(概要)
 V9.7 から V10.1 に移行後、データベースを QUIESCE DATABASE コマンドで静止状態にしたにもかかわらず、オフライン・バックアップが SQL1035N で失敗することがあります。理由を教えてください。 

症状
以下はこの現象の再現の例です。 

1) CLP1:
DBADM 権限の USER ID で CLP から quiesce database コマンドを実行します。 

 * 
 * $ db2 connect to sample
   
   Database Connection Information
   
   Database server = DB2/AIX64 10.5.7
   SQL authorization ID = E105Q7A
   Local database alias = SAMPLE
   
   
   $ db2 quiesce database immediate force connections
   DB20000I The QUIESCE DATABASE command completed successfully.
   $ db2 terminate
   DB20
 * 
 * 

2) CLP2: 
Connect 権限を持つ USER ID で CLP から、シェル・スクリプを使いトデータベース接続を連続して試行します。 
ただし CONNECT DATABASE コマンドは、データベースが静止状態のため SQL20157N で失敗します。 
 * 
 * 
 * $ cat connect.sh
   #!/bin/sh
   count=0
   while [ $count -lt 1000 ]; do
   db2 connect to $db
   count=`expr $count + 1`
   done 
 * 
 * 
 * 
 * 
 * db2insth $ sh -x loop.sh
   + count=0
   + [ 0 -lt 1000 ]
   + db2 connect to sample
   SQL20157N User with authorization ID "USER1" failed to attach to a
   quiesced instance, or connect to a quiesced database or a database in a
   quiesced instance which is in the following quiesce mode: "QUIESCE DATABASE"
   SQLSTATE=08004
   + + expr 0 + 1
   count=1
   + [ 1 -lt 1000 ]
   + db2 connect to sample
 * 
 * 
 * 


3) CLP1: 
以上のシェルス・クリプトの実行中に、並行して DBADM 権限を持つ USER ID で、オフライン・バックアップを実行します。 
オフライン・バックアップはSQL1035Nで失敗しました。  * 
 * $ db2 backup db sample
   SQL1035N The operation failed because the specified database cannot be
   connected to in the mode requested. SQLSTATE=57019


原因
V10.1 で DB2 のコードが変更されたため、データベースの接続要求があった場合に、オフラインバックアップがSQL1035N で受け付けられない時間が短時間だけ発生するようになりました。


診断
CONNECT DATABASE 実行時には短時間だけデータベースが活動化されるため、オフライン・バックアップが失敗します。以下に説明する QUIESCE INSTANCE を RESTRICTED ACCESS オプションと共にで実行するとCONNECT DATABASE 時のデータベースの活動化を防ぐことができます



解決方法
 

 1. 可能であれば、QUIESCE DATABASE コマンドを使う代わりに、QUIESCE INSTANCE コマンドを RESTRICTED ACCESS オプションで実行してください。 
 2. オフライン・バックアップが SQL1035N で失敗した場合、再度オフライン・バックアップを試行してください。SQL1035N が発生するのは CONNECT DATBASE 実行時の短時間のため、再試行した OFFLINE BACKUP が受け付けられる可能性があります。

関連情報
 V10.0 QUIESCE コマンド [https://www.ibm.com/support/knowledgecenter/SSEPGG_10.1.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0008635.html]
V10.5 QUIESCE コマンド [https://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0008635.html]
V10.1 BACKUP DATABASE コマンド [https://www.ibm.com/support/knowledgecenter/SSEPGG_10.1.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0001933.html]
V10.5 BACKUP DATABASE コマンド [https://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0001933.html?cp=SSEPGG_10.5.0%2F3-6-2-4-8&lang=ja]
An US English translation is available [http://www.ibm.com/support/docview.wss?uid=swg21979667]