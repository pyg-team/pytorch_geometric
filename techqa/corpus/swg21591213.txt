Title: IBM Too many open files - United States

Text:
ASISslCert; Too many open files TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 SI would start but after a few minutes of processing the schedules stopped running and the UI became unresponsive . Database connections were working (dump_info.sh worked). 

SYMPTOM
bizIntel.log: 

ERROR 000000000000 GLOBAL_SCOPE <BIResourceMonitorEventListener-240520790> [BIResourceMonitorEventListener] : Error in socket connection on : http://<server>:<port> Connection refused

noapp.log:
ALL 000000000000 GLOBAL_SCOPE FROMLOGSYS: java.io.FileNotFoundException: /si50/install/logs/system.log.D20120414.T112557 (Too many open files)
at java.io.FileOutputStream.open(Native Method)
at java.io.FileOutputStream.<init>(FileOutputStream.java:205)
at java.io.FileOutputStream.<init>(FileOutputStream.java:96)
at com.sterlingcommerce.woodstock.util.frame.log.ServerLog.open(ServerLog.java:192)
at com.sterlingcommerce.woodstock.util.frame.log.ServerLog.rotateLog(ServerLog.java:259)
at com.sterlingcommerce.woodstock.util.frame.log.ServerLog.write(ServerLog.java:323)
at com.sterlingcommerce.woodstock.util.frame.logex.SCIAppender.append(SCIAppender.java:128)
at org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:230)
at org.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:65)
at org.apache.log4j.Category.callAppenders(Category.java:203)
at org.apache.log4j.Category.forcedLog(Category.java:388)
at com.yantra.yfc.log.YFCLogCategory.lowLevelLog(YFCLogCategory.java:546)
at com.yantra.yfc.log.YFCLogCategory.error(YFCLogCategory.java:437)
at com.sterlingcommerce.woodstock.util.frame.log.Logger.logError(Logger.java:801)
at com.sterlingcommerce.security.kcapi.PrivateKeyInfo.getInstanceByName(PrivateKeyInfo.java:1002)
at com.sterlingcommerce.security.jsseimpl.SCIX509KeyManagerImpl.getPrivateKey(SCIX509KeyManagerImpl.java:97)
at com.ibm.jsse2.mc$a_.getPrivateKey(mc$a_.java:8)
at com.ibm.jsse2.mc.getPrivateKey(mc.java:6)
at com.ibm.jsse2.fb.a(fb.java:20)
at com.ibm.jsse2.fb.a(fb.java:361)
at com.ibm.jsse2.hc.a(hc.java:48)
at com.ibm.jsse2.hc.accept(hc.java:44)
at org.mortbay.jetty.security.SslSocketConnector.accept(SslSocketConnector.java:170)
at com.sterlingcommerce.woodstock.noapp.ssl.SCISslSocketConnector.accept(SCISslSocketConnector.java:90)
at org.mortbay.jetty.AbstractConnector$Acceptor.run(AbstractConnector.java:537)
at org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:450)

servicesctl.log:
ERROR 000410020322 SERVICES.SERVICES_CONTROLLER.ERR_getAdapter21 getAdapter 
ERROR 000000000000 GLOBAL_SCOPE [1334424900295] Exception creating connection to: <IP address>; nested exception is: 
java.net.SocketException: Too many open files

system.log:
ERROR 000000000000 GLOBAL_SCOPE Error: Could not find PrivateKeyInfo with name ASISslCert

CAUSE
ASISslCert was deleted from the Sterling Integrator System certificates store - 'Trading Partner > Digital Certificates > System'. This certificate is used for baseport+1 SSL socket connections. 


sslCert=ASISslCert
noapp.properties_platform_ifcresources_ext
noapp.properties_platform_ifcresources_ext.in


ENVIRONMENT
Sterling Integrator 5.x



DIAGNOSING THE PROBLEM
"lsof -u <SI user>" results: 

90% of the output looked liked this:
COMMAND PID USER FD TYPE DEVICE SIZE NODE NAME
java <noapp pid> <SI user> 616u sock 0,5 18557 can't identify protocol

"Type=sock" and "Name=can't identify protocol" represent connections that can occur if you create a socket but never connect() or bind() with it.


RESOLVING THE PROBLEM
Restored database from backup 


Another solution (temporary workaround until the database restore can be completed) would be to add the "sslCert=" parameter to customer_overrides.properties but reference another System certificate name:
Example:
noapp.sslCert=<new name>

Next step for this change to take effect would be to simply restart SI . 

**The newly referenced System certificate name must exist in the System store**

**The following certificates are very important to SI and should not be deleted without exporting first:**
B2BHttp
OpsKey
OpsDrv
UIKey
doccrypto
DefDBCrypt
ASISslCert