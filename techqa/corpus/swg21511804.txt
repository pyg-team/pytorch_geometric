Title: IBM Limited Scope Discovery - United States

Text:
"limited scope discovery" TECHNOTE (FAQ)

QUESTION
 Support has asked me to create a limited scope discovery for ITNM 3.9. How do I do this? 

CAUSE
This document assumes that you have sourced your environment (. $NCHOME/env.sh).

ANSWER
To clone the domain: 

Run:
ncp_perl /opt/IBM/tivoli/netcool/precision/scripts/perl/scripts/domain_create.pl -domain TESTDOMAIN -clone <YOUR_DOMAIN> -nopolls -password <NCIM_PASSWORD>

Replace TESTDOMAIN with the name of the domain you are creating and GOODDOMAIN with the name of the domain from which you want to copy.

The -nopolls command line option prevents new poll policies being created for the DEBUG domain.



The output will look like this:
[ root@testbox : /opt/IBM/tivoli/netcool ]
# ncp_perl /opt/IBM/tivoli/netcool/precision/scripts/perl/scripts/domain_create.pl -domain TESTDOMAIN -clone GOODDOMAIN -nopolls -password netcool
Level: info Msg: No domain-specific version of the MibDbLogin.cfg file found for domain TESTDOMAIN - trying the generic file
Level: info Msg: m_DbId mapped to dbid = NCIM
Level: info Msg: m_Server mapped to server = informix
Level: info Msg: m_DbName mapped to dbname = ITNM.itnm
Level: info Msg: m_Schema mapped to schema = ncim
Level: info Msg: m_Hostname mapped to host = 10.0.20.118
Level: info Msg: m_Username mapped to username = ncim
Level: info Msg: m_Password mapped to password = @44:yNpRvEUMJEUhdU6EbMiYfzEgfqlfuaIlmlvtrwqIUlU=@
Level: info Msg: m_PortNum mapped to port = 9088
Level: info Msg: m_EncryptedPwd mapped to pwdIsEncrypted = 1
Level: info Msg: Attempting to connect to database (DBI:ODBC:driver=IBM INFORMIX ODBC DRIVER;host=10.0.20.118;server=ITNM;database=itnm;service=9088;protocol=onsoctcp;DELIMIDENT=Y)...
Level: info Msg: INSERT INTO domainMgr (webtopDataSource,lastUpdated,creationTime,description,domainHost,domainPort,domainName,managerName) VALUES (?,?,?,?,?,?,?,?)
Level: info Msg: INSERT INTO domainSummary (changeTime , domainMgrId , createTime) VALUES (? , ? , ?) ( 2011-08-09 06:26:11,8,2011-08-09 06:26:11,)


Changes to the cfg before starting the new domain:

We first need to make sure that a discovery does not run automatically as soon as we start the domain.

Edit your DiscoConfig.TESTDOMAIN.cfg file. Within the insert into disco.config section, there are a number of options. You will need to count them off, and change the value of m_DiscoOnStartup to be 0 and change m_FeedbackCtrl to be 0:

[ root@testbox : /opt/IBM/tivoli/netcool/etc/precision ]
# vi DiscoConfig.TESTDOMAIN.cfg
.....
insert into disco.config
(
...
m_FeedbackCtrl,
m_DiscoOnStartup,
...
)
values
(
...
0,
0,
...
);

Verify your CtrlServices.TESTDOMAIN.cfg file to be sure it wasn't set there. If you find that you do not have a domain specific version of this file, then make one by simply copying CtrlServices.cfg to CtrlServices.TESTDOMAIN.cfg, and ensure that this is correct:
insert into services.inTray
(
serviceName,
binaryName,
servicePath,
domainName,
argList,
dependsOn,
retryCount
)
values
(
"ncp_disco",
"ncp_disco",
"$PRECISION_HOME/platform/$PLATFORM/bin",
"$PRECISION_DOMAIN",
[ "-domain" , "$PRECISION_DOMAIN", "-discoOnStartup", "0" ,"-latency" , "100000" , "-debug", "0", "-messagelevel", "warn"],
[ "ncp_d_helpserv", "ncp_model" ],
5
);


Starting the new domain:

Use itnm_start ncp -domain TESTDOMAIN to start everything. It should look like this:

[ root@testbox : /opt/IBM/tivoli/netcool/etc/precision ]
# itnm_start ncp -domain TESTDOMAIN
Network Manager:
Domain: TESTDOMAIN
ncp_ctrl RUNNING PID=5153 TESTDOMAIN
ncp_store IDLE PID= TESTDOMAIN
ncp_class IDLE PID= TESTDOMAIN
ncp_model IDLE PID= TESTDOMAIN
ncp_disco IDLE PID= TESTDOMAIN
ncp_d_helpserv IDLE PID= TESTDOMAIN
ncp_config IDLE PID= TESTDOMAIN
ncp_poller(default) IDLE PID= TESTDOMAIN
nco_p_ncpmonitor IDLE PID= TESTDOMAIN
ncp_g_event IDLE PID= TESTDOMAIN
ncp_webtool IDLE PID= TESTDOMAIN
ncp_virtualdomain IDLE PID= TESTDOMAIN


Limiting the scope of discovery:

Chose the devices to which you wish to limit the scope. For example, if you see incorrect connectivity between 10.1.0.51, 10.1.0.52 and 10.1.0.53, then limit the discovery to only find these three nodes.

Remove any existing scopes and do not add a new one. We are only adding nodes to the ping finder, and we will be ensuring that Feedback is disabled, so only those devices will be discovered. Save this page.

[/support/docview.wss?uid=swg21511804&aid=1] [/support/docview.wss?uid=swg21511804&aid=1] 

Navigate to the Seed page. Remove any existing seeds, and add your new individual nodes, which you chose above, ensuring that the "Use Ping Finder in Discovery" is checked and that the "Use File Finder in Discovery" box is unchecked, as below. Then save this page. 
[/support/docview.wss?uid=swg21511804&aid=2] [/support/docview.wss?uid=swg21511804&aid=2] 

Navigate to the Advanced tab and change "Enable Feedback Control" to show "No Feedback". Then save this page.
[/support/docview.wss?uid=swg21511804&aid=3] [/support/docview.wss?uid=swg21511804&aid=3]

Everything is now ready to go. 

Running the new discovery:
Let's start a discovery. We are going to do this as a manual insert into the database:

[ root@testbox : /opt/IBM/tivoli/netcool/log/precision ]
#ncp_oql -service disco -domain TESTDOMAIN -query "insert into stitchers.actions values ('FullDiscovery');"
ncp_oql ( IBM Tivoli Network Manager OQL Interface )
Copyright (C) 1997 - 2010 By IBM Corporation. All Rights Reserved. See product license for details.

IBM Tivoli Network Manager Version 3.9 (Build 32) created by ncpbuild at 04:09:53 Wed Feb 9 GMT 2011

Using no authentication
Executing query:
insert into stitchers.actions values ('FullDiscovery');
.
( 0 record(s) : Transaction complete )

ncp_oql is dead.


Gathering Data:

Once the discovery is complete, you will need to send the discovery data to the IBM Support Engineer who requested it.

First, create the disco cache file. 

Run the GetDiscoCache perl script in the dir where the cache resides... From $NCHOME/var/precision, run it for the TESTDOMAIN: 
ncp_perl $NCHOME/precision/scripts/perl/scripts/GetDiscoCache.pl -domain TESTDOMAIN


[ root@testbox : /opt/IBM/tivoli/netcool/precision/PD/core ]
# cd /opt/IBM/tivoli/netcool/var/precision/

[ root@testbox : /opt/IBM/tivoli/netcool/var/precision ]
# ncp_perl $NCHOME/precision/scripts/perl/scripts/GetDiscoCache.pl -domain TESTDOMAIN
Use of uninitialized value in pattern match (m//) at /opt/IBM/tivoli/netcool/precision/scripts/perl/scripts/GetDiscoCache.pl line 425.

[ root@testbox : /opt/IBM/tivoli/netcool/var/precision ]
#ll -rt *.tar
-rw-r--r-- 1 root root 3635200 Aug 9 13:10 Disco.17-10_9_8_2011.TESTDOMAIN.tar

Then, run the ffdc script to collect everything in a tar file:

[ root@testbox : /opt/IBM/tivoli/netcool/precision/PD ]
# cd $NCHOME/PD/precision

[ root@testbox : /opt/IBM/tivoli/netcool/PD/precision ]
#ncp_ffdc.sh
ffdc-2011-08-09-131250_0

Once you've executed this command, it may take some time to complete, but the result is the directory where you can find the tar file, under ./ffdc/sessions: 

[ root@testbox : /opt/IBM/tivoli/netcool/PD/precision ]
# cd ffdc/sessions/ffdc-2011-08-09-131250_0

[ root@testbox : /opt/IBM/tivoli/netcool/PD/precision/ffdc/sessions/ffdc-2011-08-09-131250_0 ]
# ls
ffdc-2011-08-09-131250_0.tar