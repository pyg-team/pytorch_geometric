Title: IBM Renew the Tivoli Common Agent certs on the TPM endpoint - United States

Text:
TCA; certificate; cert; renew; IC79149; IV09260 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 How to renew the Tivoli Common Agent certs on the TPM endpoint 

CAUSE
The TCA certs are configured to expire yearly, and at expiration time they should renew automatically. However a restart of the TCA may be required to complete the cert renewal. Is there a way to force renewal of the Certs before the certs expire, so that the manual restart of the TCA can be avoided?
HistoricalNumber: 


DIAGNOSING THE PROBLEM
Following error is seeing in the SytemOut.log

11/8/12 11:57:29:107 EST] 00001a54 SSLHandshakeE E SSLC0008E: Unable
o initialize SSL connection. Unauthorized access was denied or 
ecurity settings have expired. Exception is javax.net.ssl. 
SLException: javax.net.ssl.SSLException: Received close_notify during 
andshake. 
11/8/12 12:01:14:758 EST] 000017bf WSX509TrustMa E CWPKI0022E: SSL 
ANDSHAKE FAILURE: A signer with SubjectDN "CN=file: 
//opt/tivoli/ep/runtime/agent, CN=BTC, 
N=84DB3784B2E511E0A3D9005056B80130, CN=Agent, DC=statestr.com" was 
ent from target host:port "*:9046". The signer may need to be added 
o local trust store "/opt/IBM/AgentManager/certs/agentManagerTrust. 
ks" located in SSL configuration alias "AMClientSSL" loaded from SSL 
onfiguration file "security.xml". The extended error message from the
SL handshake exception is: "Certificate expired". 
11/8/12 12:01:14:765 EST] 000017bf SystemOut O 
11/8/12 12:01:14:765 EST] 000017bf SystemOut O CWPKI0022E: SSL 
ANDSHAKE FAILURE: A signer with SubjectDN "CN=file: 
//opt/tivoli/ep/runtime/agent, CN=BTC, 
N=84DB3784B2E511E0A3D9005056B80130, CN=Agent, DC=statestr.com" was 
ent from target host:port "*:9046". The signer may need to be added 
o local trust store "/opt/IBM/AgentManager/certs/agentManagerTrust. 
ks" located in SSL configuration alias "AMClientSSL" loaded from SSL 
onfiguration file "security.xml". The extended error message from the
SL handshake exception is: "Certificate expired". 

RESOLVING THE PROBLEM
 Starting with TPM 7.2.0.2 there is a Software Package called
Register_TCA_Package that can be installed on the target to cause the
following operations:
The SPB launches a script on the target TCA that does the following:
- copy the certificates
from "<agentDir>\runtime\agent\cert"
to "<agentDir>\runtime\agent\cert.bak"

- stop the TCA

- delete the content of "<agentDir>\runtime\agent\cert"

- set agent.ssl.truststore.download=true in the endpoint.properties file.

- start the TCA

- wait until new certs are downloaded in the cert dir

- if after 10 minutes the certs are not downloaded then it will restore the
original certificates
- stop the TCA
- copy the certificates
from "<agentDir>\runtime\agent\cert.bak"
to "<agentDir>\runtime\agent\cert"

- start the TCA





If you TPM server is at a version less than 7.2.0.2
then the TCA_registration.spb will need to be imported.
To import the SPB , please copy the SPB under

$TIO_HOME/repository/TCA_reg/spb

(you might need to create the TCA_reg and spb directories)

Then use the attached tca_registration.xml file
and this syntax to import:
$TIO_HOME/tools/xmlimport.sh file:<full_file_path_to tca_registration.xml>

Importing the SPB in this way will ensure the compatibility with the TPM 7202
installation where the SPB is officially installed.

You will need to know the set of TCAs that have certs that are about to expire.
Then on those TCAs you can install the TCA_registration software package for
force cert renewal.

An SQL query can be used to find those endpoints with certs about to expire:

select CERT_SERIAL_NUM, CERT_EXPIRATION_DT, CDB.X509_Cert.ME_GUID,
substr(CDB.Agent.agnt_create_nm,1,20) from CDB.X509_Cert, CDB.AGENT WHERE
CDB.X509_Cert.ME_GUID=CDB.AGENT.ME_GUID AND (CERT_EXPIRATION_DT < '12/15/2011')
AND (CERT_EXPIRATION_DT > '10/20/2011') order by
CDB.X509_Cert.CERT_EXPIRATION_DT

where:
CERT_EXPIRATION_DT < (12/15/2011) - shows those certs that will expire by
this date specified. Suggest using the current date plus one month.
CERT_EXPIRATION_DT > (yesterdays date) - filters out those already expired




Note:The defect that requires a TCA restart to renew the certs will be fixed in
the TPM 7.2.1-IF01 release under APARs IC79149 and APAR IV09260. Thereafter the
installation of the Register_TCA_Package software package to renew the certs
will not be necessary.

Note: This procedure is only valid for TCA endpoints of version 1.4.2.0 and
greater.

Note: This registration with the Agent Manager and the downloading of the new
certificate files takes some time (maybe 10 minutes) depending on how busy the
AgentManager is, so allow ample time before testing the new certs.
For visual verification, after the refresh the new certs can be seen in the
folder
<agentDir>\runtime\agent\cert
and re-run of the SQL above can show the new certificate expiration value.



 

PRODUCT ALIAS/SYNONYM
 Tivoli Common Agent