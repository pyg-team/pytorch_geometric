Title: IBM How to start LSF docker image with the controlled user account and permissions? - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 How to start LSF docker image with the controlled user account and permissions?
For example, allow ONLY user A, B, C to run docker image #1, allow ONLY user D to run docker image #2. 

ANSWER
The solution is using an esub script to set the LSF_CONTAINER_IMAGE environment variable, then call the esub by bsub command. ($LSB_CONTAINER_IMAGE environment variable can be used as the image name). 

1. Write an executable file called esub.docker under $LSF_SERVERDIR.

user1@host: ls -l $LSF_SERVERDIR/esub.docker
-rwxrwxrwx1 root root 465 Jan 16 03:19 esub.docker*

user1@host: more $LSF_SERVERDIR/esub.docker
#!/bin/sh
. $LSB_SUB_PARM_FILE
# Redirect stderr to stdout so echo can be used for error messages
exec 1>&2
USER=`whoami`
if [ "$USER" = "userA" -o "$USER" = "userB" -o "$USER" = "userC" ]; then
echo "LSB_CONTAINER_IMAGE=image#1" >> $LSB_SUB_MODIFY_ENVFILE
elif [ $USER = "userD" ]; then
echo "LSB_CONTAINER_IMAGE=image#2" >> $LSB_SUB_MODIFY_ENVFILE
else
echo "Job is rejected. Current user not allow to run any docker images"
exit $LSB_SUB_ABORT_VALUE
fi


2. Define the docker application in lsb.application. 

Begin Application
NAME = dockerapp
CONTAINER = docker[image($LSB_CONTAINER_IMAGE) options (--rm) starter(root)]
DESCRIPTION = Docker User Service
End Application


3. Reconfigure LIM and restart MBD to apply the changes with commands shown below.
# lsadmin reconfig
# badmin mbdrestart 


4. Submit docker job and check the result. 
For userA, will run image#1.
userA@host: bsub -a docker -app dockerapp sleep 1h
Job <1> is submitted to default queue <normal>.

For userB, will run image#1.
userB@host: bsub -a docker -app dockerapp sleep 1h
Job <2> is submitted to default queue <normal>.

For user userD, will run image#2.
userD@host: bsub -a docker -app dockerapp sleep 1h
Job <3> is submitted to default queue <normal>.

For user userE, not allow to run any images:
userE@host: bsub -a docker -app dockerapp sleep 1h
Job is rejected. Current user not allow to run any docker images
Request aborted by esub. Job not submitted.

5. Check result. 

[user@host ~]$docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
5f2de03355d9 image#1 "/home/userA/.lsbatch" About a minute ago Up About a minute job.1
2605f8b0a921 image#1 "/home/userB/.lsbatch/" 8 minutes ago Up 8 minutes job.2
c4887640e637 image#2 "/home/userD/.lsbatch/"" 50 seconds ago Up 50 seconds job.3