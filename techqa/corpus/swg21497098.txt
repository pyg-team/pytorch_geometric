Title: IBM java.lang.AbstractMethodError, J2CA0045E, and ConnectionWaitTimeoutException may occur with an Oracle data source after installing Fix Pack 15 (V7.0.0.15) or Fix Pack 17 (V7.0.0.17) - United States

Text:
 FLASH (ALERT)

ABSTRACT
 After WebSphere Application Server V7.0 Fix Pack 15 (V7.0.0.15) or Fix Pack 17 (V7.0.0.17) is installed, problems may occur in environments that have data sources that connect to an Oracle database. The problems can only occur if the ojdbc5.jar from the Oracle 11g driver (rather than the ojdbc6.jar) is used, or if an Oracle 10g or earlier driver is used. This is due to a change that was made for APAR PM20797 that uses a JDBC 4.0 method call. Support for JDBC 4.0 APIs is included with the ojdbc6.jar, but not ojdbc5.jar or any older versions of the Oracle JDBC driver. 

CONTENT
Versions affected:
Versions 7.0.0.15 and 7.0.0.17 only.

Problem Description:
WebSphere Application Server V7.0.0.15 and V7.0.0.17 include the fix for APAR PM20797, which includes a java/sql/Wrapper.isWrapperFor method call. This class and method were added in JDBC 4.0, which is included with Java 6. WebSphere Application Server V7.0 runs within a Java 6 runtime environment.

The Oracle 11g JDBC driver includes ojdbc5.jar and ojdbc6.jar files. The ojdbc5.jar contains JDBC driver classes for use with Java 5 runtime environments. The ojdbc6.jar contains JDBC driver classes for use with Java 6 runtime environments. Older versions of the Oracle JDBC driver provide JAR files that contain classes for use with older Java runtime environments. Oracle documents what Java runtime environment each JDBC driver JAR file is used for on its Oracle JDBC product site [http://www.oracle.com/technetwork/database/features/jdbc/index-091264.html].

Only the Oracle 11g ojdbc6.jar contains the classes that are required to support JDBC 4.0 APIs. Because the fix for APAR PM20797 includes a JDBC 4.0 method call, problems will occur if another Oracle JDBC driver JAR file is configured with a WebSphere Application Server data source to connect to an Oracle database.

A java.lang.AbstractMethodError will occur with one of the following Java stack traces:

java.lang.AbstractMethodError: java/sql/Wrapper.isWrapperFor(Ljava/lang/Class;)Z
at 
com.ibm.websphere.rsadapter.OracleDataStoreHelper.doConnectionCleanup(OracleDataStoreHelper.java:358)
at 
com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.cleanupStates(WSRdbManagedConnectionImpl.java:4218)
at 
com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.cleanup(WSRdbManagedConnectionImpl.java:4038)
at com.ibm.ejs.j2c.MCWrapper.cleanup(MCWrapper.java:1531)
at com.ibm.ejs.j2c.FreePool.returnToFreePool(FreePool.java:508)
at com.ibm.ejs.j2c.PoolManager.release(PoolManager.java:1846)
...

java.lang.AbstractMethodError: java/sql/Wrapper.isWrapperFor(Ljava/lang/Class;)Z
at com.ibm.websphere.rsadapter.OracleDataStoreHelper.doConnectionCleanup(OracleDataStoreHelper.java:358)
at com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.preTestConnection(WSRdbManagedConnectionImpl.java:5825)
at com.ibm.ws.rsadapter.spi.WSRdbManagedConnectionImpl.preTestConnection(WSRdbManagedConnectionImpl.java:5719)
at com.ibm.ejs.j2c.PoolManager.reserve(PoolManager.java:2593)
...

Because the java.lang.AbstractMethodError happens during the connection cleanup, the cleanup of connections may not complete and connections will not return to the free pool. This causes the size of the connection pool to grow until the maximum connection pool size is reached and no free connections are available. Subsequent requests for connections will then fail with J2CA0045E errors and ConnectionWaitTimeoutExceptions:

J2CA0045E: Connection not available while invoking method createOrWaitForConnection for resource jdbc/testds

com.ibm.websphere.ce.j2c.ConnectionWaitTimeoutException: Connection not available, Timed out waiting for 180000
at com.ibm.ejs.j2c.FreePool.createOrWaitForConnection(FreePool.java:1664)
at com.ibm.ejs.j2c.PoolManager.reserve(PoolManager.java:2471)
...

The application server may also appear to be hung and a Javacore may show a large number of threads waiting for a free connection from the connection pool.

When the problem occurs, the application server must be restarted to free the connections that were not returned to the free pool due to the cleanup failure.

An additional symptom of the problem is that if connection pool tracing (WAS.j2c=all:RRA=all) is enabled, the trace will show incorrect connection pool statistics. That is, the connection pool is shown to have no shared, unshared, or free connections, while the total number of connections indicates that there are connections in the pool. The detailed information about each connection in the pool is also missing. Because of this, it can be very difficult to determine the cause of the J2CA0045E error and ConnectionWaitTimeoutException unless you have prior knowledge about this problem.

Solutions:
Recommended Solution:
IBM recommends using the ojdbc6.jar from the Oracle 11g JDBC driver with WebSphere Application Server V7.0. Using ojdbc6.jar will enable your applications to use JDBC 4.0 APIs and will prevent any WebSphere Application Server code changes that use JDBC 4.0 APIs from causing problems in your environment.

In order to change the JDBC driver that is used, update the JDBC Provider classpath to point to the ojdbc6.jar instead of any other Oracle JDBC driver JAR files. Ensure that there are no other JDBC Providers configured in your environment that use other Oracle JDBC driver JAR files and that no other Oracle JDBC drivers are packaged in your application EAR files or configured in WebSphere Application Server shared libraries.

Alternative Solution:
Applying Interim Fix APAR PM34365, which replaces the original APAR PM20797 (as specified below), or a Fix Pack containing the APAR (as specified below), resolves this issue.

For IBM WebSphere Application Server for Distributed:

For V7.0.0.15 and V7.0.0.17: 

 * Apply Interim Fix APAR PM34365 [http://www.ibm.com/support/docview.wss?uid=swg24029891]
   --OR-- 
 * Apply Fix Pack 19 or later (V7.0.0.19 targeted to be available in September 2011)
   


For IBM WebSphere Application Server for z/OS: 

For V7.0.0.15 and V7.0.0.17:  * Contact IBM support and request a ++APAR for this problem (PM34365) on z/OS
   --OR-- 
 * Apply Fix Pack 19 or later (V7.0.0.19 targeted to be available in September 2011)
   


For IBM WebSphere Application Server for IBM i: 

For V7.0.0.15 and V7.0.0.17:  * Apply Interim Fix APAR PM34365 [http://www.ibm.com/support/docview.wss?uid=swg24029891]
   --OR-- 
 * Apply the WebSphere Application Server PTF group [http://www-03.ibm.com/systems/i/software/websphere/services/service.html] which includes Fix Pack 19, or later, when available (V7.0.0.19 targeted to be available in September 2011)


Additional documentation: [http://w3.ibm.com/support] [http://w3.ibm.com/support/techdocs] [https://longspeak.boulder.ibm.com/WebRetain/logon.jsp] 
For additional details and information on WebSphere Application Server product updates:  * For Distributed, see Recommended fixes for WebSphere Application Server. [http://www.ibm.com/support/docview.wss?rs=180&uid=swg27004980] 
 * For i5/OS, see WebSphere Application Server for i5/OS [http://www-03.ibm.com/servers/eserver/iseries/software/websphere/wsappserver/services/service.html]. 
 * For z/OS, see WebSphere Application Server for z/OS [http://www-1.ibm.com/support/docview.wss?uid=swg27006970]

 

Cross reference information Segment Product Component Platform Version Edition Application Servers WebSphere Application Server for z/OS DB Connections/Connection Pooling z/OS 7.0.0.15