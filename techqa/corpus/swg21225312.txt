Title: IBM MustGather:  Abnormal Termination / CORE Dumps of IBM Mobile Connect Connection Manager - United States

Text:
mustgather; MustGather'Mustgather; dbx; gdb; core; debug; abend; terminate; MustGatherDocument; dump; Windows Error Reporting; WER; watson; windows; error; reporting; dmp; kill TECHNOTE (TROUBLESHOOTING)

THIS DOCUMENT APPLIES ONLY TO THE FOLLOWING LANGUAGE VERSION(S):
 English 

PROBLEM
There may exist certain unforeseen execution scenarios which result in the IBM Mobile Connect Connection Manager abnormally exiting and dumping its core. This can also be referred to as a core or an abend or a dump. The Connection Manager is designed to restart itself after such an occurrence, but most likely the cause of the abnormal termination needs to be tracked down. There may also be certain situations where gathering a dump of the product is requested by product support. This document will guide the administrator in the documentation which IBM support will require to assist with the problem diagnosis.

RESOLVING THE PROBLEM
 

CONNECTION MANAGER ABNORMAL TERMINATION
 * Windows
 * Linux
 * AIX


WINDOWS 

Note - Beginning with IBM Mobile Connect 6.1.5.1 dump handling has changed. It is more convenient, and does NOT require the procedure outlined below. The IMCSUPPORT [http://www-01.ibm.com/support/knowledgecenter/SSVLBW_6.1.5/com.ibm.lmc_6.1.5.doc/ISAinstall.htm] command documentation has additional details. 

WINDOWS SERVER 2008 PROCEDURE [For 6.1.5.0 and earlier ONLY] 

1. In Windows Server 2008 there is no Dr. Watson, but rather Windows Error Reporting. Windows Error Reporting (WER) can be configured so that full user-mode dumps are collected and stored locally after a user-mode application crashes. Since the procedure to collect full user-mode dumps involves altering your registry we will refer to the Microsoft Technical document which describes how to do this. You can find the document here - http://msdn.microsoft.com/en-us/library/bb787181%28VS.85%29.aspx [http://msdn.microsoft.com/en-us/library/bb787181%28VS.85%29.aspx] 

2. Download the MS debugging tools from 

http://msdl.microsoft.com/download/symbols/debuggers/dbg_x86_6.11.1.404.msi [http://msdl.microsoft.com/download/symbols/debuggers/dbg_x86_6.11.1.404.msi] and install. 

Once you install the Debugging tools create a new directory C:\dumps 

Then open a command prompt and run the following command to start adplus: 

"C:\Program Files (x86)\Debugging Tools for Windows (x86)\adplus" -crash -quiet -pn wgattachd.exe -o c:\dumps 

This tells the adplus debugger to watch the wgattachd process for crashes and when one occurs it will dump debug data to c:\dumps with the PID of the crash 

3. Please examine the DumpFolder specified in the HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps key to find where your Windows dumps are stored. 
If the Windows registry does not contain this key, then it would need to be created. Microsoft documents this here - http://msdn.microsoft.com/en-us/library/windows/desktop/bb787181%28v=vs.85%29.aspx [http://msdn.microsoft.com/en-us/library/windows/desktop/bb787181%28v=vs.85%29.aspx] 

4. Once an abnormal termination has occurred open a Problem Record [https://www-947.ibm.com/support/servicerequest/Home.action] to IBM and submit the dump file along with the build date of the Connection Manager which is installed ( lswg -V |more). 

To force a dump of a running or hung Connection Manager open the Task Manager, locate the running wgated process, right mouse click this process and select the Create Dump option. A popup message will be displayed indicating the path where the file is written. The Level 2 support center may request this type of dump depending on the circumstances of the problem being reported. 
5. Please see the following Technote [http://www-01.ibm.com/support/docview.wss?rs=3183&context=SSVLBW&context=SSZQDW&q1=submit+diagnostic+data+IBM&uid=swg21208712&loc=en_US&cs=utf-8&lang=en] to submit diagnostic information to the IBM Support Center. 

 

 

LINUX 


Core dumps are turned off by default by some Linux distributions. To collect a Connection Manager core dump do the following while logged in as root.

For a scenario where there is elevated CPU perhaps, or too much memory consumed, or any other scenario where IBM Support is requesting to collect a core dump intentionally

1. Issue the wgstop command (or alternatively killall wgattachd)

***Note - For step (1) if you do a kill -9 <pid of wgattachd> <pid of wgated> it will stop IMC without logging VPN Client users off which is often preferred.

2. Issue ulimit -c unlimited in a command shell.
3. Issue wgstart from same shell as ulimit command.
4. When the Connection Manager becomes hung or inoperative or perhaps is using too much CPU or memory then issue kill -11 <wgated pid> where pid is wgated process id determined with
ps -ef |grep wgated.
5. If IBM Support is requesting a STACK Trace also, please see the Note below for instructions BEFORE proceeding to Step 6.
6. Issue the imcsupport.sh pmr <pmr number> /all command to gather up the IMC configuration, logs, and core dump file(s). 
Note - If your Connection Manager allows FTP protocol then the data collection will be automatically 
uploaded to the IBM FTP server.
The imcsupport.sh script is only executable from a Bash shell in Linux.
If your Connection Manager does NOT allow FTP, then the data collection will be available from 
the /var/adm directory and will need to be manually uploaded to the IBM Support Center [http://www-01.ibm.com/support/docview.wss?rs=3183&context=SSVLBW&context=SSZQDW&q1=submit+diagnostic+data+IBM&uid=swg21208712&loc=en_US&cs=utf-8&lang=en]. 


For a scenario where the Connection Manager is abnormally terminating unpredictably

1. Issue ulimit -c unlimited in a command shell. (If your Linux distribution does NOT have core dumps enabled)
2. Issue wgstart from same shell as ulimit command.
3. When the Connection Manager has abnormally terminated / restarted itself there will be a core dump file from the event in which IBM Support will want a stack trace from this file. See the Note below for instructions.
4. Issue the imcsupport.sh pmr <pmr number> /all command to gather up the IMC configuration, logs, and core dump file(s). 
Note - If your Connection Manager allows FTP protocol then the data collection will be automatically 
uploaded to the IBM FTP server.
The imcsupport.sh script is only executable from a Bash shell in Linux.
If your Connection Manager does NOT allow FTP, then the data collection will be available from 
the /var/adm directory and will need to be manually uploaded to the IBM Support Center [http://www-01.ibm.com/support/docview.wss?rs=3183&context=SSVLBW&context=SSZQDW&q1=submit+diagnostic+data+IBM&uid=swg21208712&loc=en_US&cs=utf-8&lang=en].

***STACK TRACE Note - IBM Support may often ask for a Stack Trace to analyze the running threads inside the wgated process at the time of an abnormal termination or the forced core dump file. With the GDB debugger installed on Linux, get into the GDB command shell and process the core dump file. By issuing the command 'thread apply all where' the threads will be output to the console. Use file operators like the '>' to direct the output to a file. 
Specific steps would be:

gdb /opt/ibm/ConnectionManager/bin/wgated /path/to/corefile > /path/to/output.txt
Then wait about 5 seconds, then type "thread apply all where" (you won't see anything)
Then wait about 5-10 more seconds then type "quit" 

 

AIX 


1. If IBM Mobile Connect appears hung or unresponsive then: 

 *  Issue ps -ef | grep wgated to obtain the present Process ID (PID) for wgated (the primary executing process for IMC. IBM Support has a custom script which can be run against the running wgated process. To obtain this script go to Fix Central [http://www-01.ibm.com/support/docview.wss?uid=swg27009682] to download it along with the brief execution instructions. Run the dumpthreads script against the running wgated process which will gather a stack trace which can be then uploaded to an open Problem Record. This process is NOT a part of the imcsupport.sh script. 

If IBM Mobile Connect has automatically restarted:  *  A core dump file often just called core will have been generated often in the root '/' filesystem. IBM Support has a custom script to gather a stack trace which can be run against the core file. To obtain this script go to Fix Central [http://www-01.ibm.com/support/docview.wss?uid=swg27009682]to download it along with the brief execution instructions. Run the dumpthreads script against the running wgated process, gathering the stack trace which can be then uploaded to an open Problem Record. This process is NOT a part of the imcsupport.sh script. 

2. Issue the imcsupport.sh pmr <pmr number> /all command to gather up the IMC configuration, logs, and core dump file(s). 
Notes  *  The collection and archive time could be significant depending on the size of the core dump files. Please be patient. If your Connection Manager allows FTP protocol then the data collection will be automatically uploaded to the IBM FTP server. If your Connection Manager does NOT allow FTP, then the data collection will be available from the /var/adm directory and will need to be manually uploaded to the IBM Support Center [http://www-01.ibm.com/support/docview.wss?rs=3183&context=SSVLBW&context=SSZQDW&q1=submit+diagnostic+data+IBM&uid=swg21208712&loc=en_US&cs=utf-8&lang=en].