Title: IBM Secure LDAP connection to Active Directory Stops Functioning After Upgrading To Domino 9.0.1 FP5 IF1 - United States

Text:
"secure LDAP"; "directory assistance"; "Windows"; "Microsoft"; "2008 R2"; "SSL"; "TLS"; "connection"; "fails" TECHNOTE (TROUBLESHOOTING)

PROBLEM
An Administrator upgrades Domino to 9.0.1 FP5 IF1 and a secure directory assistance LDAP connection to a Windows 2008 R2 server which only supports TLSv1.0 fails. 
Changing the connection to not use SSL results in the connection being re-established or downgrading to Domino 9.0.1 FP5 results in a secure connection being re-established.

SYMPTOM
Enable DEBUG_SSL_ALL=2 on your Domino Server and the following should be seen. Please note as the debug is quite verbose the following is an abridged version of the output for the connection attempt.

SSL_Handshake> outgoing ->protocolVersion: 0303
SSLAdvanceHandshake Enter> Processed: SSL_hello_request (0) State: HandshakeClientIdle (4)
SSLAdvanceHandshake calling SSLPrepareAndQueueMessage> SSLEncodeClientHello
SSLEncodeClientHello> Sending empty extended_master_secret (0x0017) extension
SSLEncodeClientHello> Sending supported signature algorithms (0x000d) extension
SSLEncodeClientHello> Sending supported point formats (0x000b) extension
SSLEncodeClientHello> Sending Supported Groups (0x000a) extension
SSLEncodeClientHello> We offered SSL/TLS version TLS1.2 (0x0303)
....
....
SSLProcessServerHello> Server chose SSL/TLS version TLS1.0 (0x0301)
SSLProcessServerHello> Server chose cipher spec ECDHE_RSA_WITH_AES_256_CBC_SHA (0xC014)
SSLProcessServerHello> Extensions found in this message
SSLProcessServerHello> Received extended_master_secret extension
SSLProcessServerHello> Received "empty" TLS Renegotiation Indication extension
....
....
SSLAdvanceHandshake Enter> Processed: ServerHelloDone (14) State: HandshakeHelloDone (9)
SSLAdvanceHandshake> A certificate has been requested
SSLAdvanceHandshake> An X509 certificate has been requested
SSLAdvanceHandshake> We have 1 certificate(s)
SSLAdvanceHandshake> No Cert Matches the Server's DN List
SSLAdvanceHandshake calling SSLPrepareAndQueueMessage> SSLEncodeCertificate with no certificates
SSLEncodeCertificate> Generating a certificate message with 1 certs
SSLAdvanceHandshake calling SSLPrepareAndQueueMessage> SSLEncodeKeyExchange
SSLAdvanceHandshake calling SSLPrepareAndQueueMessage> SSLEncodeCertificateVerify
SSLAdvanceHandshake calling SSLPrepareAndQueueMessage> SSLEncodeChangeCipherSpec
SSLAdvanceHandshake calling SSLPrepareAndQueueMessage> SSLEncodeFinishedMessage
SSLCalculateTLSFinishedMessage Enter> senderID: client finished
....
.....
SSLSendAlert> Sending an alert of 0x0 (close_notify) level 0x2 (fatal)
SSL_Handshake> Changing SSL status from -6989 to -5000 to flush write queue
SSL_Handshake> After handshake2 state SSLErrorClose (2)
int_MapSSLError> Mapping SSL error -5000 to 4176 [SSLHandshakeNoDone]




CAUSE
Support for the Extended Master Secret for TLSv1.2 was enabled in Domino 9.0.1 FP5 Interim Fix 1 through SPR DKENA32JMP however this is not the cause of the issue.

Domino development have determined the cause of this issue is that the Microsoft server which only has TLSv1.0 support enabled sends a server hello with a Extended Master Secret extension which is not supported for TLSv1.0, which can be seen when DEBUG_SSL_ALL=2 is enabled and the Windows 2008 R2 server send its Server Hello
SSLProcessServerHello> Server chose SSL/TLS version TLS1.0 (0x0301)
SSLProcessServerHello> Server chose cipher spec ECDHE_RSA_WITH_AES_256_CBC_SHA (0xC014)
SSLProcessServerHello> Extensions found in this message
SSLProcessServerHello> Received extended_master_secret extension
SSLProcessServerHello> Received "empty" TLS Renegotiation Indication extension


ENVIRONMENT
Domino 9.0.1 FP5 Interim Fix 1 or higher with secure directory assistance enabled to a remote Windows 2008 R2 server which only support for TLSv1.0

RESOLVING THE PROBLEM
Apart from contacting Microsoft support, an administrator can take the following steps to resolve this issue.

Enable TLSv1.2 support on the Windows 2008 R2 server that you are attempting to connect to, as the connection will not then be downgrade to TLSv1.0

If this is not possible, you can set the following parameter in your Domino server's notes.ini and then restart your server.

SSL_DISABLE_EXTENDED_MASTER_SECRET=1

With this parameter enabled Domino will not send the Extended Master Secret extension in its Client Hello.

In one case where mixed directory assistance connections between remote Microsoft LDAP servers that do and do not support TLSv1.2 exist. Setting this parameter shows no affect when connecting to those servers that support TLSv1.2 and allows the connection to be established to those server which only support TLSv1.0