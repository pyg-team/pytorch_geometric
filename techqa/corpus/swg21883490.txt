Title: IBM Case Foundation Case Analyzer 5.2 upgrade fails with error "com.microsoft.sqlserver.jdbc.SQLServerException: The query has timed out". - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Case Analyzer upgrade fails with error "com.microsoft.sqlserver.jdbc.SQLServerException: The query has timed out" when running the "upgrade_int_bigint.sql" script. 

SYMPTOM
==>CAupgrd.txt output:

2015/04/06 12:43:13.250-0500 RPCHandler Thread-919 [Info] [CA_Store]

ExecuteScriptsFromFolder::executeScript-Executing script

filenet/eventexporter/ca/resources/scripts/sqlserver/v3600to3700/upgrade

_int_bigint.sql.

2015/04/06 12:43:13.891-0500 RPCHandler Thread-919 [Error] [CA_Store]

filenet.eventexporter.ca.admin.upgrade.Upgrade::upgrade-Case Analyzer

upgrade failed.; Exception:

com.microsoft.sqlserver.jdbc.SQLServerException: The query has timed

out.
<==

==>vwtool trace output:

2015/04/06 12:43:13.198-0500 RPCHandler Thread-19106 [Trace] CA_DATA, [CA_Store] ExecuteScriptsFromFolder::substituteSchemaName replacedSQL: ALTER TABLE dbo.F_DMWIP ALTER COLUMN DMWorkItem_key BIGINT NOT NULL
2015/04/06 12:43:13.198-0500 RPCHandler Thread-19106 [Trace] CA_DATA, [CA_Store] ExecuteScriptsFromFolder::executeScript Executing: 
ALTER TABLE dbo.F_DMWIP ALTER COLUMN DMWorkItem_key BIGINT NOT NULL
2015/04/06 12:43:16.729-0500 RPCHandler Thread-19106 [Error] [CA_Store] filenet.eventexporter.ca.admin.upgrade.Upgrade::upgrade-Case Analyzer upgrade failed.; Exception: com.microsoft.sqlserver.jdbc.SQLServerException: The query has timed out. 
at com.microsoft.sqlserver.jdbc.TDSCommand.checkForInterrupt(IOBuffer.java:5918) 
at com.microsoft.sqlserver.jdbc.TDSParser.parse(tdsparser.java:70) 
at com.microsoft.sqlserver.jdbc.SQLServerStatement.getNextResult(SQLServerStatement.java:1510) 
at com.microsoft.sqlserver.jdbc.SQLServerStatement.doExecuteStatement(SQLServerStatement.java:792) 
at com.microsoft.sqlserver.jdbc.SQLServerStatement$StmtExecCmd.doExecute(SQLServerStatement.java:689) 
at com.microsoft.sqlserver.jdbc.TDSCommand.execute(IOBuffer.java:5696) 
at com.microsoft.sqlserver.jdbc.SQLServerConnection.executeCommand(SQLServerConnection.java:1715) 
at com.microsoft.sqlserver.jdbc.SQLServerStatement.executeCommand(SQLServerStatement.java:180) 
at com.microsoft.sqlserver.jdbc.SQLServerStatement.executeStatement(SQLServerStatement.java:155) 
at com.microsoft.sqlserver.jdbc.SQLServerStatement.execute(SQLServerStatement.java:662) 
at com.ibm.ws.rsadapter.jdbc.WSJdbcStatement.pmiExecute(WSJdbcStatement.java:1559) 
at com.ibm.ws.rsadapter.jdbc.WSJdbcStatement.execute(WSJdbcStatement.java:706) 
at filenet.eventexporter.ca.sql.ExecuteScriptsFromFolder.executeScript(ExecuteScriptsFromFolder.java:225) 
at filenet.eventexporter.ca.sql.ExecuteScriptsFromFolder.executeScripts(ExecuteScriptsFromFolder.java:240) 
at filenet.eventexporter.ca.admin.upgrade.UpgradeSchema.upgrade(UpgradeSchema.java:75) 
at filenet.eventexporter.ca.admin.upgrade.Upgrade.doUpgrade(Upgrade.java:214) 
at filenet.eventexporter.ca.admin.upgrade.Upgrade.run(Upgrade.java:137) 
at java.lang.Thread.run(Thread.java:738)


CAUSE
The following JDBC datasource custom property was set to 2 seconds "webSphereDefaultQueryTimeout = 2" and the query took 14 seconds to run. 

DIAGNOSING THE PROBLEM
Use the following steps to diagnose the issue. 

 1. Enabled CA trace flags(TRACE_CA_DATABASE,TRACE_CA_RPC,TRACE_CA_UPGRADE,TRACE_CA_OLAP etc...) to capture the failing query in the vwtool. 
 2. Run the failing query directly in Microsoft SQL Server Management Studio on the server to see how many seconds it takes to run. It will not time out since it is running on the server. 
 3. Once you see how log it takes to run the query use the steps in "Resolving the problem" to see the “webSphereDefaultQueryTimeout” value.

RESOLVING THE PROBLEM
Once you determine how log it takes to return the results from the failing query, you can set the following parameter using the following steps: 

 1. Login to WebSphere Integrated Solutions Console (ISC) 
 2. Resources==>JDBC==>datasource==><CADBdatasourcename>==>Custom Properties 
 3. Locate “webSphereDefaultQueryTimeout” and set the value in seconds accordingly. 
 4. Restart WebSphere Application server.