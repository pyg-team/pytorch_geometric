Title: IBM [Db2] Java 8 に移行すると、JDBC アプリケーションがエラー -4220 で失敗することがある - United States

Text:
 TECHNOTE(トラブルシューティング)

問題(概要)
 Java アプリケーション・サーバーのアップグレードなどで、Java 8 にアップグレードした場合、これまで正常に動作していた JDBC アプリケーションが -4220 エラーをスローするようになることがあります。 

症状
Unicode でないデータベースに接続した場合や、文字操作を行った場合に以下のような例外がスローされることがあります。 

com.ibm.db2.jcc.am.SqlDataException:
[jcc][t4][10275][10041][3.68.61] サポートされない ccsid、エンコード、またはロケール: "Cp943C"。 
ERRORCODE=-4220, SQLSTATE=22021 
(コンバーター名は接続先 DB に依存して可変です。)

[jcc][t4][1065][12306][3.64.82] java.io.CharConversionException をキャッチしました。 詳しくは、添付の Throwable を参照してください。
ERRORCODE=-4220, SQLSTATE=null 


原因
Java 8 で sun.io パッケージは廃止されました。 

古い Jcc ドライバーには sun.io パッケージに依存したコードが含まれるため、症状に示したような例外が発生することがあります。


環境
以下の条件を満たす場合、この問題に遭遇する可能性があります。 

 * Jcc 3.69.49 または Jcc 4.19.49 より古い Jcc ドライバーを使っている。


現在利用中の Jcc ドライバーのバージョンは、以下のコマンドで確認できます。
java -cp <path_to_db2jcc.jar> com.ibm.db2.jcc.DB2Jcc -version

注: path_to_db2jcc.jar はお使いの db2jcc.jar または db2jcc4.jar ファイルのフル・パスです。


解決方法
Db2 V10.5 FP7 以降に含まれる Jcc ドライバーは Java 8 に対応しています。 

Db2 V10.5 FP7 以降、もしくは Db2 V11.1 に含まれる Jcc ドライバーにアップグレードしてください。 


V10.5 JDBC および SQLJ のサポートの機能拡張 [https://www.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.wn.doc/doc/c0051316.html] 

 * 
 * 
 * 

IT12454: Java 8 compatibility [http://www.ibm.com/support/docview.wss?uid=swg1IT12454]  * 


V11.1 DB2 データベース製品の Java ソフトウェア・サポート [https://www.ibm.com/support/knowledgecenter/ja/SSEPGG_11.1.0/com.ibm.db2.luw.qb.server.doc/doc/r0011932.html]  

Jcc ドライバー・ファイルは以下のページから入手可能です。
DB2 JDBC Driver Versions and Downloads [http://www.ibm.com/support/docview.wss?uid=swg21363866]

V10.5 および V11.1 のドライバーは DB2 V9.7 以降のサーバーへの接続をサポートしています。
詳細は以下の文書を参照してください。
[DB2 LUW] クライアント・サーバーのサポートされる組み合わせ [http://www.ibm.com/support/docview.wss?uid=jpn1J1001026]


運用上の考慮点
Jcc ドライバーの db2.jcc.charsetDecoderEncoder 構成プロパティを利用して、sun.io でなく java.nio パッケージの使用を強制できます。しかし、Java 8 に対応していないドライバーで、この構成プロパティを設定してエラーを回避する運用はサポートされないのでご注意ください。

Java 8 をサポートするドライバーで、Unicode データベースに接続しているときに -4220 (java.nio.charset.MalformedInputException) エラーが返されることがあります。これは Java 8 で UTF-8 データの処理が厳格化された影響の可能性があるため、以下の Technote を参照してください。
UTF-8 encoding/decoding problem in JDK 8 [http://www.ibm.com/support/docview.wss?uid=swg21973226]

sun.io と java.nio は許容する文字の範囲が異なります。
たとえば、シフト JIS の置換文字である x'FCFC' はsun.io では許容され、暗黙的に Java の代替文字に置き換えられます。しかし java.nio では java.nio.charset.UnmappableCharacterException がスローされ、Jcc ドライバーは この例外を -4220 にマッピングします。
データベース上の正しくないコードを直ちに修正できない場合、Jcc の構成プロパティ db2.jcc.charsetDecoderEncoder=3 を設定することで、例外をスローせず暗黙的に代替文字に置き換えられます。

WebSphere Application Server の Software Compatibility Product Report (SCPR) が正しくない情報をレポートすることがあるのでご注意ください。例 [https://www.ibm.com/software/reports/compatibility/clarity-reports/report/html/prereqTabViewDetails?osPlatform=spcrAllValues&dsrType=tsr&deliverableId=1374008815765&productName=WebSphere+Application+Server+9.0&prereqId=1339922994427&prereqName=IBM+Data+Server+Driver+for+JDBC+and+SQLJ+3.66+10.5&capName=JDBC+Drivers&isDUOnly=true&isMandatory=false&osPlatforms=AIX%7CHP%7CIBM+i%7CLinux%7CSolaris%7CWindows&duComponentIds=S000] 

関連情報
[DB2 LUW] パスポート・アドバンテージによく寄せられる質問 [http://www.ibm.com/support/docview.wss?uid=swg21590877]
[DB2 LUW] DB2 が提供している JDBC ドライバーの種類 [http://www.ibm.com/support/docview.wss?uid=swg21601089]

お問合せ先
技術的な内容に関して、サービス契約のもと IBM サービス・ラインにお問い合わせください。
IBM サービス・ライン [http://www.ibm.com/jp/news/20070420001.html]