Title: IBM Adding a local device mount or NFS mount to Heartbeat - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 How do you add a local device mount or NFS mount to the Heartbeat cluster? 

ANSWER
Adding a local device or NFS mount to Heartbeat control means that it will be mounted on whichever host is active.
The following steps must be performed as the root user.

1. Ensure that the cluster is operating properly; if it is not, you cannot continue. Note the active hostname; it will be the one with all the services running on it. In the following output, the host is server1a: 


 * /usr/sbin/crm_mon -i5
 * 
 * 
 * Last updated: Mon Feb 9 15:25:24 2009
 * 
 * Current DC: server1a (8f113ab4-874e-4775-b140-56c2b5c81a35)
 * 
 * 2 Nodes configured.
 * 
 * 3 Resources configured.
 * 
 * ============
 * 
 * 
 * Node: server1b (61487a81-9d8b-4af9-9111-983ed8ccfd29): online
 * 
 * Node: server1a (8f113ab4-874e-4775-b140-56c2b5c81a35): online
 * 
 * 
 * Resource Group: nps
 * 
 * drbd_exphome_device (heartbeat:drbddisk): Started server1a
 * 
 * drbd_nz_device (heartbeat:drbddisk): Started server1a
 * 
 * exphome_filesystem (heartbeat::ocf:Filesystem): Started server1a
 * 
 * nz_filesystem (heartbeat::ocf:Filesystem): Started server1a
 * 
 * fabric_ip (heartbeat::ocf:IPaddr): Started server1a
 * 
 * wall_ip (heartbeat::ocf:IPaddr): Started server1a
 * 
 * nzbootpd (lsb:nzbootpd): Started server1a
 * 
 * snmptrapd (lsb:snmptrapd): Started server1a
 * 
 * storagepadinit (lsb:storagepadinit): Started server1a
 * 
 * nzinit (lsb:nzinit): Started server1a
 * 
 * fencing_route_to_ha1 (stonith:apcmaster): Started server1b
 * 
 * fencing_route_to_ha2 (stonith:apcmaster): Started server1a


2. Make backups of the configuration file and the database on the active server (server1a).  * 
 *  cp /etc/ha.d/ha.cf /tmp/ha.cf.backup 
   
 * 
 *  /usr/sbin/cibadmin –Q > /tmp/cib_backup.xml 
   

c. Move the backup files from /tmp to another system for safekeeping. 

3. Confirm that your mount directory exists. If it does not exist, create it by running one of the following commands: 
 * mkdir /mnt/mymount 
 * 
 * mkdir /mnt/my_nfs_mount


4. Using a text editor such as vi, create a template file on the system. For example: 
 * vi /tmp/add_mount.xml


-----------------------------------------------------------------------------------------  * <group id=”nps”>
 * 
 * <primitive class=”ocf” id=”%RES_NAME%” provider=”heartbeat” type=”Filesystem”>
 * 
 * <instance_attributes id=”%RES_NAME%_ext_config”>
 * 
 * <attributes>
 * 
 * <nvpair id=”%RES_NAME%_ext_attr_1” name=”device” value=”%DEVICE%” />
 * 
 * <nvpair id=”%RES_NAME%_ext_attr_2” name=”directory” value=”%DIRECTORY%” />
 * 
 * <nvpair id=”%RES_NAME%_ext_attr_3” name=”fstype” value=”%FSTYPE%” />
 * 
 * <nvpair id=”%RES_NAME%_ext_attr_4” name=”options” value=”%OPTIONS%” />
 * 
 * </attributes>
 * 
 * </instance_attributes>
 * 
 * </primitive>
 * 
 * </group>

----------------------------------------------------------------------------------------- 

You must change any attributes that are surrounded by % signs. 
For example ( local mount | NFS ): 

• %RES_NAME% = my_partition_1 | my_nfs_mount_1 
• %DEVICE% = /dev/sda1 | 192.168.20.30:/my_export 
• %DIRECTORY% = /mnt/my_mount | /mnt/my_nfs_mount 
• %FSTYPE% = ext3 | nfs 

The options field is not required. It is a comma-separated field used to add mount / nfs options. These are the same options that you might pass on the command-line via the -o <options> flag or the -t <options> flag for NFS. 

For example ( local mount | NFS ): 
• %OPTIONS% = ro,atime | nosuid,nfsvers=3,soft 

If you do not wish to specify options, make the field blank as follows: 
<nvpair id=”%RES_NAME%_ext_attr_4” name=”options” value=”” /> 

5. Save the template file. 

6. To add your resource under Heartbeat control, run the following command: 
 * /usr/sbin/cibadmin –U –o resources –x /tmp/add_mount.xml


The command options used above have the following meanings: 

-U = update 
-o = object type (resources) 
-x = xml file 

7. If the command completes successfully, Heartbeat will immediately attempt to take control of your newly-added resource. Run /usr/sbin/crm_mon –i5 to monitor this. You will see the resource listed. You should also see your mount on the active host under the directory you created. 

HISTORICAL NUMBER
 NZ569857