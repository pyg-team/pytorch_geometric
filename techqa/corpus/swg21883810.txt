Title: IBM ISBI CLA2 Server fails to use public key of renewed cla2ssl certificate - United States

Text:
ISBI CLA2 Adapter Server Client cla2ssl SSLHandshakeException certificate_unknown TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 After renewing the cla2ssl certificate for secure connection between Command Line 2 (CLA2) Adapter and CLA2 Server in IBM Sterling B2B Integrator (ISBI) this secure connection fails with:
- "Handshake error, unable to find valid certification path to requested target" in the Business Process (BP) Detail, 
- "javax.net.ssl.SSLHandshakeException: Received fatal alert: certificate_unknown" in cla2server.log, and
- "javax.net.ssl.SSLHandshakeException: com.ibm.jsse2.util.g: PKIX path building failed: java.security.cert.CertPathBuilderException: unable to find valid certification path to requested target" in cla2client.log. 

SYMPTOM
A BP step utilizing CLA2 Adapter is failing with Advanced Status "Handshake error, unable to find valid certification path to requested target".

And cla2server.log.D<date>.T<time> is reporting:
04-24-2015 13:43:58:259 (441457232) Exception occurred.
javax.net.ssl.SSLHandshakeException: Received fatal alert: certificate_unknown
at com.ibm.jsse2.n.a(n.java:44)
at com.ibm.jsse2.n.a(n.java:34)
at com.ibm.jsse2.sc.b(sc.java:199)
at com.ibm.jsse2.sc.a(sc.java:577)
at com.ibm.jsse2.sc.g(sc.java:599)
at com.ibm.jsse2.sc.a(sc.java:288)
at com.ibm.jsse2.e.read(e.java:11)
at java.io.BufferedInputStream.fill(BufferedInputStream.java:230)
at java.io.BufferedInputStream.read1(BufferedInputStream.java:270)
at java.io.BufferedInputStream.read(BufferedInputStream.java:329)
at java.io.ObjectInputStream$PeekInputStream.read(ObjectInputStream.java:2270)
at java.io.ObjectInputStream$PeekInputStream.readFully(ObjectInputStream.java:2283)
at java.io.ObjectInputStream$BlockDataInputStream.readShort(ObjectInputStream.java:2754)
at java.io.ObjectInputStream.readStreamHeader(ObjectInputStream.java:781)
at java.io.ObjectInputStream.<init>(ObjectInputStream.java:281)
at com.sterlingcommerce.woodstock.services.cmdline2.CmdLine2Thread.setup(CmdLine2Thread.java:268)
at com.sterlingcommerce.woodstock.services.cmdline2.CmdLine2Thread.run(CmdLine2Thread.java:128)

And cla2client.log.D<date>.T<time> is reporting:
[2015-04-24 10:41:57.904] ERRORDTL <HAR.392317.Thread> [1429864917904]javax.net.ssl.SSLHandshakeException: com.ibm.jsse2.util.g: PKIX path building failed: java.security.cert.CertPathBuilderException: unable to find valid certif
ication path to requested target
at com.ibm.jsse2.n.a(n.java:44)
at com.ibm.jsse2.sc.a(sc.java:440)
at com.ibm.jsse2.gb.a(gb.java:266)
at com.ibm.jsse2.gb.a(gb.java:359)
at com.ibm.jsse2.hb.a(hb.java:252)
at com.ibm.jsse2.hb.a(hb.java:144)
at com.ibm.jsse2.gb.n(gb.java:42)
at com.ibm.jsse2.gb.a(gb.java:316)
at com.ibm.jsse2.sc.a(sc.java:367)
at com.ibm.jsse2.sc.g(sc.java:599)
at com.ibm.jsse2.sc.a(sc.java:326)
at com.ibm.jsse2.j.write(j.java:15)
at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:77)
at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:135)
at java.io.ObjectOutputStream$BlockDataOutputStream.flush(ObjectOutputStream.java:1793)
at java.io.ObjectOutputStream.flush(ObjectOutputStream.java)
at com.sterlingcommerce.woodstock.services.cmdline2.CmdLine2Impl.processData(CmdLine2Impl.java:190)
at com.sterlingcommerce.woodstock.workflow.activity.engine.ActivityEngineHelper.invokeService(ActivityEngineHelper.java:1818)
at com.sterlingcommerce.woodstock.workflow.activity.engine.ActivityEngineHelper.nextMainLogic(ActivityEngineHelper.java:631)
at com.sterlingcommerce.woodstock.workflow.activity.engine.ActivityEngineHelper.next(ActivityEngineHelper.java:362)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.doWork(WorkFlowQueueListener.java:440)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.run(WorkFlowQueueListener.java:236)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.onMessage(WorkFlowQueueListener.java:197)
at com.sterlingcommerce.woodstock.workflow.queue.WorkFlowQueueListener.onMessage(WorkFlowQueueListener.java:184)
at com.sterlingcommerce.woodstock.workflow.queue.wfTransporter.run(wfTransporter.java:444)
at com.sterlingcommerce.woodstock.workflow.queue.BasicExecutor$Worker.run(BasicExecutor.java:508)
at java.lang.Thread.run(Thread.java:736)
Caused by: com.ibm.jsse2.util.g: PKIX path building failed: java.security.cert.CertPathBuilderException: unable to find valid certification path to requested target
at com.ibm.jsse2.util.e.b(e.java:19)
at com.ibm.jsse2.util.e.b(e.java:113)
at com.ibm.jsse2.util.d.a(d.java:19)
at com.ibm.jsse2.gc.a(gc.java:57)
at com.ibm.jsse2.gc.checkServerTrusted(gc.java:67)
at com.ibm.jsse2.gc.b(gc.java:69)
at com.ibm.jsse2.hb.a(hb.java:209)
... 22 more


CAUSE
 

 1. This error scenario can be caused by differences between the password for the CLA2 Server certificate keystore and the password for the public key of the SSL Public CA Certificate for the CLA2 Server (default cla2ssl) in this keystore.
    In <isbi-install>/properties/CmdLine2server.properties you can find this description for the property keystorePassword:
    ## PROPERTY_START
    ## PROPERTY_NAME: keystorePassword
    ## PROPERTY_TYPE: String
    ## PROPERTY_DESCRIPTION
    ## Keystore password and key password
    ## This property is not used if enable_authentication=false
    keystorePassword=CRYPTED:EI++...=
    ## PROPERTY_END
    This means keystore password and public key password have to be the same. 
 2. In other circumstances this error scenario can be caused by more than one private key in the CLA2 Server keystore.
    The ISBI CLA2 documentation [http://www.ibm.com/support/knowledgecenter/SS3JSW_5.2.0/com.ibm.help.svcs_adpts_a_l.doc/Command_Line_adapter_2_5241_2.html] notes for the field "Use SSL":
    Restriction: The Command Line Adapter 2 server cannot have more than one private certificate in the JKS repository.

DIAGNOSING THE PROBLEM
Check the Buiness Process Details of the failing BP that is using CLA2 Adapter for the error pattern provided above in the Sympton section.
And check CLA2 Server log files and CLA2 Client log files for the error pattern provided above in the Sympton section. 

 1. Ensure that the private key for the SSL Public CA Certificate (default: cla2ssl) has been created using the same password that has been setup for the CLA2 Server Keystore. 
 2. Verify that only one certificate with private key (Entry type: keyEntry) is listed in the cla2_KeyStore.jks

 * To list the contents of the cla2_KeyStore.jks use (on command line from <isbi-install>)
   jdk/bin/keytool -list -v -keystore client/cmdline2/cla2_KeyStore.jks -storepass CLA2ServerKeyStorePassword 
 * Identify the aliases of entries with Entry type: keyEntry

Notes:  * The CLA2 Server keystore is configured in <isbi-install>properties/CmdLine2server.properties - the default is:
   keystoreLocation=<isbi-install>/client/cmdline2/cla2_KeyStore.jks. 
 * You can find the password for the CLA2 Server keystore ibidem - for example:
   keystorePassword=CRYPTED:EI++...= 
 * You can decrypt this password using "CLA2_PasswordUtil.cmd -decrypt <string>" (on command line from <isbi-install>/bin) - for example:
   ./CLA2_PasswordUtil.sh -decrypt CRYPTED:EI++...=

RESOLVING THE PROBLEM
 

 1. Create the private key for the SSL Public CA Certificate using the same password that is setup for the CLA2 Server keystore. 
 2. Remove all but the renewed certificate with private key (Entry type: keyEntry) from the CLA2 Server keystore.
    For example to remove an old keyEntry with alias cla2ssl use (on command line from <isbi-install>):
    jdk/bin/keytool -delete -v -keystore client/cmdline2/cla2_KeyStore.jks -storepass CLA2ServerKeyStorePassword -alias cla2ssl


Please note IBM TechNote How to renew certificates for CLA2 Adapter and CLA2 Server in ISBI? [http://www.ibm.com/support/docview.wss?uid=swg21883788] RELATED INFORMATION
 IBM KC: CLA2 Adapter [http://www.ibm.com/support/knowledgecenter/SS3JSW_5.2.0/com.ibm.help.svcs_adpts_a_l.doc/Command_Line_adapter_2_5241_2.html]
IBM TechNote: howto renew cla2autch and cla2ssl [http://www.ibm.com/support/docview.wss?uid=swg21883788]