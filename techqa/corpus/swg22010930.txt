Title: IBM [Db2] ロック待機が原因で SQL0952N、SQL30081N または-4499 が返ることがある - United States

Text:
 技術情報(FAQS)

質問
 ロック待機中に、特定のアプリケーションが SQL0952N やSQL30081N (selectForRecvTimeout) または -4499 (Read timeout) を返すことがあります。

これはなぜでしょう？ 

原因
ロック・タイムアウト時間より短い照会タイムアウトや通信タイムアウトを設定すると、ロック・タイムアウト (SQL0911N rc=68) でなく、照会タイムアウト (SQL0952N) や通信タイムアウト (SQL30081N selectForRecvTimeout もしくは -4499 Read timeout) が返ります。

回答
ロック・タイムアウト時間より短い照会タイムアウトや通信タイム後を設定すると、ロック・タイムアウトが返らないのは期待される結果です。 

以下の手順は、どのように照会タイムアウトや通信タイムアウトが発生するかを例示しています。


 1. SAMPLE データベースの LOCKTIMEOUT を 20 秒に設定します。
    $ db2 get db cfg for sample | grep LOCK
    Lock timeout (sec) (LOCKTIMEOUT) = 20
    
 2. コマンド行プロセッサー (CLP) から ORG 表を排他モードでロックします。
    $ db2 connect to sample
    $ db2 +c lock table org in exclusive mode
    
 3. Db2 に付属の JDBC テスト・プログラムから ORG 表を照会します。これはロック・タイムアウト (SQL0911N rc=68) が返ります。
    $ java com.ibm.db2.jcc.DB2Jcc -url "jdbc:db2://localhost:50000/SAMPLE" -user db2inst1 -password passw0rd -sql \'select deptname from org\'
    [jcc][10521][13706]Command : java com.ibm.db2.jcc.DB2Jcc -url jdbc:db2://localhost:50000/SAMPLE -user db2inst1 -password ******** -sql 'select deptname from org'
    
    [jcc][10516][13709]Test Connection Successful.
    [jcc][10515][13711]Execution of SQL failed with error code -911.
    Exception:
    com.ibm.db2.jcc.am.SqlTransactionRollbackException: DB2 SQL Error: SQLCODE=-911, SQLSTATE=40001, SQLERRMC=68, DRIVER=3.69.24
    
 4. 同じプログラムをロック・タイムアウト (20秒) より短い照会タイムアウト (commandTimeout 10 秒) を指定して実行します。これは照会タイムアウト (SQL0952N) が返ります。
    $ java com.ibm.db2.jcc.DB2Jcc -url "jdbc:db2://localhost:50000/SAMPLE:commandTimeout=10;" -user db2inst1 -password
    passw0rd -sql \'select deptname from org\'
    [jcc][10521][13706]Command : java com.ibm.db2.jcc.DB2Jcc -url jdbc:db2://localhost:50000/SAMPLE:commandTimeout=10; -user db2inst1 -password ******** -sql 'select deptname from org'
    
    [jcc][10516][13709]Test Connection Successful.
    [jcc][10515][13711]Execution of SQL failed with error code -952.
    Exception:
    com.ibm.db2.jcc.am.SqlException: DB2 SQL Error:SQLCODE=-952, SQLSTATE=57014, SQLERRMC=null, DRIVER=3.69.24
    
 5. 同じプログラムをロック・タイムアウト (20秒) より短い通信タイムアウト (blockingReadConnectionTimeout 10秒) を指定して実行します。これは通信タイムアウト (-4499 Read timed out) が返ります。
    $ java com.ibm.db2.jcc.DB2Jcc -url "jdbc:db2://localhost:50000/SAMPLE:blockingReadConnectionTimeout=10;" -user db2inst1 -password passw0rd -sql \'select deptname from org\'
    
    [jcc][10521][13706]Command : java com.ibm.db2.jcc.DB2Jcc -url jdbc:db2://localhost:50000/SAMPLE:blockingReadConnectionTimeout=10; -user db2inst1 -password ******** -sql 'select deptname from org'
    
    [jcc][10516][13709]Test Connection Successful.
    [jcc][10515][13711]Execution of SQL failed with error code -4,499.
    Exception:
    com.ibm.db2.jcc.am.DisconnectNonTransientConnectionException:
    [jcc][t4][2030][11211][3.69.24] A communication error occurred during operations on the connection's underlying socket, socket input stream, or socket output stream. Error location: Reply.fill() - socketInputStream.read (-1). Message: Read timed out. ERRORCODE=-4499, SQLSTATE=08001
    
    注: -4499 は Jcc ドライバー固有の通信エラー・コードです。non-Java クライアントは同じ状況で SQL30081N selectForRecvTimeout を返します。
    
    例
    $ db2set DB2TCP_CLIENT_RCVTIMEOUT=10
    $ db2 terminate
    $ db2 connect to SAMPLE user db2inst1 using passw0rd
    
    Database Connection Information
    
    Database server = DB2/AIX64 10.5.8
    SQL authorization ID = DB2INST1
    Local database alias = SAMPLE
    
    $ db2 "select * from org"
    SQL30081NA communication error has been detected. Communication protocol being used: "TCP/IP". Communication API being used: "SOCKETS". Location where the error was detected: "192.168.100.123". Communication function detecting the error: "selectForRecvTimeout". Protocol specific error code(s): "0", "*", "*". SQLSTATE=08001 



関連情報
パスポート・アドバンテージによく寄せられる質問 [http://www-01.ibm.com/support/docview.wss?uid=swg21590877]
locktimeout - ロック・タイムアウト構成パラメーター [https://www.ibm.com/support/knowledgecenter/ja/SSEPGG_11.1.0/com.ibm.db2.luw.admin.config.doc/doc/r0000329.html]
DB2Jcc - IBM Data Server Driver for JDBC and SQLJ の診断ユーティリティー [https://www.ibm.com/support/knowledgecenter/ja/SSEPGG_11.1.0/com.ibm.db2.luw.apdv.java.doc/src/tpc/imjcc_rjv00004.html]
サポートされるすべてのデータベース製品に共通の IBM Data Server Driver for JDBC and SQLJ のプロパティー [https://www.ibm.com/support/knowledgecenter/ja/SSEPGG_11.1.0/com.ibm.db2.luw.apdv.java.doc/src/tpc/imjcc_r0052038.html]
通信変数 [https://www.ibm.com/support/knowledgecenter/ja/SSEPGG_11.1.0/com.ibm.db2.luw.admin.regvars.doc/doc/r0005660.html]
[DB2 LUW] SQL0952N の原因と対処方法 [http://www.ibm.com/support/docview.wss?uid=swg21632578]
[DB2 LUW] DB2 クライアントの通信タイムアウトを設定する方法 [http://www.ibm.com/support/docview.wss?uid=jpn1J1000645]

お問合せ先
技術的な内容に関して、サービス契約のもと IBM サービス・ラインにお問い合わせください。
IBM サービス・ライン [http://www.ibm.com/services/jp/ja/it-services/svcline.html]

関連情報
 An US English translation is available [http://www.ibm.com/support/docview.wss?uid=swg21995530]