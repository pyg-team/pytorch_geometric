Title: IBM Required procedure prior to FlashSystem Battery Replacements - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 IBM has created a utility that must be installed and ran to backup battery quorum before a battery replacement. 

ENVIRONMENT
This procedure must be followed for FlashSystem enclosures:
FlashSystem 840 
FlashSystem V840
FlashSystem 900
FlashSystem A9000/R
FlashSystem V9000 with external AE3 enclosures

(This procedure does not apply to FlashSystem V9000 AE2 enclosures (9846-AE2, 9848-AE2))



DIAGNOSING THE PROBLEM
This procedure is performed just before running a battery replacement using the FlashSystem GUI or manually replacing a battery for any reason on a FlashSystem enclosure. 


The procedure may be performed by an IBM service rep, business partner, or customer, if necessary, however the battery replacement utility should be used only for battery replacements.



RESOLVING THE PROBLEM
Procedure: 


You have two options. Option 1 use the FlashSystem management GUI to upload the Battery Replacement Utility to the FlashSystem. Option 2 uses command line SCP or pscp.exe to transfer the file. Otherwise, the procedures are the same. Both options required using the CLI to execute the command. Choose the option you are most comfortable with.


Option 1 - GUI



 1. Download the Battery Replacement utility. Download the utility to the workstation that will be attached to your FlashSystem. The workstation must have GUI/CLI access.
    
    [/support/docview.wss?uid=ssg1S1012166&aid=2]TMS9840_INSTALL_battery_replacement_1.1 [/support/docview.wss?uid=ssg1S1012166&aid=1]
    TMS9840_INSTALL_battery_replacement_1.1
    
    
 2. Download the Upgrade Test utility. This file is required to allow us to upload the Battery Replacement utility from the GUI. 
    
    [/support/docview.wss?uid=ssg1S1012166&aid=4]TMS9840_INSTALL_svcupgradetest_1.38 [/support/docview.wss?uid=ssg1S1012166&aid=3]
    TMS9840_INSTALL_svcupgradetest_1.38
    
    (Note: you do not have to use the latest version of the upgrade test utility because you are not actually upgrading the firmware.)
    
    
 3. Open the FlashSystem GUI and go to the System > Update System page
    
    
 4. Click the "Update & Test" button then for the select the following:
    
    Test utility: TMS9840_INSTALL_svcupgradetest_1.3.8
    Update package: TMS9840_INSTALL_battery_replacement_1.1
    Code level: Enter your current running code version (it is displayed on the update system page)
    
    Click "Update" and both files will be uploaded to the FlashSystem.
    
    
 5. Wait for the upgrade test utility to run and detect issues on your FlashSystem (due to the state of the batteries). You may see a popup similar to this one:
    
    [/support/docview.wss?uid=ssg1S1012166&aid=5] [/support/docview.wss?uid=ssg1S1012166&aid=5]
    Click Close. Then simply click "cancel." 
    (Note that if this is a proactive replacement and both batteries are in a "online" healthy state you may not see the above popup and test utility will finish running without issue. The battery replacement utility will also be automatically installed so you can skip to step 8)
    
    
 6. Open an SSH session to the cluster IP of your FlashSystem storage device and verify the Battery Replacement utility was uploaded with command:
    
    superuser>lsdumps -prefix /home/admin/upgrade 
    Example output:
    id filename
    0 TMS9840_INSTALL_battery_replacement_1.1-123456789.1
    
    Your utility file name will end differently from the above so take note of it.
    
    
 7. Next, install the package:
    
    superuser>applysoftware -file TMS9840_INSTALL_battery_replacement_1.1-123456789.1
    CMMVC6227I The package installed successfully.
    
    You must use the exact file name generated by your FlashSystem as shown in the step 7. The above is simply an example.
    
    
 8. Run the utility. SSH to the cluster management IP of your FlashSystem storage device and run the start_battery_replacement command:
    
    superuser>start_battery_replacement
    Configuration backup starting...
    SVC configuration backup successful
    Quorum backup starting...
    D0 quorum backup successful (/dumps/d0_t3.bak)
    D4 quorum backup successful (/dumps/d4_t3.bak)
    
    You should see the output above. If there are errors, then do not replace the battery. Contact IBM support.
    
 9. At this point you can begin the normal battery replacement 
    







Option 2 - SCP or pscp.exe 

 1. Download the Battery Replacement utility. Download the utility to the workstation that will be attached to the customer's system. The PC must have CLI access and support scp or pscp file transfer or must support browser access in order to install the utility.
    
    [/support/docview.wss?uid=ssg1S1012166&aid=7]TMS9840_INSTALL_battery_replacement_1.1 [/support/docview.wss?uid=ssg1S1012166&aid=6]
    TMS9840_INSTALL_battery_replacement_1.1
    
    
 2. Install the utility. The utility must be installed using SCP or PSCP.EXE and the "applysoftware" command. (The GUI cannot be used because it requires the use of the Upgrade Test Utility, which will not allow you to proceed when a battery is failed or degraded.)
    
    
 3. Copy the utility from the PC to the FlashSystem using secure copy (scp) on Linux or PuTTY secure copy (pscp.exe) on Windows as in the following examples:
    
    (Using Linux)
    scp TMS9840_INSTALL_battery_replacement_1.1 superuser@cluster_ip:/upgrade
    
    (Using Windows)
    pscp.exe TMS9840_INSTALL_battery_replacement_1.1 superuser@cluster_ip:/upgrade
    
    
 4. SSH to the cluster IP and install the package:
    
    superuser>applysoftware -file TMS9840_INSTALL_battery_replacement_1.1
    CMMVC6227I The package installed successfully.
    
    
 5. Run the utility. SSH to the cluster management IP and run the start_battery_replacement command:
    
    superuser>start_battery_replacement
    Configuration backup starting...
    SVC configuration backup successful
    Quorum backup starting...
    D0 quorum backup successful (/dumps/d0_t3.bak)
    D4 quorum backup successful (/dumps/d4_t3.bak)
    
    You should see the output above. If there are errors, then do not replace the battery. Contact IBM support. 
 6.  
 7. At this point you can begin the normal battery replacement





Cross reference information Segment Product Component Platform Version Edition Flash Storage IBM FlashSystem 900 Flash Storage IBM FlashSystem A9000 Flash Storage IBM FlashSystem A9000R Flash Storage IBM FlashSystem V840 Flash Storage IBM FlashSystem V9000