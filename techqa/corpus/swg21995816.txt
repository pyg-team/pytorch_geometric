Title: IBM 1.9 upgrade/migration is sensitive to duplicate scm-ids within a custom site - United States

Text:
SCM-ID; schema upgrade fails; duplicate SCM-IDs TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 If there is a duplicate scm-id in a custom site, the schema upgrade fails when upgrading to IBM BigFix Compliance 1.9.60. 

SYMPTOM
During the upgrade to SCA 1.9, a schema update is required upon completion of SCM installation. When invoking the schema upgrade from the SCA web interface, the following error shows on the browser:

"We're sorry, but BigFix Compliance database is not accessible"

Example of the error shown in tema.log during schema upgrade:

[12/6/16 23:41:47:068 PST] 00000025 com.ibm.ws.webcontainer.webapp I SRVE0292I: Servlet Message - [tema]:.[ERROR] Java::ComMicrosoftSqlserverJdbc::SQLServerException: The CREATE UNIQUE INDEX statement terminated because a duplicate key was found for the object name 'scm.checks_persistent' and the index name 'scm_checks_persistent_checklist_id_remote_id_index'. The duplicate key value is (18, 15913A50-2689-2E2B-30FE-3715AAC3E326).: CREATE UNIQUE INDEX [scm_checks_persistent_checklist_id_remote_id_index] ON [scm].[checks_persistent] ([checklist_id], [remote_id]) 


IMPORTANT: If you ever run into upgrade schema failure stage, you can always roll back to the previous version of SCA by uninstalling 1.9 and reinstalling back to the version that you upgraded from. To know the last working version of SCA, the version information can is found in the import log with the last successful import or tema.log prior to upgrade.


CAUSE
Duplicate SCM-ID in a custom site.


DIAGNOSING THE PROBLEM
What is an SCM-ID?

BigFix Compliance imports data from the BigFix Server. All BigFix SCM checklist content is tagged with an SCM-ID MIME field. SCM-IDs not only allow BigFix Compliance to recognize what security content to consume, but also uniquely identify Fixlets and allow BigFix Compliance to trace them back to their original external sites.

Example of SCM-ID as coded in a fixlet's XML:

<MIMEField>
<Name>x-fixlet-scm-id</Name>
<Value>PCI-MSSQL-2008[1001004]</Value>
</MIMEField>

Using the wizards provided in the SCM Reporting site to create custom checklists significantly reduces the likelihood of creating fixlets with duplicate SCM-IDs. Manually copying fixlets to a custom site or creating entirely custom fixlets may result in multiple fixlets with the same SCM-ID. This is not readily apparent from the BigFix console, which does not display SCM-IDs. 


How to check for duplicate SCM-IDs

You can detect the problem before or after it occurs. To do so, you need to find out which Fixlets in your environment have duplicate SCM-IDs, if any. To do, follow these steps:
1) Open Microsoft SQL Server Management studio and locate the BigFix Compliance database. The default name is tem_analytics.
2) Right-click on your BigFix Compliance database and select ‘New Query’ from the menu.
3) Copy and paste following SQL statement in the ‘New Query’ window:

select ds.name as site_name,
ds.remote_id as site_id,
df.name fixlet_name,
df.remote_id as fixlet_bes_id,
checks.remote_id as scm_id,
checks.name as check_name
from scm.checks as checks
join (
select checklist_id, remote_id from scm.checks
group by checklist_id, remote_id
having COUNT(*) > 1 ) as duplicates on duplicates.checklist_id = checks.checklist_id
and duplicates.remote_id = checks.remote_id
join datasource_fixlets df on df.id = checks.datasource_fixlet_id
join datasource_sites ds on ds.id = df.datasource_site_id
order by ds.name

If the query produces no results, you have no duplicates and you can proceed with your upgrade to BigFix Compliance 1.9.
If the query produces any results, you will need to remove the duplicates prior to the upgrade.



RESOLVING THE PROBLEM
Before upgrading to BigFix Compliance 1.9, make sure your environment doesn’t contain Fixlets with duplicate SCM-IDs.

How to resolve duplication

The remediation should be done in the BigFix Console.

The aforementioned query gives you all the information you need to resolve duplicate SCM-IDs:

site_name - the name of custom site where duplicate IDs were detected
site_id - the site's ID number, for that site containing the duplicate fixlets in the BFEnterprise database
fixlet_name - the fixlet's name in the BigFix Console
fixlet_bes_id – the fixlet's ID number in the BigFix Console
scm_id – the SCM-ID value that is being duplicated



Locate the custom site where duplicate IDs are detected
Expand the custom site in BigFix Console and locate the fixlets with the same SCM-ID, either by name or by the Fixlet ID.

Either delete all but one of the duplicate Fixlets if they are copies, or if it is a completely custom Fixlet, you must change the SCM-IDs of the custom Fixlets until they are all unique.

How to change an SCM-ID
To change a Fixlet's SCM-ID, follow these steps:


 1. In the BigFix Console, right-click on the Fixlet and select ‘Export..’ menu option. 
 2. Export the Fixlet as a .bes file 
 3. Delete the Fixlet from the BigFix Console 
 4. Locate the exported Fixlet .bes file and open it in your favorite text editor or Windows Notepad. 
 5. Locate the following tag using the search function of your editor: x-fixlet-scm-id 
 6. Change the <Value> tag to a unique value. We suggest using a UUID generator to create a unique tag for each Fixlet. There are many tools that allow you to generate unique IDs. You could also use the following MSSQL function to get a new ID: SELECT NEWID() produces an unique global identifier. 
 7. After the x-fixlet-scm-id tag is updated, save the .bes file, and import it back into the BigFix Console. You can double click on the file and it should bring up the BigFix Console UI. Follow the wizard to complete the import. Be sure to select the correct site to place it in. 
 8. When all duplications are resolved, you need to run an Import in BigFix Compliance, which should resolve all duplicate records inside the BigFix Compliance database. 
 9. After a successful import, make sure to rerun the query again to ensure no return result. If there are still records shown on the provided query, you would have to repeat de-duplication steps. Otherwise you may upgrade to BigFix Compliance 1.9.