Title: IBM Migrating from V9.7 to V10.5, .NET application may receive CLI0129E - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 Why .NET application receive CLI0129E after migrating from V9.7 to V10.5? 

ANSWER
Here is a sample .NET source code.
-----
Imports System
Imports System.Data
Imports Microsoft.VisualBasic
Imports IBM.Data.DB2

Public Class repro
Public Shared Sub Main()

Dim ds As New System.Data.DataSet()

Dim connectString As String = "database=db1;uid=administrator;pwd=password"
Dim cmd as DB2Command
Dim conn As New DB2Connection(connectString)
Dim trans As DB2Transaction
cmd = conn.CreateCommand()

conn.Open()
trans = conn.BeginTransaction
cmd.Transaction = trans

cmd.CommandText = "CREATE TABLE DB2INST1.TAB1 (col1 int)"
cmd.ExecuteNonQuery()

cmd.CommandText = "INSERT INTO DB2INST1.TAB1 VALUES (1)"
cmd.Prepare()
cmd.ExecuteNonQuery()

cmd.CommandText = "UPDATE DB2INST1.TAB1 SET COL1=2"
cmd.Prepare()
cmd.ExecuteNonQuery()

cmd.CommandText = "DROP TABLE DB2INST1.TAB1"
cmd.Prepare()
cmd.ExecuteNonQuery()

trans.Commit()
conn.Close()

End Sub
End Class

-----

On V9.7 FP2, take a db2trc and run "grep sqljs_ddm_excsqlimm", find below output:
-----
Line 89623: 128628 | | | | | | sqljs_ddm_excsqlimm entry [...]
Line 115803: 161064 | | | | | | sqljs_ddm_excsqlimm exit
Line 127756: 173996 | | | | | | sqljs_ddm_excsqlimm entry [...]
Line 139086: 186051 | | | | | | sqljs_ddm_excsqlimm exit
Line 151196: 204383 | | | | | | sqljs_ddm_excsqlimm entry [...]
Line 163193: 216404 | | | | | | sqljs_ddm_excsqlimm exit
Line 166727: 219957 | | | | | | sqljs_ddm_excsqlimm entry [...]
Line 185918: 239632 | | | | | | sqljs_ddm_excsqlimm exit
-----
It calls EXECUTE IMMEDIATE 4 times for all CREATE, INSERT, UPDATE and DROP statement.

However on 10.5 FP8, it shows below:
-----
Line 21654: 15859 | | | | | | | sqljs_ddm_excsqlimm entry [...]
Line 34300: 28713 | | | | | | | sqljs_ddm_excsqlimm exit
-----
It calls EXECUTE IMMEDIATE only 1 time.

The difference between the two versions is an known expected behavior. On V9.7 FP2 
case, EXECUTE IMMEDIATE always happens only on the last section of the package 
(i.e SYSSH200 section 64). 

But V10.5 FP8, EXECUTE request will reserve one section and keeps until we explicitly 
close the statement handle (i.e SQLFreeStmt() in CLI and DB2command.Close() in case of 
DB2.Net). This is forcing the CLI to use the new section for every 
DB2Command.ExecuteNonQuery(). After some point time we are exhausting the number of 
available sections for use. 

The different behavior is caused by a future enhancement on V9.7 FP5, an internal 
architecture had been changed. And it may lead the CLI0129E error side effectively if 
coding logically similar as above sample on V9.7 FP5 or later FixPack and later DB2
versions, such as V10.1, V10.5 or V11.1.

There are some possible work arounds for this situation:
1) call DB2Command.Close() right after ExecuteNonQuery()
2) prevent to call prepare() before ExecuteNonQuery()

Note:
This behavior might be changed without notice in the future. We can confirm whether this technote
is valid or not by following above steps.
Please contact your Sales Rep to submit a potential design change towards a future release.
Or please open a ticket, Request For Enhancement at https://www.ibm.com/developerworks/rfe/ [https://www.ibm.com/developerworks/rfe/]

RELATED INFORMATION
 CLI0129E An attempt to allocate a handle failed becau [http://www.ibm.com/support/knowledgecenter/en/SSEPGG_11.1.0/com.ibm.db2.luw.messages.cli.doc/doc/mcli00129e.html]