Title: IBM WebSphere DataPower SOA Appliances Integration Between DataPower and InfoSphere Streams with MQSeries. - United States

Text:
 TECHNOTE (FAQ)

QUESTION
 We are trying to proceed integration between DataPower and InfoSphere Streams with MQ. The full chain is: Client (HTTP) -> DP -> Queue Manager <- Streams (DataPower sends MQ messages and Streams consumes them).

After testing different configurations, we chose to send MQ/JMS messages of type StreamMessage.

You can see below what was done with an xslt file, we generate the MQ message
- Header MQMD with the following content

<MQMD>
<StrucId>MD</StrucId>
<Version>2</Version>
<Format>MQHRF2</Format>
<Priority>4</Priority>
<Encoding>273</Encoding>
<CodedCharSetId>819</CodedCharSetId>
<Persistence>1</Persistence>
<GroupId>000000000000000000000000000000000000000000000000</GroupId>
<MsgSeqNumber>1</MsgSeqNumber>
<Offset>0</Offset>
<MsgFlags>0</MsgFlags>
<OriginalLength>-1</OriginalLength>
</MQMD>

- Header MQRFH2 with the following content
<MQRFH2>
<StrucId>RFH</StrucId>
<Version>2</Version>
<Encoding>273</Encoding>
<CodedCharSetId>819</CodedCharSetId>
<Format>MQSTR</Format>
<Flags>0</Flags>
<NameValueCCSID>1208</NameValueCCSID>
<NameValueData>
<NameValue>
<mcd>
<Msd>jms_stream</Msd>
</mcd>
</NameValue>
<NameValue>
<jms>
<Dst>
<xsl:text>queue:///QL.TEST</xsl:text>
</Dst>
</jms>
</NameValue>
</NameValueData>
</MQRFH2>

- JMS payload with the following content
<stream>
<elt> data </elt>
</stream>

We would like to know if it is the right way to send MQ/JMS message from DataPower or there is a better approach. 

CAUSE
The best approach for sending MQ/JMS messages from DataPower.

ANSWER
Yes, this is correct, however, you want to make sure you're using the (DataPower)MQFTE protocol for this; DataPower supports MQMD.Version = 2 only if the (DataPower)MQFTE protocol is used. 

Currently DataPower supports both MQ headers MQMD header version 1 (for MQ front side handler and DPMQ url-opener) and MQMD header version 2 (for MQFTE front side handler and DPMQFTE url-opener). MQMD header version 2 isn't supported by MQ front side handler and DataPower MQ
url-opener.

If you need MQFTE's benefit (e.g. transfer large files) and use MQMD header version 2 to enable it, MQFTE backend/url-open should be used.

Here is a technote [http://www-01.ibm.com/support/docview.wss?uid=swg21608405] that shows how to configure a DataPower MPGW with Websphere MQ FTE for a message to file transfer.

Lastly, let's be clear of how to inject the MQMD and MQRFH2 structures.

(1) Define the MQMD structure with a variable such as
<xsl:variable name="MQMDStr">

(2) Serilaize the "MQMDStr" variable with the following code snippet:
<xsl:variable name="serializeMqmd">
<dp:serialize select="$MQMDStrr" omit-xml-decl="yes"/>
</xsl:variable>

(3) Set the MQMD header in the request flow:
<dp:set-request-header name="'MQMD'" value="$serializeMqmd"/>

Similar method is needed to use a variable for the MQRFH2 header, serilaize it and then set the MQRFH2 header in the request flow:

(4) Let us assume that the variable "RFH2Str" holds the MQRFH2 structure

(5) Serialize it using the following code snippet:
<xsl:variable name="serilizedRFH2">
<dp:serialize select="$RFH2Str" omit-xml-decl="yes"/>
</xsl:variable>

(6) Set the MQRFH2 header in the request flow: 
<dp:set-request-header name="'MQRFH2'" value="$serilizedRFH2"/>