Title: IBM Using 3rd party certificate to encrypt communication between Agent Manger and SiteProtector server on port 3994 and https - United States

Text:
encryption; certificate; custom; communication TECHNOTE (FAQ)

QUESTION
 How do you encrypt communication between the Agent Manager and SiteProtector server using a custom certificate? 

ANSWER
SiteProtector must be installed in Compatible Mode. A Strict Mode site may require different commands.
Making these changes may prevent communication from an agent to the Update Server unless the agent's old certificate for the Update Server is removed. The method for correcting this will vary by agent.

For the purposes of these instructions, we will assume the new keys are in pem format and are encrypted. If the keys are in another format, openssl or other third party utilities can be used to convert the keys. In the example commands, the keys will be named like this:


Preparation:


 1. Backup the files from the Keystore folder. These are the master GSK files for the SiteProtector system:
    
    \Program Files\ISS\SiteProtector\Keystore
    
    
 2. Download OpenSSL and put it in a location such as this (for 64 bit OS):
    
    C:\OpenSSL-Win64\
    
    
 3. Set the configuration file for OpenSSL. You will need to use this same command window for other OpenSSL commands:
    
    set OPENSSL_CONF=C:\OpenSSL-Win64\bin\openssl.cfg
    
    
 4. If you need to generate a private key you can use the command below. It will prompt for a password.
    
    bin\openssl genrsa -des3 -out privkey.pem 2048



SiteProtector Server (XUS) steps :

 1.  Stop the SiteProtector Application Server Service, SiteProtector Sensor Controller Service and SiteProtector Webserver Service services.
     
     
 2.  Backup all files from these directories: 
     
     \Program Files\ISS\SiteProtector\Application Server\webserver\IHS\
     
     
 3.  Move all the server.* files out of the above IHS directory so there are no longer any files that begin with "server" in that directory.
     
     
 4.  On the Application Server, copy the public and private keys in the \webserver\IHS directory.
     
     Example: \Program Files\ISS\SiteProtector\Application Server\webserver\IHS\newpublic.pem and newprivate.pem.
     
     
 5.  On the Application Server, open a Command Prompt and run the below commands one by one. Confirm the path for IHS folder is correct for your Application Server.
     
     Note 1: Verify that you have the correct GSK version (.5, .11, .20) in the path.
     
     Note 2: If you use the BAT file located here: C:\Program Files\ISS\SiteProtector\Application Server\webserver\IHS\bin\gskcapicmd.bat you do not need to set the path below.
     
     set PATH=%PATH%;C:\Program Files\ISS\SiteProtector\GSK\8.0.50.11\lib
     
     cd "\Program Files\ISS\SiteProtector\ApplicationServer\webserver\IHS\" 
     
     bin\issGcPw.exe amcg_ini_update.txt > p.txt
     
     SET /p CONFIGUREDP=<p.txt
     
     del p.txt
     
     
 6.  In the same command prompt window, convert the keys to pcks12 format using OpenSSL.
     
     Example commands (remember to enter your correct private key password): 
     
     SET PRIVATEKEYPASS=yourprivatekeypasshere
     
     "C:\OpenSSL-Win64\bin\openssl.exe" pkcs12 -export -in newpublic.pem -inkey newprivate.pem -out new.p12 -passin pass:%PRIVATEKEYPASS% -passout pass:%CONFIGUREDP% -name "siteprotectorkeys-rsa"
     
     
 7.  In the same command prompt window, convert the pkcs12 keystore to a cms database.
     
     Example command:
     
     "bin\gskcapicmd.bat" -keydb -convert -db new.p12 -new_db server.kdb -pw %CONFIGUREDP% -old_format pkcs12 -new_format cms -stash -fips true
     
     
 8.  Set the Default Certificate.
     
     Example command:
     
     "bin\gskcapicmd.bat" -cert -setdefault -db server.kdb -stashed -label siteprotectorkeys-rsa -type cms -fips true
     
     
 9.  Ensure the cert are still intact.
     
     Example command:
     
     "bin\gskcapicmd.bat" -cert -list all -db server.kdb -stashed
     
     
 10. If desired, the working files can be removed:
     
     new.p12
     newpublic.pem
     newprivate.pem
     
     
 11. Start the SiteProtector services previously stopped as Step 1.
     
     

Agent Manager changes : 

Agent Manager is able to use the same files since it is installed on the SiteProtector Application Server. It the Agent Manager is located on a different system than the SiteProtector Application Server the creation of the files may have be to be performed again on that system. You can reuse the files generated for the Application Server. 

 1. Save the server.pem and the cert*.pem to a folder on the desktop:
    
    \Program Files\ISS\SiteProtector\Agent Manager\server.pem
    \Program Files\ISS\SiteProtector\Agent Manager\certificates\cert2014_06_20_14_48.pem
    
    
 2. Stop the issDaemon service and then copy the newpublic.key to the same certificate name. The date in the name is the date that the pem was generated.
    
    
 3. Copy newpublic.pem to \Program Files\ISS\SiteProtector\Agent Manager\certificates\cert2014_06_20_14_48.pem
    
    
 4. Create a new server.pem by concatenating newpublic.pem and privkey.pem (not required for SiteProtector 3.0 or higher).
    
    
 5. Copy server.* (.crl, .kdb, .rdb, .sth) created in the SiteProtector XUS section to \Program Files\ISS\SiteProtector\Agent Manager.
    
    
 6. Copy server.pem to \Program Files\ISS\SiteProtector\Agent Manager (not required for SiteProtector 3.0 or higher).
    
    
 7. Restart the issDaemon service.



Event Collector changes : 

Event Collector is able to use the same files since it is on the SiteProtector Application server. 

 1. Stop the issDaemon service.
    
    
 2. Copy server.* (.crl, .kdb, .rdb, .sth) created in the SiteProtector XUS section to \Program Files\ISS\SiteProtector\Event Collector.
    
    
 3. Start the issDaemon service.






[/support/docview.wss?uid=swg21687476&aid=1] [https://ibm.biz/BdHdjw] [/support/docview.wss?uid=swg21687476&aid=2] [http://ibm.biz/InfraSecForumTechnote] [/support/docview.wss?uid=swg21687476&aid=3] [http://ibm.biz/SecSuptUTube] [/support/docview.wss?uid=swg21687476&aid=4] [http://ibm.biz/InfraSecFixes] [/support/docview.wss?uid=swg21687476&aid=5] [http://ibm.biz/FlexLicLogin] [/support/docview.wss?uid=swg21687476&aid=6] [http://ibm.biz/MyNotification] [/support/docview.wss?uid=swg21687476&aid=7] [http://ibm.biz/ContactSecSupport]