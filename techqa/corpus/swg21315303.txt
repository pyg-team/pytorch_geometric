Title: IBM MQ000003 after ending AIX without stopping the queue manager - United States

Text:
XC338001 SIGTERM MQ000003 shutdown shut down end endmqm stop stopping mqminfo TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 You ended AIX without stopping your WebSphere MQ queue manager. You restart AIX and MQ, then find that your application can not connect to your queue manager. FDCs were issued. After stopping and restarting the queue manager the problem did not occur. 

SYMPTOM
When AIX was shut down there were FDC's with probe id XC338001, indicating that SIGTERM was sent to MQ processes. 

After AIX and the queue manager was started, then there was a repeating pattern of FDC files as the application attempted to connect to the queue manager. Each time the FDC's start with an amqzlaa0 process writing probe id MQ000003, but the component is unknown and the reason code is xecI_S_FAIL. The reason code xecI_S_FAIL means that we have failed to connect to a segment of shared memory. It is accompanied by the following message: 

AMQ6004 An error occurred during WebSphere MQ initialization or ending. 

EXPLANATION: An error was detected during initialization or ending of MQ. The MQ error recording routine has been called.


CAUSE
Stopping AIX without ending the queue manager first


RESOLVING THE PROBLEM
WebSphere MQ is working as designed. You should not end AIX without first ending the queue manager with the endmqm command. 


Additional information
Normally, before the queue manager ends, all ipc resources used by the queue manager are deleted and the corresponding files (for example files in /var/mqm/qmgr/<qmgr>/shmem/shm.*) which contain information about the ipc resources are also deleted. On restart, the queue manager creates these ipc resources and creates corresponding files to store this information. If these files are already present when the queue manager starts, the information stored in these files are used to connect to the ipc resources. 

 In this particular scenario, shutting down the AIX operating system before ending the queue manager causes the MQ processes to end abruptly. This prevents the regular cleanup of the ipc resources and the deletion of the corresponding files from the system. However, the ending and restarting of AIX caused AIX to clean up all the ipc resources on the system, including the ones being used by MQ. 

When the queue manager is restarted, MQ checks for the existence of files in "shmem" directory to see if it can attach to the shared memory segments pointed to by these files. Since these files continue to exist but the ipc resources were removed by the AIX shutdown, MQ tries to attach to shared memory segments, which are non existent. This leads to the MQ000003 FDC from the agent and subsequently the
termination of the agent process. When the agent process is terminated it causes the application to fail when it tries to connect to the queue manager 

When the queue manager ends using the endmqm command, then all of the files related to ipc resources are deleted during the normal MQ cleanup process. On restart of the queue manager new ipcs resources are created, and then the application is able to successfully connect to the queue manager. 

These symptoms are the normal MQ behavior and all this occurred due to stopping AIX without ending the queue manager first.

 

PRODUCT ALIAS/SYNONYM
 wmq/mq