Title: IBM Ethernet Connection Restrictions For  SAN Volume Controller And Storwize Storage Systems - United States

Text:
 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 The ethernet connection restrictions for the SAN Volume Controller and the Storwize Storage Systems, limit the number of concurrent SSH sessions to 15 new connections per sec with a burst limit of 3. Attempts to open multiple concurrent SSH sessions will fail after the user log-on limit has been reached. An existing active connection must first be closed before a new connection to the cluster will be accepted. This document outlines the key connection restrictions for each firmware version of the SAN Volume Controller and the Storwize Storage Systems. 

CAUSE
The ethernet connection restrictions on the SAN Volume Controller and the Storwize Storage Systems, are necessary to manage the cluster configuration node system resources. These restrictions protect the cluster and the I/O service against processing large amounts of ethernet related work which could risk consuming excessive resources.



SSH - Active Connection Limit

SAN Volume Controller (SVC) V2.1.0 onwards
SVC restricts the maximum of concurrent SSH session to 10 per user; supporting 10 concurrent SSH connections for the admin user and 10 concurrent SSH connections for the service user. There is also a limit of 3 concurrent unauthenticated SSH connection attempts to the cluster. Subsequent connections will be dropped until authentication of the existing connections succeeds, fails, or times out.

Note that connections used by the SAN Volume Controller Console (GUI) CIMOM application and host automation such as HACMP-XD count towards these limits, so the number of interactive SSH sessions you can open to the cluster concurrently may be less than 10.

Once the connection limit has been reached then subsequent connection attempts will fail, with the new SSH session closing immediately after user authentication.



SSH - New Connection Rate Limit

SAN Volume Controller (SVC) V4.1.x and V4.2.0
V4.1.0 introduced a restriction of 10 new SSH connections per second. This restriction protects the SVC cluster against "Denial of Service" flood attacks. Most users should not be affected by this limit as a typical connection session will take more than 1/10th of a second to open, process and close.

If more than 10 connection attempts are made in a second then only the first ten attempts will be accepted, subsequent attempts will fail before the user authentication stage. 

SAN Volume Controller (SVC) V4.2.1.2 and later
V4.2.1.2 relaxed this restriction, allowing 15 new SSH connections per second.

From V4.2.1.2 onwards, any failure to get a connection results in an explicit reject packet from the SVC. This enables the remote system which is attempting to connect to regain control immediately and implement a retry algorithm, rather than waiting for the TCP layer to retry (which may take up to approximately 3 minutes).



SSH - Authentication Limit

SAN Volume Controller (SVC) V4.2.0 onwards
V4.2.0 introduced a limit of 3 authentication attempts per connection. After a third authentication failure the connection will be closed.



SSH - KeepAlive

SAN Volume Controller (SVC) V2.1.0 onwards
TCP keepalive messages are sent from the configuration node to the SSH client on the connecting host to detect the loss of an SSH connection. Unresponsive connections are dropped after the two hour keepalive period has expired.

SAN Volume Controller (SVC) V4.2.0 onwards
V4.2.0 enabled use of "ClientAlive" timeouts in the SSH2 protocol, requiring the SSH client to respond to the server after a period of inactivity to keep the connection alive. Unresponsive connections are dropped after approximately 90 seconds. This allows the connection slots held by stale SSH connections to be released much quicker than using the TCP layer keepalive alone.



Ping - Rate Limit

SAN Volume Controller (SVC), Storwize V7000 and Storwize V3700 V6.4.1.x and older
This limit was relaxed to 70 pings/minute (average) in the V4.2.0 release.

SAN Volume Controller (SVC) and all Storwize Storage Systems V7.1.x and newer
This limit was relaxed to 140 pings/minute (average)



RESOLVING THE PROBLEM
It is recommended to close SSH connections when they are no longer required, in order to avoid unknowingly reaching the connection limit. The 'exit' command should be used to terminate an interactive SSH session. 

 


Guidance for handling SSH connection limit problems

SAN Volume Controller (SVC) releases prior to V4.2.0
If the connection limit has been reached and you are unable to identify the clients with open SSH connections to the cluster, then there are two options to trigger the configuration node to close all active connections and restart the network services:

Option 1 – update the network settings

If you have working ethernet access to the cluster, via either the GUI or the CLI, the network services can be restarted by updating the cluster ethernet network settings. The new settings do not need to be different from the existing values to trigger the services to be restarted. For example, update the Subnet Mask to be the same as the existing value.

Once the settings have been updated then the network services will be restarted, disconnecting all existing SSH connections to the cluster, and allowing new connections to be opened.

Option 2 - restart the configuration node

If you do not have working ethernet access to the cluster then the network services can be restarted by restarting the configuration node in the cluster. This disconnects all existing SSH connections and the role of configuration node will failover to another node in the cluster, allowing new connections to be opened. 

 * Use the front panel menus to identify the node with the 'Active' ethernet status (only the configuration node in a cluster will have an active ethernet connection). 
 * Press and release the front panel power button to initiate the node shutdown. Once the shutdown process has completed then the node will power-off and remain in the standby state. 
 * Press and release the front panel power button to power the node back on.


NOTE: this procedure can only be applied concurrently with host I/O running if the configuration node’s partner node is online, i.e. the I/O group containing the configuration node is not degraded, and the host multi-pathing software is correctly configured. 



SAN Volume Controller (SVC) V4.2.0 and later 
SVC V4.2 introduced several improvements to simplify resolving SSH access problems: 

1) Detection of failed/"stale" SSH connections:  * Use of SSH ClientAlive feature to detect when a client has dropped a connection and terminate the stale session.



2) Clear reporting when the SSH user limit has been reached. If an 11th concurrent SSH connection is attempted then the following will occur:  * A new cluster error code (2500) is logged by the cluster. This will generate an SNMP notification (if configured). If there are no unfixed errors with a higher priority then the Cluster Error 2500 will be displayed on the front panel of all nodes which are online in the cluster. 
 * The connection attempt will return the text "Too many logins for 'admin'" or "Too many logins for 'service'".



3) Improved recovery process:  * The Directed Maintenance Procedure for the Cluster Error 2500 will list the remote IP addresses which have open SSH connections. If these clients are inaccessible then the maintenance procedure will allow all active connections to be reset, terminating all SSH sessions and clearing the login count.

 * If the SVC (V5.1.0.x and older) Console (GUI) is unable to open a new SSH connection to the cluster then the cluster state will be reported as "No Contact". The Directed Maintenance Procedures can be accessed directly via the "Launch Maintenance Procedures" task from the drop-down list on the Viewing Clusters panel.
   
   SVC Console GUI Menu [/support/docview.wss?uid=ssg1S1002896&aid=1] [/support/docview.wss?uid=ssg1S1002896&aid=1]

 * 
 * 
 * 
 * SVC Console Maintenance Page [/support/docview.wss?uid=ssg1S1002896&amp;aid=2]

 * 

 * SVC V5.1.0.x DMP screen [/support/docview.wss?uid=ssg1S1002896&amp;aid=3]


Starting with SAN Volume Controller (and Storwize) firmware level V6.1.0.x and newer, the SSH Daemon can be restarted from the Service Assistant interface. 

Connect to the Service Assistant and select the 'Restart Service' option: 

Service Assistant Home Screen [/support/docview.wss?uid=ssg1S1002896&amp;aid=4] 

Then select the 'Secure Shell Daemon (SSHD)' and click on the 'Restart' button; 

Service Assistant Restart Service Screen [/support/docview.wss?uid=ssg1S1002896&aid=5] [/support/docview.wss?uid=ssg1S1002896&aid=5] 
RELATED INFORMATION
 SVC Ethernet Connectivity Overview [http://www-1.ibm.com/support/docview.wss?rs=0&uid=ssg1S1002897]






Cross reference information Segment Product Component Platform Version Edition Disk Storage Systems IBM Storwize V3500 (2071) Not Applicable Platform Independent Version Independent Disk Storage Systems IBM Storwize V3700 (2072) Not Applicable Platform Independent Not Applicable Disk Storage Systems IBM Storwize V5000 Not Applicable Platform Independent Version Independent Disk Storage Systems IBM Storwize V7000 (2076) Not Applicable Platform Independent Version Independent Disk Storage Systems Flex System V7000 Not Applicable Platform Independent Not Applicable