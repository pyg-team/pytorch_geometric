Title: IBM MustGather: WebSphere Application Server Community Edition 100% CPU on AIX - United States

Text:
mustgather; MustGather; AIX; 100% cpu; cpu; high cpu; ce; wasce; community edition; MustGatherDocument; WAS CE; WAS CE; WAS CE; WASCE; WASCE; WASCE; JBoss; JBoss; JBoss; Glassfish; Glassfish; Glassfish; App Server; App Server; WebSphere CE; WebSphere CE; WebSphere CE; WebSphere Community Edition; WebSphere Community Edition; WebSphere Community Edition; IBM CE; IBM CE; IBM CE; Open Source; Open Source; Open Source TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Collecting data for problems with WebSphere Application Server Community Edition 100% CPU on the AIX operating system. Gathering this information before calling IBM support will help familiarize you with the troubleshooting process and save your time. 

RESOLVING THE PROBLEM
This document details the MustGather data to be collected for WebSphere Application Server Community Edition when 100% CPU usage is observed with IBM Java 1.5 or IBM Java 1.6 on the AIX operating system. 


Setup for 100% CPU on AIX
The first section of the document covers the necessary setup required prior to collection of the MustGather. The latter part covers the MustGather collection steps.

Ensure javacore.txt generation is enabled
The Javadump (javacore) is a useful file to provide information about the general state of the Java runtime, and the applications running on it. In order to ensure this is generated, the relevant settings must be in place. Although they are set by default, it is possible that the default setting has been changed, so it is important to check that the correct settings are in place.

Check that the JVM is set to produce a javadump file when a user signal (SIGQUIT) occurs, by adding the following command line option: 



java -Xdump:what 
The preceding command shows the options which are set, such as: 

dumpFn=doJavaDump
events=gpf+user+abort 
filter=
label=/usr/local/jdk/jre/bin/javacore.%Y%m%d.%H%M%S.%pid.txt
range=1..0
priority=10
request=exclusive 
The preceding values are the default settings. At least events=user must be in place to generate javadumps on a user signal. 

Options can be changed and set using the command line option: 

-Xdump:java[:=,...] 
So, for example, to set the ability to generate javadump files on user signals you would use: 

-Xdump:java:events=user 

Enable verbose GC logging 
Verbose GC logging gives an insight into the actions that the Garbage Collector is taking. This allows an application to be monitored and better tuned for performance, in addition to being vital for diagnosing problems. 

Verbose GC logging is not enabled by default, and can be done by 1 of the following ways:  * Enabling the generation of Verbose GC logging is done to direct the Verbose GC logging output to a single file using the following command line option:
   
   -Xverbosegclog:[DIR_PATH][FILE_NAME] 
   Where: [DIR_PATH] is the directory where the file should be written [FILE_NAME] is the name of the file to write the logging to 
   For example, 
   java -Xverbosegclog:/tmp/verbose_output.xml 
   Note: Ensure that the directory provided in [DIR_PATH] exists in the file system. 
   
 * The logging can also be done in a circular fashion to a series of files, this is carried out using the following command line option:
   
   -Xverbosegclog:[DIR_PATH][FILE_NAME],X,Y 
   Where: [DIR_PATH] is the directory where the file should be written [FILE_NAME] is the name of the file to write the logging to X is the number of files to write to Y is the number of GC cycles a file should contain 
   The parameter needs to be set in the setenv.sh file located under the following directory: 
   <WAS CE Installation Directory>/bin 
   Edit the setenv.sh file, then locate "JAVA_OPTS=" line and append the parameter to the existing list.
   
   For example: 
   JAVA_OPTS=-Xms128m -Xmx512m -Xverbosegclog:/tmp/verbose-ouput.xml 
   
   

Enable process size monitoring, CPU profiling and paging usage  * Monitoring the process size
   Follow the Process Size Monitoring for IBM Java technote [http://www.ibm.com/support/docview.wss?uid=swg21222446] and collect the process size monitoring logs.
   
   
 * Monitor the CPU Profiling
   Profiling the CPU usage on AIX can be achieved using the tprof utility, as carried out with the following command: 
   
   ./tprof_ps.sh tprof_ps 
   Which uses the following script: 
   #! /bin/ksh
   TPROF_LOG=$1
   
   mkdir $TPROF_LOG
   cd $TPROF_LOG
   tprof -skex sleep 60
   ps avwwwg > ps-w-tprof.log
   
   cd ..
   
   
 * Monitoring the paging usage
   Monitoring the paging usage on AIX can be achieved using the vmstat utility, as carried out with the following command:
   
   ./vmstat.sh vmstat.log 
   Which uses the following script: 
   #!/bin/ksh
   #log file name
   VMSTAT_LOG=$1
   # Adjust LIMIT & SLEEP_TIME to suite your purpose/need.
   # There Lre 288- 5 minute intervals in a day
   LIMIT=288
   #sleep for 5 minutes
   SLEEP_TIME=300
   while true
   do
   i=0
   echo >$VMSTAT_LOG
   while [ $i -le "$LIMIT" ];
   do
   date >> $VMSTAT_LOG;
   vmstat 5 12 >> $VMSTAT_LOG;
   i=`expr $i + 1`;
   sleep $SLEEP_TIME;
   done
   done 
   Where: LIMIT is the number of log cycles before the log file rolls over SLEEP_TIME is the amount of time between each log cycle 
   
   

MustGather collection 
Having ensured that AIX is properly setup for MustGather collection, follow these steps to collect the data files:  1. Take a snapshot of the network activity using the following command:
    
    netstat -an netstat_before.out 
    
 2. Run CPU Profiling for the current CPU activity
    
    
 3. Take a listing of the current processes:
    
    ps -efHm > ps_efhm.txt 
    Note: If you face problems with the preceding command, try to run the following in succession: 
    ps -efm > ps_efm.txt
    ps -efH > ps_efh.txt 
    
 4. Generate 3 javacore.txt files, taken 2 minutes apart from the time of 100% CPU usage using kill command as shown below:
    
    kill -3 [PID_of_server_JVM] 
    
 5. Take a second snapshot of network activity:
    
    netstat -an netstat_after.out 
    
 6. Collect the verbose GC output.
    
    
 7. Collect the CPU monitoring output.
    
    
 8. Collect the process size monitoring.
    
    
 9. Collect the paging size usage monitoring.
    
    

Additional Information  * Recent changes to the server before the 100% CPU usage
   
   
 * Brief description of the applications running while 100% CPU usage
   
   
 * Collect general information of the server as discussed here [http://www.ibm.com/support/docview.wss?uid=swg21231419#generalMustGather]


These data files should then be submitted to IBM Support as given at the bottom of this technote. 

Tip to save you time: If you open and update your PMRs electronically, using Service Request [http://www.ibm.com/software/support/probsub.html] [http://www.ibm.com/software/support/probsub.html], update the PMR to indicate that data has been sent.