Title: IBM TEMA not exporting to Warehouse Proxy Agent - United States

Text:
"Remote call failure"; 1C010001; CTX_RPCError; gateway; kde gateway; tunnel; tunneling; wpa; whp; data export; historical collection; ITM TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 Some agents are configured to connect TEMS and Warehouse Proxy Agent (WPA) using KDE gateway feature. Connection with TEMS works fine but the agents are failing to export historical data to WPA 

SYMPTOM
When the agents try to export data to WPA, the following error message is shown in the agent log: 

(51867566.0000-1C:kdcc1sr.c,566,"rpc__sar") Remote call failure: 1C010001
..
..
+51867566.0000 e-secs: 0 mtu: 944 KDE1_stc_t: 1DE0000F
+51867566.0000 bld-date: Feb 18 2011 bld-time: 11:37:53 revision: d65200:1.1.1.10
+51867566.0000 bsn: 4113282 bsq: 4 driver: tms_ctbs622mdx:d1049a
+51867566.0000 short: 10 contact: 180 reply: 300 
+51867566.0000 req-int: 30 frag-int: 30 ping-int: 30 
+51867566.0000 limit: 900 work-allow: 60 
+51867566.0000 loc-endpt: ip.pipe:#*:14209
+51867566.0000 rmt-endpt: ip.pipe:#xxx.yy.zzz.eee:6014
..
..
+51867569.0009 Error Type= CTX_RPCError 
+51867569.0009 Severity= CTX_Critical 
+51867569.0009 Native Error Code = 0 
+51867569.0009 SQL State= NULL 
+51867569.0009 Reason Code= 469827585 
+51867569.0009 executing: KHD_QueryServerInfo 
(51867569.000A-1C:khdxbase.cpp,339,"setError") 
+51867569.000A ERROR MESSAGE: "RPC Error"


DIAGNOSING THE PROBLEM
The KDE gateway tunnel is established using the following xml definition for the proxy role in the DMZ side: 


<interface name="gatewayproxy" ipversion="4" role="proxy">
<bind localport="1918" service="tems"/>
<bind localport="6014" service="whp"/>
</interface>

In the trusted zone, the Warehouse Proxy Agent is actually listening on port 6014 and the upstream connection between client and server proxy is correctly established.
In the machine that is running the KDE gateway feature in the DMZ, netstat command output shows port 6014 is actually listening and there are a lot of established connections between port 6014 and remote addresses. This indicates that the ITM agents relying on this gateway proxy were able to establish the connection with port 6014 but then the historical data export fails anyway with RPC error.

If you have already verified that all is fine on trusted zone for what concern the warehouse proxy agent (eg: is it actually listening on port 6014? any error into the WPA logs?) you can then focus on the machine where the KDE gateway proxy server feature is implemented, in the DMZ side.
You know that port 6014 is listening and that the agents in the DMZ are able to connect to it.
This means that an ITM process actually bound this port.
We expect this port to be used by the KDE gateway feature, but if there are other ITM components running on the same machine it is indeed possible that this port has been allocated by someone else (eg. another ITM agent) instead of the KDE gateway.

This would explain why, even if port 6014 is listening and the agents established a session to it, the export is failing anyway.
As first step, verify which the process that allocated port 6014 is.
On AIX you can do this with following commands:

a. netstat -Aan ! grep 6014 
This shows if the specified <port number> is being used. The hex number in the first column is the address of protocol control block (PCB) 

b. rmsock <addr of PCB> tcpcb 
This shows the process holding the socket. 

On Linux you can do it by using :

netstat -ap |grep 6014

Port 6014 must belong to the process where the KDE gateway feature is running, usually the OS agent.
If it is allocated by another agent process, then it is the reason for the historical data export failure.



RESOLVING THE PROBLEM
You need to avoid that ITM components running on the same machine of the KDE gateway server bind port 6014 (or the port you choose for WPA communication). 

You can rely on the SKIP keyword to force ITM component binding ports after 6014.
Basically, we want the agents to start allocating port after the 6014 and this could be done with the following settings:

KDC_FAMILIES=IP.PIPE SKIP:2 
In this way the first agent process will allocate port 10110, the second will allocate port 14206 and so on, bypassing port 6014.
So, in the machine running the KDE gateway feature, you need to change all the agents configuration files (but OS agent file) to modify KDC_FAMILIES parameter as mentioned above. 

In example, if we consider agent UL (Unix Log agent), into the ul.ini file you will see:
KDC_FAMILIES=$NETWORKPROTOCOL$ 
that is then resolved into the ul.config file as:

export KDC_FAMILIES='ip.pipe port:1918 ip use:n ip.spipe use:n sna use:n'

So you need to put

KDC_FAMILIES='ip.pipe port:1918 skip:2 use:y ip use:n ip.spipe use:n sna use:n' 
into the ul.ini file the following parameter in place of the original KDC_FAMILIES.
In this way you are sure port 6014 will be used by the KDE gateway running into the OS agent.

Another option would be to reconfigure WPA to use port 63358 (this is the default in latest ITM releases) instead of 6014 and change the KDE gateway configuration files accordingly.
In this way you don't need to use the SKIP option in the agents configuration file.

 

PRODUCT ALIAS/SYNONYM
 IBM Tivoli Monitoring V6.x TEMA