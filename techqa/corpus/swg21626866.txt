Title: IBM EmailPlus Package constructing invalid URL when using the #@URLOFENTITY@# expression when including Web User ID - United States

Text:
ClearQuest; EmailPlus; EmailPlus Rule. EmailPlus Template; #@URLofEntity@#; #@RestUriOfEntity@#; expression; security TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 When configuring the EmailPlusSiteConfig for CQWeb specifying a "Web User ID", the link that is generated is invalid. 

SYMPTOM
For instance here is a link that was generated. It has the wrong contextid. The database name is SAMPL, and the user specified was NONE and the password was password. It combined these two into SAMPLNONE. 


https://server.test.com/cqweb/main?command=GenerateMainFrame&ser [https://server.test.com/cqweb/main?command=GenerateMainFrame&ser]vice=CQ&schema=CQMS.World.TST&contextid=SAMPLNONE&password=password&entityID=33554433&entityDefName=Defect

Here is the corresponding link that was generated when removing the user ID (and password), it works correctly and you just need to login to ClearQuest to see the record: 

https://server.test.com/cqweb/main?command=GenerateMainFrame&ser [https://server.test.com/cqweb/main?command=GenerateMainFrame&ser]
vice=CQ&schema=CQMS.World.TST&contextid=SAMPL&entityID=33554433&entityDefName=Defect

EmailPlus is not creating the URL link for the Record correctly when using the "#@URLofEntity@#" expression within EmailPlus Template and when adding an userid and password in the EmailPlusSiteConfig for CQWeb.


CAUSE
There is an issue/error with the Global Script EMP_URLServices.


ENVIRONMENT
WARNING: It is not recommended to include a username and password in the URL, as this is insecure. If you require this, consider only using a limited purpose user account that has restricted mode privileges in CQ Web.



DIAGNOSING THE PROBLEM
- Login to ClearQuest Web and Connect to a repository with EmailPlus enabled and configured.
- Modify the EmailPlus rule, add an "Modify" action in the "Action Conditions", add your email address and save it.
- Run the All Defects query, for instance. And just modify a record and save it.
- Using the #@URLofEntity@# expression within EmailPlus Template, you should receive an email where you can check the link/URL for the record.
- If you add an userid and password in the EmailPlusSiteConfig for CQWeb, the link/URL created for the record is broken. See the error message below: 

[/support/docview.wss?uid=swg21626866&aid=1] [/support/docview.wss?uid=swg21626866&aid=1]
Note: If you leave the userid and password as "blank" it works correctly.


RESOLVING THE PROBLEM
This issue has been classified as a defect on the product with referred APAR # PI84019 [http://www.ibm.com/support/docview.wss?uid=swg1PI84019].
2 workarounds, and 1 solution: 

1) Simplest workaround:
Instead of using the EmailPlus expression:

#@URLofEntity@#

instead use:

#@RestUriOfEntity@#

We tested and the #@RestUriOfEntity@# URL format works correctly whereas #@URLofEntity@# has the issue.

2) This workaround will fix the issue for #@URLOfEntity@# as requested, but will break it for #@RestUriOfEntity@# (which may not even be used right now):
In the EmailPlusSiteConfig > CQWeb Config > replace Web User Id value as follows:
original:
<username>
replacement:
&username=<username>
Example correction:
"&username=admin"
instead of just "admin"
Save the record. All users will have to logoff and back on for the change to take affect.

> Solution: You can fix the hook code using package editing:

# Start of Global Script EMP_URLServices
...
my $URL_LOGON = "&username=";
...
sub EMP_GetBaseURL {
...
# Add username and pw if present
if ($webUser ne "") {
$result .= $URL_LOGIN.$webUser.$URL_PASSWORD.$webPw;
}


Enabling package editing (and then disabling when completed), you would just change "LOGIN" to "LOGON" in the incorrect $URL_LOGIN to match the variable name defined above $URL_LOGON.
You can search for these strings using the Designer. We would advise using the classic Designer (cqdesign.exe) for the task.
It is needed to checkin the Schema and upgrade the database, logout ClearQuest Web (if not already logout). So, the change in the Global Script EMP_URLServices, will take place and it will be valid.
================================================
***** Use caution with package editing. It is generally not supported for customer use. Take backups and necessary precautions for mistakes you may make in package hook code that was not intended for customer editing. Once you have finished the package editing, remember to disable it (disable packageediting, as informed below) *****
To enable packageediting, run the following:

packageutil enablepackageediting -dbset <CQConnection> <CQ_superuser> <CQ_superuser_password> -enable <CQ_superuser>

For example:

packageutil enablepackageediting -dbset myConnection admin "" -enable admin

Expected output:

Enabled the package editing option for user 'admin'
--------------------------------------------------------------
To disable packageediting when completed, run the following:

packageutil enablepackageediting -dbset <CQConnection> <CQ_superuser> <CQ_superuser_password> -disable <CQ_superuser>

For example:

packageutil enablepackageediting -dbset myConnection admin "" -disable admin

Expected output:

Disabled the package editing option for user 'admin'
================================================