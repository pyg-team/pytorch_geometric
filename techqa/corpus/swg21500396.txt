Title: IBM Getting DatabaseDeadlockException during fixpack installation - United States

Text:
DatabaseDeadlockException; fixpack; ifix; COPUTL001E; SQLCODE=-911 SQLSTATE=40001 SQLERRMC=68 TECHNOTE (TROUBLESHOOTING)

PROBLEM(ABSTRACT)
 During data migration step of FP1 installation got an error: COPUTL001E An unexpected data migration 

SYMPTOM
Got an error during data migration: 

 

2011-05-16 20:56:21,712 INFO COPUTL023E Processing Migration Step: drop 

the foreign keys on endpoint task table 

2011-05-16 20:56:21,715 INFO COPUTL025I Performing SQL command: 

sql/db2/drop.referential.all.tables.sql 

2011-05-16 20:56:21,718 WARN No file 

[sql/db2/drop.referential.all.tables.sql] found try generic SQL 

2011-05-16 20:56:21,720 INFO COPUTL025I Performing SQL command: 

sql/drop.referential.all.tables.sql 

2011-05-16 20:56:21,727 INFO Executing SQL : alter table 

MAXIMO.END_POINT_TASK drop foreign key SQL101223154548950 

2011-05-16 20:58:21,996 ERROR COPUTL033E Failed SQL Message: DB2 SQL 

Error: SQLCODE=-911, SQLSTATE=40001, SQLERRMC=68, DRIVER=3.53.70 

2011-05-16 20:58:22,022 ERROR COPUTL001E An unexpected data migration 

system exception occurred. Exception: COPUTL001E An unexpected data 

migration system exception occurred. Exception: class 

com.thinkdynamics.kanaha.util.exception.DatabaseDeadlockException:DB2 

SQL Error: SQLCODE=-911, SQLSTATE=40001, SQLERRMC=68, DRIVER=3.53.70.. 

2011-05-16 20:58:22,028 INFO COPUTL077I The data migration failed. 

 

ERROR: data migration failed, exiting. 

 



CAUSE
This is a deadlock error which usually occurs if there is a concurrent process accessing the database while dropping the constraint: 

 
2011-05-16 20:56:21,727 INFO Executing SQL : alter table 
MAXIMO.END_POINT_TASK drop foreign key SQL101223154548950 


RESOLVING THE PROBLEM
You need to ensure that no other java processes are accessing the database while migration is being done to avoid another process from locking the table to be modified. 

 
You can run this command to make sure there is no connection to db from any processes: 
db2 force application all 

After this you need to restore the database backup since we do not allow to re-run fixpack install again if data migration has failed since this could cause the db corruption. Then you can run the fixpack install again. 

If this is an ifix installation then you can re-run the ifix install after making sure no other java processes are accessing the db. During ifix install we allow to re-run data migration step, so you dont have to restore the database. So you can re-run ifix install script and it will pick up at the data migration step and continue.