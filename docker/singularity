Bootstrap: docker
From: nvidia/cuda:10.2-cudnn8-devel-ubuntu18.04

%post
  CURDIR=$(pwd)

  # Set timezone to Etc/UTC for tzdata. See issue #4365 for more details.
  TZ=Etc/UTC && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone

  apt-get update -y
  apt-get install -y tmux nano git wget
  apt-get install -y --no-install-recommends \
    build-essential \
    gfortran \
    libssl-dev \
    zlib1g-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    wget \
    curl \
    llvm \
    libncurses5-dev \
    xz-utils \
    tk-dev \
    libxml2-dev \
    libxmlsec1-dev \
    libffi-dev \
    liblzma-dev \
    liblapack-dev \
    libopenblas-dev \
    libhdf5-dev

  export PYENV_ROOT=/opt/pyenv && \
    export PATH="/opt/pyenv/bin:$PATH" && \
    curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash && \
    pyenv install 3.10.3 && \
    echo 'export PATH=/opt/pyenv/versions/3.10.3/bin:$PATH' >> $SINGULARITY_ENVIRONMENT && \
    export PATH=/opt/pyenv/versions/3.10.3/bin:$PATH

  pip install torch==1.11.0

  mkdir -p $SINGULARITY_ROOTFS/tmp/sing_build_cuda
  cd $SINGULARITY_ROOTFS/tmp/sing_build_cuda

  echo 'export TORCH_CUDA_ARCH_LIST="5.0 6.1"' >> $SINGULARITY_ENVIRONMENT && \
    export TORCH_CUDA_ARCH_LIST="5.0 6.1"

  git clone https://github.com/rusty1s/pytorch_scatter.git && \
    cd ./pytorch_scatter && \
    git checkout 2.0.9 && \
    python3 -m pip install . && \
    cd ..

  git clone https://github.com/rusty1s/pytorch_sparse.git && \
    cd ./pytorch_sparse && \
    git checkout 0.6.13 && \
    python3 -m pip install . && \
    cd ..

  git clone https://github.com/rusty1s/pytorch_cluster.git && \
    cd ./pytorch_cluster && \
    git checkout 1.6.0 && \
    python3 -m pip install . && \
    cd ..

  git clone https://github.com/pyg-team/pytorch_geometric.git && \
    cd ./pytorch_geometric && \
    git checkout 2.0.4 && \
    python3 -m pip install . && \
    cd ..

  cd $CURDIR
  rm -rf $SINGULARITY_ROOTFS/tmp/sing_build_cuda
